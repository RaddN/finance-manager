<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Manager</title>
    <!-- SheetJS for Excel processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --primary: #3182ce;
            --primary-dark: #2c5282;
            --success: #38a169;
            --danger: #e53e3e;
            --warning: #d97706;
            --purple: #805ad5;
            --bg-grad-start: #f5f7fa;
            --bg-grad-end: #e4e8ec;
            --card-bg: #ffffff;
            --text-main: #2d3748;
            --text-light: #718096;
            --border: #e2e8f0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, var(--bg-grad-start) 0%, var(--bg-grad-end) 100%);
            min-height: 100vh;
            color: var(--text-main);
            padding-bottom: 100px; /* Space for FAB */
        }

        /* Header */
        header {
            background: var(--card-bg);
            padding: 1rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        .logo { font-size: 1.25rem; font-weight: bold; color: var(--primary); display: flex; align-items: center; gap: 0.5rem; }
        
        /* Status Bar */
        .status-bar {
            background: #fff;
            border-bottom: 1px solid var(--border);
            padding: 0.5rem;
            text-align: center;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .status-connected { color: var(--success); background: #f0fff4; }
        .status-disconnected { color: var(--danger); background: #fff5f5; }

        /* Navigation */
        .nav-tabs {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            background: var(--card-bg);
            padding: 0.5rem 1rem;
            border-bottom: 1px solid var(--border);
            max-width: 1200px;
            margin: 0 auto;
        }
        .nav-tab {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            white-space: nowrap;
            color: var(--text-light);
            transition: all 0.2s;
            font-weight: 500;
        }
        .nav-tab:hover { background: #edf2f7; color: var(--text-main); }
        .nav-tab.active { background: var(--primary); color: white; }

        /* Main Content */
        .container { max-width: 1200px; margin: 0 auto; padding: 1.5rem 1rem; }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-left: 5px solid var(--primary);
        }
        .stat-label { font-size: 0.8rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; }
        .stat-value { font-size: 1.8rem; font-weight: bold; margin-top: 0.5rem; }

        /* Tables & Cards */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .card h2 { margin-bottom: 1rem; font-size: 1.25rem; color: var(--text-main); }
        
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { text-align: left; padding: 1rem; background: #f7fafc; color: var(--text-light); font-size: 0.875rem; font-weight: 600; border-bottom: 2px solid var(--border); }
        td { padding: 1rem; border-bottom: 1px solid #edf2f7; font-size: 0.95rem; vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: #f7fafc; }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 64px;
            height: 64px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(49, 130, 206, 0.4);
            cursor: pointer;
            font-size: 2rem;
            transition: transform 0.2s, background 0.2s;
            z-index: 100;
            border: none;
        }
        .fab:hover { transform: scale(1.1); background: var(--primary-dark); }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal {
            background: var(--card-bg);
            width: 90%;
            max-width: 500px;
            border-radius: 16px;
            padding: 2rem;
            transform: translateY(20px);
            transition: transform 0.2s;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .modal-overlay.active .modal { transform: translateY(0); }
        
        .modal-header { font-size: 1.5rem; font-weight: bold; margin-bottom: 1.5rem; text-align: center; }
        
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--text-light); font-weight: 500; }
        .form-input, .form-select, textarea.form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            transition: border 0.2s;
        }
        textarea.form-input {
            resize: vertical;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(49,130,206,0.1);
        }
        
        .btn { padding: 0.75rem 1.5rem; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; width: 100%; margin-top: 0.5rem; transition: background 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-secondary { background: #edf2f7; color: var(--text-main); }
        .btn-secondary:hover { background: #e2e8f0; }
        .btn-danger { background: #fed7d7; color: var(--danger); padding: 0.5rem 1rem; font-size: 0.875rem; width: auto; }
        .btn-danger:hover { background: #feb2b2; }

        /* Type Selector Grid */
        .type-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .type-card {
            background: #f7fafc;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .type-card:hover { border-color: var(--primary); background: #ebf8ff; transform: translateY(-2px); }
        .type-icon { font-size: 2.5rem; margin-bottom: 0.5rem; display: block; }
        .type-label { font-weight: 600; color: var(--text-main); }

        /* Tags */
        .tag { padding: 0.25rem 0.75rem; border-radius: 99px; font-size: 0.75rem; font-weight: 600; display: inline-block; }
        .tag-success { background: #f0fff4; color: var(--success); }
        .tag-danger { background: #fff5f5; color: var(--danger); }
        .tag-warning { background: #fffaf0; color: var(--warning); }
        .tag-purple { background: #faf5ff; color: var(--purple); }

        /* Future Plans Progress */
        .plan-item { margin-bottom: 1.5rem; }
        .plan-header { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        .progress-track { width: 100%; height: 10px; background: #edf2f7; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--purple); transition: width 0.5s ease; }
        .plan-meta { display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-light); }

        .hidden { display: none !important; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }

        /* Filter Bar */
        .filter-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex: 1;
            min-width: 200px;
        }
        .filter-input {
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.875rem;
            flex: 1;
        }
        .btn-icon {
            background: transparent;
            border: 1px solid var(--border);
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            font-size: 0.875rem;
        }
        .btn-icon:hover {
            background: #f7fafc;
            border-color: var(--primary);
        }
        .btn-edit {
            background: #e6f3ff;
            color: var(--primary);
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            margin-right: 0.5rem;
            transition: background 0.2s;
        }
        .btn-edit:hover {
            background: #bee3f8;
        }
        .btn-delete {
            background: #fed7d7;
            color: var(--danger);
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background 0.2s;
        }
        .btn-delete:hover {
            background: #feb2b2;
        }

        /* Charts */
        .chart-container {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
            height: 300px;
        }
        .chart-container canvas {
            max-height: 280px;
        }
        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-main);
        }

        /* Search Box */
        .search-box {
            position: relative;
            flex: 1;
            min-width: 250px;
        }
        .search-box input {
            width: 100%;
            padding: 0.5rem 2.5rem 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.875rem;
        }
        .search-icon {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        /* Analytics & Insights */
        .insight-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary);
        }
        .insight-title {
            font-size: 0.875rem;
            color: var(--text-light);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .insight-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--text-main);
        }
        .insight-trend {
            font-size: 0.75rem;
            margin-top: 0.5rem;
            color: var(--text-light);
        }
        .trend-up { color: var(--success); }
        .trend-down { color: var(--danger); }

        /* Budget Progress */
        .budget-item {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary);
        }
        .budget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .budget-category {
            font-weight: 600;
            font-size: 1.1rem;
        }
        .budget-amount {
            font-size: 1.25rem;
            font-weight: bold;
        }
        .budget-spent {
            color: var(--danger);
        }
        .budget-remaining {
            color: var(--success);
        }

        /* Report Sections */
        .report-section {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }
        .report-section:last-child {
            border-bottom: none;
        }
        .report-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-main);
        }
        .report-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        /* Analytics Grid */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        /* Category Management */
        .category-item {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }
        .category-item:hover {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-color: var(--primary);
        }
        .category-name {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-main);
        }
        .category-actions {
            display: flex;
            gap: 0.5rem;
        }
        .category-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        .badge-income { background: #f0fff4; color: var(--success); }
        .badge-expense { background: #fff5f5; color: var(--danger); }

        /* Bulk Actions */
        .bulk-actions {
            background: #f7fafc;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
            align-items: center;
            gap: 1rem;
        }
        .bulk-actions.active {
            display: flex;
        }
        .checkbox-cell {
            text-align: center;
            width: 40px;
        }
        input[type="checkbox"] {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        /* Transaction Notes */
        .transaction-note {
            font-size: 0.75rem;
            color: var(--text-light);
            font-style: italic;
            margin-top: 0.25rem;
        }

        /* Recurring Badge */
        .recurring-badge {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            background: #e6fffa;
            color: #047857;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header>
        <div class="header-content">
            <div class="logo">
                <span>üìä</span> Finance Manager
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-secondary" style="width: auto;" onclick="exportData()" title="Export Data">üì• Export</button>
                <button class="btn btn-primary" style="width: auto;" id="connect-btn" onclick="connectExcelFile()">Connect Excel</button>
            </div>
        </div>
    </header>

    <!-- Status Bar -->
    <div id="status-bar" class="status-bar status-disconnected">
        Disconnected from 'finance_data.xlsx'. Please connect to start.
    </div>

    <!-- Navigation -->
    <nav class="nav-tabs">
        <div class="nav-tab active" onclick="switchTab('dashboard')">Dashboard</div>
        <div class="nav-tab" onclick="switchTab('income')">Income</div>
        <div class="nav-tab" onclick="switchTab('expenses')">Expenses</div>
        <div class="nav-tab" onclick="switchTab('receivables')">Due (Receivables)</div>
        <div class="nav-tab" onclick="switchTab('payables')">Payables</div>
        <div class="nav-tab" onclick="switchTab('plans')">Future Plans</div>
        <div class="nav-tab" onclick="switchTab('budgets')">Budgets</div>
        <div class="nav-tab" onclick="switchTab('categories')">Categories</div>
        <div class="nav-tab" onclick="switchTab('reports')">Reports</div>
        <div class="nav-tab" onclick="switchTab('analytics')">Analytics</div>
    </nav>

    <!-- Main Content Area -->
    <main class="container">
        
        <!-- Dashboard View -->
        <div id="view-dashboard">
            <div class="stats-grid">
                <div class="stat-card" style="border-color: var(--success);">
                    <div class="stat-label">Total Income</div>
                    <div class="stat-value" id="dash-income">‡ß≥0</div>
                </div>
                <div class="stat-card" style="border-color: var(--danger);">
                    <div class="stat-label">Total Expenses</div>
                    <div class="stat-value" id="dash-expenses">‡ß≥0</div>
                </div>
                <div class="stat-card" style="border-color: var(--primary);">
                    <div class="stat-label">Net Balance</div>
                    <div class="stat-value" id="dash-balance">‡ß≥0</div>
                </div>
                <div class="stat-card" style="border-color: var(--purple);">
                    <div class="stat-label">Total Savings</div>
                    <div class="stat-value" id="dash-savings">‡ß≥0</div>
                </div>
                <div class="stat-card" style="border-color: var(--warning);">
                    <div class="stat-label">Due Receivables</div>
                    <div class="stat-value" id="dash-receivables-total">‡ß≥0</div>
                </div>
                <div class="stat-card" style="border-color: #c53030;">
                    <div class="stat-label">Due Payables</div>
                    <div class="stat-value" id="dash-payables-total">‡ß≥0</div>
                </div>
            </div>

            <!-- Financial Health Score -->
            <div class="card" style="margin-bottom: 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <div>
                        <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Financial Health Score</div>
                        <div style="font-size: 3rem; font-weight: bold;" id="health-score">-</div>
                        <div style="font-size: 0.875rem; opacity: 0.9; margin-top: 0.5rem;" id="health-status"></div>
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                            <div>
                                <div style="font-size: 0.75rem; opacity: 0.8;">Savings Rate</div>
                                <div style="font-size: 1.5rem; font-weight: bold;" id="savings-rate">0%</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; opacity: 0.8;">Expense Ratio</div>
                                <div style="font-size: 1.5rem; font-weight: bold;" id="expense-ratio">0%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Insights -->
            <div class="analytics-grid" style="margin-bottom: 2rem;">
                <div class="insight-card">
                    <div class="insight-title">Average Monthly Expense</div>
                    <div class="insight-value" id="avg-monthly-expense">‡ß≥0</div>
                    <div class="insight-trend" id="expense-trend"></div>
                </div>
                <div class="insight-card">
                    <div class="insight-title">Average Monthly Income</div>
                    <div class="insight-value" id="avg-monthly-income">‡ß≥0</div>
                    <div class="insight-trend" id="income-trend"></div>
                </div>
                <div class="insight-card">
                    <div class="insight-title">Top Spending Category</div>
                    <div class="insight-value" id="top-category" style="font-size: 1.2rem;">-</div>
                    <div class="insight-trend" id="top-category-amount"></div>
                </div>
                <div class="insight-card">
                    <div class="insight-title">Average Transaction Size</div>
                    <div class="insight-value" id="avg-transaction">‡ß≥0</div>
                    <div class="insight-trend">All transactions</div>
                </div>
                <div class="insight-card">
                    <div class="insight-title">Monthly Savings</div>
                    <div class="insight-value" id="avg-monthly-savings">‡ß≥0</div>
                    <div class="insight-trend" id="savings-trend"></div>
                </div>
                <div class="insight-card">
                    <div class="insight-title">Transaction Count</div>
                    <div class="insight-value" id="transaction-count">0</div>
                    <div class="insight-trend" id="transaction-breakdown"></div>
                </div>
            </div>

            <!-- Charts Section -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                <div class="chart-container">
                    <div class="chart-title">Income vs Expenses Trend</div>
                    <canvas id="trend-chart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Cash Flow</div>
                    <canvas id="cashflow-chart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Expense Categories</div>
                    <canvas id="expense-categories-chart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Income Categories</div>
                    <canvas id="income-categories-chart"></canvas>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                <div class="card">
                    <h2>üì• Due Receivables</h2>
                    <div id="dash-receivables-list"></div>
                </div>
                <div class="card">
                    <h2>üì§ Due Payables</h2>
                    <div id="dash-payables-list"></div>
                </div>
            </div>
        </div>

        <!-- Generic List View (Used for Income, Expenses, Receivables, Payables) -->
        <div id="view-list" class="hidden">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                    <div>
                        <h2 id="list-title" style="margin: 0;">Items</h2>
                        <small id="list-count" style="color: var(--text-light); font-size: 0.875rem;"></small>
                    </div>
                    <div class="filter-bar" style="margin: 0;">
                        <div class="search-box">
                            <input type="text" id="search-input" placeholder="Search..." onkeyup="applyFilters()">
                            <span class="search-icon">üîç</span>
                        </div>
                        <select class="filter-input" id="category-filter" onchange="applyFilters()">
                            <option value="">All Categories</option>
                        </select>
                        <input type="date" class="filter-input" id="date-from-filter" onchange="applyFilters()" placeholder="From Date">
                        <input type="date" class="filter-input" id="date-to-filter" onchange="applyFilters()" placeholder="To Date">
                        <select class="filter-input" id="recurring-filter" onchange="applyFilters()" style="min-width: 120px;">
                            <option value="">All Types</option>
                            <option value="recurring">Recurring Only</option>
                            <option value="non-recurring">Non-Recurring</option>
                        </select>
                        <select class="filter-input" id="sort-by" onchange="applyFilters()" style="min-width: 150px;">
                            <option value="">Sort by...</option>
                            <option value="date-asc">Date (Oldest)</option>
                            <option value="date-desc">Date (Newest)</option>
                            <option value="amount-asc">Amount (Low to High)</option>
                            <option value="amount-desc">Amount (High to Low)</option>
                        </select>
                        <button class="btn-icon" onclick="clearFilters()">Clear Filters</button>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead id="list-thead"></thead>
                        <tbody id="list-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Plans View -->
        <div id="view-plans" class="hidden">
            <div class="card">
                <h2>Future Plans & Goals</h2>
                <div id="plans-container"></div>
            </div>
        </div>

        <!-- Budgets View -->
        <div id="view-budgets" class="hidden">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2>Budget Tracking</h2>
                    <button class="btn btn-primary" style="width: auto;" onclick="openModal('form', 'budget')">+ Add Budget</button>
                </div>
                <div id="budgets-container"></div>
            </div>
        </div>

        <!-- Reports View -->
        <div id="view-reports" class="hidden">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                    <h2>Financial Reports</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <select class="filter-input" id="report-period" onchange="renderReports()" style="min-width: 150px;">
                            <option value="month">This Month</option>
                            <option value="lastmonth">Last Month</option>
                            <option value="year">This Year</option>
                            <option value="lastyear">Last Year</option>
                            <option value="all">All Time</option>
                        </select>
                        <button class="btn-icon" onclick="printReport()">üñ®Ô∏è Print</button>
                    </div>
                </div>
                <div id="reports-container"></div>
            </div>
        </div>

        <!-- Analytics View -->
        <div id="view-analytics" class="hidden">
            <div class="card">
                <h2>Advanced Analytics</h2>
                <div id="analytics-container"></div>
            </div>
        </div>

        <!-- Categories View -->
        <div id="view-categories" class="hidden">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2>Category Management</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary" style="width: auto;" onclick="openModal('form', 'category')">+ Add Category</button>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                    <div>
                        <h3 style="margin-bottom: 1rem; font-size: 1rem; color: var(--text-main);">Income Categories</h3>
                        <div id="income-categories-list"></div>
                    </div>
                    <div>
                        <h3 style="margin-bottom: 1rem; font-size: 1rem; color: var(--text-main);">Expense Categories</h3>
                        <div id="expense-categories-list"></div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Sticky Add Button -->
    <button class="fab" onclick="openModal('selector')">+</button>

    <!-- Modal Overlay -->
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal" id="modal-content">
            <!-- Content injected via JS -->
        </div>
    </div>

    <script>
        // --- 1. STATE & CONFIG ---
        const CONFIG = {
            fileName: 'finance_data.xlsx',
            currency: '‡ß≥'
        };

        let state = {
            fileHandle: null,
            isConnected: false,
            data: {
                income: [],
                expenses: [],
                receivables: [],
                payables: [],
                plans: [],
                budgets: [],
                categories: []
            }
        };

        // --- 2. EXCEL FILE SYSTEM LOGIC ---
        
        async function connectExcelFile() {
            if (!window.showOpenFilePicker) {
                alert("Your browser does not support the File System Access API. Please use Chrome, Edge, or Opera on HTTPS/Localhost.");
                return;
            }

            try {
                [state.fileHandle] = await window.showOpenFilePicker({
                    types: [{
                        description: 'Excel Files',
                        accept: { 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'] }
                    }],
                    multiple: false
                });

                if (state.fileHandle.name !== CONFIG.fileName) {
                    alert(`Please select the file named exactly: ${CONFIG.fileName}`);
                    state.fileHandle = null;
                    return;
                }

                state.isConnected = true;
                updateStatus(true);
                
                // Load Data
                await readExcelFile();
                renderAll();

            } catch (err) {
                console.error(err);
                if (err.name !== 'AbortError') {
                    alert('Error connecting to file: ' + err.message);
                }
            }
        }

        async function readExcelFile() {
            const file = await state.fileHandle.getFile();
            const arrayBuffer = await file.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, {type: 'array'});

            const parseSheet = (name) => {
                if (workbook.Sheets[name]) {
                    return XLSX.utils.sheet_to_json(workbook.Sheets[name]);
                }
                return [];
            };

            // Map sheets to state data
            state.data.income = parseSheet('Income');
            state.data.expenses = parseSheet('Expenses');
            state.data.receivables = parseSheet('Receivables');
            state.data.payables = parseSheet('Payables');
            state.data.plans = parseSheet('Plans');
            state.data.budgets = parseSheet('Budgets') || [];
            state.data.categories = parseSheet('Categories') || [];
        }

        async function writeExcelFile() {
            if (!state.fileHandle || !state.isConnected) return;

            try {
                // Create workbook
                const wb = XLSX.utils.book_new();

                // Convert data to sheets
                const incomeSheet = XLSX.utils.json_to_sheet(state.data.income);
                const expensesSheet = XLSX.utils.json_to_sheet(state.data.expenses);
                const receivablesSheet = XLSX.utils.json_to_sheet(state.data.receivables);
                const payablesSheet = XLSX.utils.json_to_sheet(state.data.payables);
                const plansSheet = XLSX.utils.json_to_sheet(state.data.plans);
                const budgetsSheet = XLSX.utils.json_to_sheet(state.data.budgets || []);
                const categoriesSheet = XLSX.utils.json_to_sheet(state.data.categories || []);

                // Append sheets
                XLSX.utils.book_append_sheet(wb, incomeSheet, "Income");
                XLSX.utils.book_append_sheet(wb, expensesSheet, "Expenses");
                XLSX.utils.book_append_sheet(wb, receivablesSheet, "Receivables");
                XLSX.utils.book_append_sheet(wb, payablesSheet, "Payables");
                XLSX.utils.book_append_sheet(wb, plansSheet, "Plans");
                XLSX.utils.book_append_sheet(wb, budgetsSheet, "Budgets");
                XLSX.utils.book_append_sheet(wb, categoriesSheet, "Categories");

                // Write to file
                const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
                const writable = await state.fileHandle.createWritable();
                await writable.write(wbout);
                await writable.close();

                // Visual feedback (brief toast or status update)
                const statusEl = document.getElementById('status-bar');
                const originalText = statusEl.textContent;
                statusEl.textContent = 'Saved successfully!';
                setTimeout(() => updateStatus(true), 1500);

            } catch (err) {
                console.error('Save error:', err);
                alert('Failed to save to Excel file. Check permissions.');
            }
        }

        // --- 3. UI RENDERING ---

        function updateStatus(connected) {
            const el = document.getElementById('status-bar');
            const btn = document.getElementById('connect-btn');
            if (connected) {
                el.className = 'status-bar status-connected';
                el.textContent = `Connected to ${CONFIG.fileName}`;
                btn.textContent = 'Connected';
                btn.disabled = true;
            } else {
                el.className = 'status-bar status-disconnected';
                el.textContent = 'Disconnected. Please connect Excel file.';
                btn.textContent = 'Connect Excel';
                btn.disabled = false;
            }
        }

        function formatCurrency(amount) {
            return CONFIG.currency + Number(amount).toLocaleString('en-BD');
        }

        function switchTab(tabId) {
            // Update Tab UI
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            const activeTab = Array.from(document.querySelectorAll('.nav-tab')).find(t => t.innerText.toLowerCase().includes(tabId === 'plans' ? 'future' : tabId));
            if (activeTab) activeTab.classList.add('active');

            // Hide all views
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-list').classList.add('hidden');
            document.getElementById('view-plans').classList.add('hidden');
            document.getElementById('view-budgets')?.classList.add('hidden');
            document.getElementById('view-reports')?.classList.add('hidden');
            document.getElementById('view-analytics')?.classList.add('hidden');
            document.getElementById('view-categories')?.classList.add('hidden');

            // Show selected view
            if (tabId === 'dashboard') {
                document.getElementById('view-dashboard').classList.remove('hidden');
                renderDashboard();
            } else if (tabId === 'plans') {
                document.getElementById('view-plans').classList.remove('hidden');
                renderPlansList();
            } else if (tabId === 'budgets') {
                document.getElementById('view-budgets').classList.remove('hidden');
                renderBudgetsList();
            } else if (tabId === 'reports') {
                document.getElementById('view-reports').classList.remove('hidden');
                renderReports();
            } else if (tabId === 'analytics') {
                document.getElementById('view-analytics').classList.remove('hidden');
                renderAnalytics();
            } else if (tabId === 'categories') {
                document.getElementById('view-categories').classList.remove('hidden');
                renderCategoriesList();
            } else {
                document.getElementById('view-list').classList.remove('hidden');
                renderListTable(tabId);
            }
        }

        function renderAll() {
            // Determine current tab and render it specifically
            const activeTab = document.querySelector('.nav-tab.active');
            if(activeTab) {
                if(activeTab.innerText.includes('Dashboard')) switchTab('dashboard');
                else if(activeTab.innerText.includes('Future')) switchTab('plans');
                else switchTab(activeTab.getAttribute('onclick').match(/'([^']+)'/)[1]);
            } else {
                switchTab('dashboard');
            }
        }

        // Calculate total savings (reusable function)
        function calculateTotalSavings() {
            const totalIncome = state.data.income.reduce((sum, i) => sum + Number(i.amount || 0), 0);
            const totalExpenses = state.data.expenses.reduce((sum, i) => sum + Number(i.amount || 0), 0);
            const netBalance = totalIncome - totalExpenses;
            const totalReceivables = state.data.receivables.reduce((sum, i) => sum + Number(i.amount || 0), 0);
            return totalReceivables + (netBalance > 0 ? netBalance : 0);
        }

        function renderDashboard() {
            // Calculate Stats
            const totalIncome = state.data.income.reduce((sum, i) => sum + Number(i.amount || 0), 0);
            const totalExpenses = state.data.expenses.reduce((sum, i) => sum + Number(i.amount || 0), 0);
            const netBalance = totalIncome - totalExpenses;
            const totalSavings = calculateTotalSavings();

            const totalReceivables = state.data.receivables.reduce((sum, i) => sum + Number(i.amount || 0), 0);
            const totalPayables = state.data.payables.reduce((sum, i) => sum + Number(i.amount || 0), 0);

            document.getElementById('dash-income').textContent = formatCurrency(totalIncome);
            document.getElementById('dash-expenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('dash-balance').textContent = formatCurrency(netBalance);
            document.getElementById('dash-savings').textContent = formatCurrency(totalSavings);
            document.getElementById('dash-receivables-total').textContent = formatCurrency(totalReceivables);
            document.getElementById('dash-payables-total').textContent = formatCurrency(totalPayables);

            // Render Quick Insights
            renderQuickInsights(totalIncome, totalExpenses);

            // Render Charts
            renderCharts();

            // Render Dashboard Lists (Top 5)
            const renderSmallList = (items, containerId, type) => {
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                const list = items.slice(0, 5); // Show top 5
                
                if (list.length === 0) {
                    container.innerHTML = '<div style="color:#cbd5e0; font-style:italic;">No items</div>';
                    return;
                }

                list.forEach((item, idx) => {
                    const row = document.createElement('div');
                    row.style.cssText = "display:flex; justify-content:space-between; padding:0.5rem 0; border-bottom:1px solid #f7fafc;";
                    const title = type === 'receivable' ? (item.from || 'Unknown') : (item.to || 'Unknown');
                    row.innerHTML = `
                        <span>${title} <small style="color:#a0aec0">(${item.dueDate || '-'})</small></span>
                        <strong style="color: ${type === 'receivable' ? 'var(--success)' : 'var(--danger)'}">${formatCurrency(item.amount)}</strong>
                    `;
                    container.appendChild(row);
                });
            };

            renderSmallList(state.data.receivables, 'dash-receivables-list', 'receivable');
            renderSmallList(state.data.payables, 'dash-payables-list', 'payable');
        }

        function renderQuickInsights(totalIncome, totalExpenses) {
            // Calculate average monthly expense
            const monthlyData = getMonthlyData();
            const avgMonthlyExpense = monthlyData.expenses.length > 0 
                ? monthlyData.expenses.reduce((a, b) => a + b, 0) / monthlyData.expenses.length 
                : 0;
            const expenseEl = document.getElementById('avg-monthly-expense');
            if (expenseEl) expenseEl.textContent = formatCurrency(avgMonthlyExpense);

            // Calculate average monthly income
            const avgMonthlyIncome = monthlyData.income.length > 0 
                ? monthlyData.income.reduce((a, b) => a + b, 0) / monthlyData.income.length 
                : 0;
            const incomeEl = document.getElementById('avg-monthly-income');
            if (incomeEl) incomeEl.textContent = formatCurrency(avgMonthlyIncome);

            // Top spending category
            const expenseCategories = getCategoryData('expenses');
            const topCategory = expenseCategories.labels.length > 0 ? expenseCategories.labels[0] : '-';
            const topCategoryAmount = expenseCategories.values.length > 0 ? expenseCategories.values[0] : 0;
            const topCatEl = document.getElementById('top-category');
            if (topCatEl) topCatEl.textContent = topCategory;
            const topCatAmountEl = document.getElementById('top-category-amount');
            if (topCatAmountEl) topCatAmountEl.textContent = topCategoryAmount > 0 ? formatCurrency(topCategoryAmount) : '-';

            // Average transaction size
            const totalTransactions = state.data.expenses.length + state.data.income.length;
            const avgTransaction = totalTransactions > 0 
                ? (totalIncome + totalExpenses) / totalTransactions 
                : 0;
            const avgTransEl = document.getElementById('avg-transaction');
            if (avgTransEl) avgTransEl.textContent = formatCurrency(avgTransaction);

            // Average monthly savings
            const avgMonthlySavings = avgMonthlyIncome - avgMonthlyExpense;
            const savingsEl = document.getElementById('avg-monthly-savings');
            if (savingsEl) savingsEl.textContent = formatCurrency(avgMonthlySavings);
            const savingsTrendEl = document.getElementById('savings-trend');
            if (savingsTrendEl) {
                savingsTrendEl.className = 'insight-trend ' + (avgMonthlySavings >= 0 ? 'trend-up' : 'trend-down');
                savingsTrendEl.textContent = avgMonthlySavings >= 0 ? 'Positive monthly savings' : 'Negative monthly savings';
            }

            // Transaction count breakdown
            const transCountEl = document.getElementById('transaction-count');
            if (transCountEl) transCountEl.textContent = totalTransactions;
            const transBreakdownEl = document.getElementById('transaction-breakdown');
            if (transBreakdownEl) {
                transBreakdownEl.textContent = `${state.data.income.length} income, ${state.data.expenses.length} expenses`;
            }

            // Calculate trends (compare last 2 months if available)
            if (monthlyData.expenses.length >= 2) {
                const recent = monthlyData.expenses.slice(-2);
                const expenseChange = recent[1] - recent[0];
                const expenseTrendEl = document.getElementById('expense-trend');
                if (expenseTrendEl) {
                    expenseTrendEl.className = 'insight-trend ' + (expenseChange < 0 ? 'trend-up' : 'trend-down');
                    expenseTrendEl.textContent = expenseChange < 0 
                        ? `‚Üì ${formatCurrency(Math.abs(expenseChange))} vs last month`
                        : `‚Üë ${formatCurrency(expenseChange)} vs last month`;
                }
            }

            if (monthlyData.income.length >= 2) {
                const recent = monthlyData.income.slice(-2);
                const incomeChange = recent[1] - recent[0];
                const incomeTrendEl = document.getElementById('income-trend');
                if (incomeTrendEl) {
                    incomeTrendEl.className = 'insight-trend ' + (incomeChange > 0 ? 'trend-up' : 'trend-down');
                    incomeTrendEl.textContent = incomeChange > 0 
                        ? `‚Üë ${formatCurrency(incomeChange)} vs last month`
                        : `‚Üì ${formatCurrency(Math.abs(incomeChange))} vs last month`;
                }
            }

            // Calculate Financial Health Score
            calculateFinancialHealth(totalIncome, totalExpenses, avgMonthlyIncome, avgMonthlyExpense);
        }

        function calculateFinancialHealth(totalIncome, totalExpenses, avgMonthlyIncome, avgMonthlyExpense) {
            let score = 0;
            const maxScore = 100;

            // Savings rate (0-30 points)
            if (totalIncome > 0) {
                const savingsRate = ((totalIncome - totalExpenses) / totalIncome) * 100;
                const savingsRateEl = document.getElementById('savings-rate');
                if (savingsRateEl) savingsRateEl.textContent = savingsRate.toFixed(1) + '%';
                if (savingsRate >= 20) score += 30;
                else if (savingsRate >= 10) score += 20;
                else if (savingsRate >= 5) score += 15;
                else if (savingsRate >= 0) score += 10;
                else score += 0;
            } else {
                const savingsRateEl = document.getElementById('savings-rate');
                if (savingsRateEl) savingsRateEl.textContent = '0%';
            }

            // Expense ratio (0-25 points)
            if (totalIncome > 0) {
                const expenseRatio = (totalExpenses / totalIncome) * 100;
                const expenseRatioEl = document.getElementById('expense-ratio');
                if (expenseRatioEl) expenseRatioEl.textContent = expenseRatio.toFixed(1) + '%';
                if (expenseRatio <= 70) score += 25;
                else if (expenseRatio <= 80) score += 20;
                else if (expenseRatio <= 90) score += 15;
                else if (expenseRatio <= 100) score += 10;
                else score += 5;
            } else {
                const expenseRatioEl = document.getElementById('expense-ratio');
                if (expenseRatioEl) expenseRatioEl.textContent = '0%';
            }

            // Monthly consistency (0-20 points)
            const monthlyData = getMonthlyData();
            if (monthlyData.income.length >= 3) {
                const incomeVariance = calculateVariance(monthlyData.income.slice(-3));
                if (incomeVariance < 0.1) score += 20;
                else if (incomeVariance < 0.2) score += 15;
                else if (incomeVariance < 0.3) score += 10;
                else score += 5;
            } else {
                score += 10; // Default for insufficient data
            }

            // Growth trend (0-15 points)
            if (monthlyData.income.length >= 2 && monthlyData.expenses.length >= 2) {
                const incomeTrend = monthlyData.income.slice(-2)[1] - monthlyData.income.slice(-2)[0];
                const expenseTrend = monthlyData.expenses.slice(-2)[1] - monthlyData.expenses.slice(-2)[0];
                if (incomeTrend > 0 && expenseTrend <= 0) score += 15;
                else if (incomeTrend > expenseTrend) score += 10;
                else if (incomeTrend === expenseTrend) score += 5;
                else score += 0;
            } else {
                score += 5;
            }

            // Transaction activity (0-10 points)
            const totalTransactions = state.data.expenses.length + state.data.income.length;
            if (totalTransactions >= 20) score += 10;
            else if (totalTransactions >= 10) score += 7;
            else if (totalTransactions >= 5) score += 5;
            else score += 2;

            // Update UI
            const healthScoreEl = document.getElementById('health-score');
            if (healthScoreEl) healthScoreEl.textContent = Math.min(score, maxScore);
            const statusEl = document.getElementById('health-status');
            if (statusEl) {
                if (score >= 80) {
                    statusEl.textContent = 'Excellent - Great financial health!';
                    statusEl.style.color = '#48bb78';
                } else if (score >= 65) {
                    statusEl.textContent = 'Good - On the right track';
                    statusEl.style.color = '#38a169';
                } else if (score >= 50) {
                    statusEl.textContent = 'Fair - Room for improvement';
                    statusEl.style.color = '#d69e2e';
                } else {
                    statusEl.textContent = 'Needs Attention - Review spending habits';
                    statusEl.style.color = '#e53e3e';
                }
            }
        }

        function calculateVariance(values) {
            if (values.length === 0) return 0;
            const mean = values.reduce((a, b) => a + b, 0) / values.length;
            const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;
            return variance / (mean * mean); // Coefficient of variation
        }

        // Chart rendering functions
        let trendChart = null;
        let expenseCategoriesChart = null;
        let incomeCategoriesChart = null;
        let cashFlowChart = null;

        function renderCharts() {
            // Destroy existing charts if they exist
            if (trendChart) trendChart.destroy();
            if (expenseCategoriesChart) expenseCategoriesChart.destroy();
            if (incomeCategoriesChart) incomeCategoriesChart.destroy();
            if (cashFlowChart) cashFlowChart.destroy();

            // Trend Chart (Income vs Expenses by Month)
            const monthlyData = getMonthlyData();
            const trendCtx = document.getElementById('trend-chart');
            if (trendCtx) {
                trendChart = new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: monthlyData.labels,
                        datasets: [
                            {
                                label: 'Income',
                                data: monthlyData.income,
                                borderColor: '#38a169',
                                backgroundColor: 'rgba(56, 161, 105, 0.1)',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Expenses',
                                data: monthlyData.expenses,
                                borderColor: '#e53e3e',
                                backgroundColor: 'rgba(229, 62, 62, 0.1)',
                                tension: 0.4,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '‡ß≥' + value.toLocaleString('en-BD');
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Expense Categories Chart
            const expenseCategories = getCategoryData('expenses');
            const expenseCtx = document.getElementById('expense-categories-chart');
            if (expenseCtx) {
                expenseCategoriesChart = new Chart(expenseCtx, {
                    type: 'doughnut',
                    data: {
                        labels: expenseCategories.labels,
                        datasets: [{
                            data: expenseCategories.values,
                            backgroundColor: [
                                '#e53e3e', '#d97706', '#d69e2e', '#38a169',
                                '#3182ce', '#805ad5', '#e53e3e', '#c53030'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return label + ': ' + formatCurrency(value) + ' (' + percentage + '%)';
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Cash Flow Chart
            const cashFlowData = getMonthlyData();
            const cashFlowValues = cashFlowData.income.map((income, idx) => income - cashFlowData.expenses[idx]);
            const cashFlowCtx = document.getElementById('cashflow-chart');
            if (cashFlowCtx) {
                cashFlowChart = new Chart(cashFlowCtx, {
                    type: 'bar',
                    data: {
                        labels: cashFlowData.labels,
                        datasets: [{
                            label: 'Net Cash Flow',
                            data: cashFlowValues,
                            backgroundColor: cashFlowValues.map(val => val >= 0 ? 'rgba(56, 161, 105, 0.6)' : 'rgba(229, 62, 62, 0.6)'),
                            borderColor: cashFlowValues.map(val => val >= 0 ? '#38a169' : '#e53e3e'),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'Cash Flow: ' + formatCurrency(context.parsed.y);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    callback: function(value) {
                                        return '‡ß≥' + value.toLocaleString('en-BD');
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Income Categories Chart
            const incomeCategories = getCategoryData('income');
            const incomeCtx = document.getElementById('income-categories-chart');
            if (incomeCtx) {
                incomeCategoriesChart = new Chart(incomeCtx, {
                    type: 'doughnut',
                    data: {
                        labels: incomeCategories.labels,
                        datasets: [{
                            data: incomeCategories.values,
                            backgroundColor: [
                                '#38a169', '#3182ce', '#805ad5', '#d69e2e',
                                '#e53e3e', '#48bb78', '#4299e1', '#9f7aea'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return label + ': ' + formatCurrency(value) + ' (' + percentage + '%)';
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        function getMonthlyData() {
            const incomeByMonth = {};
            const expensesByMonth = {};

            state.data.income.forEach(item => {
                if (item.date) {
                    const month = item.date.substring(0, 7); // YYYY-MM
                    incomeByMonth[month] = (incomeByMonth[month] || 0) + Number(item.amount || 0);
                }
            });

            state.data.expenses.forEach(item => {
                if (item.date) {
                    const month = item.date.substring(0, 7); // YYYY-MM
                    expensesByMonth[month] = (expensesByMonth[month] || 0) + Number(item.amount || 0);
                }
            });

            const allMonths = [...new Set([...Object.keys(incomeByMonth), ...Object.keys(expensesByMonth)])].sort();
            
            return {
                labels: allMonths,
                income: allMonths.map(m => incomeByMonth[m] || 0),
                expenses: allMonths.map(m => expensesByMonth[m] || 0)
            };
        }

        function getCategoryData(type) {
            const data = type === 'expenses' ? state.data.expenses : state.data.income;
            const categoryMap = {};

            data.forEach(item => {
                const category = item.category || 'Other';
                categoryMap[category] = (categoryMap[category] || 0) + Number(item.amount || 0);
            });

            const sorted = Object.entries(categoryMap).sort((a, b) => b[1] - a[1]);
            
            return {
                labels: sorted.map(([cat]) => cat),
                values: sorted.map(([, val]) => val)
            };
        }

        // Filter state
        let currentListType = null;
        let filteredData = null;

        function renderListTable(type) {
            currentListType = type;
            const titleEl = document.getElementById('list-title');
            const thead = document.getElementById('list-thead');
            const tbody = document.getElementById('list-tbody');
            const data = state.data[type] || [];
            filteredData = [...data]; // Copy for filtering

            thead.innerHTML = '';
            tbody.innerHTML = '';

            let headers = [];

            if (type === 'income') {
                titleEl.textContent = 'Income Sources';
                headers = ['Date', 'Source', 'Category', 'Amount', 'Actions'];
            } else if (type === 'expenses') {
                titleEl.textContent = 'Expenses';
                headers = ['Date', 'Description', 'Category', 'Amount', 'Actions'];
            } else if (type === 'receivables') {
                titleEl.textContent = 'Receivables (Due)';
                headers = ['Due Date', 'From', 'Description', 'Amount', 'Actions'];
            } else if (type === 'payables') {
                titleEl.textContent = 'Payables';
                headers = ['Due Date', 'To', 'Description', 'Amount', 'Actions'];
            }

            // Populate category filter
            populateCategoryFilter(type, data);

            // Render Headers
            const trHead = document.createElement('tr');
            headers.forEach(h => {
                const th = document.createElement('th');
                th.textContent = h;
                trHead.appendChild(th);
            });
            thead.appendChild(trHead);

            // Render rows
            renderTableRows(type, filteredData, tbody, headers.length);
            
            // Update item count
            const countEl = document.getElementById('list-count');
            if (countEl) {
                const totalCount = data.length;
                const filteredCount = filteredData.length;
                if (filteredCount === totalCount) {
                    countEl.textContent = `${totalCount} item${totalCount !== 1 ? 's' : ''}`;
                } else {
                    countEl.textContent = `Showing ${filteredCount} of ${totalCount} item${totalCount !== 1 ? 's' : ''}`;
                }
            }
        }

        function populateCategoryFilter(type, data) {
            const categoryFilter = document.getElementById('category-filter');
            if (!categoryFilter) return;

            const categories = [...new Set(data.map(item => item.category || 'Other').filter(Boolean))].sort();
            categoryFilter.innerHTML = '<option value="">All Categories</option>' + 
                categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }

        function renderTableRows(type, data, tbody, colspan) {
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${colspan}" class="text-center" style="padding: 2rem; color: var(--text-light);">No data found.</td></tr>`;
                return;
            }

            data.forEach((item, index) => {
                const originalIndex = state.data[type].indexOf(item);
                const tr = document.createElement('tr');
                let cols = '';

                if (type === 'income') {
                    cols = `
                        <td>${item.date || '-'}</td>
                        <td>
                            ${item.source || '-'}
                            ${item.recurring ? '<span class="recurring-badge">üîÑ Recurring</span>' : ''}
                            ${item.notes ? `<div class="transaction-note">${item.notes}</div>` : ''}
                        </td>
                        <td><span class="tag tag-success">${item.category || 'Other'}</span></td>
                        <td>${formatCurrency(item.amount)}</td>
                    `;
                } else if (type === 'expenses') {
                    cols = `
                        <td>${item.date || '-'}</td>
                        <td>
                            ${item.description || '-'}
                            ${item.recurring ? '<span class="recurring-badge">üîÑ Recurring</span>' : ''}
                            ${item.notes ? `<div class="transaction-note">${item.notes}</div>` : ''}
                        </td>
                        <td><span class="tag tag-danger">${item.category || 'Other'}</span></td>
                        <td>${formatCurrency(item.amount)}</td>
                    `;
                } else if (type === 'receivables') {
                    cols = `
                        <td>${item.dueDate || '-'}</td>
                        <td>${item.from || '-'}</td>
                        <td>${item.description || '-'}</td>
                        <td style="color:var(--success); font-weight:bold;">${formatCurrency(item.amount)}</td>
                    `;
                } else if (type === 'payables') {
                    cols = `
                        <td>${item.dueDate || '-'}</td>
                        <td>${item.to || '-'}</td>
                        <td>${item.description || '-'}</td>
                        <td style="color:var(--danger); font-weight:bold;">${formatCurrency(item.amount)}</td>
                    `;
                }

                const actionButtons = type === 'income' || type === 'expenses' 
                    ? `<button class="btn-icon" onclick="duplicateTransaction('${type}', ${originalIndex})" title="Duplicate">üìã</button>`
                    : '';
                
                tr.innerHTML = cols + `
                    <td>
                        <div class="action-buttons">
                            ${actionButtons}
                            <button class="btn-edit" onclick="editItem('${type}', ${originalIndex})">‚úèÔ∏è Edit</button>
                            <button class="btn-delete" onclick="deleteItem('${type}', ${originalIndex})">üóëÔ∏è Delete</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function applyFilters() {
            if (!currentListType) return;

            const searchTerm = (document.getElementById('search-input')?.value || '').toLowerCase();
            const categoryFilter = document.getElementById('category-filter')?.value || '';
            const dateFrom = document.getElementById('date-from-filter')?.value || '';
            const dateTo = document.getElementById('date-to-filter')?.value || '';
            const recurringFilter = document.getElementById('recurring-filter')?.value || '';
            const sortBy = document.getElementById('sort-by')?.value || '';

            const data = state.data[currentListType] || [];
            filteredData = data.filter(item => {
                // Search filter
                if (searchTerm) {
                    const searchableText = Object.values(item).join(' ').toLowerCase();
                    if (!searchableText.includes(searchTerm)) return false;
                }

                // Category filter
                if (categoryFilter && item.category !== categoryFilter) return false;

                // Date filter
                const dateField = currentListType === 'receivables' || currentListType === 'payables' ? 'dueDate' : 'date';
                const itemDate = item[dateField] || '';
                
                if (dateFrom && itemDate < dateFrom) return false;
                if (dateTo && itemDate > dateTo) return false;

                // Recurring filter
                if (recurringFilter) {
                    const isRecurring = item.recurring === true || item.recurring === 'true';
                    if (recurringFilter === 'recurring' && !isRecurring) return false;
                    if (recurringFilter === 'non-recurring' && isRecurring) return false;
                }

                return true;
            });

            // Apply sorting
            if (sortBy) {
                const dateField = currentListType === 'receivables' || currentListType === 'payables' ? 'dueDate' : 'date';
                
                filteredData.sort((a, b) => {
                    if (sortBy === 'date-asc' || sortBy === 'date-desc') {
                        const dateA = a[dateField] || '';
                        const dateB = b[dateField] || '';
                        return sortBy === 'date-asc' ? dateA.localeCompare(dateB) : dateB.localeCompare(dateA);
                    } else if (sortBy === 'amount-asc' || sortBy === 'amount-desc') {
                        const amountA = Number(a.amount || 0);
                        const amountB = Number(b.amount || 0);
                        return sortBy === 'amount-asc' ? amountA - amountB : amountB - amountA;
                    }
                    return 0;
                });
            }

            const tbody = document.getElementById('list-tbody');
            const headers = document.querySelectorAll('#list-thead th').length;
            renderTableRows(currentListType, filteredData, tbody, headers);
            
            // Update item count
            const countEl = document.getElementById('list-count');
            if (countEl) {
                const totalCount = state.data[currentListType]?.length || 0;
                const filteredCount = filteredData.length;
                if (filteredCount === totalCount) {
                    countEl.textContent = `${totalCount} item${totalCount !== 1 ? 's' : ''}`;
                } else {
                    countEl.textContent = `Showing ${filteredCount} of ${totalCount} item${totalCount !== 1 ? 's' : ''}`;
                }
            }
        }

        function clearFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('category-filter').value = '';
            document.getElementById('date-from-filter').value = '';
            document.getElementById('date-to-filter').value = '';
            document.getElementById('recurring-filter').value = '';
            document.getElementById('sort-by').value = '';
            applyFilters();
        }

        function renderPlansList() {
            const container = document.getElementById('plans-container');
            container.innerHTML = '';
            const data = state.data.plans || [];

            if (data.length === 0) {
                container.innerHTML = '<div class="text-center" style="padding: 2rem; color: var(--text-light);">No future plans found.</div>';
                return;
            }

            const totalSavings = calculateTotalSavings();

            data.forEach((plan, index) => {
                const target = Number(plan.targetAmount || 1);
                const percent = Math.min(100, Math.round((totalSavings / target) * 100));

                const div = document.createElement('div');
                div.className = 'plan-item';
                div.innerHTML = `
                    <div class="plan-header">
                        <h3 style="font-size: 1.1rem;">${plan.title || 'Untitled'}</h3>
                        <div class="action-buttons">
                            <button class="btn-edit" onclick="editItem('plans', ${index})">‚úèÔ∏è Edit</button>
                            <button class="btn-delete" onclick="deleteItem('plans', ${index})">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                    <div style="font-size: 0.875rem; color: var(--text-light); margin-bottom: 0.5rem;">
                        Target: ${formatCurrency(target)} by ${plan.deadline || 'No Date'}
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill" style="width: ${percent}%"></div>
                    </div>
                    <div class="plan-meta">
                        <span>Total Savings: ${formatCurrency(totalSavings)}</span>
                        <span style="font-weight: bold; color: var(--purple);">${percent}%</span>
                    </div>
                    <div style="font-size: 0.75rem; color: var(--text-light); margin-top: 0.5rem;">
                        Remaining: ${formatCurrency(Math.max(0, target - totalSavings))}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Budget rendering
        function renderBudgetsList() {
            const container = document.getElementById('budgets-container');
            if (!container) return;
            
            container.innerHTML = '';
            const budgets = state.data.budgets || [];

            if (budgets.length === 0) {
                container.innerHTML = '<div class="text-center" style="padding: 2rem; color: var(--text-light);">No budgets set. Add a budget to track spending limits.</div>';
                return;
            }

            budgets.forEach((budget, index) => {
                const category = budget.category || 'Uncategorized';
                const budgetAmount = Number(budget.amount || 0);
                
                // Calculate actual spending for this category
                const actualSpending = state.data.expenses
                    .filter(exp => exp.category === category)
                    .reduce((sum, exp) => sum + Number(exp.amount || 0), 0);
                
                const percent = budgetAmount > 0 ? Math.min(100, Math.round((actualSpending / budgetAmount) * 100)) : 0;
                const remaining = Math.max(0, budgetAmount - actualSpending);
                const isOverBudget = actualSpending > budgetAmount;

                const div = document.createElement('div');
                div.className = 'budget-item';
                div.style.borderLeftColor = isOverBudget ? 'var(--danger)' : 'var(--primary)';
                div.innerHTML = `
                    <div class="budget-header">
                        <div class="budget-category">${category}</div>
                        <div class="action-buttons">
                            <button class="btn-edit" onclick="editItem('budgets', ${index})">‚úèÔ∏è Edit</button>
                            <button class="btn-delete" onclick="deleteItem('budgets', ${index})">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-light);">Budget</div>
                            <div class="budget-amount">${formatCurrency(budgetAmount)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-light);">Spent</div>
                            <div class="budget-amount budget-spent">${formatCurrency(actualSpending)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-light);">Remaining</div>
                            <div class="budget-amount budget-remaining">${formatCurrency(remaining)}</div>
                        </div>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill" style="width: ${percent}%; background: ${isOverBudget ? 'var(--danger)' : 'var(--primary)'}"></div>
                    </div>
                    <div style="font-size: 0.75rem; color: ${isOverBudget ? 'var(--danger)' : 'var(--text-light)'}; margin-top: 0.5rem;">
                        ${isOverBudget ? `‚ö†Ô∏è Over budget by ${formatCurrency(actualSpending - budgetAmount)}` : `${percent}% used`}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Reports rendering
        function renderReports() {
            const container = document.getElementById('reports-container');
            if (!container) return;

            const period = document.getElementById('report-period')?.value || 'month';
            const customRange = document.getElementById('custom-date-range');
            
            if (period === 'custom') {
                if (customRange) customRange.style.display = 'flex';
            } else {
                if (customRange) customRange.style.display = 'none';
            }

            const now = new Date();
            let startDate = '', endDate = '';

            if (period === 'month') {
                startDate = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
                endDate = now.toISOString().split('T')[0];
            } else if (period === 'lastmonth') {
                startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1).toISOString().split('T')[0];
                endDate = new Date(now.getFullYear(), now.getMonth(), 0).toISOString().split('T')[0];
            } else if (period === 'quarter') {
                const quarter = Math.floor(now.getMonth() / 3);
                startDate = new Date(now.getFullYear(), quarter * 3, 1).toISOString().split('T')[0];
                endDate = now.toISOString().split('T')[0];
            } else if (period === 'year') {
                startDate = new Date(now.getFullYear(), 0, 1).toISOString().split('T')[0];
                endDate = now.toISOString().split('T')[0];
            } else if (period === 'lastyear') {
                startDate = new Date(now.getFullYear() - 1, 0, 1).toISOString().split('T')[0];
                endDate = new Date(now.getFullYear() - 1, 11, 31).toISOString().split('T')[0];
            } else if (period === 'custom') {
                startDate = document.getElementById('custom-from')?.value || '';
                endDate = document.getElementById('custom-to')?.value || '';
            }

            const filterByDate = (items, dateField) => {
                if (!startDate) return items;
                return items.filter(item => {
                    const itemDate = item[dateField] || '';
                    return itemDate >= startDate && itemDate <= endDate;
                });
            };

            const periodIncome = filterByDate(state.data.income, 'date');
            const periodExpenses = filterByDate(state.data.expenses, 'date');
            const periodReceivables = filterByDate(state.data.receivables, 'dueDate');
            const periodPayables = filterByDate(state.data.payables, 'dueDate');

            const totalIncome = periodIncome.reduce((sum, i) => sum + Number(i.amount || 0), 0);
            const totalExpenses = periodExpenses.reduce((sum, i) => sum + Number(i.amount || 0), 0);
            const netBalance = totalIncome - totalExpenses;
            const totalReceivables = periodReceivables.reduce((sum, i) => sum + Number(i.amount || 0), 0);
            const totalPayables = periodPayables.reduce((sum, i) => sum + Number(i.amount || 0), 0);

            container.innerHTML = `
                <div class="report-section">
                    <div class="report-title">Summary</div>
                    <div class="report-grid">
                        <div class="stat-card" style="border-color: var(--success);">
                            <div class="stat-label">Total Income</div>
                            <div class="stat-value">${formatCurrency(totalIncome)}</div>
                        </div>
                        <div class="stat-card" style="border-color: var(--danger);">
                            <div class="stat-label">Total Expenses</div>
                            <div class="stat-value">${formatCurrency(totalExpenses)}</div>
                        </div>
                        <div class="stat-card" style="border-color: var(--primary);">
                            <div class="stat-label">Net Balance</div>
                            <div class="stat-value">${formatCurrency(netBalance)}</div>
                        </div>
                        <div class="stat-card" style="border-color: var(--warning);">
                            <div class="stat-label">Due Receivables</div>
                            <div class="stat-value">${formatCurrency(totalReceivables)}</div>
                        </div>
                        <div class="stat-card" style="border-color: #c53030;">
                            <div class="stat-label">Due Payables</div>
                            <div class="stat-value">${formatCurrency(totalPayables)}</div>
                        </div>
                    </div>
                </div>
                <div class="report-section">
                    <div class="report-title">Top Expense Categories</div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Amount</th>
                                    <th>Transactions</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${getCategoryBreakdown(periodExpenses).map(cat => `
                                    <tr>
                                        <td><span class="tag tag-danger">${cat.name}</span></td>
                                        <td>${formatCurrency(cat.amount)}</td>
                                        <td>${cat.count}</td>
                                        <td>${cat.percentage}%</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="report-section">
                    <div class="report-title">Top Income Categories</div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Amount</th>
                                    <th>Transactions</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${getCategoryBreakdown(periodIncome).map(cat => `
                                    <tr>
                                        <td><span class="tag tag-success">${cat.name}</span></td>
                                        <td>${formatCurrency(cat.amount)}</td>
                                        <td>${cat.count}</td>
                                        <td>${cat.percentage}%</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function getCategoryBreakdown(items) {
            const categoryMap = {};
            items.forEach(item => {
                const cat = item.category || 'Other';
                if (!categoryMap[cat]) {
                    categoryMap[cat] = { amount: 0, count: 0 };
                }
                categoryMap[cat].amount += Number(item.amount || 0);
                categoryMap[cat].count++;
            });

            const total = items.reduce((sum, item) => sum + Number(item.amount || 0), 0);
            return Object.entries(categoryMap)
                .map(([name, data]) => ({
                    name,
                    amount: data.amount,
                    count: data.count,
                    percentage: total > 0 ? ((data.amount / total) * 100).toFixed(1) : 0
                }))
                .sort((a, b) => b.amount - a.amount)
                .slice(0, 10);
        }

        function printReport() {
            window.print();
        }

        function exportReportToPDF() {
            // Simple PDF export using window.print with PDF option
            // For better PDF generation, you could use libraries like jsPDF
            alert('To export as PDF, use the Print button and select "Save as PDF" from your printer options.');
            window.print();
        }

        // Analytics rendering
        // Category Management
        function getCategoriesByType(type) {
            // Get all unique categories from data if categories sheet is empty
            if (!state.data.categories || state.data.categories.length === 0) {
                const dataArray = type === 'income' ? state.data.income : state.data.expenses;
                const uniqueCategories = [...new Set(dataArray.map(item => item.category).filter(Boolean))];
                return uniqueCategories.map(cat => ({ name: cat, type: type }));
            }
            return state.data.categories.filter(cat => cat.type === type);
        }

        function renderCategoriesList() {
            const incomeContainer = document.getElementById('income-categories-list');
            const expenseContainer = document.getElementById('expense-categories-list');
            
            if (!incomeContainer || !expenseContainer) return;

            const incomeCategories = getCategoriesByType('income');
            const expenseCategories = getCategoriesByType('expense');

            // Render Income Categories
            if (incomeCategories.length === 0) {
                incomeContainer.innerHTML = '<div style="color: var(--text-light); font-style: italic; padding: 1rem;">No income categories. Add one to get started.</div>';
            } else {
                incomeContainer.innerHTML = incomeCategories.map((cat, index) => {
                    const catIndex = state.data.categories.findIndex(c => c.name === cat.name && c.type === 'income');
                    const usageCount = state.data.income.filter(i => i.category === cat.name).length;
                    return `
                        <div class="category-item">
                            <div>
                                <span class="category-name">${cat.name || 'Unnamed'}</span>
                                <span class="category-badge badge-income">Income</span>
                                <small style="color: var(--text-light); margin-left: 0.5rem;">(${usageCount} transactions)</small>
                            </div>
                            <div class="category-actions">
                                <button class="btn-edit" onclick="editItem('categories', ${catIndex >= 0 ? catIndex : index})">‚úèÔ∏è Edit</button>
                                <button class="btn-delete" onclick="deleteCategory('income', '${cat.name}', ${usageCount})">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Render Expense Categories
            if (expenseCategories.length === 0) {
                expenseContainer.innerHTML = '<div style="color: var(--text-light); font-style: italic; padding: 1rem;">No expense categories. Add one to get started.</div>';
            } else {
                expenseContainer.innerHTML = expenseCategories.map((cat, index) => {
                    const catIndex = state.data.categories.findIndex(c => c.name === cat.name && c.type === 'expense');
                    const usageCount = state.data.expenses.filter(e => e.category === cat.name).length;
                    return `
                        <div class="category-item">
                            <div>
                                <span class="category-name">${cat.name || 'Unnamed'}</span>
                                <span class="category-badge badge-expense">Expense</span>
                                <small style="color: var(--text-light); margin-left: 0.5rem;">(${usageCount} transactions)</small>
                            </div>
                            <div class="category-actions">
                                <button class="btn-edit" onclick="editItem('categories', ${catIndex >= 0 ? catIndex : index})">‚úèÔ∏è Edit</button>
                                <button class="btn-delete" onclick="deleteCategory('expense', '${cat.name}', ${usageCount})">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function deleteCategory(type, name, usageCount) {
            if (usageCount > 0) {
                if (!confirm(`This category is used in ${usageCount} transaction(s). Deleting it will set those transactions to "Other". Continue?`)) {
                    return;
                }
                // Update transactions to use "Other" category
                if (type === 'income') {
                    state.data.income.forEach(item => {
                        if (item.category === name) item.category = 'Other';
                    });
                } else {
                    state.data.expenses.forEach(item => {
                        if (item.category === name) item.category = 'Other';
                    });
                }
            }
            
            const index = state.data.categories.findIndex(c => c.name === name && c.type === type);
            if (index >= 0) {
                state.data.categories.splice(index, 1);
            }
            
            writeExcelFile().then(() => {
                renderAll();
            });
        }

        function renderAnalytics() {
            const container = document.getElementById('analytics-container');
            if (!container) return;

            const monthlyData = getMonthlyData();
            const expenseCategories = getCategoryData('expenses');
            const incomeCategories = getCategoryData('income');

            // Calculate trends
            const recentMonths = 3;
            const recentExpenses = monthlyData.expenses.slice(-recentMonths);
            const recentIncome = monthlyData.income.slice(-recentMonths);
            const avgRecentExpense = recentExpenses.length > 0 
                ? recentExpenses.reduce((a, b) => a + b, 0) / recentExpenses.length 
                : 0;
            const avgRecentIncome = recentIncome.length > 0 
                ? recentIncome.reduce((a, b) => a + b, 0) / recentIncome.length 
                : 0;

            container.innerHTML = `
                <div class="analytics-grid">
                    <div class="insight-card">
                        <div class="insight-title">Average Monthly Spending</div>
                        <div class="insight-value">${formatCurrency(avgRecentExpense)}</div>
                        <div class="insight-trend">Last ${recentMonths} months average</div>
                    </div>
                    <div class="insight-card">
                        <div class="insight-title">Average Monthly Income</div>
                        <div class="insight-value">${formatCurrency(avgRecentIncome)}</div>
                        <div class="insight-trend">Last ${recentMonths} months average</div>
                    </div>
                    <div class="insight-card">
                        <div class="insight-title">Savings Rate</div>
                        <div class="insight-value">${avgRecentIncome > 0 ? ((avgRecentIncome - avgRecentExpense) / avgRecentIncome * 100).toFixed(1) : 0}%</div>
                        <div class="insight-trend">Income vs Expenses</div>
                    </div>
                    <div class="insight-card">
                        <div class="insight-title">Total Transactions</div>
                        <div class="insight-value">${state.data.expenses.length + state.data.income.length}</div>
                        <div class="insight-trend">${state.data.expenses.length} expenses, ${state.data.income.length} income</div>
                    </div>
                </div>
                <div class="card" style="margin-bottom: 1.5rem;">
                    <h3>Top Spending Categories</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Total Amount</th>
                                    <th>Percentage</th>
                                    <th>Transactions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${expenseCategories.labels.slice(0, 10).map((label, idx) => {
                                    const amount = expenseCategories.values[idx];
                                    const total = expenseCategories.values.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((amount / total) * 100).toFixed(1) : 0;
                                    const count = state.data.expenses.filter(e => e.category === label).length;
                                    return `
                                        <tr>
                                            <td><span class="tag tag-danger">${label}</span></td>
                                            <td>${formatCurrency(amount)}</td>
                                            <td>${percentage}%</td>
                                            <td>${count}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card">
                    <h3>Top Income Categories</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Total Amount</th>
                                    <th>Percentage</th>
                                    <th>Transactions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${incomeCategories.labels.slice(0, 10).map((label, idx) => {
                                    const amount = incomeCategories.values[idx];
                                    const total = incomeCategories.values.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((amount / total) * 100).toFixed(1) : 0;
                                    const count = state.data.income.filter(i => i.category === label).length;
                                    return `
                                        <tr>
                                            <td><span class="tag tag-success">${label}</span></td>
                                            <td>${formatCurrency(amount)}</td>
                                            <td>${percentage}%</td>
                                            <td>${count}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // --- 4. MODAL & FORM LOGIC ---

        // Edit state
        let editingIndex = null;
        let editingType = null;

        function openModal(mode, type = null, editIndex = null, categoryType = null) {
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            
            editingIndex = editIndex;
            editingType = type;
            if (categoryType) window.lastCategoryType = categoryType;
            
            overlay.classList.add('active');

            if (mode === 'selector') {
                content.innerHTML = `
                    <div class="modal-header">Add New Item</div>
                    <div class="type-grid">
                        <div class="type-card" onclick="openModal('form', 'income')">
                            <span class="type-icon">üí∞</span>
                            <div class="type-label">Income</div>
                        </div>
                        <div class="type-card" onclick="openModal('form', 'expense')">
                            <span class="type-icon">üí∏</span>
                            <div class="type-label">Expense</div>
                        </div>
                        <div class="type-card" onclick="openModal('form', 'receivable')">
                            <span class="type-icon">üì•</span>
                            <div class="type-label">Due (Receivable)</div>
                        </div>
                        <div class="type-card" onclick="openModal('form', 'payable')">
                            <span class="type-icon">üì§</span>
                            <div class="type-label">Payable</div>
                        </div>
                        <div class="type-card" style="grid-column: span 2;" onclick="openModal('form', 'plan')">
                            <span class="type-icon">üéØ</span>
                            <div class="type-label">Future Plan</div>
                        </div>
                        <div class="type-card" style="grid-column: span 2;" onclick="openModal('form', 'budget')">
                            <span class="type-icon">üí∞</span>
                            <div class="type-label">Budget</div>
                        </div>
                        <div class="type-card" style="grid-column: span 2;" onclick="openCategorySelector()">
                            <span class="type-icon">üìÅ</span>
                            <div class="type-label">Category</div>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                `;
            } else if (mode === 'form') {
                const isEditing = editIndex !== null;
                // Map form type back to data type for retrieving item
                const dataTypeMap = {
                    'income': 'income',
                    'expense': 'expenses',
                    'receivable': 'receivables',
                    'payable': 'payables',
                    'plan': 'plans',
                    'budget': 'budgets',
                    'category': 'categories'
                };
                const dataType = dataTypeMap[type] || type;
                const item = isEditing && editIndex !== null ? (state.data[dataType] && state.data[dataType][editIndex]) : null;
                const today = new Date().toISOString().split('T')[0]; // Default date
                
                let formHTML = `<div class="modal-header">${isEditing ? 'Edit' : 'Add'} ${type.charAt(0).toUpperCase() + type.slice(1)}</div>`;

                if (type === 'income') {
                    const incomeCategories = getCategoriesByType('income').map(c => c.name);
                    const uniqueCategories = [...new Set([...incomeCategories, ...state.data.income.map(i => i.category).filter(Boolean)])].sort();
                    const categoryOptions = uniqueCategories.map(cat => `<option${item?.category === cat ? ' selected' : ''}>${cat || 'Other'}</option>`).join('');
                    formHTML += `
                        <div class="form-group">
                            <label class="form-label">Source</label>
                            <input type="text" class="form-input" id="inp-source" placeholder="e.g. Salary, Freelance" value="${item?.source || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <select class="form-select" id="inp-category" style="flex: 1;">
                                    <option value="">Select Category</option>
                                    ${categoryOptions}
                                </select>
                                <button type="button" class="btn-icon" onclick="closeModal(); setTimeout(() => openModal('form', 'category', null, 'income'), 100);" title="Manage Categories">‚öôÔ∏è</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Amount</label>
                            <input type="number" class="form-input" id="inp-amount" placeholder="0" step="0.01" value="${item?.amount || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-input" id="inp-date" value="${item?.date || today}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Notes (Optional)</label>
                            <textarea class="form-input" id="inp-notes" placeholder="Additional notes..." rows="2">${item?.notes || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="inp-recurring" ${item?.recurring ? 'checked' : ''}>
                                <span>Recurring Transaction</span>
                            </label>
                        </div>
                    `;
                } else if (type === 'expense') {
                    const expenseCategories = getCategoriesByType('expense').map(c => c.name);
                    const uniqueCategories = [...new Set([...expenseCategories, ...state.data.expenses.map(e => e.category).filter(Boolean)])].sort();
                    const categoryOptions = uniqueCategories.map(cat => `<option${item?.category === cat ? ' selected' : ''}>${cat || 'Other'}</option>`).join('');
                    formHTML += `
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <input type="text" class="form-input" id="inp-desc" placeholder="e.g. Groceries" value="${item?.description || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <select class="form-select" id="inp-category" style="flex: 1;">
                                    <option value="">Select Category</option>
                                    ${categoryOptions}
                                </select>
                                <button type="button" class="btn-icon" onclick="closeModal(); setTimeout(() => openModal('form', 'category', null, 'expense'), 100);" title="Manage Categories">‚öôÔ∏è</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Amount</label>
                            <input type="number" class="form-input" id="inp-amount" placeholder="0" step="0.01" value="${item?.amount || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-input" id="inp-date" value="${item?.date || today}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Notes (Optional)</label>
                            <textarea class="form-input" id="inp-notes" placeholder="Additional notes..." rows="2">${item?.notes || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="inp-recurring" ${item?.recurring ? 'checked' : ''}>
                                <span>Recurring Transaction</span>
                            </label>
                        </div>
                    `;
                } else if (type === 'receivable') {
                    formHTML += `
                        <div class="form-group">
                            <label class="form-label">From (Client/Person)</label>
                            <input type="text" class="form-input" id="inp-from" placeholder="Name" value="${item?.from || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <input type="text" class="form-input" id="inp-desc" placeholder="Reason" value="${item?.description || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Amount</label>
                            <input type="number" class="form-input" id="inp-amount" placeholder="0" value="${item?.amount || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Due Date</label>
                            <input type="date" class="form-input" id="inp-duedate" value="${item?.dueDate || today}">
                        </div>
                    `;
                } else if (type === 'payable') {
                    formHTML += `
                        <div class="form-group">
                            <label class="form-label">To (Vendor/Person)</label>
                            <input type="text" class="form-input" id="inp-to" placeholder="Name" value="${item?.to || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <input type="text" class="form-input" id="inp-desc" placeholder="Reason" value="${item?.description || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Amount</label>
                            <input type="number" class="form-input" id="inp-amount" placeholder="0" value="${item?.amount || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Due Date</label>
                            <input type="date" class="form-input" id="inp-duedate" value="${item?.dueDate || today}">
                        </div>
                    `;
                } else if (type === 'plan') {
                    formHTML += `
                        <div class="form-group">
                            <label class="form-label">Plan Title</label>
                            <input type="text" class="form-input" id="inp-title" placeholder="e.g. New Laptop" value="${item?.title || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Target Amount</label>
                            <input type="number" class="form-input" id="inp-target" placeholder="0" value="${item?.targetAmount || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Target Deadline</label>
                            <input type="date" class="form-input" id="inp-deadline" value="${item?.deadline || today}">
                        </div>
                        <div style="padding: 1rem; background: #f7fafc; border-radius: 8px; font-size: 0.875rem; color: var(--text-light);">
                            Note: Progress will be calculated based on Total Savings (Income - Expenses + Receivables).
                        </div>
                    `;
                } else if (type === 'category') {
                    const categoryType = editIndex === null && typeof editIndex !== 'number' ? (window.lastCategoryType || 'expense') : (item?.type || 'expense');
                    formHTML += `
                        <div class="form-group">
                            <label class="form-label">Category Name</label>
                            <input type="text" class="form-input" id="inp-name" placeholder="e.g. Groceries, Salary" value="${item?.name || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Type</label>
                            <select class="form-select" id="inp-type" ${item ? 'disabled' : ''}>
                                <option value="income" ${categoryType === 'income' ? 'selected' : ''}>Income</option>
                                <option value="expense" ${categoryType === 'expense' ? 'selected' : ''}>Expense</option>
                            </select>
                            ${item ? '<small style="color: var(--text-light);">Type cannot be changed after creation</small>' : ''}
                        </div>
                    `;
                } else if (type === 'budget') {
                    const categories = [...new Set(state.data.expenses.map(e => e.category).filter(Boolean))].sort();
                    const categoryOptions = categories.map(cat => `<option${item?.category === cat ? ' selected' : ''}>${cat}</option>`).join('');
                    formHTML += `
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <select class="form-select" id="inp-category" ${isEditing ? 'disabled' : ''}>
                                <option value="">Select Category</option>
                                ${categoryOptions}
                            </select>
                            ${isEditing ? '<small style="color: var(--text-light);">Category cannot be changed after creation</small>' : ''}
                        </div>
                        <div class="form-group">
                            <label class="form-label">Budget Amount</label>
                            <input type="number" class="form-input" id="inp-amount" placeholder="0" value="${item?.amount || ''}">
                        </div>
                        <div style="padding: 1rem; background: #f7fafc; border-radius: 8px; font-size: 0.875rem; color: var(--text-light);">
                            Budget tracks actual spending against this limit for the selected category.
                        </div>
                    `;
                }

                formHTML += `
                    <button class="btn btn-primary" onclick="submitForm('${type}')">${isEditing ? 'Update' : 'Save'} Item</button>
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                `;
                
                content.innerHTML = formHTML;
            }
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('active');
            editingIndex = null;
            editingType = null;
        }

        function editItem(type, index) {
            // Map data type to form type
            if (type === 'income') openModal('form', 'income', index);
            else if (type === 'expenses') openModal('form', 'expense', index);
            else if (type === 'receivables') openModal('form', 'receivable', index);
            else if (type === 'payables') openModal('form', 'payable', index);
            else if (type === 'plans') openModal('form', 'plan', index);
            else if (type === 'budgets') openModal('form', 'budget', index);
            else if (type === 'categories') openModal('form', 'category', index);
        }

        function duplicateTransaction(type, index) {
            const data = state.data[type];
            if (data && data[index]) {
                const original = data[index];
                const duplicate = {...original};
                duplicate.date = new Date().toISOString().split('T')[0]; // Set to today
                delete duplicate.id; // Remove any ID if present
                data.push(duplicate);
                writeExcelFile().then(() => {
                    renderAll();
                });
            }
        }

        function openCategorySelector() {
            closeModal();
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            
            overlay.classList.add('active');
            content.innerHTML = `
                <div class="modal-header">Add Category</div>
                <div class="form-group">
                    <label class="form-label">Category Type</label>
                    <select class="form-select" id="cat-type-selector" onchange="updateCategoryForm()">
                        <option value="income">Income</option>
                        <option value="expense">Expense</option>
                    </select>
                </div>
                <div id="category-form-content"></div>
                <button class="btn btn-primary" onclick="submitCategoryFromSelector()">Add Category</button>
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            `;
            updateCategoryForm();
        }

        function updateCategoryForm() {
            const type = document.getElementById('cat-type-selector')?.value || 'expense';
            const formContent = document.getElementById('category-form-content');
            if (formContent) {
                formContent.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Category Name</label>
                        <input type="text" class="form-input" id="cat-name-input" placeholder="e.g. Groceries, Salary" required>
                    </div>
                    <div style="padding: 1rem; background: #f7fafc; border-radius: 8px; font-size: 0.875rem; color: var(--text-light);">
                        This category will be available for ${type} transactions.
                    </div>
                `;
            }
        }

        function submitCategoryFromSelector() {
            const type = document.getElementById('cat-type-selector')?.value || 'expense';
            const name = document.getElementById('cat-name-input')?.value.trim();
            
            if (!name) {
                alert('Category name is required!');
                return;
            }

            const newCategory = { name, type };
            
            // Check if category already exists
            if (!state.data.categories) state.data.categories = [];
            const exists = state.data.categories.find(c => 
                c.name.toLowerCase() === name.toLowerCase() && c.type === type
            );
            
            if (exists) {
                alert('This category already exists!');
                return;
            }

            state.data.categories.push(newCategory);
            writeExcelFile().then(() => {
                closeModal();
                if (window.location.hash === '#categories' || document.querySelector('.nav-tab.active')?.textContent.includes('Categor')) {
                    switchTab('categories');
                } else {
                    renderAll();
                }
            });
        }

        function submitForm(type) {
            let newItem = {};
            
            // Helper to get value
            const val = (id) => document.getElementById(id)?.value || '';
            const num = (id) => Number(document.getElementById(id)?.value) || 0;

            const isEditing = editingIndex !== null;

            if (type === 'income') {
                newItem = {
                    source: val('inp-source'),
                    category: val('inp-category') || 'Other',
                    amount: num('inp-amount'),
                    date: val('inp-date'),
                    notes: val('inp-notes'),
                    recurring: document.getElementById('inp-recurring')?.checked || false
                };
                if (isEditing) {
                    state.data.income[editingIndex] = newItem;
                } else {
                    state.data.income.push(newItem);
                }
            } else if (type === 'expense') {
                newItem = {
                    description: val('inp-desc'),
                    category: val('inp-category') || 'Other',
                    amount: num('inp-amount'),
                    date: val('inp-date'),
                    notes: val('inp-notes'),
                    recurring: document.getElementById('inp-recurring')?.checked || false
                };
                if (isEditing && editingIndex !== null) {
                    state.data.expenses[editingIndex] = newItem;
                } else {
                    state.data.expenses.push(newItem);
                }
            } else if (type === 'receivable') {
                newItem = {
                    from: val('inp-from'),
                    description: val('inp-desc'),
                    amount: num('inp-amount'),
                    dueDate: val('inp-duedate')
                };
                if (isEditing && editingIndex !== null) {
                    state.data.receivables[editingIndex] = newItem;
                } else {
                    state.data.receivables.push(newItem);
                }
            } else if (type === 'payable') {
                newItem = {
                    to: val('inp-to'),
                    description: val('inp-desc'),
                    amount: num('inp-amount'),
                    dueDate: val('inp-duedate')
                };
                if (isEditing && editingIndex !== null) {
                    state.data.payables[editingIndex] = newItem;
                } else {
                    state.data.payables.push(newItem);
                }
            } else if (type === 'plan') {
                newItem = {
                    title: val('inp-title'),
                    targetAmount: num('inp-target'),
                    deadline: val('inp-deadline')
                };
                if (isEditing && editingIndex !== null) {
                    state.data.plans[editingIndex] = newItem;
                } else {
                    state.data.plans.push(newItem);
                }
            } else if (type === 'budget') {
                newItem = {
                    category: val('inp-category'),
                    amount: num('inp-amount')
                };
                if (isEditing && editingIndex !== null) {
                    state.data.budgets[editingIndex] = newItem;
                } else {
                    state.data.budgets.push(newItem);
                }
            } else if (type === 'category') {
                newItem = {
                    name: val('inp-name'),
                    type: val('inp-type')
                };
                if (isEditing && editingIndex !== null) {
                    state.data.categories[editingIndex] = newItem;
                } else {
                    // Check if category already exists
                    const exists = state.data.categories.find(c => c.name === newItem.name && c.type === newItem.type);
                    if (!exists) {
                        state.data.categories.push(newItem);
                    } else {
                        alert('This category already exists!');
                        return;
                    }
                }
            }

            // Save to Excel and UI
            writeExcelFile().then(() => {
                renderAll();
                closeModal();
            });
        }

        function deleteItem(type, index) {
            if (confirm('Are you sure you want to delete this item?')) {
                state.data[type].splice(index, 1);
                writeExcelFile().then(() => {
                    renderAll();
                });
            }
        }

        // --- 6. EXPORT FUNCTIONALITY ---
        function exportData() {
            if (!state.isConnected) {
                alert('Please connect to Excel file first.');
                return;
            }

            const wb = XLSX.utils.book_new();
            const incomeSheet = XLSX.utils.json_to_sheet(state.data.income);
            const expensesSheet = XLSX.utils.json_to_sheet(state.data.expenses);
            const receivablesSheet = XLSX.utils.json_to_sheet(state.data.receivables);
            const payablesSheet = XLSX.utils.json_to_sheet(state.data.payables);
            const plansSheet = XLSX.utils.json_to_sheet(state.data.plans);
            const budgetsSheet = XLSX.utils.json_to_sheet(state.data.budgets || []);
            const categoriesSheet = XLSX.utils.json_to_sheet(state.data.categories || []);

            XLSX.utils.book_append_sheet(wb, incomeSheet, "Income");
            XLSX.utils.book_append_sheet(wb, expensesSheet, "Expenses");
            XLSX.utils.book_append_sheet(wb, receivablesSheet, "Receivables");
            XLSX.utils.book_append_sheet(wb, payablesSheet, "Payables");
            XLSX.utils.book_append_sheet(wb, plansSheet, "Plans");
            XLSX.utils.book_append_sheet(wb, budgetsSheet, "Budgets");
            XLSX.utils.book_append_sheet(wb, categoriesSheet, "Categories");

            const dateStr = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `finance_data_export_${dateStr}.xlsx`);
        }

        // --- 7. INITIALIZATION ---
        // Check if previously connected (optional advanced feature, skipped for simplicity to stick to manual connect for security)
        // Just wait for user to click connect.
    </script>
</body>
</html>

