<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Manager</title>
    <!-- SheetJS for Excel processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --primary: #3182ce;
            --primary-dark: #2c5282;
            --success: #38a169;
            --danger: #e53e3e;
            --warning: #d97706;
            --purple: #805ad5;
            --bg-grad-start: #f5f7fa;
            --bg-grad-end: #e4e8ec;
            --card-bg: #ffffff;
            --text-main: #2d3748;
            --text-light: #718096;
            --border: #e2e8f0;
        }

        [data-theme="dark"] {
            --primary: #4299e1;
            --primary-dark: #2b6cb0;
            --success: #48bb78;
            --danger: #f56565;
            --warning: #ed8936;
            --purple: #9f7aea;
            --bg-grad-start: #1a202c;
            --bg-grad-end: #2d3748;
            --card-bg: #2d3748;
            --text-main: #f7fafc;
            --text-light: #a0aec0;
            --border: #4a5568;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, var(--bg-grad-start) 0%, var(--bg-grad-end) 100%);
            min-height: 100vh;
            color: var(--text-main);
            padding-bottom: 100px;
            /* Space for FAB */
        }

        /* Header */
        header {
            background: var(--card-bg);
            padding: 1rem 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .header-mobile-controls {
            display: none;
        }

        .header-desktop-controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .mobile-menu-dropdown-header {
            position: absolute;
            right: 0;
            top: calc(100% + 0.5rem);
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 200px;
            z-index: 1002;
            display: none;
            padding: 0.5rem;
        }

        .mobile-menu-dropdown-header.show {
            display: block !important;
        }

        #notification-dropdown-mobile {
            z-index: 1002 !important;
        }

        .mobile-menu-item-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            color: var(--text-main);
            font-size: 0.875rem;
        }

        .mobile-menu-item-header:hover {
            background: #f7fafc;
        }

        .logo {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        @media (max-width: 768px) {
            .header-mobile-controls {
                display: flex;
                gap: 0.5rem;
                align-items: center;
            }

            .header-desktop-controls {
                display: none;
            }

            .header-content {
                flex-wrap: wrap;
            }

            .logo {
                flex: 1;
                min-width: 0;
                font-size: 1rem;
            }

            #notification-dropdown {
                min-width: calc(100vw - 2rem);
                max-width: calc(100vw - 2rem);
                right: -1rem;
            }

            .mobile-menu-dropdown-header {
                min-width: calc(100vw - 2rem);
                right: -1rem;
            }
        }

        

        /* Status Bar */
        .status-bar {
            background: #fff;
            border-bottom: 1px solid var(--border);
            padding: 0.5rem;
            text-align: center;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-connected {
            color: var(--success);
            background: #f0fff4;
        }

        .status-disconnected {
            color: var(--danger);
            background: #fff5f5;
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            background: var(--card-bg);
            padding: 0.5rem 1rem;
            border-bottom: 1px solid var(--border);
            max-width: 1200px;
            margin: 0 auto;
        }

        .nav-tab {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            white-space: nowrap;
            color: var(--text-light);
            transition: all 0.2s;
            font-weight: 500;
        }

        .nav-tab:hover {
            background: #edf2f7;
            color: var(--text-main);
        }

        .nav-tab.active {
            background: var(--primary);
            color: white;
        }

        /* Main Content */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem 1rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-left: 5px solid var(--primary);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-top: 0.5rem;
        }

        /* Tables & Cards */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card h2 {
            margin-bottom: 1rem;
            font-size: 1.25rem;
            color: var(--text-main);
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        th {
            text-align: left;
            padding: 1rem;
            background: #f7fafc;
            color: var(--text-light);
            font-size: 0.875rem;
            font-weight: 600;
            border-bottom: 2px solid var(--border);
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid #edf2f7;
            font-size: 0.95rem;
            vertical-align: middle;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover td {
            background: #f7fafc;
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 64px;
            height: 64px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(49, 130, 206, 0.4);
            cursor: pointer;
            font-size: 2rem;
            transition: transform 0.2s, background 0.2s;
            z-index: 100;
            border: none;
        }

        .fab:hover {
            transform: scale(1.1);
            background: var(--primary-dark);
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal {
            background: var(--card-bg);
            width: 90%;
            max-width: 500px;
            border-radius: 16px;
            padding: 2rem;
            transform: translateY(20px);
            transition: transform 0.2s;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-light);
            font-weight: 500;
        }

        .form-input,
        .form-select,
        textarea.form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            transition: border 0.2s;
        }

        textarea.form-input {
            resize: vertical;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            margin-top: 0.5rem;
            transition: background 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: #edf2f7;
            color: var(--text-main);
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .btn-danger {
            background: #fed7d7;
            color: var(--danger);
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            width: auto;
        }

        .btn-danger:hover {
            background: #feb2b2;
        }

        /* Type Selector Grid */
        .type-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .type-card {
            background: #f7fafc;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .type-card:hover {
            border-color: var(--primary);
            background: #ebf8ff;
            transform: translateY(-2px);
        }

        .type-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        .type-label {
            font-weight: 600;
            color: var(--text-main);
        }

        /* Tags */
        .tag {
            padding: 0.25rem 0.75rem;
            border-radius: 99px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }

        .tag-success {
            background: #f0fff4;
            color: var(--success);
        }

        .tag-danger {
            background: #fff5f5;
            color: var(--danger);
        }

        .tag-warning {
            background: #fffaf0;
            color: var(--warning);
        }

        .tag-purple {
            background: #faf5ff;
            color: var(--purple);
        }

        /* Future Plans Progress */
        .plan-item {
            margin-bottom: 1.5rem;
        }

        .plan-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .progress-track {
            width: 100%;
            height: 10px;
            background: #edf2f7;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--purple);
            transition: width 0.5s ease;
        }

        .plan-meta {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-light);
        }

        .hidden {
            display: none !important;
        }

        .text-right {
            text-align: right;
        }

        .text-center {
            text-align: center;
        }

        /* Filter Bar */
        .filter-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex: 1;
            min-width: 200px;
        }

        .filter-input {
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.875rem;
            flex: 1;
        }

        .btn-icon {
            background: transparent;
            border: 1px solid var(--border);
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .btn-icon:hover {
            background: #f7fafc;
            border-color: var(--primary);
        }

        .btn-edit {
            background: #e6f3ff;
            color: var(--primary);
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            margin-right: 0.5rem;
            transition: background 0.2s;
        }

        .btn-edit:hover {
            background: #bee3f8;
        }

        .btn-delete {
            background: #fed7d7;
            color: var(--danger);
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background 0.2s;
        }

        .btn-delete:hover {
            background: #feb2b2;
        }

        /* Charts */
        .chart-container {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            position: relative;
            height: 300px;
            max-width: 100vw;
            min-height: fit-content;
        }

        .chart-container canvas {
            max-height: 280px;
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-main);
        }

        /* Search Box */
        .search-box {
            position: relative;
            flex: 1;
            min-width: 250px;
        }

        .search-box input {
            width: 100%;
            padding: 0.5rem 2.5rem 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.875rem;
        }

        .search-icon {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        /* Analytics & Insights */
        .insight-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            border-left: 4px solid var(--primary);
        }

        .insight-title {
            font-size: 0.875rem;
            color: var(--text-light);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .insight-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--text-main);
        }

        .insight-trend {
            font-size: 0.75rem;
            margin-top: 0.5rem;
            color: var(--text-light);
        }

        .trend-up {
            color: var(--success);
        }

        .trend-down {
            color: var(--danger);
        }

        /* Budget Progress */
        .budget-item {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary);
        }

        .budget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .budget-category {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .budget-amount {
            font-size: 1.25rem;
            font-weight: bold;
        }

        .budget-spent {
            color: var(--danger);
        }

        .budget-remaining {
            color: var(--success);
        }

        /* Report Sections */
        .report-section {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .report-section:last-child {
            border-bottom: none;
        }

        .report-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-main);
        }

        .report-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        /* Analytics Grid */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        /* Category Management */
        .category-item {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .category-item:hover {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
        }

        .category-name {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-main);
        }

        .category-actions {
            display: flex;
            gap: 0.5rem;
        }

        .category-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .badge-income {
            background: #f0fff4;
            color: var(--success);
        }

        .badge-expense {
            background: #fff5f5;
            color: var(--danger);
        }

        /* Bulk Actions */
        .bulk-actions {
            background: #f7fafc;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
            align-items: center;
            gap: 1rem;
        }

        .bulk-actions.active {
            display: flex;
        }

        .checkbox-cell {
            text-align: center;
            width: 40px;
        }

        input[type="checkbox"] {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        /* Transaction Notes */
        .transaction-note {
            font-size: 0.75rem;
            color: var(--text-light);
            font-style: italic;
            margin-top: 0.25rem;
        }

        /* SVG Icons */
        .icon {
            width: 18px;
            height: 18px;
            display: inline-block;
            vertical-align: middle;
            fill: currentColor;
            flex-shrink: 0;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .icon-sm {
            width: 16px;
            height: 16px;
        }

        .icon-lg {
            width: 20px;
            height: 20px;
        }

        .btn .icon {
            margin-right: 0.5rem;
        }

        .btn-icon .icon {
            margin-right: 0;
        }

        .btn-icon.icon-only {
            padding: 0.5rem;
        }

        .btn-icon.icon-only .icon {
            margin: 0;
        }

        /* Table Footer */
        tfoot {
            background: #f7fafc;
            font-weight: 600;
        }

        tfoot td {
            padding: 1rem;
            border-top: 2px solid var(--border);
            border-bottom: none;
            font-size: 0.95rem;
        }

        tfoot tr:last-child td {
            border-bottom: 2px solid var(--border);
        }

        .table-total-label {
            text-align: right;
            color: var(--text-main);
        }

        .table-total-value {
            color: var(--primary);
            font-size: 1.05rem;
        }

        /* Mobile Table Styles */
        .mobile-details {
            display: none;
        }

        .mobile-actions-menu {
            position: relative;
        }

        .mobile-menu-button {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            display: none;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .desktop-only {
            display: inline;
        }

        @media (max-width: 768px) {
            .mobile-menu-button {
                display: flex !important;
            }

            .desktop-only {
                display: none;
            }

            .mobile-actions-menu {
                display: block !important;
            }

            .action-buttons .btn-edit,
            .action-buttons .btn-delete {
                display: none !important;
            }
        }

        .mobile-menu-button:hover {
            background: #f7fafc;
        }

        .mobile-menu-dropdown {
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 100;
            min-width: 150px;
            display: none;
            margin-top: 0.25rem;
        }

        .mobile-menu-dropdown.show {
            display: block;
        }

        .mobile-menu-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 0.875rem;
            transition: background 0.2s;
        }

        .mobile-menu-item:hover {
            background: #f7fafc;
        }

        .mobile-menu-item:first-child {
            border-radius: 8px 8px 0 0;
        }

        .mobile-menu-item:last-child {
            border-radius: 0 0 8px 8px;
        }

        .mobile-menu-item.delete {
            color: var(--danger);
        }

        /* Notification Dropdown */
        #notification-dropdown {
            font-family: inherit;
        }

        #notification-dropdown::-webkit-scrollbar {
            width: 6px;
        }

        #notification-dropdown::-webkit-scrollbar-track {
            background: var(--card-bg);
        }

        #notification-dropdown::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        #notification-dropdown::-webkit-scrollbar-thumb:hover {
            background: var(--text-light);
        }

        #notification-badge {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Language Selector */
        #language-selector {
            cursor: pointer;
            font-size: 0.875rem;
        }

        #language-selector:hover {
            border-color: var(--primary);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .nav-tabs {
                padding: 0.5rem;
            }

            .nav-tab {
                padding: 0.5rem 0.75rem;
                font-size: 0.875rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .card {
                padding: 1rem;
            }

            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            table {
                min-width: 100%;
                font-size: 0.875rem;
            }

            /* Mobile table layout: Details | Amount | Actions */
            /* Structure: mobile-details(1) | checkbox(2) | date(3) | source/desc(4) | category(5) | amount(6) | actions(7) */

            /* Hide checkbox column on mobile */
            table th.select-all-cell,
            table td.checkbox-cell {
                display: none;
            }

            /* Hide individual desktop columns (Date, Source/Description, Category) */
            table th:nth-child(3),
            table th:nth-child(4),
            table th:nth-child(5),
            table td:nth-child(3),
            table td:nth-child(4),
            table td:nth-child(5) {
                display: none;
            }

            /* Show mobile details column (first column) */
            table th.mobile-details,
            table td.mobile-details {
                display: table-cell !important;
            }

            /* Show Amount column */
            table th:nth-child(6),
            table td:nth-child(6) {
                display: table-cell;
            }

            /* Show Actions column */
            table th:nth-child(7),
            table td:nth-child(7) {
                display: table-cell;
                width: 50px;
            }

            /* Adjust column widths */
            table th.mobile-details,
            table td.mobile-details {
                width: auto;
                min-width: 200px;
                max-width: calc(100vw - 200px);
            }

            table th:nth-child(6),
            table td:nth-child(6) {
                width: 100px;
                text-align: right;
                white-space: nowrap;
            }

            /* Mobile footer styling - show only Details and Amount columns */
            tfoot tr td.mobile-total {
                display: table-cell !important;
            }

            tfoot tr td.desktop-total {
                display: none;
            }

            tfoot tr td.table-total-value {
                display: table-cell !important;
            }

            tfoot tr td:last-child {
                display: table-cell !important;
            }

            /* Hide desktop action buttons */
            .action-buttons {
                display: none !important;
            }

            /* Show mobile menu button */
            .mobile-actions-menu {
                display: block;
            }

            th,
            td {
                padding: 0.75rem 0.5rem;
            }

            /* Mobile details styling */
            .mobile-details-content {
                display: flex;
                flex-direction: column;
                gap: 0.25rem;
            }

            .mobile-details-row {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                flex-wrap: wrap;
            }

            .mobile-details-label {
                font-size: 0.75rem;
                color: var(--text-light);
                font-weight: 600;
                min-width: 60px;
            }

            .mobile-details-value {
                flex: 1;
            }

            .filter-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group {
                flex-direction: column;
                min-width: 100%;
            }

            .action-buttons {
                flex-wrap: wrap;
            }

            .btn-edit,
            .btn-delete {
                font-size: 0.75rem;
                padding: 0.4rem 0.75rem;
            }

            .fab {
                width: 56px;
                height: 56px;
                bottom: 1rem;
                right: 1rem;
            }

            .modal {
                width: 95%;
                padding: 1.5rem;
            }

            .type-grid {
                grid-template-columns: 1fr;
            }

            .report-grid {
                grid-template-columns: 1fr;
            }

            .analytics-grid {
                grid-template-columns: 1fr;
            }

            .btn .icon {
                width: 16px;
                height: 16px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 1rem 0.5rem;
            }

            .card {
                padding: 0.75rem;
            }

            table {
                font-size: 0.8rem;
            }

            th,
            td {
                padding: 0.5rem 0.25rem;
            }

            .btn {
                padding: 0.625rem 0.5rem;
                font-size: 0.875rem;
            }

            .btn-icon {
                padding: 0.4rem 0.5rem;
                font-size: 0.75rem;
            }
        }

        /* Recurring Badge */
        .recurring-badge {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            background: #e6fffa;
            color: #047857;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        /* Overdue Badge */
        .overdue-badge {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            background: #fff5f5;
            color: #c53030;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .due-soon-badge {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            background: #fffaf0;
            color: #d69e2e;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        /* Alert Banner */
        .alert-banner {
            background: #fff5f5;
            border-left: 4px solid var(--danger);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .alert-banner.warning {
            background: #fffaf0;
            border-left-color: var(--warning);
        }

        .alert-banner.info {
            background: #ebf8ff;
            border-left-color: var(--primary);
        }

        /* Comparison Card */
        .comparison-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary);
        }

        .comparison-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
        }

        .comparison-row:last-child {
            border-bottom: none;
        }

        .comparison-label {
            font-weight: 500;
            color: var(--text-main);
        }

        .comparison-values {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .comparison-value {
            text-align: right;
            min-width: 100px;
        }

        .comparison-diff {
            font-size: 0.875rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
        }

        .comparison-diff.positive {
            background: #f0fff4;
            color: var(--success);
        }

        .comparison-diff.negative {
            background: #fff5f5;
            color: var(--danger);
        }

        /* Template Badge */
        .template-badge {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            background: #faf5ff;
            color: var(--purple);
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 100px;
            right: 2rem;
            background: var(--card-bg);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            min-width: 300px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s;
        }

        /* Confirmation Modal */
        .confirm-modal {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 0;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .confirm-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .confirm-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .confirm-icon.warning {
            background: #fffaf0;
            color: var(--warning);
        }

        .confirm-icon.danger {
            background: #fff5f5;
            color: var(--danger);
        }

        .confirm-icon.info {
            background: #ebf8ff;
            color: var(--primary);
        }

        .confirm-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-main);
            margin: 0;
        }

        .confirm-body {
            padding: 1.5rem;
            color: var(--text-main);
            line-height: 1.6;
        }

        .confirm-actions {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        /* Settings Panel */
        .settings-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .settings-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border);
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border);
        }

        .settings-row:last-child {
            border-bottom: none;
        }

        .settings-label {
            font-weight: 500;
            color: var(--text-main);
        }

        .settings-description {
            font-size: 0.875rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }

        /* Keyboard Shortcuts Help */
        .shortcut-key {
            display: inline-block;
            background: var(--border);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            font-family: monospace;
            margin: 0 0.25rem;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--danger);
        }

        .toast.warning {
            border-left: 4px solid var(--warning);
        }

        /* Select All Checkbox */
        .select-all-cell {
            text-align: center;
            width: 60px;
        }

        div#monthly-comparison-content {
            display: block;
            overflow: auto;
        }

        button.modal-close {
            position: absolute;
            top: 1px;
            right: 11px;
            border: none;
            background: transparent;
            font-size: 30px;
            color: var(--text-light);
            cursor: pointer;
        }
    </style>
</head>

<body>

    <!-- Header -->
    <header>
        <div class="header-content">
            <div class="logo">
                <span>ðŸ“Š</span> Finance Manager
            </div>
            <!-- Desktop Controls -->
            <div class="header-desktop-controls">
                <!-- Language Selector -->
                <select class="filter-input" id="language-selector" onchange="changeLanguage(this.value)" style="width: auto; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text-main);">
                    <option value="en">ðŸ‡¬ðŸ‡§ English</option>
                    <option value="bn">ðŸ‡§ðŸ‡© à¦¬à¦¾à¦‚à¦²à¦¾</option>
                    <option value="es">ðŸ‡ªðŸ‡¸ EspaÃ±ol</option>
                    <option value="fr">ðŸ‡«ðŸ‡· FranÃ§ais</option>
                    <option value="de">ðŸ‡©ðŸ‡ª Deutsch</option>
                    <option value="hi">ðŸ‡®ðŸ‡³ à¤¹à¤¿à¤‚à¤¦à¥€</option>
                    <option value="ar">ðŸ‡¸ðŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                    <option value="zh">ðŸ‡¨ðŸ‡³ ä¸­æ–‡</option>
                </select>
                
                <!-- Notification Icon -->
                <div style="position: relative;">
                    <button class="btn btn-secondary" style="width: auto; position: relative;" onclick="toggleNotifications()" id="notification-btn" title="Notifications">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                        <span id="notification-badge" style="position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; display: none;">0</span>
                    </button>
                    <div id="notification-dropdown" style="position: absolute; right: 0; top: calc(100% + 0.5rem); background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 300px; max-width: 400px; max-height: 400px; overflow-y: auto; z-index: 1000; display: none;">
                        <div style="padding: 1rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0; font-size: 1rem;" data-translate="notifications">Notifications</h3>
                            <button onclick="clearAllNotifications()" style="background: none; border: none; color: var(--primary); cursor: pointer; font-size: 0.875rem;" data-translate="clear_all">Clear All</button>
                        </div>
                        <div id="notification-list" style="padding: 0.5rem;">
                            <div style="padding: 2rem; text-align: center; color: var(--text-light);" data-translate="no_notifications">No notifications</div>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-secondary" style="width: auto; display: none;" onclick="refreshData()"
                    title="Refresh Data" id="refresh-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" xml:space="preserve" width="16"
                        height="16">
                        <path fill="none" stroke="#000" stroke-miterlimit="10"
                            d="M12.85 5.45A5.47 5.47 0 0 0 8 2.5C5.65 2.5 3.7 3.95 2.9 6m.2 4.5c.9 1.75 2.75 3 4.9 3 2.35 0 4.3-1.45 5.1-3.5" />
                        <path fill="none" stroke="#000" stroke-miterlimit="10" d="M13 2.5v3h-3m-7 8v-3h3" />
                    </svg>
                </button>
                <button class="btn btn-secondary" style="width: auto; display: none;" onclick="exportData()"
                    title="Export Data" id="export-btn">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                </button>
                <button class="btn btn-secondary" style="width: auto; display: none;" onclick="disconnectExcelFile()"
                    title="Disconnect Excel File" id="disconnect-btn">
                    <svg width="16" height="16" viewBox="-0.08 0 1.28 1.28" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M.103 0a.1.1 0 0 0-.101.102v1.077a.1.1 0 0 0 .101.101h.915a.1.1 0 0 0 .101-.101V.406L.742 0z"
                            fill-rule="evenodd" clip-rule="evenodd" fill="#0c8fe8" />
                        <g fill-rule="evenodd" clip-rule="evenodd">
                            <path d="M1.12.407v.02H.864S.738.402.741.293c0 0 .004.114.12.114z" fill="#0973e2" />
                            <path d="M.741 0v.291c0 .033.022.116.122.116h.256z" opacity=".5" fill="#fff" />
                        </g>
                        <path
                            d="M.565.712a.106.106 0 0 0-.151 0L.353.773a.11.11 0 0 0 0 .151.025.025 0 0 0 .035 0 .024.024 0 0 0 0-.035.06.06 0 0 1 0-.082L.45.746a.057.057 0 0 1 .081 0 .06.06 0 0 1 0 .081l-.029.03q.01.03.008.061L.566.862a.106.106 0 0 0 0-.151M.412.83a.025.025 0 0 0 0 .035.057.057 0 0 1 0 .081l-.061.061a.057.057 0 0 1-.081 0 .06.06 0 0 1 0-.081L.299.897A.14.14 0 0 1 .291.835L.235.891a.106.106 0 0 0 0 .151.11.11 0 0 0 .151 0L.448.98a.106.106 0 0 0 0-.151.025.025 0 0 0-.035 0"
                            fill="#fff" />
                    </svg>
                </button>
                <button class="btn btn-secondary" style="width: auto;" id="connect-btn" onclick="connectExcelFile()">
                    <svg width="16" height="16" viewBox="-0.08 0 1.28 1.28" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M.103 0a.1.1 0 0 0-.101.102v1.077a.1.1 0 0 0 .101.101h.915a.1.1 0 0 0 .101-.101V.406L.742 0z"
                            fill-rule="evenodd" clip-rule="evenodd" fill="#0c8fe8" />
                        <g fill-rule="evenodd" clip-rule="evenodd">
                            <path d="M1.12.407v.02H.864S.738.402.741.293c0 0 .004.114.12.114z" fill="#0973e2" />
                            <path d="M.741 0v.291c0 .033.022.116.122.116h.256z" opacity=".5" fill="#fff" />
                        </g>
                        <path
                            d="M.565.712a.106.106 0 0 0-.151 0L.353.773a.11.11 0 0 0 0 .151.025.025 0 0 0 .035 0 .024.024 0 0 0 0-.035.06.06 0 0 1 0-.082L.45.746a.057.057 0 0 1 .081 0 .06.06 0 0 1 0 .081l-.029.03q.01.03.008.061L.566.862a.106.106 0 0 0 0-.151M.412.83a.025.025 0 0 0 0 .035.057.057 0 0 1 0 .081l-.061.061a.057.057 0 0 1-.081 0 .06.06 0 0 1 0-.081L.299.897A.14.14 0 0 1 .291.835L.235.891a.106.106 0 0 0 0 .151.11.11 0 0 0 .151 0L.448.98a.106.106 0 0 0 0-.151.025.025 0 0 0-.035 0"
                            fill="#fff" />
                    </svg>
                </button>
                <button class="btn btn-secondary" style="width: auto;" id="dark-mode-toggle" onclick="toggleDarkMode()"
                    title="Toggle Dark Mode">
                    <svg class="icon" id="dark-mode-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>

            <!-- Mobile Controls -->
            <div class="header-mobile-controls">
                <!-- Language Selector -->
                <select class="filter-input" id="language-selector-mobile" onchange="changeLanguage(this.value)" style="width: auto; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text-main); font-size: 0.875rem;">
                    <option value="en">ðŸ‡¬ðŸ‡§</option>
                    <option value="bn">ðŸ‡§ðŸ‡©</option>
                    <option value="es">ðŸ‡ªðŸ‡¸</option>
                    <option value="fr">ðŸ‡«ðŸ‡·</option>
                    <option value="de">ðŸ‡©ðŸ‡ª</option>
                    <option value="hi">ðŸ‡®ðŸ‡³</option>
                    <option value="ar">ðŸ‡¸ðŸ‡¦</option>
                    <option value="zh">ðŸ‡¨ðŸ‡³</option>
                </select>
                
                <!-- Notification Icon -->
                <div style="position: relative;">
                    <button class="btn btn-secondary" style="width: auto; position: relative; padding: 0.5rem;" onclick="toggleNotificationsMobile(event)" id="notification-btn-mobile" title="Notifications">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 18px; height: 18px;">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                        <span id="notification-badge-mobile" style="position: absolute; top: -3px; right: -3px; background: var(--danger); color: white; border-radius: 50%; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; font-weight: bold; display: none;">0</span>
                    </button>
                    <div id="notification-dropdown-mobile" style="position: absolute; right: 0; top: calc(100% + 0.5rem); background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: calc(100vw - 2rem); max-width: calc(100vw - 2rem); max-height: 400px; overflow-y: auto; z-index: 1002; display: none;">
                        <div style="padding: 1rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0; font-size: 1rem;" data-translate="notifications">Notifications</h3>
                            <button onclick="clearAllNotifications()" style="background: none; border: none; color: var(--primary); cursor: pointer; font-size: 0.875rem;" data-translate="clear_all">Clear All</button>
                        </div>
                        <div id="notification-list-mobile" style="padding: 0.5rem;">
                            <div style="padding: 2rem; text-align: center; color: var(--text-light);" data-translate="no_notifications">No notifications</div>
                        </div>
                    </div>
                </div>

                <!-- 3-Dot Menu -->
                <div style="position: relative;">
                    <button class="btn btn-secondary" style="width: auto; padding: 0.5rem;" onclick="toggleMobileMenu(event)" id="mobile-menu-btn" title="Menu">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 18px; height: 18px;">
                            <circle cx="12" cy="12" r="1"></circle>
                            <circle cx="12" cy="5" r="1"></circle>
                            <circle cx="12" cy="19" r="1"></circle>
                        </svg>
                    </button>
                    <div id="mobile-menu-dropdown" class="mobile-menu-dropdown-header">
                        <button class="mobile-menu-item-header" onclick="refreshData(); closeMobileMenuHeader();">
                            <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="23 4 23 10 17 10"></polyline>
                                <polyline points="1 20 1 14 7 14"></polyline>
                                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                            </svg>
                            <span data-translate="refresh">Refresh</span>
                        </button>
                        <button class="mobile-menu-item-header" onclick="exportData(); closeMobileMenuHeader();">
                            <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            <span data-translate="export">Export</span>
                        </button>
                        <button class="mobile-menu-item-header" onclick="disconnectExcelFile(); closeMobileMenuHeader();">
                            <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                <polyline points="16 17 21 12 16 7"></polyline>
                                <line x1="21" y1="12" x2="9" y2="12"></line>
                            </svg>
                            <span data-translate="disconnect">Disconnect</span>
                        </button>
                        <button class="mobile-menu-item-header" onclick="toggleDarkMode(); closeMobileMenuHeader();">
                            <svg class="icon icon-sm" id="dark-mode-icon-mobile" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="5"></circle>
                                <line x1="12" y1="1" x2="12" y2="3"></line>
                                <line x1="12" y1="21" x2="12" y2="23"></line>
                                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                                <line x1="1" y1="12" x2="3" y2="12"></line>
                                <line x1="21" y1="12" x2="23" y2="12"></line>
                                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                            </svg>
                            <span data-translate="dark_mode">Dark Mode</span>
                        </button>
                        <button class="mobile-menu-item-header" onclick="switchTab('settings'); closeMobileMenuHeader();">
                            <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="3"></circle>
                                <path d="M12 1v6m0 6v6m9-9h-6m-6 0H3m15.364 6.364l-4.243-4.243m-4.242 0L5.636 17.364m12.728 0l-4.243-4.243m-4.242 0L5.636 6.636"></path>
                            </svg>
                            <span data-translate="settings">Settings</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Status Bar -->
    <div id="status-bar" class="status-bar status-disconnected">
        Disconnected from 'finance_data.xlsx'. Please connect to start.
    </div>

    <!-- Navigation -->
    <nav class="nav-tabs">
        <div class="nav-tab active" onclick="switchTab('dashboard')" data-translate="dashboard">Dashboard</div>
        <div class="nav-tab" onclick="switchTab('income')" data-translate="income">Income</div>
        <div class="nav-tab" onclick="switchTab('expenses')" data-translate="expenses">Expenses</div>
        <div class="nav-tab" onclick="switchTab('receivables')" data-translate="receivables">Due (Receivables)</div>
        <div class="nav-tab" onclick="switchTab('payables')" data-translate="payables">Payables</div>
        <div class="nav-tab" onclick="switchTab('plans')" data-translate="plans">Future Plans</div>
        <div class="nav-tab" onclick="switchTab('budgets')" data-translate="budgets">Budgets</div>
        <div class="nav-tab" onclick="switchTab('categories')" data-translate="categories">Categories</div>
        <div class="nav-tab" onclick="switchTab('reports')" data-translate="reports">Reports</div>
        <div class="nav-tab" onclick="switchTab('analytics')" data-translate="analytics">Analytics</div>
        <div class="nav-tab" onclick="switchTab('templates')" data-translate="templates">ðŸ“‹ Templates</div>
        <div class="nav-tab" onclick="switchTab('accounts')" data-translate="accounts">ðŸ’³ Accounts</div>
        <div class="nav-tab" onclick="switchTab('transfers')" data-translate="transfers">ðŸ’¸ Transfers</div>
        <div class="nav-tab" onclick="switchTab('debts')" data-translate="debts">ðŸ’¸ Debts</div>
        <div class="nav-tab" onclick="switchTab('recurring')" data-translate="recurring">ðŸ”„ Recurring</div>
        <div class="nav-tab" onclick="switchTab('calendar')" data-translate="calendar">ðŸ“… Calendar</div>
        <div class="nav-tab" onclick="switchTab('cashflow')" data-translate="cashflow">ðŸ’° Cash Flow</div>
        <div class="nav-tab" onclick="switchTab('investments')" data-translate="investments">ðŸ“ˆ Investments</div>
        <div class="nav-tab" onclick="switchTab('settings')" data-translate="settings">âš™ï¸ Settings</div>
    </nav>

    <!-- Main Content Area -->
    <main class="container">

        <!-- Dashboard View -->
        <div id="view-dashboard">
            <div class="stats-grid">
                <div class="stat-card" style="border-color: var(--success);">
                    <div class="stat-label" data-translate="this_month_income">This Month Income</div>
                    <div class="stat-value" id="dash-current-month-income">à§³0</div>
                </div>
                <div class="stat-card" style="border-color: var(--danger);">
                    <div class="stat-label" data-translate="this_month_expenses">This Month Expenses</div>
                    <div class="stat-value" id="dash-current-month-expenses">à§³0</div>
                </div>
                <div class="stat-card" style="border-color: var(--primary);">
                    <div class="stat-label" data-translate="this_month_balance">This Month Balance</div>
                    <div class="stat-value" id="dash-current-month-balance">à§³0</div>
                </div>
                <div class="stat-card" style="border-color: var(--success);">
                    <div class="stat-label" data-translate="total_income">Total Income</div>
                    <div class="stat-value" id="dash-income">à§³0</div>
                </div>
                <div class="stat-card" style="border-color: var(--danger);">
                    <div class="stat-label" data-translate="total_expenses">Total Expenses</div>
                    <div class="stat-value" id="dash-expenses">à§³0</div>
                </div>
                <div class="stat-card" style="border-color: var(--primary);">
                    <div class="stat-label" data-translate="net_balance">Net Balance</div>
                    <div class="stat-value" id="dash-balance">à§³0</div>
                </div>
                <div class="stat-card" style="border-color: var(--purple);">
                    <div class="stat-label" data-translate="total_savings">Total Savings</div>
                    <div class="stat-value" id="dash-savings">à§³0</div>
                </div>
                <div class="stat-card" style="border-color: var(--warning);">
                    <div class="stat-label" data-translate="due_receivables">Due Receivables</div>
                    <div class="stat-value" id="dash-receivables-total">à§³0</div>
                </div>
                <div class="stat-card" style="border-color: #c53030;">
                    <div class="stat-label" data-translate="due_payables">Due Payables</div>
                    <div class="stat-value" id="dash-payables-total">à§³0</div>
                </div>
            </div>


            <!-- Bill Reminders Widget -->
            <div class="card" style="margin-bottom: 1.5rem;">
                <h2>ðŸ“… <span data-translate="upcoming_bills">Upcoming Bills & Reminders</span></h2>
                <div id="bill-reminders-content" style="margin-top: 1rem;">
                    <div class="text-center" style="padding: 1rem; color: var(--text-light);" data-translate="loading_reminders">Loading reminders...</div>
                </div>
            </div>

            <!-- Alerts Banner -->
            <div id="dashboard-alerts"></div>

            <!-- Monthly Comparison -->
            <div class="card" id="monthly-comparison-card" style="margin-bottom: 2rem;">
                <h2>ðŸ“Š <span data-translate="monthly_comparison">Monthly Comparison</span></h2>
                <div id="monthly-comparison-content"></div>
            </div>

            <!-- Financial Health Score -->
            <div class="card"
                style="margin-bottom: 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <div>
                        <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;" data-translate="financial_health_score">Financial Health Score</div>
                        <div style="font-size: 3rem; font-weight: bold;" id="health-score">-</div>
                        <div style="font-size: 0.875rem; opacity: 0.9; margin-top: 0.5rem;" id="health-status"></div>
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                            <div>
                                <div style="font-size: 0.75rem; opacity: 0.8;" data-translate="savings_rate">Savings Rate</div>
                                <div style="font-size: 1.5rem; font-weight: bold;" id="savings-rate">0%</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; opacity: 0.8;" data-translate="expense_ratio">Expense Ratio</div>
                                <div style="font-size: 1.5rem; font-weight: bold;" id="expense-ratio">0%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Insights -->
            <div class="analytics-grid" style="margin-bottom: 2rem;">
                <div class="insight-card">
                    <div class="insight-title" data-translate="average_monthly_expense">Average Monthly Expense</div>
                    <div class="insight-value" id="avg-monthly-expense">à§³0</div>
                    <div class="insight-trend" id="expense-trend"></div>
                </div>
                <div class="insight-card">
                    <div class="insight-title" data-translate="average_monthly_income">Average Monthly Income</div>
                    <div class="insight-value" id="avg-monthly-income">à§³0</div>
                    <div class="insight-trend" id="income-trend"></div>
                </div>
                <div class="insight-card">
                    <div class="insight-title" data-translate="top_spending_category">Top Spending Category</div>
                    <div class="insight-value" id="top-category" style="font-size: 1.2rem;">-</div>
                    <div class="insight-trend" id="top-category-amount"></div>
                </div>
                <div class="insight-card">
                    <div class="insight-title" data-translate="average_transaction_size">Average Transaction Size</div>
                    <div class="insight-value" id="avg-transaction">à§³0</div>
                    <div class="insight-trend" data-translate="all_transactions">All transactions</div>
                </div>
                <div class="insight-card">
                    <div class="insight-title" data-translate="monthly_savings">Monthly Savings</div>
                    <div class="insight-value" id="avg-monthly-savings">à§³0</div>
                    <div class="insight-trend" id="savings-trend"></div>
                </div>
                <div class="insight-card">
                    <div class="insight-title" data-translate="transaction_count">Transaction Count</div>
                    <div class="insight-value" id="transaction-count">0</div>
                    <div class="insight-trend" id="transaction-breakdown"></div>
                </div>
            </div>

            <!-- Charts Section -->
            <div
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                <div class="chart-container">
                    <div class="chart-title" data-translate="income_vs_expenses_trend">Income vs Expenses Trend</div>
                    <canvas id="trend-chart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title" data-translate="cash_flow">Cash Flow</div>
                    <canvas id="cashflow-chart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title" data-translate="expense_categories">Expense Categories</div>
                    <canvas id="expense-categories-chart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title" data-translate="income_categories">Income Categories</div>
                    <canvas id="income-categories-chart"></canvas>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                <div class="card">
                    <h2>ðŸ“¥ <span data-translate="due_receivables">Due Receivables</span></h2>
                    <div id="dash-receivables-list"></div>
                </div>
                <div class="card">
                    <h2>ðŸ“¤ <span data-translate="due_payables">Due Payables</span></h2>
                    <div id="dash-payables-list"></div>
                </div>
            </div>
        </div>

        <!-- Generic List View (Used for Income, Expenses, Receivables, Payables) -->
        <div id="view-list" class="hidden">
            <div class="card">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                    <div>
                        <h2 id="list-title" style="margin: 0;">Items</h2>
                        <small id="list-count" style="color: var(--text-light); font-size: 0.875rem;"></small>
                    </div>
                    <div class="filter-bar" style="margin: 0;">
                        <div class="search-box">
                            <input type="text" id="search-input" placeholder="" data-translate-placeholder="search" onkeyup="applyFilters()">
                            <span class="search-icon">ðŸ”</span>
                        </div>
                        <select class="filter-input" id="category-filter" onchange="applyFilters()">
                            <option value="">All Categories</option>
                        </select>
                        <input type="date" class="filter-input" id="date-from-filter" onchange="applyFilters()"
                            placeholder="" data-translate-placeholder="from_date">
                        <input type="date" class="filter-input" id="date-to-filter" onchange="applyFilters()"
                            placeholder="" data-translate-placeholder="to_date">
                        <select class="filter-input" id="recurring-filter" onchange="applyFilters()"
                            style="min-width: 120px;">
                            <option value="">All Types</option>
                            <option value="recurring">Recurring Only</option>
                            <option value="non-recurring">Non-Recurring</option>
                        </select>
                        <select class="filter-input" id="sort-by" onchange="applyFilters()" style="min-width: 150px;">
                            <option value="" data-translate="sort_by">Sort by...</option>
                            <option value="date-asc">Date (Oldest First)</option>
                            <option value="date-desc">Date (Newest First)</option>
                            <option value="amount-asc">Amount (Low to High)</option>
                            <option value="amount-desc">Amount (High to Low)</option>
                            <option value="category-asc">Category (A-Z)</option>
                            <option value="category-desc">Category (Z-A)</option>
                            <option value="status-asc">Status (Paid First)</option>
                            <option value="status-desc">Status (Unpaid First)</option>
                            <option value="priority-asc">Priority (Low to High)</option>
                            <option value="priority-desc">Priority (High to Low)</option>
                        </select>
                        <button class="btn-icon" onclick="clearFilters()">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                            Clear Filters
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead id="list-thead"></thead>
                        <tbody id="list-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Plans View -->
        <div id="view-plans" class="hidden">
            <div class="card">
                <h2>Future Plans & Goals</h2>
                <div id="plans-container"></div>
            </div>
        </div>

        <!-- Budgets View -->
        <div id="view-budgets" class="hidden">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2>Budget Tracking</h2>
                    <button class="btn btn-primary" style="width: auto;" onclick="openModal('form', 'budget')">+ Add
                        Budget</button>
                </div>
                <div id="budgets-container"></div>
            </div>
        </div>

        <!-- Reports View -->
        <div id="view-reports" class="hidden">
            <div class="card">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                    <h2>Financial Reports</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn-icon" onclick="printReport()">ðŸ–¨ï¸ Print</button>
                    </div>
                </div>
                <div style="background: #f7fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div
                        style="font-size: 0.875rem; font-weight: 600; color: var(--text-main); margin-bottom: 0.75rem;">
                        Filters</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div>
                            <label
                                style="display: block; font-size: 0.75rem; color: var(--text-light); margin-bottom: 0.25rem;">Report
                                Period</label>
                            <select class="filter-input" id="report-period" onchange="renderReports()"
                                style="width: 100%;">
                                <option value="month">This Month</option>
                                <option value="lastmonth">Last Month</option>
                                <option value="year">This Year</option>
                                <option value="lastyear">Last Year</option>
                                <option value="custom">Custom Range</option>
                                <option value="all">All Time</option>
                            </select>
                        </div>
                        <div id="custom-date-from-container" style="display: none;">
                            <label
                                style="display: block; font-size: 0.75rem; color: var(--text-light); margin-bottom: 0.25rem;">Date
                                From</label>
                            <input type="date" class="filter-input" id="report-date-from" onchange="renderReports()"
                                style="width: 100%;">
                        </div>
                        <div id="custom-date-to-container" style="display: none;">
                            <label
                                style="display: block; font-size: 0.75rem; color: var(--text-light); margin-bottom: 0.25rem;">Date
                                To</label>
                            <input type="date" class="filter-input" id="report-date-to" onchange="renderReports()"
                                style="width: 100%;">
                        </div>
                        <div>
                            <label
                                style="display: block; font-size: 0.75rem; color: var(--text-light); margin-bottom: 0.25rem;">Transaction
                                Type</label>
                            <select class="filter-input" id="report-type" onchange="renderReports()"
                                style="width: 100%;">
                                <option value="all">All Types</option>
                                <option value="income">Income Only</option>
                                <option value="expense">Expense Only</option>
                                <option value="receivable">Receivables Only</option>
                                <option value="payable">Payables Only</option>
                            </select>
                        </div>
                        <div>
                            <label
                                style="display: block; font-size: 0.75rem; color: var(--text-light); margin-bottom: 0.25rem;">Category</label>
                            <select class="filter-input" id="report-category" onchange="renderReports()"
                                style="width: 100%;">
                                <option value="">All Categories</option>
                            </select>
                        </div>
                        <div>
                            <label
                                style="display: block; font-size: 0.75rem; color: var(--text-light); margin-bottom: 0.25rem;">${t('account')}</label>
                            <select class="filter-input" id="report-account" onchange="renderReports()"
                                style="width: 100%;">
                                <option value="">${t('all_accounts')}</option>
                                ${(state.data.accounts || []).map(acc => `<option value="${acc.name}">${acc.name} (${acc.type})</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label
                                style="display: block; font-size: 0.75rem; color: var(--text-light); margin-bottom: 0.25rem;">Status
                                (Receivables/Payables)</label>
                            <select class="filter-input" id="report-status" onchange="renderReports()"
                                style="width: 100%;">
                                <option value="">All Status</option>
                                <option value="paid">Paid</option>
                                <option value="unpaid">Unpaid</option>
                            </select>
                        </div>
                        <div>
                            <label
                                style="display: block; font-size: 0.75rem; color: var(--text-light); margin-bottom: 0.25rem;">Priority</label>
                            <select class="filter-input" id="report-priority" onchange="renderReports()"
                                style="width: 100%;">
                                <option value="">All Priorities</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                        <div>
                            <label
                                style="display: block; font-size: 0.75rem; color: var(--text-light); margin-bottom: 0.25rem;">Recurring</label>
                            <select class="filter-input" id="report-recurring" onchange="renderReports()"
                                style="width: 100%;">
                                <option value="">All Transactions</option>
                                <option value="recurring">Recurring Only</option>
                                <option value="non-recurring">Non-Recurring Only</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="resetReportFilters()"
                        style="margin-top: 0.75rem; font-size: 0.875rem;">Reset Filters</button>
                </div>
                <div id="reports-container"></div>
            </div>
        </div>

        <!-- Analytics View -->
        <div id="view-analytics" class="hidden">
            <div class="card">
                <h2>Advanced Analytics</h2>
                <div id="analytics-container"></div>
            </div>
        </div>

        <!-- Templates View -->
        <div id="view-templates" class="hidden">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2>Transaction Templates</h2>
                    <button class="btn btn-primary" onclick="openTemplateModal()" style="width: auto;">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        <span data-translate="create_template">Create Template</span>
                    </button>
                </div>
                <div id="templates-container"></div>
            </div>
        </div>

        <!-- Accounts View -->
        <div id="view-accounts" class="hidden">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 data-translate="account_management">Account Management</h2>
                    <button class="btn btn-primary" onclick="openAccountModal()" style="width: auto;">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        <span data-translate="add_account">Add Account</span>
                    </button>
                </div>
                <div id="accounts-container"></div>
            </div>
        </div>

        <!-- Transfers View -->
        <div id="view-transfers" class="hidden">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 data-translate="account_transfers">Account Transfers</h2>
                    <button class="btn btn-primary" onclick="openTransferModal()" style="width: auto;">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        <span data-translate="add_transfer">Add Transfer</span>
                    </button>
                </div>
                <div id="transfers-container"></div>
            </div>
        </div>

        <!-- Debts View -->
        <div id="view-debts" class="hidden">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 data-translate="debt_tracker">Debt Tracker</h2>
                    <button class="btn btn-primary" onclick="openDebtModal()" style="width: auto;">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        <span data-translate="add_debt">Add Debt</span>
                    </button>
                </div>
                <div id="debts-container"></div>
            </div>
        </div>


        <!-- Recurring Transactions View -->
        <div id="view-recurring" class="hidden">
            <div class="card">
                <h2 data-translate="recurring_transactions_manager">Recurring Transactions Manager</h2>
                <div
                    style="margin-bottom: 1rem; padding: 1rem; background: #f0f9ff; border-radius: 8px; border-left: 4px solid var(--primary);">
                    <div style="font-weight: 600; margin-bottom: 0.5rem;">ðŸ’¡ Auto-Generate Recurring Transactions</div>
                    <div style="font-size: 0.875rem; color: var(--text-light); margin-bottom: 0.75rem;">
                        This will automatically create transactions for all recurring items based on their frequency and
                        next due date.
                    </div>
                    <button class="btn btn-primary" onclick="generateRecurringTransactions()">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="23 4 23 10 17 10"></polyline>
                            <polyline points="1 20 1 14 7 14"></polyline>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                        </svg>
                        Generate Recurring Transactions
                    </button>
                </div>
                <div id="recurring-container"></div>
            </div>
        </div>

        <!-- Calendar View -->
        <div id="view-calendar" class="hidden">
            <div class="card">
                <h2>Financial Calendar</h2>
                <div id="calendar-container"></div>
            </div>
        </div>

        <!-- Cash Flow View -->
        <div id="view-cashflow" class="hidden">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 data-translate="cash_flow_analysis">Cash Flow Analysis</h2>
                    <div>
                        <select class="filter-input" id="cashflow-period" onchange="renderCashFlow()"
                            style="min-width: 150px;">
                            <option value="monthly">Monthly</option>
                            <option value="quarterly">Quarterly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                    </div>
                </div>
                <div id="cashflow-container"></div>
            </div>
        </div>

        <!-- Investments View -->
        <div id="view-investments" class="hidden">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 data-translate="investment_portfolio">Investment Portfolio</h2>
                    <button class="btn btn-primary" onclick="openInvestmentModal()" style="width: auto;" data-translate="add_investment">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Add Investment
                    </button>
                </div>
                <div id="investments-container"></div>
            </div>
        </div>

        <!-- Settings View -->
        <div id="view-settings" class="hidden">
            <div class="card">
                <h2>Settings & Preferences</h2>

                <div class="settings-section">
                    <div class="settings-section-title">General Settings</div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">Currency Symbol</div>
                            <div class="settings-description">Default currency symbol for all amounts</div>
                        </div>
                        <select class="form-select" id="setting-currency" style="width: 200px;"
                            onchange="saveSettings()">
                            <option value="à§³">à§³ (Taka)</option>
                            <option value="$">$ (Dollar)</option>
                            <option value="â‚¬">â‚¬ (Euro)</option>
                            <option value="Â£">Â£ (Pound)</option>
                            <option value="â‚¹">â‚¹ (Rupee)</option>
                            <option value="Â¥">Â¥ (Yen)</option>
                        </select>
                    </div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">Date Format</div>
                            <div class="settings-description">Preferred date display format</div>
                        </div>
                        <select class="form-select" id="setting-date-format" style="width: 200px;"
                            onchange="saveSettings()">
                            <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                            <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                            <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                            <option value="DD-MM-YYYY">DD-MM-YYYY</option>
                        </select>
                    </div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">Auto-save</div>
                            <div class="settings-description">Automatically save changes to Excel file</div>
                        </div>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="setting-auto-save" onchange="saveSettings()">
                            <span>Enable</span>
                        </label>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-section-title">Data Management</div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">Export Data</div>
                            <div class="settings-description">Download all data as Excel file</div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary" onclick="exportData()">Export to Excel</button>
                            <button class="btn btn-secondary" onclick="exportDataCSV()">Export to CSV</button>
                        </div>
                    </div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">Import Data</div>
                            <div class="settings-description">Import data from Excel file (will merge with existing
                                data)</div>
                        </div>
                        <button class="btn btn-primary" onclick="importData()" style="width: auto;">Import from Excel</button>
                    </div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">Backup Data</div>
                            <div class="settings-description">Create a backup of all your data</div>
                        </div>
                        <button class="btn btn-secondary" onclick="backupData()" style="width: auto;">Create Backup</button>
                    </div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">Restore Data</div>
                            <div class="settings-description">Restore data from a backup file</div>
                        </div>
                        <button class="btn btn-secondary" onclick="restoreData()" style="width: auto;">Restore Backup</button>
                    </div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">Undo Last Action</div>
                            <div class="settings-description">Undo the last transaction (add/edit/delete)</div>
                        </div>
                        <button class="btn btn-secondary" onclick="undoLastAction()" id="undo-btn" style="width: auto;">Undo</button>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-section-title">Keyboard Shortcuts</div>
                    <div style="padding: 1rem 0;">
                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 0.5rem;">Navigation</div>
                                <div style="font-size: 0.875rem; line-height: 2;">
                                    <div><span class="shortcut-key">Ctrl</span> + <span class="shortcut-key">1</span> -
                                        Dashboard</div>
                                    <div><span class="shortcut-key">Ctrl</span> + <span class="shortcut-key">2</span> -
                                        Income</div>
                                    <div><span class="shortcut-key">Ctrl</span> + <span class="shortcut-key">3</span> -
                                        Expenses</div>
                                    <div><span class="shortcut-key">Ctrl</span> + <span class="shortcut-key">N</span> -
                                        New Item</div>
                                </div>
                            </div>
                            <div>
                                <div style="font-weight: 600; margin-bottom: 0.5rem;">Actions</div>
                                <div style="font-size: 0.875rem; line-height: 2;">
                                    <div><span class="shortcut-key">Ctrl</span> + <span class="shortcut-key">S</span> -
                                        Save</div>
                                    <div><span class="shortcut-key">Esc</span> - Close Modal</div>
                                    <div><span class="shortcut-key">Ctrl</span> + <span class="shortcut-key">F</span> -
                                        Search</div>
                                    <div><span class="shortcut-key">Del</span> - Delete Selected</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Categories View -->
        <div id="view-categories" class="hidden">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2>Category Management</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary" style="width: auto;" onclick="openModal('form', 'category')">+
                            Add Category</button>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                    <div>
                        <h3 style="margin-bottom: 1rem; font-size: 1rem; color: var(--text-main);">Income Categories
                        </h3>
                        <div id="income-categories-list"></div>
                    </div>
                    <div>
                        <h3 style="margin-bottom: 1rem; font-size: 1rem; color: var(--text-main);">Expense Categories
                        </h3>
                        <div id="expense-categories-list"></div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Sticky Add Button -->
    <button class="fab" onclick="openModal('selector')">+</button>

    <!-- Modal Overlay -->
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal" id="modal-content">
            <!-- Content injected via JS -->
        </div>
    </div>

    <script>
        // --- 1. STATE & CONFIG ---
        const CONFIG = {
            fileName: 'finance_data.xlsx',
            currency: 'à§³'
        };

        // --- TRANSLATION SYSTEM ---
        const translations = {
            en: {
                notifications: 'Notifications',
                clear_all: 'Clear All',
                no_notifications: 'No notifications',
                view: 'View',
                edit: 'Edit',
                delete: 'Delete',
                dashboard: 'Dashboard',
                income: 'Income',
                expenses: 'Expenses',
                receivables: 'Due (Receivables)',
                payables: 'Payables',
                plans: 'Future Plans',
                budgets: 'Budgets',
                categories: 'Categories',
                category: 'Category',
                reports: 'Reports',
                analytics: 'Analytics',
                templates: 'Templates',
                accounts: 'Accounts',
                debts: 'Debts',
                goals: 'Goals',
                recurring: 'Recurring',
                calendar: 'Calendar',
                cashflow: 'Cash Flow',
                investments: 'Investments',
                settings: 'Settings',
                bill_details: 'Bill Details',
                amount: 'Amount',
                due_date: 'Due Date',
                status: 'Status',
                description: 'Description',
                priority: 'Priority',
                type: 'Type',
                paid: 'Paid',
                unpaid: 'Unpaid',
                high: 'High',
                medium: 'Medium',
                low: 'Low',
                today: 'Today',
                tomorrow: 'Tomorrow',
                days: 'days',
                close: 'Close',
                refresh: 'Refresh',
                export: 'Export',
                disconnect: 'Disconnect',
                dark_mode: 'Dark Mode',
                income_sources: 'Income Sources',
                date: 'Date',
                source: 'Source',
                actions: 'Actions',
                details: 'Details',
                from: 'From',
                to: 'To',
                search: 'Search...',
                from_date: 'From Date',
                to_date: 'To Date',
                sort_by: 'Sort by...',
                total_income: 'Total Income',
                total_expenses: 'Total Expenses',
                net_balance: 'Net Balance',
                this_month_income: 'This Month Income',
                this_month_expenses: 'This Month Expenses',
                this_month_balance: 'This Month Balance',
                total_savings: 'Total Savings',
                due_receivables: 'Due Receivables',
                due_payables: 'Due Payables',
                loading_reminders: 'Loading reminders...',
                no_items: 'No items',
                saved_successfully: 'Saved successfully!',
                connected_to: 'Connected to',
                disconnected: 'Disconnected',
                please_connect: 'Please connect Excel file.',
                upcoming_bills: 'Upcoming Bills & Reminders',
                monthly_comparison: 'Monthly Comparison',
                financial_health_score: 'Financial Health Score',
                savings_rate: 'Savings Rate',
                expense_ratio: 'Expense Ratio',
                average_monthly_expense: 'Average Monthly Expense',
                average_monthly_income: 'Average Monthly Income',
                top_spending_category: 'Top Spending Category',
                average_transaction_size: 'Average Transaction Size',
                monthly_savings: 'Monthly Savings',
                transaction_count: 'Transaction Count',
                income_vs_expenses_trend: 'Income vs Expenses Trend',
                cash_flow: 'Cash Flow',
                expense_categories: 'Expense Categories',
                income_categories: 'Income Categories',
                all_transactions: 'All transactions',
                not_enough_data: 'Not enough data for comparison. Need at least 2 months of data.',
                no_upcoming_bills: 'No upcoming bills in the next 7 days.',
                positive_monthly_savings: 'Positive monthly savings',
                negative_monthly_savings: 'Negative monthly savings',
                income_comma_expenses: 'income',
                expenses_word: 'expenses',
                item: 'item',
                items: 'items',
                showing: 'Showing',
                of: 'of',
                all_categories: 'All Categories',
                no_data_found: 'No data found.',
                no_future_plans: 'No future plans found.',
                no_budgets_set: 'No budgets set. Add a budget to track spending limits.',
                excellent_health: 'Excellent - Great financial health!',
                good_health: 'Good - On the right track',
                fair_health: 'Fair - Room for improvement',
                needs_attention: 'Needs Attention - Review spending habits',
                save: 'Save',
                update: 'Update',
                cancel: 'Cancel',
                add: 'Add',
                save_item: 'Save Item',
                update_item: 'Update Item',
                add_income: 'Add Income',
                edit_income: 'Edit Income',
                add_expense: 'Add Expense',
                edit_expense: 'Edit Expense',
                add_receivable: 'Add Receivable',
                edit_receivable: 'Edit Receivable',
                add_payable: 'Add Payable',
                edit_payable: 'Edit Payable',
                add_plan: 'Add Plan',
                edit_plan: 'Edit Plan',
                add_budget: 'Add Budget',
                edit_budget: 'Edit Budget',
                create_template: 'Create Template',
                edit_template: 'Edit Template',
                add_account: 'Add Account',
                update_account: 'Update Account',
                add_debt: 'Add Debt',
                update_debt: 'Update Debt',
                add_goal: 'Add Goal',
                update_goal: 'Update Goal',
                period: 'Period',
                daily: 'Daily',
                weekly: 'Weekly',
                monthly: 'Monthly',
                per_3_month: 'Per 3 Month',
                per_6_month: 'Per 6 Month',
                yearly: 'Yearly',
                active: 'Active',
                paused: 'Paused',
                completed: 'Completed',
                in_progress: 'In Progress',
                cancelled: 'Cancelled',
                budget_tracks_info: 'Budget tracks actual spending against this limit for the selected category within the selected period.',
                source: 'Source',
                notes_optional: 'Notes (Optional)',
                recurring_transaction: 'Recurring Transaction',
                frequency: 'Frequency',
                next_occurrence_date: 'Next Occurrence Date',
                payment_method: 'Payment Method',
                select_method: 'Select Method',
                cash: 'Cash',
                bank_transfer: 'Bank Transfer',
                card: 'Card',
                mobile_payment: 'Mobile Payment',
                other: 'Other',
                select_category: 'Select Category',
                from_client: 'From (Client/Person)',
                to_vendor: 'To (Vendor/Person)',
                name_placeholder: 'Name',
                reason: 'Reason',
                reminder_days_before: 'Reminder (Days Before Due)',
                reminder_days_before_deadline: 'Reminder (Days Before Deadline)',
                plan_title: 'Plan Title',
                target_amount: 'Target Amount',
                start_date: 'Start Date',
                target_deadline: 'Target Deadline',
                notes: 'Notes',
                additional_notes: 'Additional notes...',
                optional_description: 'Optional description',
                progress_note: 'Note: Progress will be calculated based on Total Savings (Income - Expenses + Receivables).',
                reminder_help_text: 'Get reminder this many days before due date (0 = on due date)',
                reminder_deadline_help: 'Get reminder this many days before deadline (0 = on deadline)',
                type_cannot_change: 'Type cannot be changed after creation',
                account_management: 'Account Management',
                debt_tracker: 'Debt Tracker',
                financial_goals: 'Financial Goals',
                account: 'Account',
                account_name: 'Account Name',
                account_type: 'Account Type',
                select_account: 'Select Account',
                initial_balance: 'Initial Balance',
                transfers: 'Transfers',
                transfer: 'Transfer',
                add_transfer: 'Add Transfer',
                account_transfers: 'Account Transfers',
                from_account: 'From Account',
                to_account: 'To Account',
                transfer_description_placeholder: 'e.g. Cash withdrawal, Account transfer',
                debt_name: 'Debt Name',
                debt_type: 'Debt Type',
                principal_amount: 'Principal Amount',
                amount_paid: 'Amount Paid',
                creditor_lender: 'Creditor/Lender',
                goal_name: 'Goal Name',
                current_amount: 'Current Amount',
                deadline: 'Deadline',
                template_name: 'Template Name',
                transaction_type: 'Transaction Type',
                recurring_only: 'Recurring Only',
                non_recurring: 'Non-Recurring',
                clear_filters: 'Clear Filters',
                all_types: 'All Types',
                all_accounts: 'All Accounts',
                transfers: 'Transfers',
                transfer: 'Transfer',
                account_transfers: 'Account Transfers',
                from_account: 'From Account',
                to_account: 'To Account',
                transfer_description_placeholder: 'e.g. Cash withdrawal, Account transfer',
                all_status: 'All Status',
                color: 'Color',
                manage_categories: 'Manage Categories',
                recurring_transactions_manager: 'Recurring Transactions Manager',
                auto_generate_info: 'Auto-Generate Recurring Transactions',
                auto_generate_desc: 'This will automatically create transactions for all recurring items based on their frequency and dates.',
                generate_recurring: 'Generate Recurring Transactions',
                low: 'Low',
                medium: 'Medium',
                high: 'High',
                select_category_placeholder: 'Select Category',
                add_new_item: 'Add New Item',
                new: 'New',
                loan: 'Loan',
                mortgage: 'Mortgage',
                personal_loan: 'Personal Loan',
                savings: 'Savings',
                bank: 'Bank',
                is_required: 'is required!',
                must_be_greater_than_zero: 'must be greater than 0!',
                category_already_exists: 'This category already exists!',
                category_name_required: 'Category name is required!',
                are_you_sure_disconnect: 'Are you sure you want to disconnect from the Excel file? You will need to reconnect to save changes.',
                failed_to_save: 'Failed to save to Excel file. Check permissions.',
                are_you_sure_delete: 'Are you sure you want to delete',
                action_cannot_undo: 'This action cannot be undone.',
                are_you_sure_delete_template: 'Are you sure you want to delete this template?',
                are_you_sure_delete_account: 'Are you sure you want to delete this account? This will not delete transactions associated with it.',
                are_you_sure_delete_debt: 'Are you sure you want to delete this debt?',
                are_you_sure_delete_goal: 'Are you sure you want to delete this goal?',
                are_you_sure_delete_investment: 'Are you sure you want to delete this investment?',
                category_used_in_transactions: 'This category is used in',
                deleting_will_set_to_other: 'transaction(s). Deleting it will set those transactions to "Other". Continue?',
                cash_flow_analysis: 'Cash Flow Analysis',
                investment_portfolio: 'Investment Portfolio',
                add_investment: 'Add Investment',
                edit_investment: 'Edit Investment',
                all_methods: 'All Methods',
                placeholder_salary_freelance: 'e.g. Salary, Freelance',
                placeholder_groceries: 'e.g. Groceries',
                placeholder_new_laptop: 'e.g. New Laptop',
                placeholder_groceries_salary: 'e.g. Groceries, Salary',
                placeholder_monthly_salary: 'e.g. Monthly Salary',
                placeholder_main_bank: 'e.g. Main Bank Account',
                placeholder_home_loan: 'e.g. Home Loan',
                placeholder_bank_name: 'e.g. Bank Name',
                placeholder_emergency_fund: 'e.g. Emergency Fund',
                placeholder_apple_inc: 'e.g. Apple Inc.',
                placeholder_aapl: 'e.g. AAPL',
                total_cost_basis: 'Total Cost Basis',
                total_gain_loss: 'Total Gain/Loss',
                total_return: 'Total Return',
                placeholder_example_3: 'e.g. 3',
                placeholder_example_7: 'e.g. 7',
                optional_notes: 'Optional notes',
                investment_name: 'Investment Name',
                symbol_ticker: 'Symbol/Ticker',
                cost_basis: 'Cost Basis',
                current_value: 'Current Value',
                purchase_date: 'Purchase Date',
                stock: 'Stock',
                bond: 'Bond',
                mutual_fund: 'Mutual Fund',
                etf: 'ETF',
                cryptocurrency: 'Cryptocurrency',
                update_investment: 'Update Investment',
                delete_multiple_items: 'Delete Multiple Items',
                delete_all: 'Delete All',
                confirm: 'Confirm'
            },
            bn: {
                notifications: 'à¦¬à¦¿à¦œà§à¦žà¦ªà§à¦¤à¦¿',
                clear_all: 'à¦¸à¦¬ à¦¸à¦¾à¦« à¦•à¦°à§à¦¨',
                no_notifications: 'à¦•à§‹à¦¨ à¦¬à¦¿à¦œà§à¦žà¦ªà§à¦¤à¦¿ à¦¨à§‡à¦‡',
                view: 'à¦¦à§‡à¦–à§à¦¨',
                edit: 'à¦¸à¦®à§à¦ªà¦¾à¦¦à¦¨à¦¾',
                delete: 'à¦®à§à¦›à§à¦¨',
                dashboard: 'à¦¡à§à¦¯à¦¾à¦¶à¦¬à§‹à¦°à§à¦¡',
                income: 'à¦†à¦¯à¦¼',
                expenses: 'à¦¬à§à¦¯à¦¯à¦¼',
                receivables: 'à¦ªà§à¦°à¦¾à¦ªà§à¦¯',
                payables: 'à¦¦à§‡à¦¯à¦¼',
                plans: 'à¦­à¦¬à¦¿à¦·à§à¦¯à¦¤ à¦ªà¦°à¦¿à¦•à¦²à§à¦ªà¦¨à¦¾',
                budgets: 'à¦¬à¦¾à¦œà§‡à¦Ÿ',
                categories: 'à¦¬à¦¿à¦­à¦¾à¦—',
                category: 'à¦¬à¦¿à¦­à¦¾à¦—',
                reports: 'à¦°à¦¿à¦ªà§‹à¦°à§à¦Ÿ',
                analytics: 'à¦¬à¦¿à¦¶à§à¦²à§‡à¦·à¦£',
                templates: 'à¦Ÿà§‡à¦®à¦ªà§à¦²à§‡à¦Ÿ',
                accounts: 'à¦…à§à¦¯à¦¾à¦•à¦¾à¦‰à¦¨à§à¦Ÿ',
                debts: 'à¦‹à¦£',
                goals: 'à¦²à¦•à§à¦·à§à¦¯',
                recurring: 'à¦ªà§à¦¨à¦°à¦¾à¦¬à§ƒà¦¤à§à¦¤',
                calendar: 'à¦•à§à¦¯à¦¾à¦²à§‡à¦¨à§à¦¡à¦¾à¦°',
                cashflow: 'à¦¨à¦—à¦¦ à¦ªà§à¦°à¦¬à¦¾à¦¹',
                investments: 'à¦¬à¦¿à¦¨à¦¿à¦¯à¦¼à§‹à¦—',
                settings: 'à¦¸à§‡à¦Ÿà¦¿à¦‚à¦¸',
                bill_details: 'à¦¬à¦¿à¦²à§‡à¦° à¦¬à¦¿à¦¬à¦°à¦£',
                amount: 'à¦ªà¦°à¦¿à¦®à¦¾à¦£',
                due_date: 'à¦¨à¦¿à¦°à§à¦§à¦¾à¦°à¦¿à¦¤ à¦¤à¦¾à¦°à¦¿à¦–',
                status: 'à¦…à¦¬à¦¸à§à¦¥à¦¾',
                description: 'à¦¬à¦¿à¦¬à¦°à¦£',
                priority: 'à¦…à¦—à§à¦°à¦¾à¦§à¦¿à¦•à¦¾à¦°',
                type: 'à¦§à¦°à¦¨',
                paid: 'à¦ªà¦°à¦¿à¦¶à§‹à¦§à¦¿à¦¤',
                unpaid: 'à¦…à¦ªà¦°à¦¿à¦¶à§‹à¦§à¦¿à¦¤',
                high: 'à¦‰à¦šà§à¦š',
                medium: 'à¦®à¦§à§à¦¯à¦®',
                low: 'à¦¨à¦¿à¦®à§à¦¨',
                today: 'à¦†à¦œ',
                tomorrow: 'à¦†à¦—à¦¾à¦®à§€à¦•à¦¾à¦²',
                days: 'à¦¦à¦¿à¦¨',
                close: 'à¦¬à¦¨à§à¦§',
                refresh: 'à¦°à¦¿à¦«à§à¦°à§‡à¦¶',
                export: 'à¦à¦•à§à¦¸à¦ªà§‹à¦°à§à¦Ÿ',
                disconnect: 'à¦¸à¦‚à¦¯à§‹à¦— à¦¬à¦¿à¦šà§à¦›à¦¿à¦¨à§à¦¨',
                dark_mode: 'à¦¡à¦¾à¦°à§à¦• à¦®à§‹à¦¡',
                income_sources: 'à¦†à¦¯à¦¼à§‡à¦° à¦‰à§Žà¦¸',
                date: 'à¦¤à¦¾à¦°à¦¿à¦–',
                source: 'à¦‰à§Žà¦¸',
                actions: 'à¦•à¦°à§à¦®',
                details: 'à¦¬à¦¿à¦¸à§à¦¤à¦¾à¦°à¦¿à¦¤',
                from: 'à¦¥à§‡à¦•à§‡',
                to: 'à¦ªà§à¦°à¦¤à¦¿',
                search: 'à¦–à§à¦à¦œà§à¦¨...',
                from_date: 'à¦¶à§à¦°à§à¦° à¦¤à¦¾à¦°à¦¿à¦–',
                to_date: 'à¦¶à§‡à¦· à¦¤à¦¾à¦°à¦¿à¦–',
                sort_by: 'à¦¸à¦¾à¦œà¦¾à¦¨...',
                total_income: 'à¦®à§‹à¦Ÿ à¦†à¦¯à¦¼',
                total_expenses: 'à¦®à§‹à¦Ÿ à¦¬à§à¦¯à¦¯à¦¼',
                net_balance: 'à¦¨à¦¿à¦Ÿ à¦¬à§à¦¯à¦¾à¦²à§‡à¦¨à§à¦¸',
                this_month_income: 'à¦à¦‡ à¦®à¦¾à¦¸à§‡à¦° à¦†à¦¯à¦¼',
                this_month_expenses: 'à¦à¦‡ à¦®à¦¾à¦¸à§‡à¦° à¦¬à§à¦¯à¦¯à¦¼',
                this_month_balance: 'à¦à¦‡ à¦®à¦¾à¦¸à§‡à¦° à¦¬à§à¦¯à¦¾à¦²à§‡à¦¨à§à¦¸',
                total_savings: 'à¦®à§‹à¦Ÿ à¦¸à¦žà§à¦šà¦¯à¦¼',
                due_receivables: 'à¦ªà§à¦°à¦¾à¦ªà§à¦¯ à¦ªà§à¦°à¦¾à¦ªà§à¦¤à¦¿',
                due_payables: 'à¦ªà§à¦°à¦¾à¦ªà§à¦¯ à¦ªà§à¦°à¦¦à¦¾à¦¨',
                loading_reminders: 'à¦°à¦¿à¦®à¦¾à¦‡à¦¨à§à¦¡à¦¾à¦° à¦²à§‹à¦¡ à¦¹à¦šà§à¦›à§‡...',
                no_items: 'à¦•à§‹à¦¨ à¦†à¦‡à¦Ÿà§‡à¦® à¦¨à§‡à¦‡',
                saved_successfully: 'à¦¸à¦«à¦²à¦­à¦¾à¦¬à§‡ à¦¸à¦‚à¦°à¦•à§à¦·à¦¿à¦¤!',
                connected_to: 'à¦¸à¦‚à¦¯à§à¦•à§à¦¤ à¦¹à¦¯à¦¼à§‡à¦›à§‡',
                disconnected: 'à¦¸à¦‚à¦¯à§‹à¦— à¦¬à¦¿à¦šà§à¦›à¦¿à¦¨à§à¦¨',
                please_connect: 'à¦…à¦¨à§à¦—à§à¦°à¦¹ à¦•à¦°à§‡ à¦à¦•à§à¦¸à§‡à¦² à¦«à¦¾à¦‡à¦² à¦¸à¦‚à¦¯à§à¦•à§à¦¤ à¦•à¦°à§à¦¨à¥¤',
                upcoming_bills: 'à¦†à¦¸à¦¨à§à¦¨ à¦¬à¦¿à¦² à¦“ à¦°à¦¿à¦®à¦¾à¦‡à¦¨à§à¦¡à¦¾à¦°',
                monthly_comparison: 'à¦®à¦¾à¦¸à¦¿à¦• à¦¤à§à¦²à¦¨à¦¾',
                financial_health_score: 'à¦†à¦°à§à¦¥à¦¿à¦• à¦¸à§à¦¬à¦¾à¦¸à§à¦¥à§à¦¯ à¦¸à§à¦•à§‹à¦°',
                savings_rate: 'à¦¸à¦žà§à¦šà¦¯à¦¼ à¦¹à¦¾à¦°',
                expense_ratio: 'à¦¬à§à¦¯à¦¯à¦¼ à¦…à¦¨à§à¦ªà¦¾à¦¤',
                average_monthly_expense: 'à¦—à¦¡à¦¼ à¦®à¦¾à¦¸à¦¿à¦• à¦¬à§à¦¯à¦¯à¦¼',
                average_monthly_income: 'à¦—à¦¡à¦¼ à¦®à¦¾à¦¸à¦¿à¦• à¦†à¦¯à¦¼',
                top_spending_category: 'à¦¶à§€à¦°à§à¦· à¦¬à§à¦¯à¦¯à¦¼ à¦¬à¦¿à¦­à¦¾à¦—',
                average_transaction_size: 'à¦—à¦¡à¦¼ à¦²à§‡à¦¨à¦¦à§‡à¦¨à§‡à¦° à¦†à¦•à¦¾à¦°',
                monthly_savings: 'à¦®à¦¾à¦¸à¦¿à¦• à¦¸à¦žà§à¦šà¦¯à¦¼',
                transaction_count: 'à¦²à§‡à¦¨à¦¦à§‡à¦¨à§‡à¦° à¦¸à¦‚à¦–à§à¦¯à¦¾',
                income_vs_expenses_trend: 'à¦†à¦¯à¦¼ à¦¬à¦¨à¦¾à¦® à¦¬à§à¦¯à¦¯à¦¼ à¦ªà§à¦°à¦¬à¦£à¦¤à¦¾',
                cash_flow: 'à¦¨à¦—à¦¦ à¦ªà§à¦°à¦¬à¦¾à¦¹',
                expense_categories: 'à¦¬à§à¦¯à¦¯à¦¼ à¦¬à¦¿à¦­à¦¾à¦—',
                income_categories: 'à¦†à¦¯à¦¼ à¦¬à¦¿à¦­à¦¾à¦—',
                all_transactions: 'à¦¸à¦®à¦¸à§à¦¤ à¦²à§‡à¦¨à¦¦à§‡à¦¨',
                not_enough_data: 'à¦¤à§à¦²à¦¨à¦¾à¦° à¦œà¦¨à§à¦¯ à¦ªà¦°à§à¦¯à¦¾à¦ªà§à¦¤ à¦¡à§‡à¦Ÿà¦¾ à¦¨à§‡à¦‡à¥¤ à¦…à¦¨à§à¦¤à¦¤ à§¨ à¦®à¦¾à¦¸à§‡à¦° à¦¡à§‡à¦Ÿà¦¾ à¦ªà§à¦°à¦¯à¦¼à§‹à¦œà¦¨à¥¤',
                no_upcoming_bills: 'à¦ªà¦°à¦¬à¦°à§à¦¤à§€ à§­ à¦¦à¦¿à¦¨à§‡ à¦•à§‹à¦¨ à¦†à¦¸à¦¨à§à¦¨ à¦¬à¦¿à¦² à¦¨à§‡à¦‡à¥¤',
                positive_monthly_savings: 'à¦‡à¦¤à¦¿à¦¬à¦¾à¦šà¦• à¦®à¦¾à¦¸à¦¿à¦• à¦¸à¦žà§à¦šà¦¯à¦¼',
                negative_monthly_savings: 'à¦¨à§‡à¦¤à¦¿à¦¬à¦¾à¦šà¦• à¦®à¦¾à¦¸à¦¿à¦• à¦¸à¦žà§à¦šà¦¯à¦¼',
                income_comma_expenses: 'à¦†à¦¯à¦¼',
                expenses_word: 'à¦¬à§à¦¯à¦¯à¦¼',
                item: 'à¦†à¦‡à¦Ÿà§‡à¦®',
                items: 'à¦†à¦‡à¦Ÿà§‡à¦®',
                showing: 'à¦¦à§‡à¦–à¦¾à¦šà§à¦›à§‡',
                of: 'à¦à¦°',
                all_categories: 'à¦¸à¦¬ à¦¬à¦¿à¦­à¦¾à¦—',
                no_data_found: 'à¦•à§‹à¦¨ à¦¡à§‡à¦Ÿà¦¾ à¦ªà¦¾à¦“à¦¯à¦¼à¦¾ à¦¯à¦¾à¦¯à¦¼à¦¨à¦¿à¥¤',
                no_future_plans: 'à¦•à§‹à¦¨ à¦­à¦¬à¦¿à¦·à§à¦¯à¦¤ à¦ªà¦°à¦¿à¦•à¦²à§à¦ªà¦¨à¦¾ à¦ªà¦¾à¦“à¦¯à¦¼à¦¾ à¦¯à¦¾à¦¯à¦¼à¦¨à¦¿à¥¤',
                no_budgets_set: 'à¦•à§‹à¦¨ à¦¬à¦¾à¦œà§‡à¦Ÿ à¦¸à§‡à¦Ÿ à¦•à¦°à¦¾ à¦¨à§‡à¦‡à¥¤ à¦¬à§à¦¯à¦¯à¦¼ à¦¸à§€à¦®à¦¾ à¦Ÿà§à¦°à§à¦¯à¦¾à¦• à¦•à¦°à¦¤à§‡ à¦à¦•à¦Ÿà¦¿ à¦¬à¦¾à¦œà§‡à¦Ÿ à¦¯à§‹à¦— à¦•à¦°à§à¦¨à¥¤',
                excellent_health: 'à¦šà¦®à§Žà¦•à¦¾à¦° - à¦¦à§à¦°à§à¦¦à¦¾à¦¨à§à¦¤ à¦†à¦°à§à¦¥à¦¿à¦• à¦¸à§à¦¬à¦¾à¦¸à§à¦¥à§à¦¯!',
                good_health: 'à¦­à¦¾à¦² - à¦¸à¦ à¦¿à¦• à¦ªà¦¥à§‡',
                fair_health: 'à¦¸à¦¨à§à¦¤à§‹à¦·à¦œà¦¨à¦• - à¦‰à¦¨à§à¦¨à¦¤à¦¿à¦° à¦¸à§à¦¯à§‹à¦— à¦†à¦›à§‡',
                needs_attention: 'à¦®à¦¨à§‹à¦¯à§‹à¦— à¦ªà§à¦°à¦¯à¦¼à§‹à¦œà¦¨ - à¦¬à§à¦¯à¦¯à¦¼à§‡à¦° à¦…à¦­à§à¦¯à¦¾à¦¸ à¦ªà¦°à§à¦¯à¦¾à¦²à§‹à¦šà¦¨à¦¾ à¦•à¦°à§à¦¨',
                source: 'à¦‰à§Žà¦¸',
                notes_optional: 'à¦¨à§‹à¦Ÿ (à¦à¦šà§à¦›à¦¿à¦•)',
                recurring_transaction: 'à¦ªà§à¦¨à¦°à¦¾à¦¬à§ƒà¦¤à§à¦¤ à¦²à§‡à¦¨à¦¦à§‡à¦¨',
                frequency: 'à¦«à§à¦°à¦¿à¦•à§‹à¦¯à¦¼à§‡à¦¨à§à¦¸à¦¿',
                next_occurrence_date: 'à¦ªà¦°à¦¬à¦°à§à¦¤à§€ à¦¤à¦¾à¦°à¦¿à¦–',
                payment_method: 'à¦ªà§‡à¦®à§‡à¦¨à§à¦Ÿ à¦ªà¦¦à§à¦§à¦¤à¦¿',
                select_method: 'à¦ªà¦¦à§à¦§à¦¤à¦¿ à¦¨à¦¿à¦°à§à¦¬à¦¾à¦šà¦¨ à¦•à¦°à§à¦¨',
                cash: 'à¦¨à¦—à¦¦',
                bank_transfer: 'à¦¬à§à¦¯à¦¾à¦‚à¦• à¦Ÿà§à¦°à¦¾à¦¨à§à¦¸à¦«à¦¾à¦°',
                card: 'à¦•à¦¾à¦°à§à¦¡',
                mobile_payment: 'à¦®à§‹à¦¬à¦¾à¦‡à¦² à¦ªà§‡à¦®à§‡à¦¨à§à¦Ÿ',
                other: 'à¦…à¦¨à§à¦¯à¦¾à¦¨à§à¦¯',
                select_category: 'à¦¬à¦¿à¦­à¦¾à¦— à¦¨à¦¿à¦°à§à¦¬à¦¾à¦šà¦¨ à¦•à¦°à§à¦¨',
                from_client: 'à¦¥à§‡à¦•à§‡ (à¦•à§à¦²à¦¾à¦¯à¦¼à§‡à¦¨à§à¦Ÿ/à¦¬à§à¦¯à¦•à§à¦¤à¦¿)',
                to_vendor: 'à¦ªà§à¦°à¦¤à¦¿ (à¦­à§‡à¦¨à§à¦¡à¦°/à¦¬à§à¦¯à¦•à§à¦¤à¦¿)',
                name_placeholder: 'à¦¨à¦¾à¦®',
                reason: 'à¦•à¦¾à¦°à¦£',
                reminder_days_before: 'à¦°à¦¿à¦®à¦¾à¦‡à¦¨à§à¦¡à¦¾à¦° (à¦¨à¦¿à¦°à§à¦§à¦¾à¦°à¦¿à¦¤ à¦¤à¦¾à¦°à¦¿à¦–à§‡à¦° à¦•à¦¤à¦¦à¦¿à¦¨ à¦†à¦—à§‡)',
                reminder_days_before_deadline: 'à¦°à¦¿à¦®à¦¾à¦‡à¦¨à§à¦¡à¦¾à¦° (à¦¨à¦¿à¦°à§à¦§à¦¾à¦°à¦¿à¦¤ à¦¸à¦®à¦¯à¦¼à¦¸à§€à¦®à¦¾à¦° à¦•à¦¤à¦¦à¦¿à¦¨ à¦†à¦—à§‡)',
                plan_title: 'à¦ªà¦°à¦¿à¦•à¦²à§à¦ªà¦¨à¦¾à¦° à¦¶à¦¿à¦°à§‹à¦¨à¦¾à¦®',
                target_amount: 'à¦²à¦•à§à¦·à§à¦¯à¦®à¦¾à¦¤à§à¦°à¦¾ à¦ªà¦°à¦¿à¦®à¦¾à¦£',
                start_date: 'à¦¶à§à¦°à§à¦° à¦¤à¦¾à¦°à¦¿à¦–',
                target_deadline: 'à¦²à¦•à§à¦·à§à¦¯à¦®à¦¾à¦¤à§à¦°à¦¾ à¦¸à¦®à¦¯à¦¼à¦¸à§€à¦®à¦¾',
                notes: 'à¦¨à§‹à¦Ÿ',
                additional_notes: 'à¦…à¦¤à¦¿à¦°à¦¿à¦•à§à¦¤ à¦¨à§‹à¦Ÿ...',
                optional_description: 'à¦à¦šà§à¦›à¦¿à¦• à¦¬à¦¿à¦¬à¦°à¦£',
                progress_note: 'à¦¦à§à¦°à¦·à§à¦Ÿà¦¬à§à¦¯: à¦…à¦—à§à¦°à¦—à¦¤à¦¿ à¦®à§‹à¦Ÿ à¦¸à¦žà§à¦šà¦¯à¦¼à§‡à¦° à¦‰à¦ªà¦° à¦­à¦¿à¦¤à§à¦¤à¦¿ à¦•à¦°à§‡ à¦—à¦£à¦¨à¦¾ à¦•à¦°à¦¾ à¦¹à¦¬à§‡ (à¦†à¦¯à¦¼ - à¦¬à§à¦¯à¦¯à¦¼ + à¦ªà§à¦°à¦¾à¦ªà§à¦¯)',
                reminder_help_text: 'à¦¨à¦¿à¦°à§à¦§à¦¾à¦°à¦¿à¦¤ à¦¤à¦¾à¦°à¦¿à¦–à§‡à¦° à¦à¦¤à¦¦à¦¿à¦¨ à¦†à¦—à§‡ à¦°à¦¿à¦®à¦¾à¦‡à¦¨à§à¦¡à¦¾à¦° à¦ªà¦¾à¦¨ (0 = à¦¨à¦¿à¦°à§à¦§à¦¾à¦°à¦¿à¦¤ à¦¤à¦¾à¦°à¦¿à¦–à§‡)',
                reminder_deadline_help: 'à¦¨à¦¿à¦°à§à¦§à¦¾à¦°à¦¿à¦¤ à¦¸à¦®à¦¯à¦¼à¦¸à§€à¦®à¦¾à¦° à¦à¦¤à¦¦à¦¿à¦¨ à¦†à¦—à§‡ à¦°à¦¿à¦®à¦¾à¦‡à¦¨à§à¦¡à¦¾à¦° à¦ªà¦¾à¦¨ (0 = à¦¨à¦¿à¦°à§à¦§à¦¾à¦°à¦¿à¦¤ à¦¸à¦®à¦¯à¦¼à¦¸à§€à¦®à¦¾à¦¯à¦¼)',
                type_cannot_change: 'à¦¸à§ƒà¦·à§à¦Ÿà¦¿à¦° à¦ªà¦°à§‡ à¦§à¦°à¦¨ à¦ªà¦°à¦¿à¦¬à¦°à§à¦¤à¦¨ à¦•à¦°à¦¾ à¦¯à¦¾à¦¬à§‡ à¦¨à¦¾',
                account_management: 'à¦…à§à¦¯à¦¾à¦•à¦¾à¦‰à¦¨à§à¦Ÿ à¦®à§à¦¯à¦¾à¦¨à§‡à¦œà¦®à§‡à¦¨à§à¦Ÿ',
                debt_tracker: 'à¦‹à¦£ à¦Ÿà§à¦°à§à¦¯à¦¾à¦•à¦¾à¦°',
                financial_goals: 'à¦†à¦°à§à¦¥à¦¿à¦• à¦²à¦•à§à¦·à§à¦¯',
                account_name: 'à¦…à§à¦¯à¦¾à¦•à¦¾à¦‰à¦¨à§à¦Ÿ à¦¨à¦¾à¦®',
                account_type: 'à¦…à§à¦¯à¦¾à¦•à¦¾à¦‰à¦¨à§à¦Ÿ à¦§à¦°à¦¨',
                initial_balance: 'à¦ªà§à¦°à¦¾à¦¥à¦®à¦¿à¦• à¦¬à§à¦¯à¦¾à¦²à§‡à¦¨à§à¦¸',
                debt_name: 'à¦‹à¦£à§‡à¦° à¦¨à¦¾à¦®',
                debt_type: 'à¦‹à¦£à§‡à¦° à¦§à¦°à¦¨',
                principal_amount: 'à¦®à§‚à¦² à¦ªà¦°à¦¿à¦®à¦¾à¦£',
                amount_paid: 'à¦ªà¦°à¦¿à¦¶à§‹à¦§à¦¿à¦¤ à¦ªà¦°à¦¿à¦®à¦¾à¦£',
                creditor_lender: 'à¦‹à¦£à¦¦à¦¾à¦¤à¦¾/à¦‹à¦£à¦¦à¦¾à¦¨à¦•à¦¾à¦°à§€',
                goal_name: 'à¦²à¦•à§à¦·à§à¦¯à§‡à¦° à¦¨à¦¾à¦®',
                current_amount: 'à¦¬à¦°à§à¦¤à¦®à¦¾à¦¨ à¦ªà¦°à¦¿à¦®à¦¾à¦£',
                deadline: 'à¦¸à¦®à¦¯à¦¼à¦¸à§€à¦®à¦¾',
                template_name: 'à¦Ÿà§‡à¦®à¦ªà§à¦²à§‡à¦Ÿ à¦¨à¦¾à¦®',
                transaction_type: 'à¦²à§‡à¦¨à¦¦à§‡à¦¨à§‡à¦° à¦§à¦°à¦¨',
                recurring_only: 'à¦¶à§à¦§à§ à¦ªà§à¦¨à¦°à¦¾à¦¬à§ƒà¦¤à§à¦¤',
                non_recurring: 'à¦…-à¦ªà§à¦¨à¦°à¦¾à¦¬à§ƒà¦¤à§à¦¤',
                all_status: 'à¦¸à¦¬ à¦…à¦¬à¦¸à§à¦¥à¦¾',
                color: 'à¦°à¦‚',
                manage_categories: 'à¦¬à¦¿à¦­à¦¾à¦— à¦ªà¦°à¦¿à¦šà¦¾à¦²à¦¨à¦¾ à¦•à¦°à§à¦¨',
                recurring_transactions_manager: 'à¦ªà§à¦¨à¦°à¦¾à¦¬à§ƒà¦¤à§à¦¤ à¦²à§‡à¦¨à¦¦à§‡à¦¨ à¦®à§à¦¯à¦¾à¦¨à§‡à¦œà¦¾à¦°',
                auto_generate_info: 'à¦¸à§à¦¬à¦¯à¦¼à¦‚à¦•à§à¦°à¦¿à¦¯à¦¼ à¦ªà§à¦¨à¦°à¦¾à¦¬à§ƒà¦¤à§à¦¤ à¦²à§‡à¦¨à¦¦à§‡à¦¨ à¦¤à§ˆà¦°à¦¿ à¦•à¦°à§à¦¨',
                auto_generate_desc: 'à¦à¦Ÿà¦¿ à¦«à§à¦°à¦¿à¦•à§‹à¦¯à¦¼à§‡à¦¨à§à¦¸à¦¿ à¦à¦¬à¦‚ à¦¤à¦¾à¦°à¦¿à¦–à§‡à¦° à¦‰à¦ªà¦° à¦­à¦¿à¦¤à§à¦¤à¦¿ à¦•à¦°à§‡ à¦¸à¦®à¦¸à§à¦¤ à¦ªà§à¦¨à¦°à¦¾à¦¬à§ƒà¦¤à§à¦¤ à¦†à¦‡à¦Ÿà§‡à¦®à§‡à¦° à¦œà¦¨à§à¦¯ à¦¸à§à¦¬à¦¯à¦¼à¦‚à¦•à§à¦°à¦¿à¦¯à¦¼à¦­à¦¾à¦¬à§‡ à¦²à§‡à¦¨à¦¦à§‡à¦¨ à¦¤à§ˆà¦°à¦¿ à¦•à¦°à¦¬à§‡à¥¤',
                generate_recurring: 'à¦ªà§à¦¨à¦°à¦¾à¦¬à§ƒà¦¤à§à¦¤ à¦²à§‡à¦¨à¦¦à§‡à¦¨ à¦¤à§ˆà¦°à¦¿ à¦•à¦°à§à¦¨',
                low: 'à¦¨à¦¿à¦®à§à¦¨',
                medium: 'à¦®à¦§à§à¦¯à¦®',
                high: 'à¦‰à¦šà§à¦š',
                select_category_placeholder: 'à¦¬à¦¿à¦­à¦¾à¦— à¦¨à¦¿à¦°à§à¦¬à¦¾à¦šà¦¨ à¦•à¦°à§à¦¨',
                add_new_item: 'à¦¨à¦¤à§à¦¨ à¦†à¦‡à¦Ÿà§‡à¦® à¦¯à§‹à¦— à¦•à¦°à§à¦¨',
                new: 'à¦¨à¦¤à§à¦¨',
                loan: 'à¦‹à¦£',
                mortgage: 'à¦¬à¦¨à§à¦§à¦•à§€',
                personal_loan: 'à¦¬à§à¦¯à¦•à§à¦¤à¦¿à¦—à¦¤ à¦‹à¦£',
                savings: 'à¦¸à¦žà§à¦šà¦¯à¦¼',
                bank: 'à¦¬à§à¦¯à¦¾à¦‚à¦•'
            },
            es: {
                notifications: 'Notificaciones',
                clear_all: 'Limpiar Todo',
                no_notifications: 'Sin notificaciones',
                view: 'Ver',
                edit: 'Editar',
                delete: 'Eliminar',
                dashboard: 'Panel',
                income: 'Ingresos',
                expenses: 'Gastos',
                receivables: 'Por Cobrar',
                payables: 'Por Pagar',
                plans: 'Planes Futuros',
                budgets: 'Presupuestos',
                categories: 'CategorÃ­as',
                category: 'CategorÃ­a',
                reports: 'Informes',
                analytics: 'AnÃ¡lisis',
                templates: 'Plantillas',
                accounts: 'Cuentas',
                debts: 'Deudas',
                goals: 'Objetivos',
                recurring: 'Recurrente',
                calendar: 'Calendario',
                cashflow: 'Flujo de Caja',
                investments: 'Inversiones',
                settings: 'ConfiguraciÃ³n',
                bill_details: 'Detalles de Factura',
                amount: 'Cantidad',
                due_date: 'Fecha de Vencimiento',
                status: 'Estado',
                description: 'DescripciÃ³n',
                priority: 'Prioridad',
                type: 'Tipo',
                paid: 'Pagado',
                unpaid: 'No Pagado',
                high: 'Alto',
                medium: 'Medio',
                low: 'Bajo',
                today: 'Hoy',
                tomorrow: 'MaÃ±ana',
                days: 'dÃ­as',
                close: 'Cerrar',
                refresh: 'Actualizar',
                export: 'Exportar',
                disconnect: 'Desconectar',
                dark_mode: 'Modo Oscuro',
                income_sources: 'Fuentes de Ingresos',
                date: 'Fecha',
                source: 'Fuente',
                actions: 'Acciones',
                details: 'Detalles',
                from: 'De',
                to: 'A',
                no_upcoming_bills: 'No hay facturas prÃ³ximas en los prÃ³ximos 7 dÃ­as.',
                positive_monthly_savings: 'Ahorros mensuales positivos',
                negative_monthly_savings: 'Ahorros mensuales negativos',
                income_comma_expenses: 'ingresos',
                expenses_word: 'gastos',
                item: 'elemento',
                items: 'elementos',
                showing: 'Mostrando',
                of: 'de',
                all_categories: 'Todas las CategorÃ­as',
                no_data_found: 'No se encontraron datos.',
                no_future_plans: 'No se encontraron planes futuros.',
                no_budgets_set: 'No se han establecido presupuestos. Agregue un presupuesto para rastrear los lÃ­mites de gasto.',
                excellent_health: 'Â¡Excelente - Gran salud financiera!',
                good_health: 'Bueno - En el camino correcto',
                fair_health: 'Regular - Hay margen de mejora',
                needs_attention: 'Necesita AtenciÃ³n - Revise los hÃ¡bitos de gasto',
                search: 'Buscar...',
                from_date: 'Fecha Desde',
                to_date: 'Fecha Hasta',
                sort_by: 'Ordenar por...',
                total_income: 'Ingresos Totales',
                total_expenses: 'Gastos Totales',
                net_balance: 'Balance Neto',
                this_month_income: 'Ingresos del Mes',
                this_month_expenses: 'Gastos del Mes',
                this_month_balance: 'Balance del Mes',
                total_savings: 'Ahorros Totales',
                due_receivables: 'Por Cobrar',
                due_payables: 'Por Pagar',
                loading_reminders: 'Cargando recordatorios...',
                no_items: 'Sin elementos',
                saved_successfully: 'Â¡Guardado exitosamente!',
                connected_to: 'Conectado a',
                disconnected: 'Desconectado',
                please_connect: 'Por favor conecte el archivo Excel.',
                upcoming_bills: 'PrÃ³ximas Facturas y Recordatorios',
                monthly_comparison: 'ComparaciÃ³n Mensual',
                financial_health_score: 'PuntuaciÃ³n de Salud Financiera',
                savings_rate: 'Tasa de Ahorro',
                expense_ratio: 'RelaciÃ³n de Gastos',
                average_monthly_expense: 'Gasto Mensual Promedio',
                average_monthly_income: 'Ingreso Mensual Promedio',
                top_spending_category: 'CategorÃ­a de Mayor Gasto',
                average_transaction_size: 'TamaÃ±o Promedio de TransacciÃ³n',
                monthly_savings: 'Ahorros Mensuales',
                transaction_count: 'Cantidad de Transacciones',
                income_vs_expenses_trend: 'Tendencia de Ingresos vs Gastos',
                cash_flow: 'Flujo de Caja',
                expense_categories: 'CategorÃ­as de Gastos',
                income_categories: 'CategorÃ­as de Ingresos',
                all_transactions: 'Todas las transacciones',
                not_enough_data: 'No hay suficientes datos para comparar. Se necesitan al menos 2 meses de datos.',
                no_upcoming_bills: 'No hay facturas prÃ³ximas en los prÃ³ximos 7 dÃ­as.',
                positive_monthly_savings: 'Ahorros mensuales positivos',
                negative_monthly_savings: 'Ahorros mensuales negativos',
                income_comma_expenses: 'ingresos',
                expenses_word: 'gastos',
                item: 'elemento',
                items: 'elementos',
                showing: 'Mostrando',
                of: 'de',
                all_categories: 'Todas las CategorÃ­as',
                no_data_found: 'No se encontraron datos.',
                no_future_plans: 'No se encontraron planes futuros.',
                no_budgets_set: 'No se han establecido presupuestos. Agregue un presupuesto para rastrear los lÃ­mites de gasto.',
                excellent_health: 'Â¡Excelente - Gran salud financiera!',
                good_health: 'Bueno - En el camino correcto',
                fair_health: 'Regular - Hay margen de mejora',
                needs_attention: 'Necesita AtenciÃ³n - Revise los hÃ¡bitos de gasto'
            },
            fr: {
                notifications: 'Notifications',
                clear_all: 'Tout Effacer',
                no_notifications: 'Aucune notification',
                view: 'Voir',
                edit: 'Modifier',
                delete: 'Supprimer',
                dashboard: 'Tableau de Bord',
                income: 'Revenus',
                expenses: 'DÃ©penses',
                receivables: 'Ã€ Recevoir',
                payables: 'Ã€ Payer',
                plans: 'Plans Futurs',
                budgets: 'Budgets',
                categories: 'CatÃ©gories',
                category: 'CatÃ©gorie',
                reports: 'Rapports',
                analytics: 'Analyses',
                templates: 'ModÃ¨les',
                accounts: 'Comptes',
                debts: 'Dettes',
                goals: 'Objectifs',
                recurring: 'RÃ©current',
                calendar: 'Calendrier',
                cashflow: 'Flux de TrÃ©sorerie',
                investments: 'Investissements',
                settings: 'ParamÃ¨tres',
                bill_details: 'DÃ©tails de la Facture',
                amount: 'Montant',
                due_date: 'Date d\'Ã‰chÃ©ance',
                status: 'Statut',
                description: 'Description',
                priority: 'PrioritÃ©',
                type: 'Type',
                paid: 'PayÃ©',
                unpaid: 'Non PayÃ©',
                high: 'Ã‰levÃ©',
                medium: 'Moyen',
                low: 'Faible',
                today: 'Aujourd\'hui',
                tomorrow: 'Demain',
                days: 'jours',
                close: 'Fermer',
                refresh: 'Actualiser',
                export: 'Exporter',
                disconnect: 'DÃ©connecter',
                dark_mode: 'Mode Sombre',
                income_sources: 'Sources de Revenus',
                date: 'Date',
                source: 'Source',
                actions: 'Actions',
                details: 'DÃ©tails',
                from: 'De',
                to: 'Ã€',
                search: 'Rechercher...',
                from_date: 'Date de dÃ©but',
                to_date: 'Date de fin',
                sort_by: 'Trier par...',
                total_income: 'Revenus Totaux',
                total_expenses: 'DÃ©penses Totales',
                net_balance: 'Solde Net',
                this_month_income: 'Revenus du Mois',
                this_month_expenses: 'DÃ©penses du Mois',
                this_month_balance: 'Solde du Mois',
                total_savings: 'Ã‰pargne Totale',
                due_receivables: 'Ã€ Recevoir',
                due_payables: 'Ã€ Payer',
                loading_reminders: 'Chargement des rappels...',
                no_items: 'Aucun Ã©lÃ©ment',
                saved_successfully: 'EnregistrÃ© avec succÃ¨s!',
                connected_to: 'ConnectÃ© Ã ',
                disconnected: 'DÃ©connectÃ©',
                please_connect: 'Veuillez connecter le fichier Excel.',
                upcoming_bills: 'Factures et Rappels Ã  Venir',
                monthly_comparison: 'Comparaison Mensuelle',
                financial_health_score: 'Score de SantÃ© FinanciÃ¨re',
                savings_rate: 'Taux d\'Ã‰pargne',
                expense_ratio: 'Ratio de DÃ©penses',
                average_monthly_expense: 'DÃ©pense Mensuelle Moyenne',
                average_monthly_income: 'Revenu Mensuel Moyen',
                top_spending_category: 'CatÃ©gorie de DÃ©pense Principale',
                average_transaction_size: 'Taille Moyenne de Transaction',
                monthly_savings: 'Ã‰pargne Mensuelle',
                transaction_count: 'Nombre de Transactions',
                income_vs_expenses_trend: 'Tendance Revenus vs DÃ©penses',
                cash_flow: 'Flux de TrÃ©sorerie',
                expense_categories: 'CatÃ©gories de DÃ©penses',
                income_categories: 'CatÃ©gories de Revenus',
                all_transactions: 'Toutes les transactions',
                not_enough_data: 'Pas assez de donnÃ©es pour comparer. Au moins 2 mois de donnÃ©es sont nÃ©cessaires.',
                no_upcoming_bills: 'Aucune facture Ã  venir dans les 7 prochains jours.',
                positive_monthly_savings: 'Ã‰pargne mensuelle positive',
                negative_monthly_savings: 'Ã‰pargne mensuelle nÃ©gative',
                income_comma_expenses: 'revenus',
                expenses_word: 'dÃ©penses',
                item: 'Ã©lÃ©ment',
                items: 'Ã©lÃ©ments',
                showing: 'Affichage',
                of: 'de',
                all_categories: 'Toutes les CatÃ©gories',
                no_data_found: 'Aucune donnÃ©e trouvÃ©e.',
                no_future_plans: 'Aucun plan futur trouvÃ©.',
                no_budgets_set: 'Aucun budget dÃ©fini. Ajoutez un budget pour suivre les limites de dÃ©penses.',
                excellent_health: 'Excellent - Excellente santÃ© financiÃ¨re!',
                good_health: 'Bien - Sur la bonne voie',
                fair_health: 'Moyen - Marge d\'amÃ©lioration',
                needs_attention: 'NÃ©cessite de l\'Attention - Examinez les habitudes de dÃ©penses',
                source: 'Source',
                notes_optional: 'Notes (Optionnel)',
                recurring_transaction: 'Transaction RÃ©currente',
                frequency: 'FrÃ©quence',
                next_occurrence_date: 'Date de Prochaine Occurrence',
                payment_method: 'MÃ©thode de Paiement',
                select_method: 'SÃ©lectionner la MÃ©thode',
                cash: 'EspÃ¨ces',
                bank_transfer: 'Virement Bancaire',
                card: 'Carte',
                mobile_payment: 'Paiement Mobile',
                other: 'Autre',
                select_category: 'SÃ©lectionner la CatÃ©gorie',
                from_client: 'De (Client/Personne)',
                to_vendor: 'Ã€ (Fournisseur/Personne)',
                name_placeholder: 'Nom',
                reason: 'Raison',
                reminder_days_before: 'Rappel (Jours Avant l\'Ã‰chÃ©ance)',
                reminder_days_before_deadline: 'Rappel (Jours Avant la Date Limite)',
                plan_title: 'Titre du Plan',
                target_amount: 'Montant Cible',
                start_date: 'Date de DÃ©but',
                target_deadline: 'Date Limite Cible',
                notes: 'Notes',
                additional_notes: 'Notes supplÃ©mentaires...',
                optional_description: 'Description optionnelle',
                progress_note: 'Note: Le progrÃ¨s sera calculÃ© basÃ© sur l\'Ã‰pargne Totale (Revenus - DÃ©penses + Ã€ Recevoir).',
                reminder_help_text: 'Recevoir un rappel ce nombre de jours avant la date d\'Ã©chÃ©ance (0 = Ã  la date d\'Ã©chÃ©ance)',
                reminder_deadline_help: 'Recevoir un rappel ce nombre de jours avant la date limite (0 = Ã  la date limite)',
                type_cannot_change: 'Le type ne peut pas Ãªtre modifiÃ© aprÃ¨s la crÃ©ation',
                account_management: 'Gestion des Comptes',
                debt_tracker: 'Suivi des Dettes',
                financial_goals: 'Objectifs Financiers',
                account_name: 'Nom du Compte',
                account_type: 'Type de Compte',
                initial_balance: 'Solde Initial',
                debt_name: 'Nom de la Dette',
                debt_type: 'Type de Dette',
                principal_amount: 'Montant Principal',
                amount_paid: 'Montant PayÃ©',
                creditor_lender: 'CrÃ©ancier/PrÃªteur',
                goal_name: 'Nom de l\'Objectif',
                current_amount: 'Montant Actuel',
                deadline: 'Date Limite',
                template_name: 'Nom du ModÃ¨le',
                transaction_type: 'Type de Transaction',
                recurring_only: 'RÃ©currentes Uniquement',
                non_recurring: 'Non RÃ©currentes',
                all_status: 'Tous les Statuts',
                color: 'Couleur',
                manage_categories: 'GÃ©rer les CatÃ©gories',
                recurring_transactions_manager: 'Gestionnaire de Transactions RÃ©currentes',
                auto_generate_info: 'GÃ©nÃ©rer Automatiquement les Transactions RÃ©currentes',
                auto_generate_desc: 'Cela crÃ©era automatiquement des transactions pour tous les Ã©lÃ©ments rÃ©currents basÃ©s sur leur frÃ©quence et leurs dates.',
                generate_recurring: 'GÃ©nÃ©rer les Transactions RÃ©currentes',
                low: 'Faible',
                medium: 'Moyen',
                high: 'Ã‰levÃ©',
                select_category_placeholder: 'SÃ©lectionner la CatÃ©gorie',
                add_new_item: 'Ajouter un Nouvel Ã‰lÃ©ment',
                new: 'Nouveau',
                loan: 'PrÃªt',
                mortgage: 'HypothÃ¨que',
                personal_loan: 'PrÃªt Personnel',
                savings: 'Ã‰pargne',
                bank: 'Banque'
            },
            de: {
                notifications: 'Benachrichtigungen',
                clear_all: 'Alle LÃ¶schen',
                no_notifications: 'Keine Benachrichtigungen',
                view: 'Anzeigen',
                edit: 'Bearbeiten',
                delete: 'LÃ¶schen',
                dashboard: 'Dashboard',
                income: 'Einkommen',
                expenses: 'Ausgaben',
                receivables: 'Forderungen',
                payables: 'Verbindlichkeiten',
                plans: 'ZukunftsplÃ¤ne',
                budgets: 'Budgets',
                categories: 'Kategorien',
                category: 'Kategorie',
                reports: 'Berichte',
                analytics: 'Analysen',
                templates: 'Vorlagen',
                accounts: 'Konten',
                debts: 'Schulden',
                goals: 'Ziele',
                recurring: 'Wiederkehrend',
                calendar: 'Kalender',
                cashflow: 'Cashflow',
                investments: 'Investitionen',
                settings: 'Einstellungen',
                bill_details: 'Rechnungsdetails',
                amount: 'Betrag',
                due_date: 'FÃ¤lligkeitsdatum',
                status: 'Status',
                description: 'Beschreibung',
                priority: 'PrioritÃ¤t',
                type: 'Typ',
                paid: 'Bezahlt',
                unpaid: 'Unbezahlt',
                high: 'Hoch',
                medium: 'Mittel',
                low: 'Niedrig',
                today: 'Heute',
                tomorrow: 'Morgen',
                days: 'Tage',
                close: 'SchlieÃŸen',
                refresh: 'Aktualisieren',
                export: 'Exportieren',
                disconnect: 'Trennen',
                dark_mode: 'Dunkler Modus',
                income_sources: 'Einkommensquellen',
                date: 'Datum',
                source: 'Quelle',
                actions: 'Aktionen',
                details: 'Details',
                from: 'Von',
                to: 'An',
                search: 'Suchen...',
                from_date: 'Von Datum',
                to_date: 'Bis Datum',
                sort_by: 'Sortieren nach...',
                total_income: 'Gesamteinkommen',
                total_expenses: 'Gesamtausgaben',
                net_balance: 'Netto-Guthaben',
                this_month_income: 'Einkommen diesen Monat',
                this_month_expenses: 'Ausgaben diesen Monat',
                this_month_balance: 'Guthaben diesen Monat',
                total_savings: 'Gesamtersparnisse',
                due_receivables: 'Offene Forderungen',
                due_payables: 'Offene Verbindlichkeiten',
                loading_reminders: 'Erinnerungen werden geladen...',
                no_items: 'Keine EintrÃ¤ge',
                saved_successfully: 'Erfolgreich gespeichert!',
                connected_to: 'Verbunden mit',
                disconnected: 'Getrennt',
                please_connect: 'Bitte Excel-Datei verbinden.',
                upcoming_bills: 'Bevorstehende Rechnungen & Erinnerungen',
                monthly_comparison: 'Monatlicher Vergleich',
                financial_health_score: 'Finanzgesundheitswert',
                savings_rate: 'Sparquote',
                expense_ratio: 'AusgabenverhÃ¤ltnis',
                average_monthly_expense: 'Durchschnittliche Monatsausgaben',
                average_monthly_income: 'Durchschnittliches Monatseinkommen',
                top_spending_category: 'Top Ausgabenkategorie',
                average_transaction_size: 'Durchschnittliche TransaktionsgrÃ¶ÃŸe',
                monthly_savings: 'Monatliche Ersparnisse',
                transaction_count: 'Anzahl der Transaktionen',
                income_vs_expenses_trend: 'Einnahmen vs Ausgaben Trend',
                cash_flow: 'Cashflow',
                expense_categories: 'Ausgabenkategorien',
                income_categories: 'Einkommenskategorien',
                all_transactions: 'Alle Transaktionen',
                not_enough_data: 'Nicht genug Daten zum Vergleichen. Mindestens 2 Monate Daten erforderlich.',
                no_upcoming_bills: 'Keine bevorstehenden Rechnungen in den nÃ¤chsten 7 Tagen.',
                positive_monthly_savings: 'Positive monatliche Ersparnisse',
                negative_monthly_savings: 'Negative monatliche Ersparnisse',
                income_comma_expenses: 'Einkommen',
                expenses_word: 'Ausgaben',
                item: 'Eintrag',
                items: 'EintrÃ¤ge',
                showing: 'Zeige',
                of: 'von',
                all_categories: 'Alle Kategorien',
                no_data_found: 'Keine Daten gefunden.',
                no_future_plans: 'Keine zukÃ¼nftigen PlÃ¤ne gefunden.',
                no_budgets_set: 'Keine Budgets festgelegt. FÃ¼gen Sie ein Budget hinzu, um Ausgabengrenzen zu verfolgen.',
                excellent_health: 'Ausgezeichnet - GroÃŸe finanzielle Gesundheit!',
                good_health: 'Gut - Auf dem richtigen Weg',
                fair_health: 'Ausreichend - Verbesserungspotenzial',
                needs_attention: 'BenÃ¶tigt Aufmerksamkeit - ÃœberprÃ¼fen Sie die Ausgabengewohnheiten'
            },
            hi: {
                notifications: 'à¤¸à¥‚à¤šà¤¨à¤¾à¤à¤‚',
                clear_all: 'à¤¸à¤­à¥€ à¤¸à¤¾à¤« à¤•à¤°à¥‡à¤‚',
                no_notifications: 'à¤•à¥‹à¤ˆ à¤¸à¥‚à¤šà¤¨à¤¾ à¤¨à¤¹à¥€à¤‚',
                view: 'à¤¦à¥‡à¤–à¥‡à¤‚',
                edit: 'à¤¸à¤‚à¤ªà¤¾à¤¦à¤¿à¤¤ à¤•à¤°à¥‡à¤‚',
                delete: 'à¤¹à¤Ÿà¤¾à¤à¤‚',
                dashboard: 'à¤¡à¥ˆà¤¶à¤¬à¥‹à¤°à¥à¤¡',
                income: 'à¤†à¤¯',
                expenses: 'à¤µà¥à¤¯à¤¯',
                receivables: 'à¤ªà¥à¤°à¤¾à¤ªà¥à¤¯',
                payables: 'à¤¦à¥‡à¤¯',
                plans: 'à¤­à¤µà¤¿à¤·à¥à¤¯ à¤•à¥€ à¤¯à¥‹à¤œà¤¨à¤¾à¤à¤‚',
                budgets: 'à¤¬à¤œà¤Ÿ',
                categories: 'à¤¶à¥à¤°à¥‡à¤£à¤¿à¤¯à¤¾à¤‚',
                category: 'à¤¶à¥à¤°à¥‡à¤£à¥€',
                reports: 'à¤°à¤¿à¤ªà¥‹à¤°à¥à¤Ÿ',
                analytics: 'à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£',
                templates: 'à¤Ÿà¥‡à¤®à¥à¤ªà¥à¤²à¥‡à¤Ÿ',
                accounts: 'à¤–à¤¾à¤¤à¥‡',
                debts: 'à¤‹à¤£',
                goals: 'à¤²à¤•à¥à¤·à¥à¤¯',
                recurring: 'à¤†à¤µà¤°à¥à¤¤à¥€',
                calendar: 'à¤•à¥ˆà¤²à¥‡à¤‚à¤¡à¤°',
                cashflow: 'à¤¨à¤•à¤¦à¥€ à¤ªà¥à¤°à¤µà¤¾à¤¹',
                investments: 'à¤¨à¤¿à¤µà¥‡à¤¶',
                settings: 'à¤¸à¥‡à¤Ÿà¤¿à¤‚à¤—à¥à¤¸',
                bill_details: 'à¤¬à¤¿à¤² à¤µà¤¿à¤µà¤°à¤£',
                amount: 'à¤°à¤¾à¤¶à¤¿',
                due_date: 'à¤¨à¤¿à¤¯à¤¤ à¤¤à¤¾à¤°à¥€à¤–',
                status: 'à¤¸à¥à¤¥à¤¿à¤¤à¤¿',
                description: 'à¤µà¤¿à¤µà¤°à¤£',
                priority: 'à¤ªà¥à¤°à¤¾à¤¥à¤®à¤¿à¤•à¤¤à¤¾',
                type: 'à¤ªà¥à¤°à¤•à¤¾à¤°',
                paid: 'à¤­à¥à¤—à¤¤à¤¾à¤¨ à¤•à¤¿à¤¯à¤¾',
                unpaid: 'à¤…à¤µà¥ˆà¤¤à¤¨à¤¿à¤•',
                high: 'à¤‰à¤šà¥à¤š',
                medium: 'à¤®à¤§à¥à¤¯à¤®',
                low: 'à¤¨à¤¿à¤®à¥à¤¨',
                today: 'à¤†à¤œ',
                tomorrow: 'à¤•à¤²',
                days: 'à¤¦à¤¿à¤¨',
                close: 'à¤¬à¤‚à¤¦ à¤•à¤°à¥‡à¤‚',
                refresh: 'à¤¤à¤¾à¤œà¤¼à¤¾ à¤•à¤°à¥‡à¤‚',
                export: 'à¤¨à¤¿à¤°à¥à¤¯à¤¾à¤¤',
                disconnect: 'à¤¡à¤¿à¤¸à¥à¤•à¤¨à¥‡à¤•à¥à¤Ÿ',
                dark_mode: 'à¤¡à¤¾à¤°à¥à¤• à¤®à¥‹à¤¡',
                income_sources: 'à¤†à¤¯ à¤•à¥‡ à¤¸à¥à¤°à¥‹à¤¤',
                date: 'à¤¤à¤¾à¤°à¥€à¤–',
                source: 'à¤¸à¥à¤°à¥‹à¤¤',
                actions: 'à¤•à¤¾à¤°à¥à¤°à¤µà¤¾à¤ˆ',
                details: 'à¤µà¤¿à¤µà¤°à¤£',
                from: 'à¤¸à¥‡',
                to: 'à¤•à¥‹',
                search: 'à¤–à¥‹à¤œà¥‡à¤‚...',
                from_date: 'à¤¶à¥à¤°à¥à¤†à¤¤à¥€ à¤¤à¤¾à¤°à¥€à¤–',
                to_date: 'à¤…à¤‚à¤¤à¤¿à¤® à¤¤à¤¾à¤°à¥€à¤–',
                sort_by: 'à¤•à¥à¤°à¤®à¤¬à¤¦à¥à¤§ à¤•à¤°à¥‡à¤‚...',
                total_income: 'à¤•à¥à¤² à¤†à¤¯',
                total_expenses: 'à¤•à¥à¤² à¤µà¥à¤¯à¤¯',
                net_balance: 'à¤¶à¥à¤¦à¥à¤§ à¤¶à¥‡à¤·',
                this_month_income: 'à¤‡à¤¸ à¤®à¤¹à¥€à¤¨à¥‡ à¤•à¥€ à¤†à¤¯',
                this_month_expenses: 'à¤‡à¤¸ à¤®à¤¹à¥€à¤¨à¥‡ à¤•à¤¾ à¤µà¥à¤¯à¤¯',
                this_month_balance: 'à¤‡à¤¸ à¤®à¤¹à¥€à¤¨à¥‡ à¤•à¤¾ à¤¶à¥‡à¤·',
                total_savings: 'à¤•à¥à¤² à¤¬à¤šà¤¤',
                due_receivables: 'à¤¦à¥‡à¤¯ à¤ªà¥à¤°à¤¾à¤ªà¥à¤¯',
                due_payables: 'à¤¦à¥‡à¤¯ à¤¦à¥‡à¤¯à¤¤à¤¾à¤à¤‚',
                loading_reminders: 'à¤°à¤¿à¤®à¤¾à¤‡à¤‚à¤¡à¤° à¤²à¥‹à¤¡ à¤¹à¥‹ à¤°à¤¹à¥‡ à¤¹à¥ˆà¤‚...',
                no_items: 'à¤•à¥‹à¤ˆ à¤†à¤‡à¤Ÿà¤® à¤¨à¤¹à¥€à¤‚',
                saved_successfully: 'à¤¸à¤«à¤²à¤¤à¤¾à¤ªà¥‚à¤°à¥à¤µà¤• à¤¸à¤¹à¥‡à¤œà¤¾ à¤—à¤¯à¤¾!',
                connected_to: 'à¤¸à¥‡ à¤œà¥à¤¡à¤¼à¤¾ à¤¹à¥à¤†',
                disconnected: 'à¤¡à¤¿à¤¸à¥à¤•à¤¨à¥‡à¤•à¥à¤Ÿ',
                please_connect: 'à¤•à¥ƒà¤ªà¤¯à¤¾ à¤à¤•à¥à¤¸à¥‡à¤² à¤«à¤¼à¤¾à¤‡à¤² à¤•à¤¨à¥‡à¤•à¥à¤Ÿ à¤•à¤°à¥‡à¤‚à¥¤',
                upcoming_bills: 'à¤†à¤—à¤¾à¤®à¥€ à¤¬à¤¿à¤² à¤”à¤° à¤°à¤¿à¤®à¤¾à¤‡à¤‚à¤¡à¤°',
                monthly_comparison: 'à¤®à¤¾à¤¸à¤¿à¤• à¤¤à¥à¤²à¤¨à¤¾',
                financial_health_score: 'à¤µà¤¿à¤¤à¥à¤¤à¥€à¤¯ à¤¸à¥à¤µà¤¾à¤¸à¥à¤¥à¥à¤¯ à¤¸à¥à¤•à¥‹à¤°',
                savings_rate: 'à¤¬à¤šà¤¤ à¤¦à¤°',
                expense_ratio: 'à¤µà¥à¤¯à¤¯ à¤…à¤¨à¥à¤ªà¤¾à¤¤',
                average_monthly_expense: 'à¤”à¤¸à¤¤ à¤®à¤¾à¤¸à¤¿à¤• à¤µà¥à¤¯à¤¯',
                average_monthly_income: 'à¤”à¤¸à¤¤ à¤®à¤¾à¤¸à¤¿à¤• à¤†à¤¯',
                top_spending_category: 'à¤¶à¥€à¤°à¥à¤· à¤µà¥à¤¯à¤¯ à¤¶à¥à¤°à¥‡à¤£à¥€',
                average_transaction_size: 'à¤”à¤¸à¤¤ à¤²à¥‡à¤¨à¤¦à¥‡à¤¨ à¤†à¤•à¤¾à¤°',
                monthly_savings: 'à¤®à¤¾à¤¸à¤¿à¤• à¤¬à¤šà¤¤',
                transaction_count: 'à¤²à¥‡à¤¨à¤¦à¥‡à¤¨ à¤•à¥€ à¤¸à¤‚à¤–à¥à¤¯à¤¾',
                income_vs_expenses_trend: 'à¤†à¤¯ à¤¬à¤¨à¤¾à¤® à¤µà¥à¤¯à¤¯ à¤ªà¥à¤°à¤µà¥ƒà¤¤à¥à¤¤à¤¿',
                cash_flow: 'à¤¨à¤•à¤¦à¥€ à¤ªà¥à¤°à¤µà¤¾à¤¹',
                expense_categories: 'à¤µà¥à¤¯à¤¯ à¤¶à¥à¤°à¥‡à¤£à¤¿à¤¯à¤¾à¤‚',
                income_categories: 'à¤†à¤¯ à¤¶à¥à¤°à¥‡à¤£à¤¿à¤¯à¤¾à¤‚',
                all_transactions: 'à¤¸à¤­à¥€ à¤²à¥‡à¤¨à¤¦à¥‡à¤¨',
                not_enough_data: 'à¤¤à¥à¤²à¤¨à¤¾ à¤•à¥‡ à¤²à¤¿à¤ à¤ªà¤°à¥à¤¯à¤¾à¤ªà¥à¤¤ à¤¡à¥‡à¤Ÿà¤¾ à¤¨à¤¹à¥€à¤‚ à¤¹à¥ˆà¥¤ à¤•à¤® à¤¸à¥‡ à¤•à¤® 2 à¤®à¤¹à¥€à¤¨à¥‡ à¤•à¤¾ à¤¡à¥‡à¤Ÿà¤¾ à¤†à¤µà¤¶à¥à¤¯à¤• à¤¹à¥ˆà¥¤',
                no_upcoming_bills: 'à¤…à¤—à¤²à¥‡ 7 à¤¦à¤¿à¤¨à¥‹à¤‚ à¤®à¥‡à¤‚ à¤•à¥‹à¤ˆ à¤†à¤—à¤¾à¤®à¥€ à¤¬à¤¿à¤² à¤¨à¤¹à¥€à¤‚à¥¤',
                positive_monthly_savings: 'à¤¸à¤•à¤¾à¤°à¤¾à¤¤à¥à¤®à¤• à¤®à¤¾à¤¸à¤¿à¤• à¤¬à¤šà¤¤',
                negative_monthly_savings: 'à¤¨à¤•à¤¾à¤°à¤¾à¤¤à¥à¤®à¤• à¤®à¤¾à¤¸à¤¿à¤• à¤¬à¤šà¤¤',
                income_comma_expenses: 'à¤†à¤¯',
                expenses_word: 'à¤µà¥à¤¯à¤¯',
                item: 'à¤†à¤‡à¤Ÿà¤®',
                items: 'à¤†à¤‡à¤Ÿà¤®',
                showing: 'à¤¦à¤¿à¤–à¤¾ à¤°à¤¹à¤¾ à¤¹à¥ˆ',
                of: 'à¤•à¤¾',
                all_categories: 'à¤¸à¤­à¥€ à¤¶à¥à¤°à¥‡à¤£à¤¿à¤¯à¤¾à¤‚',
                no_data_found: 'à¤•à¥‹à¤ˆ à¤¡à¥‡à¤Ÿà¤¾ à¤¨à¤¹à¥€à¤‚ à¤®à¤¿à¤²à¤¾à¥¤',
                no_future_plans: 'à¤•à¥‹à¤ˆ à¤­à¤µà¤¿à¤·à¥à¤¯ à¤•à¥€ à¤¯à¥‹à¤œà¤¨à¤¾à¤à¤‚ à¤¨à¤¹à¥€à¤‚ à¤®à¤¿à¤²à¥€à¤‚à¥¤',
                no_budgets_set: 'à¤•à¥‹à¤ˆ à¤¬à¤œà¤Ÿ à¤¸à¥‡à¤Ÿ à¤¨à¤¹à¥€à¤‚ à¤•à¤¿à¤¯à¤¾ à¤—à¤¯à¤¾à¥¤ à¤–à¤°à¥à¤š à¤¸à¥€à¤®à¤¾ à¤Ÿà¥à¤°à¥ˆà¤• à¤•à¤°à¤¨à¥‡ à¤•à¥‡ à¤²à¤¿à¤ à¤à¤• à¤¬à¤œà¤Ÿ à¤œà¥‹à¤¡à¤¼à¥‡à¤‚à¥¤',
                excellent_health: 'à¤‰à¤¤à¥à¤•à¥ƒà¤·à¥à¤Ÿ - à¤®à¤¹à¤¾à¤¨ à¤µà¤¿à¤¤à¥à¤¤à¥€à¤¯ à¤¸à¥à¤µà¤¾à¤¸à¥à¤¥à¥à¤¯!',
                good_health: 'à¤…à¤šà¥à¤›à¤¾ - à¤¸à¤¹à¥€ à¤°à¤¾à¤¸à¥à¤¤à¥‡ à¤ªà¤°',
                fair_health: 'à¤¨à¤¿à¤·à¥à¤ªà¤•à¥à¤· - à¤¸à¥à¤§à¤¾à¤° à¤•à¥‡ à¤²à¤¿à¤ à¤œà¤—à¤¹',
                needs_attention: 'à¤§à¥à¤¯à¤¾à¤¨ à¤•à¥€ à¤†à¤µà¤¶à¥à¤¯à¤•à¤¤à¤¾ - à¤–à¤°à¥à¤š à¤•à¥€ à¤†à¤¦à¤¤à¥‹à¤‚ à¤•à¥€ à¤¸à¤®à¥€à¤•à¥à¤·à¤¾ à¤•à¤°à¥‡à¤‚'
            },
            ar: {
                notifications: 'Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª',
                clear_all: 'Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„',
                no_notifications: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª',
                view: 'Ø¹Ø±Ø¶',
                edit: 'ØªØ¹Ø¯ÙŠÙ„',
                delete: 'Ø­Ø°Ù',
                dashboard: 'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…',
                income: 'Ø§Ù„Ø¯Ø®Ù„',
                expenses: 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª',
                receivables: 'Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø§Øª',
                payables: 'Ø§Ù„Ø°Ù…Ù… Ø§Ù„Ø¯Ø§Ø¦Ù†Ø©',
                plans: 'Ø§Ù„Ø®Ø·Ø· Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ©',
                budgets: 'Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª',
                categories: 'Ø§Ù„ÙØ¦Ø§Øª',
                category: 'Ø§Ù„ÙØ¦Ø©',
                reports: 'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±',
                analytics: 'Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª',
                templates: 'Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨',
                accounts: 'Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª',
                debts: 'Ø§Ù„Ø¯ÙŠÙˆÙ†',
                goals: 'Ø§Ù„Ø£Ù‡Ø¯Ø§Ù',
                recurring: 'Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©',
                calendar: 'Ø§Ù„ØªÙ‚ÙˆÙŠÙ…',
                cashflow: 'Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ù†Ù‚Ø¯ÙŠ',
                investments: 'Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±Ø§Øª',
                settings: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª',
                bill_details: 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©',
                amount: 'Ø§Ù„Ù…Ø¨Ù„Øº',
                due_date: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚',
                status: 'Ø§Ù„Ø­Ø§Ù„Ø©',
                description: 'Ø§Ù„ÙˆØµÙ',
                priority: 'Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©',
                type: 'Ø§Ù„Ù†ÙˆØ¹',
                paid: 'Ù…Ø¯ÙÙˆØ¹',
                unpaid: 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹',
                high: 'Ø¹Ø§Ù„ÙŠ',
                medium: 'Ù…ØªÙˆØ³Ø·',
                low: 'Ù…Ù†Ø®ÙØ¶',
                today: 'Ø§Ù„ÙŠÙˆÙ…',
                tomorrow: 'ØºØ¯Ø§Ù‹',
                days: 'Ø£ÙŠØ§Ù…',
                close: 'Ø¥ØºÙ„Ø§Ù‚',
                refresh: 'ØªØ­Ø¯ÙŠØ«',
                export: 'ØªØµØ¯ÙŠØ±',
                disconnect: 'Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„',
                dark_mode: 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†',
                income_sources: 'Ù…ØµØ§Ø¯Ø± Ø§Ù„Ø¯Ø®Ù„',
                date: 'Ø§Ù„ØªØ§Ø±ÙŠØ®',
                source: 'Ø§Ù„Ù…ØµØ¯Ø±',
                actions: 'Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª',
                details: 'Ø§Ù„ØªÙØ§ØµÙŠÙ„',
                from: 'Ù…Ù†',
                to: 'Ø¥Ù„Ù‰',
                search: 'Ø¨Ø­Ø«...',
                from_date: 'Ù…Ù† ØªØ§Ø±ÙŠØ®',
                to_date: 'Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®',
                sort_by: 'ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨...',
                total_income: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø®Ù„',
                total_expenses: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª',
                net_balance: 'Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ØµØ§ÙÙŠ',
                this_month_income: 'Ø¯Ø®Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±',
                this_month_expenses: 'Ù…ØµØ±ÙˆÙØ§Øª Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±',
                this_month_balance: 'Ø±ØµÙŠØ¯ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±',
                total_savings: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯Ø®Ø±Ø§Øª',
                due_receivables: 'Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø§Øª',
                due_payables: 'Ø§Ù„Ø°Ù…Ù… Ø§Ù„Ø¯Ø§Ø¦Ù†Ø©',
                loading_reminders: 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª...',
                no_items: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ±',
                saved_successfully: 'ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!',
                connected_to: 'Ù…ØªØµÙ„ Ø¨Ù€',
                disconnected: 'ØºÙŠØ± Ù…ØªØµÙ„',
                please_connect: 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù…Ù„Ù Excel.',
                upcoming_bills: 'Ø§Ù„ÙÙˆØ§ØªÙŠØ± ÙˆØ§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©',
                monthly_comparison: 'Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©',
                financial_health_score: 'Ù†Ù‚Ø§Ø· Ø§Ù„ØµØ­Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©',
                savings_rate: 'Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø§Ø¯Ø®Ø§Ø±',
                expense_ratio: 'Ù†Ø³Ø¨Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª',
                average_monthly_expense: 'Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©',
                average_monthly_income: 'Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø´Ù‡Ø±ÙŠ',
                top_spending_category: 'Ø£ÙØ¶Ù„ ÙØ¦Ø© Ø¥Ù†ÙØ§Ù‚',
                average_transaction_size: 'Ù…ØªÙˆØ³Ø· Ø­Ø¬Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©',
                monthly_savings: 'Ø§Ù„Ù…Ø¯Ø®Ø±Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©',
                transaction_count: 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª',
                income_vs_expenses_trend: 'Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø¯Ø®Ù„ Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª',
                cash_flow: 'Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ù†Ù‚Ø¯ÙŠ',
                expense_categories: 'ÙØ¦Ø§Øª Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª',
                income_categories: 'ÙØ¦Ø§Øª Ø§Ù„Ø¯Ø®Ù„',
                all_transactions: 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª',
                not_enough_data: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ© Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©. Ù‡Ù†Ø§Ùƒ Ø­Ø§Ø¬Ø© Ø¥Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø´Ù‡Ø±ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.',
                no_upcoming_bills: 'Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù‚Ø§Ø¯Ù…Ø© ÙÙŠ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ø³Ø¨Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.',
                positive_monthly_savings: 'Ù…Ø¯Ø®Ø±Ø§Øª Ø´Ù‡Ø±ÙŠØ© Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ©',
                negative_monthly_savings: 'Ù…Ø¯Ø®Ø±Ø§Øª Ø´Ù‡Ø±ÙŠØ© Ø³Ù„Ø¨ÙŠØ©',
                income_comma_expenses: 'Ø¯Ø®Ù„',
                expenses_word: 'Ù…ØµØ±ÙˆÙØ§Øª',
                item: 'Ø¹Ù†ØµØ±',
                items: 'Ø¹Ù†Ø§ØµØ±',
                showing: 'Ø¹Ø±Ø¶',
                of: 'Ù…Ù†',
                all_categories: 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ¦Ø§Øª',
                no_data_found: 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª.',
                no_future_plans: 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø®Ø·Ø· Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ©.',
                no_budgets_set: 'Ù„Ù… ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª. Ø£Ø¶Ù Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ù„ØªØªØ¨Ø¹ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¥Ù†ÙØ§Ù‚.',
                excellent_health: 'Ù…Ù…ØªØ§Ø² - ØµØ­Ø© Ù…Ø§Ù„ÙŠØ© Ø±Ø§Ø¦Ø¹Ø©!',
                good_health: 'Ø¬ÙŠØ¯ - Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø§Ù„ØµØ­ÙŠØ­',
                fair_health: 'Ø¹Ø§Ø¯Ù„ - Ù…Ø¬Ø§Ù„ Ù„Ù„ØªØ­Ø³ÙŠÙ†',
                needs_attention: 'ÙŠØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù… - Ø±Ø§Ø¬Ø¹ Ø¹Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ù†ÙØ§Ù‚'
            },
            zh: {
                notifications: 'é€šçŸ¥',
                clear_all: 'æ¸…é™¤å…¨éƒ¨',
                no_notifications: 'æ— é€šçŸ¥',
                view: 'æŸ¥çœ‹',
                edit: 'ç¼–è¾‘',
                delete: 'åˆ é™¤',
                dashboard: 'ä»ªè¡¨æ¿',
                income: 'æ”¶å…¥',
                expenses: 'æ”¯å‡º',
                receivables: 'åº”æ”¶',
                payables: 'åº”ä»˜',
                plans: 'æœªæ¥è®¡åˆ’',
                budgets: 'é¢„ç®—',
                categories: 'ç±»åˆ«',
                category: 'ç±»åˆ«',
                reports: 'æŠ¥å‘Š',
                analytics: 'åˆ†æž',
                templates: 'æ¨¡æ¿',
                accounts: 'è´¦æˆ·',
                debts: 'å€ºåŠ¡',
                goals: 'ç›®æ ‡',
                recurring: 'å®šæœŸ',
                calendar: 'æ—¥åŽ†',
                cashflow: 'çŽ°é‡‘æµ',
                investments: 'æŠ•èµ„',
                settings: 'è®¾ç½®',
                bill_details: 'è´¦å•è¯¦æƒ…',
                amount: 'é‡‘é¢',
                due_date: 'åˆ°æœŸæ—¥',
                status: 'çŠ¶æ€',
                description: 'æè¿°',
                priority: 'ä¼˜å…ˆçº§',
                type: 'ç±»åž‹',
                paid: 'å·²ä»˜',
                unpaid: 'æœªä»˜',
                high: 'é«˜',
                medium: 'ä¸­',
                low: 'ä½Ž',
                today: 'ä»Šå¤©',
                tomorrow: 'æ˜Žå¤©',
                days: 'å¤©',
                close: 'å…³é—­',
                refresh: 'åˆ·æ–°',
                export: 'å¯¼å‡º',
                disconnect: 'æ–­å¼€è¿žæŽ¥',
                dark_mode: 'æ·±è‰²æ¨¡å¼',
                income_sources: 'æ”¶å…¥æ¥æº',
                date: 'æ—¥æœŸ',
                source: 'æ¥æº',
                actions: 'æ“ä½œ',
                details: 'è¯¦æƒ…',
                from: 'ä»Ž',
                to: 'åˆ°',
                search: 'æœç´¢...',
                from_date: 'å¼€å§‹æ—¥æœŸ',
                to_date: 'ç»“æŸæ—¥æœŸ',
                sort_by: 'æŽ’åº...',
                total_income: 'æ€»æ”¶å…¥',
                total_expenses: 'æ€»æ”¯å‡º',
                net_balance: 'å‡€ä½™é¢',
                this_month_income: 'æœ¬æœˆæ”¶å…¥',
                this_month_expenses: 'æœ¬æœˆæ”¯å‡º',
                this_month_balance: 'æœ¬æœˆä½™é¢',
                total_savings: 'æ€»å‚¨è“„',
                due_receivables: 'åº”æ”¶æ¬¾é¡¹',
                due_payables: 'åº”ä»˜æ¬¾é¡¹',
                loading_reminders: 'æ­£åœ¨åŠ è½½æé†’...',
                no_items: 'æ— é¡¹ç›®',
                saved_successfully: 'ä¿å­˜æˆåŠŸï¼',
                connected_to: 'å·²è¿žæŽ¥åˆ°',
                disconnected: 'å·²æ–­å¼€',
                please_connect: 'è¯·è¿žæŽ¥Excelæ–‡ä»¶ã€‚',
                upcoming_bills: 'å³å°†åˆ°æ¥çš„è´¦å•å’Œæé†’',
                monthly_comparison: 'æœˆåº¦æ¯”è¾ƒ',
                financial_health_score: 'è´¢åŠ¡å¥åº·è¯„åˆ†',
                savings_rate: 'å‚¨è“„çŽ‡',
                expense_ratio: 'æ”¯å‡ºæ¯”çŽ‡',
                average_monthly_expense: 'å¹³å‡æœˆæ”¯å‡º',
                average_monthly_income: 'å¹³å‡æœˆæ”¶å…¥',
                top_spending_category: 'æœ€é«˜æ”¯å‡ºç±»åˆ«',
                average_transaction_size: 'å¹³å‡äº¤æ˜“è§„æ¨¡',
                monthly_savings: 'æœˆåº¦å‚¨è“„',
                transaction_count: 'äº¤æ˜“æ•°é‡',
                income_vs_expenses_trend: 'æ”¶å…¥ä¸Žæ”¯å‡ºè¶‹åŠ¿',
                cash_flow: 'çŽ°é‡‘æµ',
                expense_categories: 'æ”¯å‡ºç±»åˆ«',
                income_categories: 'æ”¶å…¥ç±»åˆ«',
                all_transactions: 'æ‰€æœ‰äº¤æ˜“',
                not_enough_data: 'æ•°æ®ä¸è¶³ï¼Œæ— æ³•æ¯”è¾ƒã€‚è‡³å°‘éœ€è¦2ä¸ªæœˆçš„æ•°æ®ã€‚',
                no_upcoming_bills: 'æœªæ¥7å¤©å†…æ²¡æœ‰å³å°†åˆ°æ¥çš„è´¦å•ã€‚',
                positive_monthly_savings: 'æ­£æœˆåº¦å‚¨è“„',
                negative_monthly_savings: 'è´Ÿæœˆåº¦å‚¨è“„',
                income_comma_expenses: 'æ”¶å…¥',
                expenses_word: 'æ”¯å‡º',
                item: 'é¡¹ç›®',
                items: 'é¡¹ç›®',
                showing: 'æ˜¾ç¤º',
                of: 'å…±',
                all_categories: 'æ‰€æœ‰ç±»åˆ«',
                no_data_found: 'æœªæ‰¾åˆ°æ•°æ®ã€‚',
                no_future_plans: 'æœªæ‰¾åˆ°æœªæ¥è®¡åˆ’ã€‚',
                no_budgets_set: 'æœªè®¾ç½®é¢„ç®—ã€‚æ·»åŠ é¢„ç®—ä»¥è·Ÿè¸ªæ”¯å‡ºé™é¢ã€‚',
                excellent_health: 'ä¼˜ç§€ - è´¢åŠ¡çŠ¶å†µè‰¯å¥½ï¼',
                good_health: 'è‰¯å¥½ - æ­¥å…¥æ­£è½¨',
                fair_health: 'ä¸€èˆ¬ - æœ‰æ”¹è¿›ç©ºé—´',
                needs_attention: 'éœ€è¦æ³¨æ„ - å®¡æŸ¥æ”¯å‡ºä¹ æƒ¯'
            }
        };

        let currentLanguage = localStorage.getItem('finance-manager-language') || 'en';

        function changeLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('finance-manager-language', lang);
            const langSelector = document.getElementById('language-selector');
            const langSelectorMobile = document.getElementById('language-selector-mobile');
            if (langSelector) langSelector.value = lang;
            if (langSelectorMobile) langSelectorMobile.value = lang;
            
            // Re-render current view to regenerate all dynamic content with new language
            const activeTab = document.querySelector('.nav-tab.active');
            if (activeTab && activeTab.getAttribute('onclick')) {
                const onclickAttr = activeTab.getAttribute('onclick');
                const match = onclickAttr.match(/switchTab\('([^']+)'\)/);
                if (match && match[1]) {
                    // Re-render the current tab to regenerate all content with new language
                    switchTab(match[1]);
                } else {
                    translatePage();
                    // Also trigger a delayed translation in case some content loads later
                    setTimeout(() => translatePage(), 200);
                }
            } else {
                // No active tab found, just translate current content and render dashboard
                translatePage();
                switchTab('dashboard');
            }
            
            // Final translation pass after everything is rendered
            setTimeout(() => translatePage(), 300);
        }

        function translatePage() {
            // Translate elements with data-translate attribute
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    const translation = translations[currentLanguage][key];
                    // For nav tabs, preserve emoji if present
                    if (el.classList.contains('nav-tab')) {
                        const emoji = el.textContent.match(/^[\u{1F300}-\u{1F9FF}]/u)?.[0] || '';
                        el.textContent = emoji + translation;
                    } else {
                        el.textContent = translation;
                    }
                }
            });

            // Translate common text patterns
            const textMappings = {
                'Dashboard': 'dashboard',
                'Income': 'income',
                'Expenses': 'expenses',
                'Due (Receivables)': 'receivables',
                'Receivables (Due)': 'receivables',
                'Payables': 'payables',
                'Future Plans': 'plans',
                'Budgets': 'budgets',
                'Categories': 'categories',
                'Reports': 'reports',
                'Analytics': 'analytics',
                'Templates': 'templates',
                'Accounts': 'accounts',
                'Debts': 'debts',
                'Recurring': 'recurring',
                'Calendar': 'calendar',
                'Cash Flow': 'cashflow',
                'Investments': 'investments',
                'Settings': 'settings',
                'View': 'view',
                'Edit': 'edit',
                'Delete': 'delete',
                'Close': 'close',
                'Refresh': 'refresh',
                'Export': 'export',
                'Disconnect': 'disconnect',
                'Dark Mode': 'dark_mode',
                'Notifications': 'notifications',
                'Clear All': 'clear_all',
                'No notifications': 'no_notifications',
                'Bill Details': 'bill_details',
                'Amount': 'amount',
                'Due Date': 'due_date',
                'Status': 'status',
                'Description': 'description',
                'Priority': 'priority',
                'Type': 'type',
                'Paid': 'paid',
                'Unpaid': 'unpaid',
                'High': 'high',
                'Medium': 'medium',
                'Low': 'low',
                'Today': 'today',
                'Tomorrow': 'tomorrow',
                'Income Sources': 'income_sources',
                'Date': 'date',
                'Source': 'source',
                'Actions': 'actions',
                'Details': 'details',
                'From': 'from',
                'To': 'to',
                'Search...': 'search',
                'From Date': 'from_date',
                'To Date': 'to_date',
                'Sort by...': 'sort_by',
                'Total Income': 'total_income',
                'Total Expenses': 'total_expenses',
                'Net Balance': 'net_balance',
                'This Month Income': 'this_month_income',
                'This Month Expenses': 'this_month_expenses',
                'This Month Balance': 'this_month_balance',
                'Total Savings': 'total_savings',
                'Due Receivables': 'due_receivables',
                'Due Payables': 'due_payables',
                'Loading reminders...': 'loading_reminders',
                'No items': 'no_items',
                'Saved successfully!': 'saved_successfully',
                'Connected to': 'connected_to',
                'Disconnected': 'disconnected',
                'Please connect Excel file.': 'please_connect',
                'Upcoming Bills & Reminders': 'upcoming_bills',
                'Monthly Comparison': 'monthly_comparison',
                'Financial Health Score': 'financial_health_score',
                'Savings Rate': 'savings_rate',
                'Expense Ratio': 'expense_ratio',
                'Average Monthly Expense': 'average_monthly_expense',
                'Average Monthly Income': 'average_monthly_income',
                'Top Spending Category': 'top_spending_category',
                'Average Transaction Size': 'average_transaction_size',
                'Monthly Savings': 'monthly_savings',
                'Transaction Count': 'transaction_count',
                'Income vs Expenses Trend': 'income_vs_expenses_trend',
                'Cash Flow': 'cash_flow',
                'Expense Categories': 'expense_categories',
                'Income Categories': 'income_categories',
                'All transactions': 'all_transactions',
                'Not enough data for comparison. Need at least 2 months of data.': 'not_enough_data',
                'No upcoming bills in the next 7 days.': 'no_upcoming_bills',
                'Positive monthly savings': 'positive_monthly_savings',
                'Negative monthly savings': 'negative_monthly_savings',
                'All Categories': 'all_categories',
                'No data found.': 'no_data_found',
                'No future plans found.': 'no_future_plans',
                'No budgets set. Add a budget to track spending limits.': 'no_budgets_set',
                'Excellent - Great financial health!': 'excellent_health',
                'Good - On the right track': 'good_health',
                'Fair - Room for improvement': 'fair_health',
                'Needs Attention - Review spending habits': 'needs_attention',
                'Clear Filters': 'clear_filters',
                'All Types': 'all_types',
                'Recurring Only': 'recurring_only',
                'Non-Recurring': 'non_recurring',
                'Account': 'account',
                'Transfers': 'transfers',
                'Transfer': 'transfer',
                'Account Transfers': 'account_transfers',
                'Future Plans & Goals': 'plans',
                'Budget Tracking': 'budgets',
                'Financial Reports': 'reports',
                'Financial Calendar': 'calendar',
                'Recurring Transactions Manager': 'recurring_transactions_manager',
                'Generate Recurring Transactions': 'generate_recurring_transactions',
                'Next Occurrence Date': 'next_occurrence_date',
                'Update Progress': 'update_progress',
                'Payment': 'payment_method',
                'From Account': 'from_account',
                'To Account': 'to_account'
            };

            // Translate buttons, labels, and headings
            document.querySelectorAll('button, label, h1, h2, h3, .btn, .form-label').forEach(el => {
                const text = el.textContent.trim();
                if (textMappings[text] && translations[currentLanguage] && translations[currentLanguage][textMappings[text]]) {
                    // Skip if element has data-translate (already handled)
                    if (!el.hasAttribute('data-translate')) {
                        const originalText = el.textContent;
                        const emoji = originalText.match(/^[\u{1F300}-\u{1F9FF}]/u)?.[0] || '';
                        const translation = translations[currentLanguage][textMappings[text]];
                        // Preserve emoji if present
                        if (emoji) {
                            el.textContent = emoji + ' ' + translation;
                        } else {
                            el.textContent = translation;
                        }
                    }
                }
            });

            // Translate table headers (th elements)
            document.querySelectorAll('th').forEach(el => {
                const text = el.textContent.trim();
                if (text && textMappings[text] && translations[currentLanguage] && translations[currentLanguage][textMappings[text]]) {
                    // Skip if it's a checkbox or has data-translate
                    if (!el.querySelector('input') && !el.hasAttribute('data-translate')) {
                        el.textContent = translations[currentLanguage][textMappings[text]];
                    }
                }
            });

            // Translate common table header texts that might be in the textMappings
            const tableHeaderMappings = {
                'Date': 'date',
                'Source': 'source',
                'Category': 'category',
                'Amount': 'amount',
                'Actions': 'actions',
                'Due Date': 'due_date',
                'From': 'from',
                'To': 'to',
                'Status': 'status',
                'Priority': 'priority',
                'Description': 'description',
                'Details': 'details',
                'Type': 'type'
            };

            // Add table header mappings to textMappings if not already present
            Object.keys(tableHeaderMappings).forEach(key => {
                if (!textMappings[key]) {
                    textMappings[key] = tableHeaderMappings[key];
                }
            });

            // Translate placeholder text with data-translate-placeholder attribute
            document.querySelectorAll('input[data-translate-placeholder], textarea[data-translate-placeholder]').forEach(el => {
                const key = el.getAttribute('data-translate-placeholder');
                if (key && translations[currentLanguage] && translations[currentLanguage][key]) {
                    el.setAttribute('placeholder', translations[currentLanguage][key]);
                }
            });
            
            // Also translate regular placeholders
            document.querySelectorAll('input[placeholder], textarea[placeholder]').forEach(el => {
                if (!el.hasAttribute('data-translate-placeholder')) {
                    const placeholder = el.getAttribute('placeholder');
                    if (placeholder && textMappings[placeholder] && translations[currentLanguage] && translations[currentLanguage][textMappings[placeholder]]) {
                        el.setAttribute('placeholder', translations[currentLanguage][textMappings[placeholder]]);
                    }
                }
            });
            
            // Translate .stat-label, .insight-title, .chart-title, .insight-trend elements
            document.querySelectorAll('.stat-label, .insight-title, .chart-title, .insight-trend').forEach(el => {
                const text = el.textContent.trim();
                if (text && textMappings[text] && translations[currentLanguage] && translations[currentLanguage][textMappings[text]]) {
                    if (!el.hasAttribute('data-translate')) {
                        el.textContent = translations[currentLanguage][textMappings[text]];
                    }
                }
            });
            
            // Translate h2 elements (handle emoji prefixes)
            document.querySelectorAll('h2').forEach(el => {
                if (!el.querySelector('[data-translate]')) {
                    const text = el.textContent.trim();
                    // Remove emoji for matching
                    const textWithoutEmoji = text.replace(/^[\u{1F300}-\u{1F9FF}]\s*/u, '').trim();
                    if (textWithoutEmoji && textMappings[textWithoutEmoji] && translations[currentLanguage] && translations[currentLanguage][textMappings[textWithoutEmoji]]) {
                        const emoji = text.match(/^[\u{1F300}-\u{1F9FF}]/u)?.[0] || '';
                        el.innerHTML = emoji ? `${emoji} ${translations[currentLanguage][textMappings[textWithoutEmoji]]}` : translations[currentLanguage][textMappings[textWithoutEmoji]];
                    }
                }
            });
            
            // Translate any span elements inside h2 that might have been missed
            document.querySelectorAll('h2 span[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    el.textContent = translations[currentLanguage][key];
                }
            });

            // Translate option text in selects
            document.querySelectorAll('select option').forEach(el => {
                const text = el.textContent.trim();
                if (textMappings[text] && translations[currentLanguage] && translations[currentLanguage][textMappings[text]]) {
                    const emoji = el.textContent.match(/^[\u{1F300}-\u{1F9FF}]/u)?.[0] || '';
                    const translation = translations[currentLanguage][textMappings[text]];
                    if (emoji) {
                        el.textContent = emoji + ' ' + translation;
                    } else {
                        el.textContent = translation;
                    }
                }
            });
            
            // Update notification badge counts
            updateNotificationBadge();
        }

        function toggleMobileMenu(event) {
            if (event) {
                event.stopPropagation();
            }
            const dropdown = document.getElementById('mobile-menu-dropdown');
            const notificationDropdown = document.getElementById('notification-dropdown-mobile');
            if (notificationDropdown) notificationDropdown.style.display = 'none';
            if (dropdown) {
                const isShowing = dropdown.classList.contains('show');
                if (isShowing) {
                    dropdown.classList.remove('show');
                } else {
                    dropdown.classList.add('show');
                }
            }
        }

        function closeMobileMenuHeader() {
            const dropdown = document.getElementById('mobile-menu-dropdown');
            if (dropdown) {
                dropdown.classList.remove('show');
            }
        }

        // Close mobile menu when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('mobile-menu-dropdown');
            const btn = document.getElementById('mobile-menu-btn');
            if (dropdown && btn && !dropdown.contains(e.target) && !btn.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        function t(key) {
            return translations[currentLanguage] && translations[currentLanguage][key] ? translations[currentLanguage][key] : key;
        }

        // --- NOTIFICATION SYSTEM ---
        let notifications = JSON.parse(localStorage.getItem('finance-manager-notifications') || '[]');

        function addNotification(type, title, message, data = {}) {
            const notification = {
                id: Date.now(),
                type: type, // 'info', 'warning', 'success', 'error'
                title: title,
                message: message,
                data: data,
                read: false,
                timestamp: new Date().toISOString()
            };
            notifications.unshift(notification);
            if (notifications.length > 50) notifications = notifications.slice(0, 50);
            localStorage.setItem('finance-manager-notifications', JSON.stringify(notifications));
            updateNotificationBadge();
            renderNotifications();
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notification-badge');
            const badgeMobile = document.getElementById('notification-badge-mobile');
            const unreadCount = notifications.filter(n => !n.read).length;
            const badgeText = unreadCount > 99 ? '99+' : unreadCount;
            
            if (badge) {
                if (unreadCount > 0) {
                    badge.textContent = badgeText;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            }
            
            if (badgeMobile) {
                if (unreadCount > 0) {
                    badgeMobile.textContent = badgeText;
                    badgeMobile.style.display = 'flex';
                } else {
                    badgeMobile.style.display = 'none';
                }
            }
        }

        function toggleNotifications() {
            const dropdown = document.getElementById('notification-dropdown');
            const mobileDropdown = document.getElementById('notification-dropdown-mobile');
            if (mobileDropdown) mobileDropdown.style.display = 'none';
            if (dropdown) {
                dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
                if (dropdown.style.display === 'block') {
                    renderNotifications();
                }
            }
        }

        function toggleNotificationsMobile(event) {
            if (event) {
                event.stopPropagation();
            }
            const dropdown = document.getElementById('notification-dropdown-mobile');
            const desktopDropdown = document.getElementById('notification-dropdown');
            const mobileMenu = document.getElementById('mobile-menu-dropdown');
            if (desktopDropdown) desktopDropdown.style.display = 'none';
            if (mobileMenu) mobileMenu.classList.remove('show');
            if (dropdown) {
                const isShowing = dropdown.style.display === 'block';
                dropdown.style.display = isShowing ? 'none' : 'block';
                if (!isShowing) {
                    renderNotificationsMobile();
                }
            }
        }

        function renderNotifications() {
            const container = document.getElementById('notification-list');
            if (!container) return;
            renderNotificationsToContainer(container);
        }

        function renderNotificationsMobile() {
            const container = document.getElementById('notification-list-mobile');
            if (!container) return;
            renderNotificationsToContainer(container);
        }

        function renderNotificationsToContainer(container) {
            if (notifications.length === 0) {
                container.innerHTML = `<div style="padding: 2rem; text-align: center; color: var(--text-light);">${t('no_notifications')}</div>`;
                return;
            }

            container.innerHTML = notifications.map(notif => {
                const date = new Date(notif.timestamp);
                const timeAgo = getTimeAgo(date);
                const typeColors = {
                    info: 'var(--primary)',
                    warning: 'var(--warning)',
                    success: 'var(--success)',
                    error: 'var(--danger)'
                };
                return `
                    <div style="padding: 0.75rem; border-bottom: 1px solid var(--border); cursor: pointer; background: ${notif.read ? 'transparent' : '#f0f9ff'};" onclick="markNotificationRead(${notif.id})">
                        <div style="display: flex; gap: 0.75rem;">
                            <div style="width: 8px; height: 8px; border-radius: 50%; background: ${typeColors[notif.type] || typeColors.info}; margin-top: 0.5rem; flex-shrink: 0;"></div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 0.25rem;">${notif.title}</div>
                                <div style="font-size: 0.875rem; color: var(--text-light);">${notif.message}</div>
                                <div style="font-size: 0.75rem; color: var(--text-light); margin-top: 0.25rem;">${timeAgo}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function markNotificationRead(id) {
            const notif = notifications.find(n => n.id === id);
            if (notif) {
                notif.read = true;
                localStorage.setItem('finance-manager-notifications', JSON.stringify(notifications));
                updateNotificationBadge();
                renderNotifications();
                renderNotificationsMobile();
            }
        }

        function clearAllNotifications() {
            notifications = [];
            localStorage.setItem('finance-manager-notifications', JSON.stringify(notifications));
            updateNotificationBadge();
            renderNotifications();
            renderNotificationsMobile();
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString();
        }

        // Close notification dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('notification-dropdown');
            const dropdownMobile = document.getElementById('notification-dropdown-mobile');
            const btn = document.getElementById('notification-btn');
            const btnMobile = document.getElementById('notification-btn-mobile');
            
            if (dropdown && btn && !dropdown.contains(e.target) && !btn.contains(e.target)) {
                dropdown.style.display = 'none';
            }
            if (dropdownMobile && btnMobile && !dropdownMobile.contains(e.target) && !btnMobile.contains(e.target)) {
                dropdownMobile.style.display = 'none';
            }
        });

        let state = {
            fileHandle: null,
            isConnected: false,
            data: {
                income: [],
                expenses: [],
                receivables: [],
                payables: [],
                plans: [],
                budgets: [],
                categories: [],
                templates: [],
                accounts: [],
                tags: [],
                transactionHistory: []
            },
            settings: {
                darkMode: false,
                currency: 'à§³',
                dateFormat: 'YYYY-MM-DD'
            }
        };

        // --- 2. EXCEL FILE SYSTEM LOGIC ---

        // Store file handle and metadata
        const STORAGE_KEY = 'finance_manager_file_handle';
        const STORAGE_METADATA_KEY = 'finance_manager_file_metadata';
        const STORAGE_DIRECTORY_KEY = 'finance_manager_directory_handle';

        // IndexedDB for storing file handle and directory handle
        let db = null;

        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('FinanceManagerDB', 2);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('fileHandle')) {
                        db.createObjectStore('fileHandle');
                    }
                    if (!db.objectStoreNames.contains('directoryHandle')) {
                        db.createObjectStore('directoryHandle');
                    }
                };
            });
        }

        async function saveFileHandle(fileHandle, directoryHandle = null) {
            try {
                // Store file handle in IndexedDB (for current session)
                if (!db) await initDB();
                const transaction = db.transaction(['fileHandle', 'directoryHandle'], 'readwrite');
                const fileStore = transaction.objectStore('fileHandle');
                await fileStore.put(fileHandle, 'handle');

                // Store directory handle if available
                if (directoryHandle) {
                    const dirStore = transaction.objectStore('directoryHandle');
                    await dirStore.put(directoryHandle, 'handle');
                }

                // Also store metadata in localStorage for persistence
                try {
                    const file = await fileHandle.getFile();
                    const metadata = {
                        name: file.name,
                        lastModified: file.lastModified,
                        size: file.size,
                        timestamp: Date.now()
                    };
                    localStorage.setItem(STORAGE_METADATA_KEY, JSON.stringify(metadata));
                } catch (err) {
                    console.error('Error saving file metadata:', err);
                }
            } catch (err) {
                console.error('Error saving file handle:', err);
            }
        }

        async function loadDirectoryHandle() {
            try {
                if (!db) await initDB();
                const transaction = db.transaction(['directoryHandle'], 'readonly');
                const store = transaction.objectStore('directoryHandle');
                return new Promise((resolve, reject) => {
                    const request = store.get('handle');
                    request.onsuccess = async () => {
                        const handle = request.result;
                        // Verify directory handle is still valid
                        if (handle) {
                            try {
                                // Try to verify by checking if we can query it
                                await handle.getDirectoryHandle('.');
                                resolve(handle);
                            } catch (err) {
                                // Handle is invalid, clear it
                                if (err.name === 'NotAllowedError' || err.name === 'NotFoundError' || err.name === 'InvalidStateError') {
                                    console.log('Directory handle is invalid, clearing');
                                    if (db) {
                                        const clearTransaction = db.transaction(['directoryHandle'], 'readwrite');
                                        const clearStore = clearTransaction.objectStore('directoryHandle');
                                        await clearStore.delete('handle');
                                    }
                                }
                                resolve(null);
                            }
                        } else {
                            resolve(null);
                        }
                    };
                    request.onerror = () => reject(request.error);
                });
            } catch (err) {
                console.error('Error loading directory handle:', err);
                return null;
            }
        }

        async function loadFileHandle() {
            try {
                if (!db) await initDB();
                const transaction = db.transaction(['fileHandle'], 'readonly');
                const store = transaction.objectStore('fileHandle');
                return new Promise((resolve, reject) => {
                    const request = store.get('handle');
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            } catch (err) {
                console.error('Error loading file handle:', err);
                return null;
            }
        }

        function getStoredFileMetadata() {
            try {
                const metadata = localStorage.getItem(STORAGE_METADATA_KEY);
                return metadata ? JSON.parse(metadata) : null;
            } catch (err) {
                console.error('Error loading file metadata:', err);
                return null;
            }
        }

        async function removeFileHandle() {
            try {
                if (!db) await initDB();
                const transaction = db.transaction(['fileHandle', 'directoryHandle'], 'readwrite');
                const fileStore = transaction.objectStore('fileHandle');
                const dirStore = transaction.objectStore('directoryHandle');
                await fileStore.delete('handle');
                await dirStore.delete('handle');
                localStorage.removeItem(STORAGE_METADATA_KEY);
            } catch (err) {
                console.error('Error removing file handle:', err);
            }
        }

        async function verifyFileHandle(fileHandle) {
            try {
                if (!fileHandle) return false;
                // Try to get the file to verify handle is still valid
                const file = await fileHandle.getFile();
                // Verify file name matches
                if (file.name !== CONFIG.fileName) {
                    return false;
                }
                return true;
            } catch (err) {
                // Handle specific errors - NotAllowedError means handle is stale/invalid
                if (err.name === 'NotAllowedError' || err.name === 'NotFoundError' || err.name === 'InvalidStateError') {
                    // File handle is invalid (likely from previous session)
                    console.log('File handle is invalid (stale from previous session)');
                    return false;
                }
                console.error('File handle verification failed:', err);
                return false;
            }
        }

        async function tryRestoreFileHandle(silent = false) {
            try {
                // First, try to restore from IndexedDB (might work if same session)
                const savedHandle = await loadFileHandle();
                if (savedHandle) {
                    const isValid = await verifyFileHandle(savedHandle);
                    if (isValid) {
                        return savedHandle;
                    } else {
                        // Handle is invalid, clear it from storage
                        console.log('Stored file handle is invalid, clearing from storage');
                        await removeFileHandle();
                    }
                }

                // If IndexedDB handle is invalid, check if we have metadata
                const metadata = getStoredFileMetadata();
                if (!metadata || metadata.name !== CONFIG.fileName) {
                    return null;
                }

                // Try to request the file again using permission persistence
                // The browser should remember the permission and make it easier
                if (window.showOpenFilePicker) {
                    try {
                        // Request the file - browser should remember permission
                        // If silent is true, we'll skip this (for auto-restore on page load)
                        if (silent) {
                            return null; // Don't show file picker automatically on page load
                        }

                        // Try to get directory handle to help browser remember location
                        let directoryHandle = null;
                        try {
                            directoryHandle = await loadDirectoryHandle();
                        } catch (err) {
                            console.log('Could not load directory handle:', err);
                        }

                        const pickerOptions = {
                            types: [{
                                description: 'Excel Files',
                                accept: { 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'] }
                            }],
                            multiple: false,
                            excludeAcceptAllOption: false
                        };

                        // Use directory handle if available to help browser remember location
                        if (directoryHandle) {
                            try {
                                // Verify directory handle is still valid
                                await directoryHandle.getDirectoryHandle('.');
                                pickerOptions.startIn = directoryHandle;
                            } catch (err) {
                                console.log('Directory handle is invalid:', err);
                                // Clear invalid directory handle
                                if (db) {
                                    const transaction = db.transaction(['directoryHandle'], 'readwrite');
                                    const dirStore = transaction.objectStore('directoryHandle');
                                    await dirStore.delete('handle');
                                }
                            }
                        }

                        const [fileHandle] = await window.showOpenFilePicker(pickerOptions);

                        // Verify it's the correct file
                        if (fileHandle.name === CONFIG.fileName) {
                            // Save the new handle with directory handle
                            await saveFileHandle(fileHandle, directoryHandle);
                            return fileHandle;
                        }
                    } catch (err) {
                        if (err.name === 'AbortError') {
                            // User cancelled, that's fine
                            return null;
                        }
                        console.error('Error restoring file handle:', err);
                    }
                }

                return null;
            } catch (err) {
                console.error('Error in tryRestoreFileHandle:', err);
                return null;
            }
        }

        async function connectExcelFile() {
            if (!window.showOpenFilePicker) {
                alert("Your browser does not support the File System Access API. Please use Chrome, Edge, or Opera on HTTPS/Localhost.");
                return;
            }

            try {
                // Check if we have stored metadata - try to reconnect automatically
                const metadata = getStoredFileMetadata();

                // If we have metadata, try to restore automatically first (non-silent mode)
                if (metadata && metadata.name === CONFIG.fileName) {
                    try {
                        const restoredHandle = await tryRestoreFileHandle(false); // false = show file picker if needed
                        if (restoredHandle && await verifyFileHandle(restoredHandle)) {
                            state.fileHandle = restoredHandle;
                            state.isConnected = true;
                            updateStatus(true);

                            await readExcelFile();
                            renderAll();

                            showToast('Reconnected to Excel file.', 'success');
                            return;
                        }
                    } catch (err) {
                        if (err.name === 'AbortError') {
                            // User cancelled file picker
                            return;
                        }
                        console.log('Auto-restore failed, showing file picker:', err);
                    }
                }

                // Show file picker (either no metadata or restore failed)
                const pickerOptions = {
                    types: [{
                        description: 'Excel Files',
                        accept: { 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'] }
                    }],
                    multiple: false,
                    excludeAcceptAllOption: false
                };

                // Try to use stored directory handle to help browser remember location
                const directoryHandle = await loadDirectoryHandle();
                if (directoryHandle) {
                    pickerOptions.startIn = directoryHandle;
                }

                [state.fileHandle] = await window.showOpenFilePicker(pickerOptions);

                if (state.fileHandle.name !== CONFIG.fileName) {
                    alert(`Please select the file named exactly: ${CONFIG.fileName}`);
                    state.fileHandle = null;
                    return;
                }

                // Try to get directory handle - use stored one or request new permission
                let directoryHandleToSave = directoryHandle;

                // If we don't have a directory handle, optionally request it
                // This helps remember the file location for future connections
                // Note: We'll skip this for now to avoid extra prompts, but the browser
                // will remember the last directory used in the file picker

                // Save file handle and metadata for next session
                await saveFileHandle(state.fileHandle, directoryHandleToSave);

                state.isConnected = true;
                updateStatus(true);

                // Load Data
                await readExcelFile();
                renderAll();

                showToast('Excel file connected successfully!', 'success');

            } catch (err) {
                console.error(err);
                if (err.name === 'AbortError') {
                    // User cancelled the file picker, just return silently
                    return;
                }
                alert('Error connecting to file: ' + err.message);
            }
        }

        // Helper function to request directory permission for better reconnection
        async function requestDirectoryPermission() {
            try {
                if (window.showDirectoryPicker) {
                    // Ask user to select the directory containing the Excel file
                    // This helps us remember the location for future connections
                    const directoryHandle = await window.showDirectoryPicker({
                        mode: 'read'
                    });
                    return directoryHandle;
                }
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error('Error requesting directory permission:', err);
                }
                return null;
            }
        }

        async function disconnectExcelFile() {
            if (confirm(t('are_you_sure_disconnect'))) {
                state.fileHandle = null;
                state.isConnected = false;
                await removeFileHandle();
                updateStatus(false);
                showToast('Disconnected from Excel file.', 'warning');
            }
        }

        async function restoreFileHandle(silent = true) {
            try {
                // Try to restore file handle (silent = true means don't show file picker automatically)
                const restoredHandle = await tryRestoreFileHandle(silent);

                if (restoredHandle && await verifyFileHandle(restoredHandle)) {
                    state.fileHandle = restoredHandle;
                    state.isConnected = true;
                    updateStatus(true);

                    // Load Data
                    await readExcelFile();
                    renderAll();

                    if (!silent) {
                        showToast('Restored connection to Excel file.', 'success');
                    }
                    return true;
                } else {
                    // No valid handle found, but keep metadata for manual reconnect
                    return false;
                }
            } catch (err) {
                console.error('Error restoring file handle:', err);
                return false;
            }
        }

        // Robust date parsing function - handles multiple formats
        function parseDate(dateValue) {
            if (!dateValue) return '';

            // Handle Date objects (from XLSX when raw: false)
            if (dateValue instanceof Date) {
                if (!isNaN(dateValue.getTime()) && dateValue.getFullYear() > 1900 && dateValue.getFullYear() < 2100) {
                    const year = dateValue.getFullYear();
                    const month = String(dateValue.getMonth() + 1).padStart(2, '0');
                    const day = String(dateValue.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
                return '';
            }

            // If it's already in ISO format (YYYY-MM-DD), return as is
            if (typeof dateValue === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateValue.trim())) {
                return dateValue.trim();
            }

            // Try to parse as date
            let date = null;

            // Handle Excel date serial numbers (if XLSX converts them)
            if (typeof dateValue === 'number') {
                // Excel date serial number (days since 1900-01-01)
                const excelEpoch = new Date(1899, 11, 30);
                date = new Date(excelEpoch.getTime() + dateValue * 24 * 60 * 60 * 1000);
            } else if (typeof dateValue === 'string') {
                const str = dateValue.trim();

                // Try multiple date formats
                const formats = [
                    // ISO formats
                    /^(\d{4})-(\d{1,2})-(\d{1,2})$/,  // YYYY-MM-DD
                    /^(\d{4})\/(\d{1,2})\/(\d{1,2})$/, // YYYY/MM/DD
                    /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/, // MM/DD/YYYY or DD/MM/YYYY
                    /^(\d{1,2})-(\d{1,2})-(\d{4})$/,  // DD-MM-YYYY or MM-DD-YYYY
                    // Text formats
                    /^(\d{1,2})\s+(january|february|march|april|may|june|july|august|september|october|november|december)\s+(\d{4})$/i, // DD Month YYYY
                    /^(january|february|march|april|may|june|july|august|september|october|november|december)\s+(\d{1,2}),?\s+(\d{4})$/i, // Month DD, YYYY
                    /^(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)\s+(\d{1,2}),?\s+(\d{4})$/i, // Mon DD, YYYY
                ];

                // Try ISO string parsing first
                date = new Date(str);
                if (!isNaN(date.getTime())) {
                    // Valid date, check if it's reasonable (not 1970)
                    if (date.getFullYear() > 1900 && date.getFullYear() < 2100) {
                        // Format as YYYY-MM-DD
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        return `${year}-${month}-${day}`;
                    }
                }

                // Try format-specific parsing
                const monthNames = ['january', 'february', 'march', 'april', 'may', 'june',
                    'july', 'august', 'september', 'october', 'november', 'december'];
                const monthShortNames = ['jan', 'feb', 'mar', 'apr', 'may', 'jun',
                    'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];

                // Format: DD Month YYYY or DD Mon YYYY
                let match = str.match(/^(\d{1,2})\s+(january|february|march|april|may|june|july|august|september|october|november|december|jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)\s+(\d{4})$/i);
                if (match) {
                    const day = parseInt(match[1]);
                    const monthName = match[2].toLowerCase();
                    const year = parseInt(match[3]);
                    let month = monthNames.indexOf(monthName);
                    if (month === -1) month = monthShortNames.indexOf(monthName);
                    if (month !== -1 && day >= 1 && day <= 31 && year >= 1900 && year <= 2100) {
                        return `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    }
                }

                // Format: Month DD, YYYY or Mon DD, YYYY
                match = str.match(/^(january|february|march|april|may|june|july|august|september|october|november|december|jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)\s+(\d{1,2}),?\s+(\d{4})$/i);
                if (match) {
                    const monthName = match[1].toLowerCase();
                    const day = parseInt(match[2]);
                    const year = parseInt(match[3]);
                    let month = monthNames.indexOf(monthName);
                    if (month === -1) month = monthShortNames.indexOf(monthName);
                    if (month !== -1 && day >= 1 && day <= 31 && year >= 1900 && year <= 2100) {
                        return `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    }
                }

                // Format: YYYY/MM/DD or YYYY-MM-DD
                match = str.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
                if (match) {
                    const year = parseInt(match[1]);
                    const month = parseInt(match[2]);
                    const day = parseInt(match[3]);
                    if (year >= 1900 && year <= 2100 && month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                        return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    }
                }

                // Format: DD/MM/YYYY or MM/DD/YYYY 
                // Prefer DD/MM/YYYY (more common international format)
                match = str.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
                if (match) {
                    const part1 = parseInt(match[1]);
                    const part2 = parseInt(match[2]);
                    const year = parseInt(match[3]);

                    // If both parts could be valid (e.g., 01/02/2025), prefer DD/MM/YYYY
                    // Try DD/MM/YYYY first (more common)
                    if (part1 >= 1 && part1 <= 31 && part2 >= 1 && part2 <= 12 && year >= 1900 && year <= 2100) {
                        // Validate it's a real date
                        const testDate = new Date(year, part2 - 1, part1);
                        if (testDate.getFullYear() === year && testDate.getMonth() === part2 - 1 && testDate.getDate() === part1) {
                            return `${year}-${String(part2).padStart(2, '0')}-${String(part1).padStart(2, '0')}`;
                        }
                    }
                    // Try MM/DD/YYYY as fallback
                    if (part1 >= 1 && part1 <= 12 && part2 >= 1 && part2 <= 31 && year >= 1900 && year <= 2100) {
                        const testDate = new Date(year, part1 - 1, part2);
                        if (testDate.getFullYear() === year && testDate.getMonth() === part1 - 1 && testDate.getDate() === part2) {
                            return `${year}-${String(part1).padStart(2, '0')}-${String(part2).padStart(2, '0')}`;
                        }
                    }
                }
            }

            // If all parsing fails, try native Date parsing as last resort
            if (!date) {
                date = new Date(dateValue);
            }

            if (date && !isNaN(date.getTime()) && date.getFullYear() > 1900 && date.getFullYear() < 2100) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            // Return empty string if parsing fails
            console.warn('Could not parse date:', dateValue);
            return '';
        }

        // Normalize numeric values - convert strings to numbers
        function parseNumber(value) {
            if (value === null || value === undefined || value === '') return 0;
            if (typeof value === 'number') return value;
            if (typeof value === 'string') {
                // Remove any currency symbols, commas, spaces
                const cleaned = value.toString().replace(/[à§³$â‚¬Â£,\s]/g, '').trim();
                const num = parseFloat(cleaned);
                return isNaN(num) ? 0 : num;
            }
            return 0;
        }

        // Normalize data from Excel sheet
        function normalizeSheetData(items, sheetType) {
            if (!Array.isArray(items)) return [];

            return items.map(item => {
                const normalized = { ...item };

                // Normalize dates based on sheet type
                if (sheetType === 'income' || sheetType === 'expenses') {
                    if (normalized.date) normalized.date = parseDate(normalized.date);
                } else if (sheetType === 'receivables' || sheetType === 'payables') {
                    if (normalized.dueDate) normalized.dueDate = parseDate(normalized.dueDate);
                } else if (sheetType === 'plans') {
                    if (normalized.deadline) normalized.deadline = parseDate(normalized.deadline);
                }

                // Normalize numeric amounts
                if ('amount' in normalized) {
                    normalized.amount = parseNumber(normalized.amount);
                }
                if ('targetAmount' in normalized) {
                    normalized.targetAmount = parseNumber(normalized.targetAmount);
                }

                // Normalize boolean values (recurring)
                if ('recurring' in normalized) {
                    if (typeof normalized.recurring === 'string') {
                        normalized.recurring = normalized.recurring.toLowerCase() === 'true' || normalized.recurring === '1' || normalized.recurring === 'yes';
                    } else {
                        normalized.recurring = Boolean(normalized.recurring);
                    }
                }

                // Trim string fields
                Object.keys(normalized).forEach(key => {
                    if (typeof normalized[key] === 'string') {
                        normalized[key] = normalized[key].trim();
                    }
                });

                return normalized;
            });
        }

        async function readExcelFile() {
            try {
                const file = await state.fileHandle.getFile();
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });

                const parseSheet = (name, sheetType) => {
                    try {
                        if (workbook.Sheets[name]) {
                            const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[name], {
                                defval: '', // Default value for empty cells
                                raw: false  // Convert dates and numbers
                            });
                            return normalizeSheetData(rawData, sheetType);
                        }
                        return [];
                    } catch (err) {
                        console.error(`Error parsing sheet "${name}":`, err);
                        return [];
                    }
                };

                // Map sheets to state data with proper normalization
                state.data.income = parseSheet('Income', 'income');
                state.data.expenses = parseSheet('Expenses', 'expenses');
                state.data.receivables = parseSheet('Receivables', 'receivables');
                state.data.payables = parseSheet('Payables', 'payables');
                state.data.plans = parseSheet('Plans', 'plans');
                state.data.budgets = parseSheet('Budgets', 'budgets') || [];
                state.data.categories = parseSheet('Categories', 'categories') || [];
                state.data.templates = parseSheet('Templates', 'templates') || [];
                state.data.accounts = parseSheet('Accounts', 'accounts') || [];
                state.data.debts = parseSheet('Debts', 'debts') || [];
                state.data.transfers = parseSheet('Transfers', 'transfers') || [];

                // Ensure arrays exist
                if (!Array.isArray(state.data.budgets)) state.data.budgets = [];
                if (!Array.isArray(state.data.categories)) state.data.categories = [];
                if (!Array.isArray(state.data.templates)) state.data.templates = [];
                if (!Array.isArray(state.data.accounts)) state.data.accounts = [];
                if (!Array.isArray(state.data.debts)) state.data.debts = [];
                if (!Array.isArray(state.data.transfers)) state.data.transfers = [];
                if (!Array.isArray(state.data.transactionHistory)) state.data.transactionHistory = [];

            } catch (err) {
                console.error('Error reading Excel file:', err);
                showToast('Error reading Excel file. Please check the file format.', 'error');
                throw err;
            }
        }

        async function writeExcelFile() {
            if (!state.fileHandle || !state.isConnected) return;

            try {
                // Create workbook
                const wb = XLSX.utils.book_new();

                // Convert data to sheets
                const incomeSheet = XLSX.utils.json_to_sheet(state.data.income);
                const expensesSheet = XLSX.utils.json_to_sheet(state.data.expenses);
                const receivablesSheet = XLSX.utils.json_to_sheet(state.data.receivables);
                const payablesSheet = XLSX.utils.json_to_sheet(state.data.payables);
                const plansSheet = XLSX.utils.json_to_sheet(state.data.plans);
                const budgetsSheet = XLSX.utils.json_to_sheet(state.data.budgets || []);
                const categoriesSheet = XLSX.utils.json_to_sheet(state.data.categories || []);
                const templatesSheet = XLSX.utils.json_to_sheet(state.data.templates || []);
                const accountsSheet = XLSX.utils.json_to_sheet(state.data.accounts || []);
                const transfersSheet = XLSX.utils.json_to_sheet(state.data.transfers || []);

                // Append sheets
                XLSX.utils.book_append_sheet(wb, incomeSheet, "Income");
                XLSX.utils.book_append_sheet(wb, expensesSheet, "Expenses");
                XLSX.utils.book_append_sheet(wb, receivablesSheet, "Receivables");
                XLSX.utils.book_append_sheet(wb, payablesSheet, "Payables");
                XLSX.utils.book_append_sheet(wb, plansSheet, "Plans");
                XLSX.utils.book_append_sheet(wb, budgetsSheet, "Budgets");
                XLSX.utils.book_append_sheet(wb, categoriesSheet, "Categories");
                XLSX.utils.book_append_sheet(wb, templatesSheet, "Templates");
                XLSX.utils.book_append_sheet(wb, accountsSheet, "Accounts");
                XLSX.utils.book_append_sheet(wb, transfersSheet, "Transfers");

                // Write to file
                const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                const writable = await state.fileHandle.createWritable();
                await writable.write(wbout);
                await writable.close();

                // Visual feedback (brief toast or status update)
                const statusEl = document.getElementById('status-bar');
                const originalText = statusEl.textContent;
                statusEl.textContent = t('saved_successfully');
                setTimeout(() => updateStatus(true), 1500);

            } catch (err) {
                console.error('Save error:', err);
                alert(t('failed_to_save'));
            }
        }

        // --- 3. UI RENDERING ---

        // Toast notification function (defined early for use in other functions)
        function showToast(message, type = 'success') {
            // Remove existing toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) existingToast.remove();

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icon = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'âš ï¸';
            toast.innerHTML = `<span>${icon}</span><span>${message}</span>`;
            document.body.appendChild(toast);

            // Show toast
            setTimeout(() => toast.classList.add('show'), 10);

            // Hide and remove toast after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function updateStatus(connected) {
            const el = document.getElementById('status-bar');
            const btn = document.getElementById('connect-btn');
            const refreshBtn = document.getElementById('refresh-btn');
            const exportBtn = document.getElementById('export-btn');
            const disconnectBtn = document.getElementById('disconnect-btn');

            if (connected) {
                el.className = 'status-bar status-connected';
                el.textContent = `${t('connected_to')} ${CONFIG.fileName}`;
                btn.innerHTML = `
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                    Connected
                `;
                btn.disabled = true;
                btn.style.display = 'none'; // Hide connect button when connected

                // Show Refresh and Export buttons
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.style.display = 'inline-flex';
                    refreshBtn.style.alignItems = 'center';
                }
                if (exportBtn) {
                    exportBtn.disabled = false;
                    exportBtn.style.display = 'inline-flex';
                    exportBtn.style.alignItems = 'center';
                }
                if (disconnectBtn) {
                    disconnectBtn.style.display = 'inline-flex';
                    disconnectBtn.style.alignItems = 'center';
                }
            } else {
                el.className = 'status-bar status-disconnected';
                el.textContent = t('disconnected') + '. ' + t('please_connect');
                btn.innerHTML = `
                    <svg width="16" height="16" viewBox="-0.08 0 1.28 1.28" xmlns="http://www.w3.org/2000/svg"><path d="M.103 0a.1.1 0 0 0-.101.102v1.077a.1.1 0 0 0 .101.101h.915a.1.1 0 0 0 .101-.101V.406L.742 0z" fill-rule="evenodd" clip-rule="evenodd" fill="#0c8fe8"/><g fill-rule="evenodd" clip-rule="evenodd"><path d="M1.12.407v.02H.864S.738.402.741.293c0 0 .004.114.12.114z" fill="#0973e2"/><path d="M.741 0v.291c0 .033.022.116.122.116h.256z" opacity=".5" fill="#fff"/></g><path d="M.565.712a.106.106 0 0 0-.151 0L.353.773a.11.11 0 0 0 0 .151.025.025 0 0 0 .035 0 .024.024 0 0 0 0-.035.06.06 0 0 1 0-.082L.45.746a.057.057 0 0 1 .081 0 .06.06 0 0 1 0 .081l-.029.03q.01.03.008.061L.566.862a.106.106 0 0 0 0-.151M.412.83a.025.025 0 0 0 0 .035.057.057 0 0 1 0 .081l-.061.061a.057.057 0 0 1-.081 0 .06.06 0 0 1 0-.081L.299.897A.14.14 0 0 1 .291.835L.235.891a.106.106 0 0 0 0 .151.11.11 0 0 0 .151 0L.448.98a.106.106 0 0 0 0-.151.025.025 0 0 0-.035 0" fill="#fff"/></svg>
                `;
                btn.disabled = false;
                btn.style.display = 'inline-flex'; // Show connect button when disconnected

                // Hide Refresh and Export buttons
                if (refreshBtn) {
                    refreshBtn.disabled = true;
                    refreshBtn.style.display = 'none';
                }
                if (exportBtn) {
                    exportBtn.disabled = true;
                    exportBtn.style.display = 'none';
                }
                if (disconnectBtn) {
                    disconnectBtn.style.display = 'none';
                }
            }
        }

        async function refreshData() {
            if (!state.isConnected || !state.fileHandle) {
                showToast('Please connect to Excel file first.', 'warning');
                return;
            }

            try {
                const refreshBtn = document.getElementById('refresh-btn');
                if (refreshBtn) {
                    refreshBtn.disabled = true;
                    refreshBtn.innerHTML = `
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="animation: spin 1s linear infinite;">
                            <polyline points="23 4 23 10 17 10"></polyline>
                            <polyline points="1 20 1 14 7 14"></polyline>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                        </svg>
                        Refreshing...
                    `;
                }

                await readExcelFile();
                renderAll();
                showToast('Data refreshed successfully!', 'success');
            } catch (err) {
                console.error('Error refreshing data:', err);
                showToast('Error refreshing data. Please check the file.', 'error');
                // If file handle is invalid, disconnect
                if (err.name === 'NotFoundError' || err.name === 'NotAllowedError') {
                    await disconnectExcelFile();
                }
            } finally {
                const refreshBtn = document.getElementById('refresh-btn');
                if (refreshBtn && state.isConnected) {
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" xml:space="preserve" width="16" height="16"><path fill="none" stroke="#000" stroke-miterlimit="10" d="M12.85 5.45A5.47 5.47 0 0 0 8 2.5C5.65 2.5 3.7 3.95 2.9 6m.2 4.5c.9 1.75 2.75 3 4.9 3 2.35 0 4.3-1.45 5.1-3.5"/><path fill="none" stroke="#000" stroke-miterlimit="10" d="M13 2.5v3h-3m-7 8v-3h3"/></svg>
                    `;
                }
            }
        }

        function formatCurrency(amount) {
            return CONFIG.currency + Number(amount).toLocaleString('en-BD');
        }

        function switchTab(tabId) {
            // Update Tab UI
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            const activeTab = Array.from(document.querySelectorAll('.nav-tab')).find(t => t.innerText.toLowerCase().includes(tabId === 'plans' ? 'future' : tabId));
            if (activeTab) activeTab.classList.add('active');

            // Hide all views
            document.getElementById('view-dashboard')?.classList.add('hidden');
            document.getElementById('view-list')?.classList.add('hidden');
            document.getElementById('view-plans')?.classList.add('hidden');
            document.getElementById('view-budgets')?.classList.add('hidden');
            document.getElementById('view-reports')?.classList.add('hidden');
            document.getElementById('view-analytics')?.classList.add('hidden');
            document.getElementById('view-categories')?.classList.add('hidden');
            document.getElementById('view-templates')?.classList.add('hidden');
            document.getElementById('view-accounts')?.classList.add('hidden');
            document.getElementById('view-transfers')?.classList.add('hidden');
            document.getElementById('view-debts')?.classList.add('hidden');
            document.getElementById('view-recurring')?.classList.add('hidden');
            document.getElementById('view-calendar')?.classList.add('hidden');
            document.getElementById('view-cashflow')?.classList.add('hidden');
            document.getElementById('view-investments')?.classList.add('hidden');
            document.getElementById('view-settings')?.classList.add('hidden');

            // Show selected view
            if (tabId === 'dashboard') {
                document.getElementById('view-dashboard').classList.remove('hidden');
                renderDashboard();
            } else if (tabId === 'plans') {
                document.getElementById('view-plans').classList.remove('hidden');
                renderPlansList();
            } else if (tabId === 'budgets') {
                document.getElementById('view-budgets').classList.remove('hidden');
                renderBudgetsList();
            } else if (tabId === 'reports') {
                document.getElementById('view-reports').classList.remove('hidden');
                renderReports();
            } else if (tabId === 'analytics') {
                document.getElementById('view-analytics').classList.remove('hidden');
                renderAnalytics();
            } else if (tabId === 'settings') {
                document.getElementById('view-settings').classList.remove('hidden');
                loadSettings();
            } else if (tabId === 'categories') {
                document.getElementById('view-categories').classList.remove('hidden');
                renderCategoriesList();
            } else if (tabId === 'templates') {
                document.getElementById('view-templates').classList.remove('hidden');
                renderTemplatesList();
            } else if (tabId === 'accounts') {
                document.getElementById('view-accounts').classList.remove('hidden');
                renderAccountsList();
            } else if (tabId === 'transfers') {
                document.getElementById('view-transfers').classList.remove('hidden');
                renderTransfersList();
            } else if (tabId === 'debts') {
                document.getElementById('view-debts').classList.remove('hidden');
                renderDebtsList();
            } else if (tabId === 'recurring') {
                document.getElementById('view-recurring').classList.remove('hidden');
                renderRecurringList();
            } else if (tabId === 'calendar') {
                const calendarView = document.getElementById('view-calendar');
                if (calendarView) {
                    calendarView.classList.remove('hidden');
                    renderFinancialCalendar();
                }
            } else if (tabId === 'cashflow') {
                const cashflowView = document.getElementById('view-cashflow');
                if (cashflowView) {
                    cashflowView.classList.remove('hidden');
                    renderCashFlow();
                }
            } else if (tabId === 'investments') {
                const investmentsView = document.getElementById('view-investments');
                if (investmentsView) {
                    investmentsView.classList.remove('hidden');
                    renderInvestmentsList();
                }
            } else {
                document.getElementById('view-list').classList.remove('hidden');
                renderListTable(tabId);
            }
            
            // Re-translate after switching tabs
            setTimeout(() => translatePage(), 100);
        }

        function renderAll() {
            // Save current filter state if on a list view
            let savedFilterState = null;
            if (currentListType && document.getElementById('view-list') && !document.getElementById('view-list').classList.contains('hidden')) {
                savedFilterState = {
                    searchTerm: document.getElementById('search-input')?.value || '',
                    categoryFilter: document.getElementById('category-filter')?.value || '',
                    dateFrom: document.getElementById('date-from-filter')?.value || '',
                    dateTo: document.getElementById('date-to-filter')?.value || '',
                    recurringFilter: document.getElementById('recurring-filter')?.value || '',
                    sortBy: document.getElementById('sort-by')?.value || '',
                    listType: currentListType
                };
            }

            // Determine current tab and render it specifically
            const activeTab = document.querySelector('.nav-tab.active');
            if (activeTab) {
                if (activeTab.innerText.includes('Dashboard') || activeTab.innerText.includes(t('dashboard'))) switchTab('dashboard');
                else if (activeTab.innerText.includes('Future') || activeTab.innerText.includes(t('plans'))) switchTab('plans');
                else switchTab(activeTab.getAttribute('onclick').match(/'([^']+)'/)[1]);
            } else {
                switchTab('dashboard');
            }
            
            // Re-translate after rendering
            setTimeout(() => translatePage(), 100);

            // Restore filter state if we were on a list view
            if (savedFilterState && savedFilterState.listType === currentListType) {
                setTimeout(() => {
                    const searchInput = document.getElementById('search-input');
                    const categoryFilter = document.getElementById('category-filter');
                    const dateFromFilter = document.getElementById('date-from-filter');
                    const dateToFilter = document.getElementById('date-to-filter');
                    const recurringFilter = document.getElementById('recurring-filter');
                    const sortBy = document.getElementById('sort-by');

                    if (searchInput) searchInput.value = savedFilterState.searchTerm;
                    if (categoryFilter) categoryFilter.value = savedFilterState.categoryFilter;
                    if (dateFromFilter) dateFromFilter.value = savedFilterState.dateFrom;
                    if (dateToFilter) dateToFilter.value = savedFilterState.dateTo;
                    if (recurringFilter) recurringFilter.value = savedFilterState.recurringFilter;
                    if (sortBy) sortBy.value = savedFilterState.sortBy;

                    // Reapply filters
                    applyFilters();
                }, 100);
            }
        }

        // Calculate total savings (reusable function)
        function calculateTotalSavings() {
            if (!state.data) return 0;
            const income = Array.isArray(state.data.income) ? state.data.income : [];
            const expenses = Array.isArray(state.data.expenses) ? state.data.expenses : [];
            const receivables = Array.isArray(state.data.receivables) ? state.data.receivables : [];

            const totalIncome = income.reduce((sum, i) => sum + Number(i?.amount || 0), 0);
            const totalExpenses = expenses.reduce((sum, i) => sum + Number(i?.amount || 0), 0);
            const netBalance = totalIncome - totalExpenses;
            const totalReceivables = receivables
                .filter(i => (i?.status || 'unpaid') === 'unpaid')
                .reduce((sum, i) => sum + Number(i?.amount || 0), 0);
            return totalReceivables + (netBalance > 0 ? netBalance : 0);
        }

        function renderDashboard() {
            // Ensure state.data exists and has required arrays
            if (!state.data) {
                state.data = {
                    income: [],
                    expenses: [],
                    receivables: [],
                    payables: [],
                    plans: [],
                    budgets: [],
                    categories: [],
                    templates: [],
                    accounts: [],
                    tags: [],
                    transactionHistory: []
                };
            }

            // Ensure arrays exist
            if (!Array.isArray(state.data.income)) state.data.income = [];
            if (!Array.isArray(state.data.expenses)) state.data.expenses = [];
            if (!Array.isArray(state.data.receivables)) state.data.receivables = [];
            if (!Array.isArray(state.data.payables)) state.data.payables = [];

            // Calculate Stats
            const totalIncome = state.data.income.reduce((sum, i) => sum + Number(i.amount || 0), 0);
            const totalExpenses = state.data.expenses.reduce((sum, i) => sum + Number(i.amount || 0), 0);
            const netBalance = totalIncome - totalExpenses;
            const totalSavings = calculateTotalSavings();

            const totalReceivables = state.data.receivables
                .filter(i => (i.status || 'unpaid') === 'unpaid')
                .reduce((sum, i) => sum + Number(i.amount || 0), 0);
            const totalPayables = state.data.payables
                .filter(i => (i.status || 'unpaid') === 'unpaid')
                .reduce((sum, i) => sum + Number(i.amount || 0), 0);

            const dashIncomeEl = document.getElementById('dash-income');
            if (dashIncomeEl) dashIncomeEl.textContent = formatCurrency(totalIncome);
            const dashExpensesEl = document.getElementById('dash-expenses');
            if (dashExpensesEl) dashExpensesEl.textContent = formatCurrency(totalExpenses);
            const dashBalanceEl = document.getElementById('dash-balance');
            if (dashBalanceEl) dashBalanceEl.textContent = formatCurrency(netBalance);
            const dashSavingsEl = document.getElementById('dash-savings');
            if (dashSavingsEl) dashSavingsEl.textContent = formatCurrency(totalSavings);
            const dashReceivablesEl = document.getElementById('dash-receivables-total');
            if (dashReceivablesEl) dashReceivablesEl.textContent = formatCurrency(totalReceivables);
            const dashPayablesEl = document.getElementById('dash-payables-total');
            if (dashPayablesEl) dashPayablesEl.textContent = formatCurrency(totalPayables);

            // Calculate current month totals
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`; // YYYY-MM

            const currentMonthIncome = state.data.income
                .filter(item => item.date && item.date.substring(0, 7) === currentMonth)
                .reduce((sum, item) => sum + Number(item.amount || 0), 0);

            const currentMonthExpenses = state.data.expenses
                .filter(item => item.date && item.date.substring(0, 7) === currentMonth)
                .reduce((sum, item) => sum + Number(item.amount || 0), 0);

            const currentMonthBalance = currentMonthIncome - currentMonthExpenses;

            const dashCurrentMonthIncomeEl = document.getElementById('dash-current-month-income');
            if (dashCurrentMonthIncomeEl) dashCurrentMonthIncomeEl.textContent = formatCurrency(currentMonthIncome);
            const dashCurrentMonthExpensesEl = document.getElementById('dash-current-month-expenses');
            if (dashCurrentMonthExpensesEl) dashCurrentMonthExpensesEl.textContent = formatCurrency(currentMonthExpenses);
            const dashCurrentMonthBalanceEl = document.getElementById('dash-current-month-balance');
            if (dashCurrentMonthBalanceEl) dashCurrentMonthBalanceEl.textContent = formatCurrency(currentMonthBalance);

            // Render Alerts
            renderDashboardAlerts();

            // Render Monthly Comparison
            renderMonthlyComparison();

            // Render Quick Insights
            renderQuickInsights(totalIncome, totalExpenses);

            // Render Charts
            renderCharts();

            // Render Bill Reminders
            renderBillReminders();
            
            // Re-translate after rendering dashboard
            setTimeout(() => translatePage(), 50);

            // Render Dashboard Lists (Top 5)
            const renderSmallList = (items, containerId, type) => {
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                // Filter out paid payables for dashboard display
                const filteredItems = type === 'payable'
                    ? items.filter(item => (item.status || 'unpaid') === 'unpaid')
                    : items;
                const list = filteredItems.slice(0, 5); // Show top 5

                if (list.length === 0) {
                    container.innerHTML = `<div style="color:#cbd5e0; font-style:italic;">${t('no_items')}</div>`;
                    return;
                }

                list.forEach((item, idx) => {
                    const row = document.createElement('div');
                    row.style.cssText = "display:flex; justify-content:space-between; padding:0.5rem 0; border-bottom:1px solid #f7fafc;";
                    const title = type === 'receivable' ? (item.from || 'Unknown') : (item.to || 'Unknown');
                    const statusBadge = type === 'payable' || type === 'receivable'
                        ? '<span style="background: #e53e3e; color: white; padding: 0.125rem 0.375rem; border-radius: 3px; font-size: 0.625rem; margin-left: 0.25rem;">Unpaid</span>'
                        : '';
                    row.innerHTML = `
                        <span>${title} <small style="color:#a0aec0">(${item.dueDate || '-'})</small>${statusBadge}</span>
                        <strong style="color: ${type === 'receivable' ? 'var(--success)' : 'var(--danger)'}">${formatCurrency(item.amount)}</strong>
                    `;
                    container.appendChild(row);
                });
            };

            renderSmallList(state.data.receivables, 'dash-receivables-list', 'receivable');
            renderSmallList(state.data.payables, 'dash-payables-list', 'payable');
        }

        function renderDashboardAlerts() {
            const alertsContainer = document.getElementById('dashboard-alerts');
            if (!alertsContainer) return;

            alertsContainer.innerHTML = '';
            const alerts = [];

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Check overdue receivables (only unpaid)
            const overdueReceivables = state.data.receivables.filter(item => {
                if ((item.status || 'unpaid') === 'paid') return false;
                if (!item.dueDate) return false;
                const due = new Date(item.dueDate);
                due.setHours(0, 0, 0, 0);
                return due < today;
            });

            // Check overdue payables (only unpaid)
            const overduePayables = state.data.payables.filter(item => {
                if ((item.status || 'unpaid') === 'paid') return false;
                if (!item.dueDate) return false;
                const due = new Date(item.dueDate);
                due.setHours(0, 0, 0, 0);
                return due < today;
            });

            // Check due soon (within 3 days) - only unpaid
            const dueSoonReceivables = state.data.receivables.filter(item => {
                if ((item.status || 'unpaid') === 'paid') return false;
                if (!item.dueDate) return false;
                const due = new Date(item.dueDate);
                due.setHours(0, 0, 0, 0);
                const diffDays = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
                return diffDays >= 0 && diffDays <= 3 && !overdueReceivables.includes(item);
            });

            const dueSoonPayables = state.data.payables.filter(item => {
                if ((item.status || 'unpaid') === 'paid') return false;
                if (!item.dueDate) return false;
                const due = new Date(item.dueDate);
                due.setHours(0, 0, 0, 0);
                const diffDays = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
                return diffDays >= 0 && diffDays <= 3 && !overduePayables.includes(item);
            });

            // Check over-budget categories (with period filtering)
            const filterExpensesByPeriod = (expenses, periodType) => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                return expenses.filter(exp => {
                    if (!exp.date) return false;
                    const expDate = new Date(exp.date);
                    expDate.setHours(0, 0, 0, 0);

                    switch (periodType) {
                        case 'daily':
                            return expDate.getTime() === today.getTime();
                        case 'monthly':
                            return expDate.getMonth() === today.getMonth() &&
                                expDate.getFullYear() === today.getFullYear();
                        case 'per 3 month':
                            const threeMonthsAgo = new Date(today);
                            threeMonthsAgo.setMonth(today.getMonth() - 3);
                            return expDate >= threeMonthsAgo && expDate <= today;
                        case 'per 6 month':
                            const sixMonthsAgo = new Date(today);
                            sixMonthsAgo.setMonth(today.getMonth() - 6);
                            return expDate >= sixMonthsAgo && expDate <= today;
                        case 'yearly':
                            return expDate.getFullYear() === today.getFullYear();
                        default:
                            return true; // fallback to all expenses
                    }
                });
            };

            const overBudgetCategories = (state.data.budgets || []).filter(budget => {
                const category = budget.category;
                const budgetAmount = Number(budget.amount || 0);
                const period = budget.period || 'monthly';

                const periodExpenses = filterExpensesByPeriod(
                    state.data.expenses.filter(exp => exp.category === category),
                    period
                );
                const actualSpending = periodExpenses.reduce((sum, exp) => sum + Number(exp.amount || 0), 0);
                return actualSpending > budgetAmount;
            });

            // Add alerts
            if (overdueReceivables.length > 0) {
                const total = overdueReceivables.reduce((sum, item) => sum + Number(item.amount || 0), 0);
                alerts.push({
                    type: 'danger',
                    message: `âš ï¸ You have ${overdueReceivables.length} overdue receivable${overdueReceivables.length > 1 ? 's' : ''} totaling ${formatCurrency(total)}`,
                    action: () => switchTab('receivables')
                });
            }

            if (overduePayables.length > 0) {
                const total = overduePayables.reduce((sum, item) => sum + Number(item.amount || 0), 0);
                alerts.push({
                    type: 'danger',
                    message: `âš ï¸ You have ${overduePayables.length} overdue payable${overduePayables.length > 1 ? 's' : ''} totaling ${formatCurrency(total)}`,
                    action: () => switchTab('payables')
                });
            }

            if (dueSoonReceivables.length > 0) {
                const total = dueSoonReceivables.reduce((sum, item) => sum + Number(item.amount || 0), 0);
                alerts.push({
                    type: 'warning',
                    message: `ðŸ“… ${dueSoonReceivables.length} receivable${dueSoonReceivables.length > 1 ? 's' : ''} due soon (within 3 days) - ${formatCurrency(total)}`,
                    action: () => switchTab('receivables')
                });
            }

            if (dueSoonPayables.length > 0) {
                const total = dueSoonPayables.reduce((sum, item) => sum + Number(item.amount || 0), 0);
                alerts.push({
                    type: 'warning',
                    message: `ðŸ“… ${dueSoonPayables.length} payable${dueSoonPayables.length > 1 ? 's' : ''} due soon (within 3 days) - ${formatCurrency(total)}`,
                    action: () => switchTab('payables')
                });
            }

            if (overBudgetCategories.length > 0) {
                alerts.push({
                    type: 'warning',
                    message: `ðŸ’° ${overBudgetCategories.length} budget${overBudgetCategories.length > 1 ? 's' : ''} exceeded`,
                    action: () => switchTab('budgets')
                });
            }

            // Render alerts
            alerts.forEach(alert => {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert-banner ${alert.type === 'danger' ? '' : alert.type === 'warning' ? 'warning' : 'info'}`;
                alertDiv.innerHTML = `
                    <div style="flex: 1;">${alert.message}</div>
                    <button class="btn btn-secondary" onclick="alert.action(); closeAlert(this)" style="width: auto; padding: 0.5rem 1rem;">View</button>
                `;
                alertsContainer.appendChild(alertDiv);
            });
        }

        function closeAlert(button) {
            button.closest('.alert-banner').remove();
        }

        function renderMonthlyComparison() {
            const container = document.getElementById('monthly-comparison-content');
            if (!container) return;

            const monthlyData = getMonthlyData();
            if (monthlyData.labels.length < 2) {
                container.innerHTML = `<div style="color: var(--text-light); padding: 1rem; text-align: center;">${t('not_enough_data')}</div>`;
                return;
            }

            const currentMonthIdx = monthlyData.labels.length - 1;
            const previousMonthIdx = monthlyData.labels.length - 2;

            const currentMonth = monthlyData.labels[currentMonthIdx];
            const previousMonth = monthlyData.labels[previousMonthIdx];

            const currentIncome = monthlyData.income[currentMonthIdx] || 0;
            const previousIncome = monthlyData.income[previousMonthIdx] || 0;
            const incomeDiff = currentIncome - previousIncome;

            const currentExpenses = monthlyData.expenses[currentMonthIdx] || 0;
            const previousExpenses = monthlyData.expenses[previousMonthIdx] || 0;
            const expenseDiff = currentExpenses - previousExpenses;

            const currentSavings = currentIncome - currentExpenses;
            const previousSavings = previousIncome - previousExpenses;
            const savingsDiff = currentSavings - previousSavings;

            container.innerHTML = `
                <div class="comparison-row">
                    <div class="comparison-label" data-translate="month">Month</div>
                    <div class="comparison-values">
                        <div class="comparison-value"><strong>${previousMonth}</strong></div>
                        <div class="comparison-value"><strong>${currentMonth}</strong></div>
                        <div class="comparison-value" style="min-width: 120px;"><strong>Difference</strong></div>
                    </div>
                </div>
                <div class="comparison-row">
                    <div class="comparison-label" data-translate="income">Income</div>
                    <div class="comparison-values">
                        <div class="comparison-value">${formatCurrency(previousIncome)}</div>
                        <div class="comparison-value">${formatCurrency(currentIncome)}</div>
                        <div class="comparison-value">
                            <span class="comparison-diff ${incomeDiff >= 0 ? 'positive' : 'negative'}">
                                ${incomeDiff >= 0 ? '+' : ''}${formatCurrency(incomeDiff)}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="comparison-row">
                    <div class="comparison-label" data-translate="expenses">Expenses</div>
                    <div class="comparison-values">
                        <div class="comparison-value">${formatCurrency(previousExpenses)}</div>
                        <div class="comparison-value">${formatCurrency(currentExpenses)}</div>
                        <div class="comparison-value">
                            <span class="comparison-diff ${expenseDiff <= 0 ? 'positive' : 'negative'}">
                                ${expenseDiff >= 0 ? '+' : ''}${formatCurrency(expenseDiff)}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="comparison-row">
                    <div class="comparison-label" data-translate="savings">Savings</div>
                    <div class="comparison-values">
                        <div class="comparison-value">${formatCurrency(previousSavings)}</div>
                        <div class="comparison-value">${formatCurrency(currentSavings)}</div>
                        <div class="comparison-value">
                            <span class="comparison-diff ${savingsDiff >= 0 ? 'positive' : 'negative'}">
                                ${savingsDiff >= 0 ? '+' : ''}${formatCurrency(savingsDiff)}
                            </span>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderQuickInsights(totalIncome, totalExpenses) {
            // Calculate average monthly expense
            const monthlyData = getMonthlyData();
            const avgMonthlyExpense = monthlyData.expenses.length > 0
                ? monthlyData.expenses.reduce((a, b) => a + b, 0) / monthlyData.expenses.length
                : 0;
            const expenseEl = document.getElementById('avg-monthly-expense');
            if (expenseEl) expenseEl.textContent = formatCurrency(avgMonthlyExpense);

            // Calculate average monthly income
            const avgMonthlyIncome = monthlyData.income.length > 0
                ? monthlyData.income.reduce((a, b) => a + b, 0) / monthlyData.income.length
                : 0;
            const incomeEl = document.getElementById('avg-monthly-income');
            if (incomeEl) incomeEl.textContent = formatCurrency(avgMonthlyIncome);

            // Top spending category
            const expenseCategories = getCategoryData('expenses');
            const topCategory = expenseCategories.labels.length > 0 ? expenseCategories.labels[0] : '-';
            const topCategoryEl = document.getElementById('top-category');
            if (topCategoryEl) topCategoryEl.textContent = topCategory;
            const topCategoryAmountEl = document.getElementById('top-category-amount');
            if (topCategoryAmountEl && expenseCategories.labels.length > 0 && expenseCategories.values && expenseCategories.values.length > 0) {
                topCategoryAmountEl.textContent = formatCurrency(expenseCategories.values[0]);
            } else if (topCategoryAmountEl) {
                topCategoryAmountEl.textContent = formatCurrency(0);
            }

            // Average transaction size
            const incomeArray = state.data && Array.isArray(state.data.income) ? state.data.income : [];
            const expensesArray = state.data && Array.isArray(state.data.expenses) ? state.data.expenses : [];
            const totalTransactions = incomeArray.length + expensesArray.length;
            const avgTransaction = totalTransactions > 0
                ? (totalIncome + totalExpenses) / totalTransactions
                : 0;
            const avgTransEl = document.getElementById('avg-transaction');
            if (avgTransEl) avgTransEl.textContent = formatCurrency(avgTransaction);

            // Average monthly savings
            const avgMonthlySavings = avgMonthlyIncome - avgMonthlyExpense;
            const savingsEl = document.getElementById('avg-monthly-savings');
            if (savingsEl) savingsEl.textContent = formatCurrency(avgMonthlySavings);
            const savingsTrendEl = document.getElementById('savings-trend');
            if (savingsTrendEl) {
                savingsTrendEl.className = 'insight-trend ' + (avgMonthlySavings >= 0 ? 'trend-up' : 'trend-down');
                savingsTrendEl.textContent = avgMonthlySavings >= 0 ? t('positive_monthly_savings') : t('negative_monthly_savings');
            }

            // Transaction count breakdown
            const transCountEl = document.getElementById('transaction-count');
            if (transCountEl) transCountEl.textContent = totalTransactions;
            const transBreakdownEl = document.getElementById('transaction-breakdown');
            if (transBreakdownEl) {
                transBreakdownEl.textContent = `${state.data.income.length} ${t('income_comma_expenses')}, ${state.data.expenses.length} ${t('expenses_word')}`;
            }

            // Calculate trends (compare last 2 months if available)
            if (monthlyData.expenses.length >= 2) {
                const recent = monthlyData.expenses.slice(-2);
                const expenseChange = recent[1] - recent[0];
                const expenseTrendEl = document.getElementById('expense-trend');
                if (expenseTrendEl) {
                    expenseTrendEl.className = 'insight-trend ' + (expenseChange < 0 ? 'trend-up' : 'trend-down');
                    expenseTrendEl.textContent = expenseChange < 0
                        ? `â†“ ${formatCurrency(Math.abs(expenseChange))} vs last month`
                        : `â†‘ ${formatCurrency(expenseChange)} vs last month`;
                }
            }

            if (monthlyData.income.length >= 2) {
                const recent = monthlyData.income.slice(-2);
                const incomeChange = recent[1] - recent[0];
                const incomeTrendEl = document.getElementById('income-trend');
                if (incomeTrendEl) {
                    incomeTrendEl.className = 'insight-trend ' + (incomeChange > 0 ? 'trend-up' : 'trend-down');
                    incomeTrendEl.textContent = incomeChange > 0
                        ? `â†‘ ${formatCurrency(incomeChange)} vs last month`
                        : `â†“ ${formatCurrency(Math.abs(incomeChange))} vs last month`;
                }
            }

            // Calculate Financial Health Score
            calculateFinancialHealth(totalIncome, totalExpenses, avgMonthlyIncome, avgMonthlyExpense);
        }

        // Dark Mode Toggle
        function toggleDarkMode() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            if (isDark) {
                document.documentElement.removeAttribute('data-theme');
                state.settings.darkMode = false;
            } else {
                document.documentElement.setAttribute('data-theme', 'dark');
                state.settings.darkMode = true;
            }
            updateDarkModeIcon();
            saveSettingsToStorage();
        }

        function updateDarkModeIcon() {
            const icon = document.getElementById('dark-mode-icon');
            if (!icon) return;
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            if (isDark) {
                icon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
            } else {
                icon.innerHTML = '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>';
            }
        }

        function saveSettingsToStorage() {
            try {
                localStorage.setItem('financeManagerSettings', JSON.stringify(state.settings));
            } catch (e) {
                console.error('Error saving settings:', e);
            }
        }

        function loadSettingsFromStorage() {
            try {
                const saved = localStorage.getItem('financeManagerSettings');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    state.settings = { ...state.settings, ...parsed };
                    if (state.settings.darkMode) {
                        document.documentElement.setAttribute('data-theme', 'dark');
                    }
                    updateDarkModeIcon();
                }
            } catch (e) {
                console.error('Error loading settings:', e);
            }
        }

        // Bill Reminders Widget
        function renderBillReminders() {
            const container = document.getElementById('bill-reminders-content');
            if (!container) return;

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);

            // Get upcoming unpaid payables and receivables
            const upcomingBills = [
                ...state.data.payables.filter(item => {
                    if ((item.status || 'unpaid') === 'paid') return false;
                    if (!item.dueDate) return false;
                    const due = new Date(item.dueDate);
                    due.setHours(0, 0, 0, 0);
                    return due >= today && due <= nextWeek;
                }).map(item => ({ ...item, type: 'payable', label: 'Payable' })),
                ...state.data.receivables.filter(item => {
                    if ((item.status || 'unpaid') === 'paid') return false;
                    if (!item.dueDate) return false;
                    const due = new Date(item.dueDate);
                    due.setHours(0, 0, 0, 0);
                    return due >= today && due <= nextWeek;
                }).map(item => ({ ...item, type: 'receivable', label: 'Receivable' }))
            ].sort((a, b) => {
                const dateA = new Date(a.dueDate);
                const dateB = new Date(b.dueDate);
                return dateA - dateB;
            });

            if (upcomingBills.length === 0) {
                container.innerHTML = `<div class="text-center" style="padding: 1rem; color: var(--text-light);">${t('no_upcoming_bills')}</div>`;
                return;
            }

            // Generate notifications for upcoming bills
            upcomingBills.forEach(bill => {
                const dueDate = new Date(bill.dueDate);
                const daysUntil = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                const isToday = daysUntil === 0;
                const isTomorrow = daysUntil === 1;
                
                // Check if notification already exists for this bill
                const billIndex = state.data[bill.type === 'payable' ? 'payables' : 'receivables'].indexOf(bill);
                const existingNotif = notifications.find(n => 
                    n.data && n.data.billId === `${bill.type}-${billIndex}`
                );
                
                if (!existingNotif) {
                    const daysText = isToday ? t('today') : isTomorrow ? t('tomorrow') : `${daysUntil} ${t('days')}`;
                    addNotification(
                        isToday ? 'error' : isTomorrow ? 'warning' : 'info',
                        `${isToday ? 'âš ï¸ ' : ''}${bill.type === 'payable' ? t('payables') : t('receivables')} ${t('due_date')}`,
                        `${bill.to || bill.from || 'Unknown'}: ${formatCurrency(bill.amount)} - ${daysText}`,
                        { billId: `${bill.type}-${billIndex}` }
                    );
                }
            });

            container.innerHTML = upcomingBills.map(bill => {
                const dueDate = new Date(bill.dueDate);
                const daysUntil = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                const isToday = daysUntil === 0;
                const isTomorrow = daysUntil === 1;
                const daysText = isToday ? 'Today' : isTomorrow ? 'Tomorrow' : `In ${daysUntil} days`;
                const priority = bill.priority || 'medium';
                const priorityColor = priority === 'high' ? 'var(--danger)' : priority === 'medium' ? 'var(--warning)' : 'var(--success)';

                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--card-bg); border-radius: 8px; margin-bottom: 0.5rem; border-left: 3px solid ${priorityColor};">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">${bill.to || bill.from || 'Unknown'}</div>
                            <div style="font-size: 0.875rem; color: var(--text-light);">
                                ${bill.description || 'No description'} â€¢ ${bill.label}
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-light); margin-top: 0.25rem;">
                                Due: ${bill.dueDate} (${daysText})
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: bold; font-size: 1.1rem; color: ${bill.type === 'payable' ? 'var(--danger)' : 'var(--success)'};">
                                ${formatCurrency(bill.amount)}
                            </div>
                            <button class="btn btn-sm" style="margin-top: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="showBillDetails('${bill.type}', ${state.data[bill.type === 'payable' ? 'payables' : 'receivables'].indexOf(bill)})">
                                ${t('view')}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showBillDetails(type, index) {
            const dataType = type === 'payable' ? 'payables' : 'receivables';
            const bill = state.data[dataType][index];
            if (!bill) return;

            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            
            if (!overlay || !content) return;
            
            const dueDate = new Date(bill.dueDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const daysUntil = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
            const isToday = daysUntil === 0;
            const isTomorrow = daysUntil === 1;
            const daysText = isToday ? t('today') : isTomorrow ? t('tomorrow') : `${daysUntil} ${t('days')}`;
            const status = bill.status || 'unpaid';
            const priority = bill.priority || 'medium';
            
            overlay.classList.add('active');
            content.innerHTML = `
                <div class="modal-header">
                    <h2>${t('bill_details')}</h2>
                    <button class="modal-close" onclick="closeModal()">Ã—</button>
                </div>
                <div style="padding: 1.5rem;">
                    <div style="margin-bottom: 1.5rem;">
                        <div style="font-size: 0.875rem; color: var(--text-light); margin-bottom: 0.25rem;">${type === 'payable' ? t('payables') : t('receivables')}</div>
                        <div style="font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem;">
                            ${type === 'payable' ? (bill.to || 'Unknown') : (bill.from || 'Unknown')}
                        </div>
                    </div>
                    
                    <div style="display: grid; gap: 1rem; margin-bottom: 1.5rem;">
                        <div>
                            <div style="font-size: 0.875rem; color: var(--text-light); margin-bottom: 0.25rem;">${t('amount')}</div>
                            <div style="font-size: 1.25rem; font-weight: bold; color: ${type === 'payable' ? 'var(--danger)' : 'var(--success)'};">
                                ${formatCurrency(bill.amount)}
                            </div>
                        </div>
                        
                        <div>
                            <div style="font-size: 0.875rem; color: var(--text-light); margin-bottom: 0.25rem;">${t('due_date')}</div>
                            <div style="font-size: 1rem; font-weight: 500;">
                                ${bill.dueDate} (${daysText})
                            </div>
                        </div>
                        
                        <div>
                            <div style="font-size: 0.875rem; color: var(--text-light); margin-bottom: 0.25rem;">${t('status')}</div>
                            <div>
                                <span style="background: ${status === 'paid' ? 'var(--success)' : 'var(--danger)'}; color: white; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.875rem; font-weight: 500;">
                                    ${status === 'paid' ? t('paid') : t('unpaid')}
                                </span>
                            </div>
                        </div>
                        
                        <div>
                            <div style="font-size: 0.875rem; color: var(--text-light); margin-bottom: 0.25rem;">${t('priority')}</div>
                            <div>
                                <span style="background: ${priority === 'high' ? 'var(--danger)' : priority === 'medium' ? 'var(--warning)' : 'var(--success)'}; color: white; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.875rem; font-weight: 500;">
                                    ${priority === 'high' ? t('high') : priority === 'medium' ? t('medium') : t('low')}
                                </span>
                            </div>
                        </div>
                        
                        ${bill.description ? `
                        <div>
                            <div style="font-size: 0.875rem; color: var(--text-light); margin-bottom: 0.25rem;">${t('description')}</div>
                            <div style="font-size: 0.875rem;">${bill.description}</div>
                        </div>
                        ` : ''}
                        
                        ${bill.paymentMethod ? `
                        <div>
                            <div style="font-size: 0.875rem; color: var(--text-light); margin-bottom: 0.25rem;">Payment Method</div>
                            <div style="font-size: 0.875rem;">${bill.paymentMethod}</div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="modal-footer" style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">${t('close')}</button>
                        <button type="button" class="btn btn-primary" onclick="closeModal(); setTimeout(() => editItem('${dataType}', ${index}), 100);">${t('edit')}</button>
                    </div>
                </div>
            `;
        }

        // Budget Alerts Widget
        function renderBudgetAlerts() {
            const alertsContainer = document.getElementById('dashboard-alerts');
            if (!alertsContainer) return;

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const filterExpensesByPeriod = (expenses, periodType) => {
                return expenses.filter(exp => {
                    if (!exp.date) return false;
                    const expDate = new Date(exp.date);
                    expDate.setHours(0, 0, 0, 0);

                    switch (periodType) {
                        case 'daily':
                            return expDate.getTime() === today.getTime();
                        case 'monthly':
                            return expDate.getMonth() === today.getMonth() &&
                                expDate.getFullYear() === today.getFullYear();
                        case 'per 3 month':
                            const threeMonthsAgo = new Date(today);
                            threeMonthsAgo.setMonth(today.getMonth() - 3);
                            return expDate >= threeMonthsAgo && expDate <= today;
                        case 'per 6 month':
                            const sixMonthsAgo = new Date(today);
                            sixMonthsAgo.setMonth(today.getMonth() - 6);
                            return expDate >= sixMonthsAgo && expDate <= today;
                        case 'yearly':
                            return expDate.getFullYear() === today.getFullYear();
                        default:
                            return true;
                    }
                });
            };

            const budgets = state.data.budgets || [];
            const budgetAlerts = [];

            budgets.forEach(budget => {
                const category = budget.category;
                const budgetAmount = Number(budget.amount || 0);
                const period = budget.period || 'monthly';

                const periodExpenses = filterExpensesByPeriod(
                    state.data.expenses.filter(exp => exp.category === category),
                    period
                );
                const actualSpending = periodExpenses.reduce((sum, exp) => sum + Number(exp.amount || 0), 0);
                const percentUsed = budgetAmount > 0 ? (actualSpending / budgetAmount) * 100 : 0;
                const remaining = budgetAmount - actualSpending;

                // Alert if over 80% used or over budget
                if (percentUsed >= 80 || actualSpending > budgetAmount) {
                    budgetAlerts.push({
                        category: category,
                        period: period,
                        budgetAmount: budgetAmount,
                        actualSpending: actualSpending,
                        percentUsed: percentUsed,
                        remaining: remaining,
                        isOverBudget: actualSpending > budgetAmount
                    });
                }
            });

            if (budgetAlerts.length > 0) {
                const existingAlerts = alertsContainer.querySelectorAll('.alert');
                const budgetAlertDiv = document.createElement('div');
                budgetAlertDiv.className = 'alert alert-warning';
                budgetAlertDiv.style.marginBottom = '1rem';
                budgetAlertDiv.innerHTML = `
                    <div style="display: flex; align-items: start; gap: 1rem;">
                        <div style="font-size: 1.5rem;">âš ï¸</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">Budget Alerts</div>
                            ${budgetAlerts.map(alert => `
                                <div style="margin-bottom: 0.5rem; padding: 0.5rem; background: rgba(255,255,255,0.5); border-radius: 4px;">
                                    <strong>${alert.category}</strong> (${alert.period}): 
                                    ${alert.isOverBudget
                        ? `<span style="color: var(--danger);">Over budget by ${formatCurrency(Math.abs(alert.remaining))}</span>`
                        : `<span style="color: var(--warning);">${Math.round(alert.percentUsed)}% used, ${formatCurrency(alert.remaining)} remaining</span>`
                    }
                                </div>
                            `).join('')}
                            <button class="btn btn-sm" style="margin-top: 0.5rem;" onclick="switchTab('budgets')">View Budgets</button>
                        </div>
                    </div>
                `;
                alertsContainer.insertBefore(budgetAlertDiv, alertsContainer.firstChild);
            }
        }

        function calculateFinancialHealth(totalIncome, totalExpenses, avgMonthlyIncome, avgMonthlyExpense) {
            let score = 0;
            const maxScore = 100;

            // Savings rate (0-30 points)
            if (totalIncome > 0) {
                const savingsRate = ((totalIncome - totalExpenses) / totalIncome) * 100;
                const savingsRateEl = document.getElementById('savings-rate');
                if (savingsRateEl) savingsRateEl.textContent = savingsRate.toFixed(1) + '%';
                if (savingsRate >= 20) score += 30;
                else if (savingsRate >= 10) score += 20;
                else if (savingsRate >= 5) score += 15;
                else if (savingsRate >= 0) score += 10;
                else score += 0;
            } else {
                const savingsRateEl = document.getElementById('savings-rate');
                if (savingsRateEl) savingsRateEl.textContent = '0%';
            }

            // Expense ratio (0-25 points)
            if (totalIncome > 0) {
                const expenseRatio = (totalExpenses / totalIncome) * 100;
                const expenseRatioEl = document.getElementById('expense-ratio');
                if (expenseRatioEl) expenseRatioEl.textContent = expenseRatio.toFixed(1) + '%';
                if (expenseRatio <= 70) score += 25;
                else if (expenseRatio <= 80) score += 20;
                else if (expenseRatio <= 90) score += 15;
                else if (expenseRatio <= 100) score += 10;
                else score += 5;
            } else {
                const expenseRatioEl = document.getElementById('expense-ratio');
                if (expenseRatioEl) expenseRatioEl.textContent = '0%';
            }

            // Monthly consistency (0-20 points)
            const monthlyData = getMonthlyData();
            if (monthlyData.income.length >= 3) {
                const incomeVariance = calculateVariance(monthlyData.income.slice(-3));
                if (incomeVariance < 0.1) score += 20;
                else if (incomeVariance < 0.2) score += 15;
                else if (incomeVariance < 0.3) score += 10;
                else score += 5;
            } else {
                score += 10; // Default for insufficient data
            }

            // Growth trend (0-15 points)
            if (monthlyData.income.length >= 2 && monthlyData.expenses.length >= 2) {
                const incomeTrend = monthlyData.income.slice(-2)[1] - monthlyData.income.slice(-2)[0];
                const expenseTrend = monthlyData.expenses.slice(-2)[1] - monthlyData.expenses.slice(-2)[0];
                if (incomeTrend > 0 && expenseTrend <= 0) score += 15;
                else if (incomeTrend > expenseTrend) score += 10;
                else if (incomeTrend === expenseTrend) score += 5;
                else score += 0;
            } else {
                score += 5;
            }

            // Transaction activity (0-10 points)
            const totalTransactions = state.data.expenses.length + state.data.income.length;
            if (totalTransactions >= 20) score += 10;
            else if (totalTransactions >= 10) score += 7;
            else if (totalTransactions >= 5) score += 5;
            else score += 2;

            // Update UI
            const healthScoreEl = document.getElementById('health-score');
            if (healthScoreEl) healthScoreEl.textContent = Math.min(score, maxScore);
            const statusEl = document.getElementById('health-status');
            if (statusEl) {
                if (score >= 80) {
                    statusEl.textContent = t('excellent_health');
                    statusEl.style.color = '#48bb78';
                } else if (score >= 65) {
                    statusEl.textContent = t('good_health');
                    statusEl.style.color = '#38a169';
                } else if (score >= 50) {
                    statusEl.textContent = t('fair_health');
                    statusEl.style.color = '#d69e2e';
                } else {
                    statusEl.textContent = t('needs_attention');
                    statusEl.style.color = '#e53e3e';
                }
            }
        }

        function calculateVariance(values) {
            if (values.length === 0) return 0;
            const mean = values.reduce((a, b) => a + b, 0) / values.length;
            const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;
            return variance / (mean * mean); // Coefficient of variation
        }

        // Chart rendering functions
        let trendChart = null;
        let expenseCategoriesChart = null;
        let incomeCategoriesChart = null;
        let cashFlowChart = null;

        function renderCharts() {
            // Destroy existing charts if they exist
            if (trendChart) trendChart.destroy();
            if (expenseCategoriesChart) expenseCategoriesChart.destroy();
            if (incomeCategoriesChart) incomeCategoriesChart.destroy();
            if (cashFlowChart) cashFlowChart.destroy();

            // Trend Chart (Income vs Expenses by Month)
            const monthlyData = getMonthlyData();
            const trendCtx = document.getElementById('trend-chart');
            if (trendCtx) {
                trendChart = new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: monthlyData.labels,
                        datasets: [
                            {
                                label: 'Income',
                                data: monthlyData.income,
                                borderColor: '#38a169',
                                backgroundColor: 'rgba(56, 161, 105, 0.1)',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Expenses',
                                data: monthlyData.expenses,
                                borderColor: '#e53e3e',
                                backgroundColor: 'rgba(229, 62, 62, 0.1)',
                                tension: 0.4,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function (value) {
                                        return 'à§³' + value.toLocaleString('en-BD');
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Expense Categories Chart
            const expenseCategories = getCategoryData('expenses');
            const expenseCtx = document.getElementById('expense-categories-chart');
            if (expenseCtx) {
                expenseCategoriesChart = new Chart(expenseCtx, {
                    type: 'doughnut',
                    data: {
                        labels: expenseCategories.labels,
                        datasets: [{
                            data: expenseCategories.values,
                            backgroundColor: [
                                '#e53e3e', '#d97706', '#d69e2e', '#38a169',
                                '#3182ce', '#805ad5', '#e53e3e', '#c53030'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return label + ': ' + formatCurrency(value) + ' (' + percentage + '%)';
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Cash Flow Chart
            const cashFlowData = getMonthlyData();
            const cashFlowValues = cashFlowData.income.map((income, idx) => income - cashFlowData.expenses[idx]);
            const cashFlowCtx = document.getElementById('cashflow-chart');
            if (cashFlowCtx) {
                cashFlowChart = new Chart(cashFlowCtx, {
                    type: 'bar',
                    data: {
                        labels: cashFlowData.labels,
                        datasets: [{
                            label: 'Net Cash Flow',
                            data: cashFlowValues,
                            backgroundColor: cashFlowValues.map(val => val >= 0 ? 'rgba(56, 161, 105, 0.6)' : 'rgba(229, 62, 62, 0.6)'),
                            borderColor: cashFlowValues.map(val => val >= 0 ? '#38a169' : '#e53e3e'),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return 'Cash Flow: ' + formatCurrency(context.parsed.y);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    callback: function (value) {
                                        return 'à§³' + value.toLocaleString('en-BD');
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Income Categories Chart
            const incomeCategories = getCategoryData('income');
            const incomeCtx = document.getElementById('income-categories-chart');
            if (incomeCtx) {
                incomeCategoriesChart = new Chart(incomeCtx, {
                    type: 'doughnut',
                    data: {
                        labels: incomeCategories.labels,
                        datasets: [{
                            data: incomeCategories.values,
                            backgroundColor: [
                                '#38a169', '#3182ce', '#805ad5', '#d69e2e',
                                '#e53e3e', '#48bb78', '#4299e1', '#9f7aea'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return label + ': ' + formatCurrency(value) + ' (' + percentage + '%)';
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Helper function to format month from YYYY-MM to "May 2025"
        function formatMonthLabel(monthStr) {
            if (!monthStr || monthStr.length < 7) return monthStr;
            const [year, month] = monthStr.split('-');
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            const monthIndex = parseInt(month) - 1;
            if (monthIndex >= 0 && monthIndex < 12) {
                return `${monthNames[monthIndex]} ${year}`;
            }
            return monthStr;
        }

        function getMonthlyData() {
            const incomeByMonth = {};
            const expensesByMonth = {};

            if (state.data && Array.isArray(state.data.income)) {
                state.data.income.forEach(item => {
                    if (item && item.date) {
                        const month = item.date.substring(0, 7); // YYYY-MM
                        incomeByMonth[month] = (incomeByMonth[month] || 0) + Number(item.amount || 0);
                    }
                });
            }

            if (state.data && Array.isArray(state.data.expenses)) {
                state.data.expenses.forEach(item => {
                    if (item && item.date) {
                        const month = item.date.substring(0, 7); // YYYY-MM
                        expensesByMonth[month] = (expensesByMonth[month] || 0) + Number(item.amount || 0);
                    }
                });
            }

            const allMonths = [...new Set([...Object.keys(incomeByMonth), ...Object.keys(expensesByMonth)])].sort();

            return {
                labels: allMonths.map(m => formatMonthLabel(m)), // Format labels as "May 2025"
                labelsRaw: allMonths, // Keep raw format for calculations
                income: allMonths.map(m => incomeByMonth[m] || 0),
                expenses: allMonths.map(m => expensesByMonth[m] || 0)
            };
        }

        function getCategoryData(type) {
            const data = (state.data && type === 'expenses')
                ? (Array.isArray(state.data.expenses) ? state.data.expenses : [])
                : (state.data && Array.isArray(state.data.income) ? state.data.income : []);
            const categoryMap = {};

            if (Array.isArray(data)) {
                data.forEach(item => {
                    if (item) {
                        const category = item.category || 'Other';
                        categoryMap[category] = (categoryMap[category] || 0) + Number(item.amount || 0);
                    }
                });
            }

            const sorted = Object.entries(categoryMap).sort((a, b) => b[1] - a[1]);

            return {
                labels: sorted.map(([cat]) => cat),
                values: sorted.map(([, val]) => val)
            };
        }

        // Filter state
        let currentListType = null;
        let filteredData = null;
        let selectedItems = new Set();

        function renderListTable(type) {
            currentListType = type;
            selectedItems.clear(); // Reset selections
            const titleEl = document.getElementById('list-title');
            const thead = document.getElementById('list-thead');
            const tbody = document.getElementById('list-tbody');
            const data = state.data[type] || [];
            filteredData = [...data]; // Copy for filtering

            thead.innerHTML = '';
            tbody.innerHTML = '';

            let headers = [];

            if (type === 'income') {
                titleEl.textContent = t('income_sources');
                headers = ['', t('date'), t('source'), t('category'), t('amount'), t('actions')];
            } else if (type === 'expenses') {
                titleEl.textContent = t('expenses');
                headers = ['', t('date'), t('description'), t('category'), t('amount'), t('actions')];
            } else if (type === 'receivables') {
                titleEl.textContent = t('receivables');
                headers = ['', t('due_date'), t('from'), t('description'), t('status'), t('priority'), t('amount'), t('actions')];
            } else if (type === 'payables') {
                titleEl.textContent = t('payables');
                headers = ['', t('due_date'), t('to'), t('description'), t('status'), t('priority'), t('amount'), t('actions')];
            }

            // Populate category filter
            populateCategoryFilter(type, data);

            // Render Headers
            const trHead = document.createElement('tr');
            // Add mobile Details header first
            const mobileDetailsHeader = document.createElement('th');
            mobileDetailsHeader.className = 'mobile-details';
            mobileDetailsHeader.textContent = t('details');
            trHead.appendChild(mobileDetailsHeader);

            headers.forEach((h, idx) => {
                const th = document.createElement('th');
                if (idx === 0) {
                    th.className = 'select-all-cell';
                    th.innerHTML = `<input type="checkbox" onchange="toggleSelectAll(this.checked)">`;
                } else {
                    th.textContent = h;
                }
                trHead.appendChild(th);
            });
            thead.appendChild(trHead);

            // Render Bulk Actions Bar
            renderBulkActionsBar();

            // Render rows
            renderTableRows(type, filteredData, tbody, headers.length);

            // Update item count
            const countEl = document.getElementById('list-count');
            if (countEl) {
                const totalCount = data.length;
                const filteredCount = filteredData.length;
                if (filteredCount === totalCount) {
                    countEl.textContent = `${totalCount} ${totalCount !== 1 ? t('items') : t('item')}`;
                } else {
                    countEl.textContent = `${t('showing')} ${filteredCount} ${t('of')} ${totalCount} ${totalCount !== 1 ? t('items') : t('item')}`;
                }
            }
        }

        function populateCategoryFilter(type, data) {
            const categoryFilter = document.getElementById('category-filter');
            if (!categoryFilter) return;

            const categories = [...new Set(data.map(item => item.category || 'Other').filter(Boolean))].sort();
            categoryFilter.innerHTML = `<option value="">${t('all_categories')}</option>` +
                categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }

        function renderTableRows(type, data, tbody, colspan) {
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${colspan}" class="text-center" style="padding: 2rem; color: var(--text-light);">${t('no_data_found')}</td></tr>`;
                // Clear footer if no data
                const table = tbody.closest('table');
                if (table) {
                    const tfoot = table.querySelector('tfoot');
                    if (tfoot) tfoot.remove();
                }
                return;
            }

            let totalAmount = 0;
            const amountColumnIndex = type === 'income' || type === 'expenses' ? 4 : 4; // Amount is always 4th data column (after checkbox)

            data.forEach((item, index) => {
                const originalIndex = state.data[type].indexOf(item);
                const tr = document.createElement('tr');
                let cols = '';
                const itemKey = `${type}-${originalIndex}`;
                const amount = Number(item.amount || 0);
                totalAmount += amount;

                // Checkbox column
                cols += `<td class="checkbox-cell"><input type="checkbox" onchange="toggleItemSelection('${itemKey}', this.checked)" ${selectedItems.has(itemKey) ? 'checked' : ''}></td>`;

                // Date badge helper
                const getDueDateBadge = (dueDate) => {
                    if (!dueDate) return '';
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const due = new Date(dueDate);
                    due.setHours(0, 0, 0, 0);
                    const diffDays = Math.ceil((due - today) / (1000 * 60 * 60 * 24));

                    if (diffDays < 0) {
                        return `<span class="overdue-badge">âš ï¸ Overdue (${Math.abs(diffDays)} days)</span>`;
                    } else if (diffDays <= 3) {
                        return `<span class="due-soon-badge">Due in ${diffDays} day${diffDays !== 1 ? 's' : ''}</span>`;
                    }
                    return '';
                };

                // Build mobile details content
                let mobileDetails = '';
                if (type === 'income') {
                    mobileDetails = `
                        <div class="mobile-details-content">
                            <div class="mobile-details-row">
                                <span class="mobile-details-label">Date:</span>
                                <span class="mobile-details-value">${item.date || '-'}</span>
                            </div>
                            <div class="mobile-details-row">
                                <span class="mobile-details-label">Source:</span>
                                <span class="mobile-details-value">${item.source || '-'} ${item.recurring ? '<span class="recurring-badge">ðŸ”„ Recurring</span>' : ''}</span>
                            </div>
                            <div class="mobile-details-row">
                                <span class="mobile-details-label">Category:</span>
                                <span class="mobile-details-value"><span class="tag tag-success">${item.category || 'Other'}</span></span>
                            </div>
                            ${item.account ? `<div class="mobile-details-row"><span class="mobile-details-label">Account:</span><span class="mobile-details-value">${item.account}</span></div>` : ''}
                            ${item.notes ? `<div class="mobile-details-row"><span class="mobile-details-value transaction-note">${item.notes}</span></div>` : ''}
                        </div>
                    `;
                    cols += `
                        <td>${item.date || '-'}</td>
                        <td>
                            ${item.source || '-'}
                            ${item.recurring ? '<span class="recurring-badge">ðŸ”„ Recurring</span>' : ''}
                            ${item.account ? `<div style="font-size: 0.75rem; color: var(--text-light); margin-top: 0.25rem;">ðŸ¦ ${item.account}</div>` : ''}
                            ${item.notes ? `<div class="transaction-note">${item.notes}</div>` : ''}
                        </td>
                        <td><span class="tag tag-success">${item.category || 'Other'}</span></td>
                        <td>${formatCurrency(item.amount)}</td>
                    `;
                } else if (type === 'expenses') {
                    mobileDetails = `
                        <div class="mobile-details-content">
                            <div class="mobile-details-row">
                                <span class="mobile-details-label">Date:</span>
                                <span class="mobile-details-value">${item.date || '-'}</span>
                            </div>
                            <div class="mobile-details-row">
                                <span class="mobile-details-label">Description:</span>
                                <span class="mobile-details-value">${item.description || '-'} ${item.recurring ? '<span class="recurring-badge">ðŸ”„ Recurring</span>' : ''}</span>
                            </div>
                            <div class="mobile-details-row">
                                <span class="mobile-details-label">Category:</span>
                                <span class="mobile-details-value"><span class="tag tag-danger">${item.category || 'Other'}</span></span>
                            </div>
                            ${item.account ? `<div class="mobile-details-row"><span class="mobile-details-label">Account:</span><span class="mobile-details-value">${item.account}</span></div>` : ''}
                            ${item.notes ? `<div class="mobile-details-row"><span class="mobile-details-value transaction-note">${item.notes}</span></div>` : ''}
                        </div>
                    `;
                    cols += `
                        <td>${item.date || '-'}</td>
                        <td>
                            ${item.description || '-'}
                            ${item.recurring ? '<span class="recurring-badge">ðŸ”„ Recurring</span>' : ''}
                            ${item.account ? `<div style="font-size: 0.75rem; color: var(--text-light); margin-top: 0.25rem;">ðŸ¦ ${item.account}</div>` : ''}
                            ${item.notes ? `<div class="transaction-note">${item.notes}</div>` : ''}
                        </td>
                        <td><span class="tag tag-danger">${item.category || 'Other'}</span></td>
                        <td>${formatCurrency(item.amount)}</td>
                    `;
                } else if (type === 'receivables') {
                    const status = item.status || 'unpaid';
                    const statusBadge = status === 'paid'
                        ? '<span style="background: #48bb78; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">Paid</span>'
                        : '<span style="background: #e53e3e; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">Unpaid</span>';
                    const priority = item.priority || 'medium';
                    const priorityBadge = priority === 'high'
                        ? '<span style="background: #e53e3e; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">High</span>'
                        : priority === 'low'
                            ? '<span style="background: #48bb78; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">Low</span>'
                            : '<span style="background: #d69e2e; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">Medium</span>';
                    mobileDetails = `
                        <div class="mobile-details-content">
                            <div class="mobile-details-row">
                                <span class="mobile-details-label">Due Date:</span>
                                <span class="mobile-details-value">${item.dueDate || '-'} ${getDueDateBadge(item.dueDate)}</span>
                            </div>
                            <div class="mobile-details-row">
                                <span class="mobile-details-label">From:</span>
                                <span class="mobile-details-value">${item.from || '-'}</span>
                            </div>
                            <div class="mobile-details-row">
                                <span class="mobile-details-label">Description:</span>
                                <span class="mobile-details-value">${item.description || '-'}</span>
                            </div>
                            <div class="mobile-details-row">
                                <span class="mobile-details-label">Status:</span>
                                <span class="mobile-details-value">${statusBadge}</span>
                            </div>
                            <div class="mobile-details-row">
                                <span class="mobile-details-label">Priority:</span>
                                <span class="mobile-details-value">${priorityBadge}</span>
                            </div>
                            ${item.notes ? `<div class="mobile-details-row"><span class="mobile-details-value transaction-note">${item.notes}</span></div>` : ''}
                        </div>
                    `;
                    cols += `
                        <td>
                            ${item.dueDate || '-'}
                            ${getDueDateBadge(item.dueDate)}
                        </td>
                        <td>${item.from || '-'}</td>
                        <td>${item.description || '-'}</td>
                        <td>${statusBadge}</td>
                        <td>${priorityBadge}</td>
                        <td style="color:var(--success); font-weight:bold;">${formatCurrency(item.amount)}</td>
                    `;
                } else if (type === 'payables') {
                    const status = item.status || 'unpaid';
                    const statusBadge = status === 'paid'
                        ? '<span style="background: #48bb78; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">Paid</span>'
                        : '<span style="background: #e53e3e; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">Unpaid</span>';
                    const priority = item.priority || 'medium';
                    const priorityBadge = priority === 'high'
                        ? '<span style="background: #e53e3e; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">High</span>'
                        : priority === 'low'
                            ? '<span style="background: #48bb78; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">Low</span>'
                            : '<span style="background: #d69e2e; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">Medium</span>';
                    mobileDetails = `
                        <div class="mobile-details-content">
                            <div class="mobile-details-row">
                                <span class="mobile-details-label">Due Date:</span>
                                <span class="mobile-details-value">${item.dueDate || '-'} ${getDueDateBadge(item.dueDate)}</span>
                            </div>
                            <div class="mobile-details-row">
                                <span class="mobile-details-label">To:</span>
                                <span class="mobile-details-value">${item.to || '-'}</span>
                            </div>
                            <div class="mobile-details-row">
                                <span class="mobile-details-label">Description:</span>
                                <span class="mobile-details-value">${item.description || '-'}</span>
                            </div>
                            <div class="mobile-details-row">
                                <span class="mobile-details-label">Status:</span>
                                <span class="mobile-details-value">${statusBadge}</span>
                            </div>
                            <div class="mobile-details-row">
                                <span class="mobile-details-label">Priority:</span>
                                <span class="mobile-details-value">${priorityBadge}</span>
                            </div>
                            ${item.notes ? `<div class="mobile-details-row"><span class="mobile-details-value transaction-note">${item.notes}</span></div>` : ''}
                        </div>
                    `;
                    cols += `
                        <td>
                            ${item.dueDate || '-'}
                            ${getDueDateBadge(item.dueDate)}
                        </td>
                        <td>${item.to || '-'}</td>
                        <td>${item.description || '-'}</td>
                        <td>${statusBadge}</td>
                        <td>${priorityBadge}</td>
                        <td style="color:var(--danger); font-weight:bold;">${formatCurrency(item.amount)}</td>
                    `;
                }

                // Add mobile details column (hidden on desktop, shown on mobile)
                cols = `<td class="mobile-details">${mobileDetails}</td>` + cols;

                const actionButtons = type === 'income' || type === 'expenses'
                    ? `<button class="btn-icon icon-only" onclick="duplicateTransaction('${type}', ${originalIndex})" title="Duplicate">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                    </button>`
                    : '';

                // Mobile menu items
                const duplicateMenuItem = type === 'income' || type === 'expenses'
                    ? `<button class="mobile-menu-item" onclick="duplicateTransaction('${type}', ${originalIndex}); closeMobileMenu(event);">
                        <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                        Duplicate
                    </button>`
                    : '';

                tr.innerHTML = cols + `
                    <td>
                        <div class="action-buttons">
                            ${actionButtons}
                            <button class="btn-edit" onclick="editItem('${type}', ${originalIndex})">
                                <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                                Edit
                            </button>
                            <button class="btn-delete" onclick="deleteItem('${type}', ${originalIndex})">
                                <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                                Delete
                            </button>
                        </div>
                        <div class="mobile-actions-menu">
                            <button class="mobile-menu-button" onclick="toggleMobileMenu(event)" title="Actions">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="1"></circle>
                                    <circle cx="12" cy="5" r="1"></circle>
                                    <circle cx="12" cy="19" r="1"></circle>
                                </svg>
                            </button>
                            <div class="mobile-menu-dropdown" id="menu-${itemKey}">
                                ${duplicateMenuItem}
                                <button class="mobile-menu-item" onclick="editItem('${type}', ${originalIndex}); closeMobileMenu(event);">
                                    <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                    Edit
                                </button>
                                <button class="mobile-menu-item delete" onclick="deleteItem('${type}', ${originalIndex}); closeMobileMenu(event);">
                                    <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                    Delete
                                </button>
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Add table footer with totals
            const table = tbody.closest('table');
            if (table) {
                let tfoot = table.querySelector('tfoot');
                if (!tfoot) {
                    tfoot = document.createElement('tfoot');
                    table.appendChild(tfoot);
                }
                // Calculate correct colspan: mobile details(1) + checkbox(1) + data columns before amount
                // For income/expenses: mobile(1) + checkbox(1) + Date(1) + Source/Desc(1) + Category(1) = 5 columns before Amount
                // For receivables/payables: mobile(1) + checkbox(1) + DueDate(1) + From/To(1) + Description(1) = 5 columns before Amount
                // On mobile, we show: mobile details(1) + amount(1) + actions(1), so colspan should be 1 for mobile
                const colsBeforeAmount = 5; // Mobile details + checkbox + Date/DueDate, Source/From/To, Description/Category, Category/Description
                tfoot.innerHTML = `
                    <tr>
                        <td colspan="1" class="table-total-label mobile-total" style="display: none;"><strong>Total:</strong></td>
                        <td colspan="${colsBeforeAmount - 1}" class="table-total-label desktop-total"><strong>Total:</strong></td>
                        <td class="table-total-value">${formatCurrency(totalAmount)}</td>
                        <td></td>
                    </tr>
                `;
            }
        }

        function renderBulkActionsBar() {
            const card = document.getElementById('view-list')?.querySelector('.card');
            if (!card) return;

            let bulkBar = card.querySelector('.bulk-actions');
            if (!bulkBar) {
                bulkBar = document.createElement('div');
                bulkBar.className = 'bulk-actions';
                bulkBar.innerHTML = `
                    <span id="bulk-count">0 selected</span>
                    <button class="btn btn-danger" onclick="bulkDelete()" style="width: auto;">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                        Delete Selected
                    </button>
                    <button class="btn btn-secondary" onclick="clearSelection()" style="width: auto;">Cancel</button>
                `;
                const tableContainer = card.querySelector('.table-container');
                if (tableContainer) {
                    card.insertBefore(bulkBar, tableContainer);
                } else {
                    card.appendChild(bulkBar);
                }
            }
            updateBulkActionsBar();
        }

        // Mobile menu functions
        function toggleMobileMenu(event) {
            event.stopPropagation();
            const button = event.currentTarget;
            const menu = button.nextElementSibling;
            const allMenus = document.querySelectorAll('.mobile-menu-dropdown');

            // Close all other menus
            allMenus.forEach(m => {
                if (m !== menu) {
                    m.classList.remove('show');
                }
            });

            // Toggle current menu
            menu.classList.toggle('show');
        }

        function closeMobileMenu(event) {
            if (event) {
                event.stopPropagation();
            }
            const allMenus = document.querySelectorAll('.mobile-menu-dropdown');
            allMenus.forEach(m => m.classList.remove('show'));
        }

        // Close mobile menu when clicking outside
        document.addEventListener('click', function (event) {
            if (!event.target.closest('.mobile-actions-menu')) {
                closeMobileMenu();
            }
        });

        function toggleItemSelection(itemKey, checked) {
            if (checked) {
                selectedItems.add(itemKey);
            } else {
                selectedItems.delete(itemKey);
            }
            updateBulkActionsBar();
        }

        function toggleSelectAll(checked) {
            if (!filteredData) return;
            filteredData.forEach((item, index) => {
                const originalIndex = state.data[currentListType].indexOf(item);
                const itemKey = `${currentListType}-${originalIndex}`;
                if (checked) {
                    selectedItems.add(itemKey);
                } else {
                    selectedItems.delete(itemKey);
                }
            });
            // Update all checkboxes
            document.querySelectorAll('#list-tbody input[type="checkbox"]').forEach(cb => cb.checked = checked);
            updateBulkActionsBar();
        }

        function updateBulkActionsBar() {
            const bulkBar = document.querySelector('.bulk-actions');
            const bulkCount = document.getElementById('bulk-count');
            if (bulkBar && bulkCount) {
                const count = selectedItems.size;
                bulkCount.textContent = `${count} selected`;
                if (count > 0) {
                    bulkBar.classList.add('active');
                } else {
                    bulkBar.classList.remove('active');
                }
            }
        }

        function clearSelection() {
            selectedItems.clear();
            document.querySelectorAll('#list-tbody input[type="checkbox"]').forEach(cb => cb.checked = false);
            document.querySelector('#list-thead input[type="checkbox"]').checked = false;
            updateBulkActionsBar();
        }

        function bulkDelete() {
            if (selectedItems.size === 0) return;
            showConfirmModal({
                title: 'Delete Multiple Items',
                message: `${t('are_you_sure_delete')} ${selectedItems.size} ${t('selected')} ${selectedItems.size !== 1 ? t('items') : t('item')}? ${t('action_cannot_undo')}`,
                type: 'danger',
                confirmText: 'Delete All',
                cancelText: 'Cancel'
            }).then(confirmed => {
                if (!confirmed) return;

                // Sort indices in descending order to avoid index shifting issues
                const indicesToDelete = Array.from(selectedItems)
                    .map(key => {
                        const [type, index] = key.split('-');
                        return { type, index: parseInt(index) };
                    })
                    .filter(item => item.type === currentListType)
                    .map(item => item.index)
                    .sort((a, b) => b - a);

                indicesToDelete.forEach(index => {
                    state.data[currentListType].splice(index, 1);
                });

                selectedItems.clear();
                writeExcelFile().then(() => {
                    renderAll();
                    showToast(`Successfully deleted ${indicesToDelete.length} item(s)`, 'success');
                });
            });
        }

        function applyFilters() {
            if (!currentListType) return;

            const searchTerm = (document.getElementById('search-input')?.value || '').toLowerCase();
            const categoryFilter = document.getElementById('category-filter')?.value || '';
            const dateFrom = document.getElementById('date-from-filter')?.value || '';
            const dateTo = document.getElementById('date-to-filter')?.value || '';
            const recurringFilter = document.getElementById('recurring-filter')?.value || '';
            const sortBy = document.getElementById('sort-by')?.value || '';

            const data = state.data[currentListType] || [];
            filteredData = data.filter(item => {
                // Search filter
                if (searchTerm) {
                    const searchableText = Object.values(item).join(' ').toLowerCase();
                    if (!searchableText.includes(searchTerm)) return false;
                }

                // Category filter
                if (categoryFilter && item.category !== categoryFilter) return false;

                // Date filter
                const dateField = currentListType === 'receivables' || currentListType === 'payables' ? 'dueDate' : 'date';
                const itemDate = item[dateField] || '';

                if (dateFrom && itemDate < dateFrom) return false;
                if (dateTo && itemDate > dateTo) return false;

                // Recurring filter
                if (recurringFilter) {
                    const isRecurring = item.recurring === true || item.recurring === 'true';
                    if (recurringFilter === 'recurring' && !isRecurring) return false;
                    if (recurringFilter === 'non-recurring' && isRecurring) return false;
                }

                return true;
            });

            // Apply sorting
            if (sortBy) {
                const dateField = currentListType === 'receivables' || currentListType === 'payables' ? 'dueDate' : 'date';

                filteredData.sort((a, b) => {
                    if (sortBy === 'date-asc' || sortBy === 'date-desc') {
                        const dateA = a[dateField] || '';
                        const dateB = b[dateField] || '';
                        return sortBy === 'date-asc' ? dateA.localeCompare(dateB) : dateB.localeCompare(dateA);
                    } else if (sortBy === 'amount-asc' || sortBy === 'amount-desc') {
                        const amountA = Number(a.amount || 0);
                        const amountB = Number(b.amount || 0);
                        return sortBy === 'amount-asc' ? amountA - amountB : amountB - amountA;
                    } else if (sortBy === 'category-asc' || sortBy === 'category-desc') {
                        const catA = (a.category || 'Other').toLowerCase();
                        const catB = (b.category || 'Other').toLowerCase();
                        return sortBy === 'category-asc' ? catA.localeCompare(catB) : catB.localeCompare(catA);
                    } else if (sortBy === 'status-asc' || sortBy === 'status-desc') {
                        const statusA = (a.status || 'unpaid').toLowerCase();
                        const statusB = (b.status || 'unpaid').toLowerCase();
                        // Paid comes before unpaid in asc, reverse in desc
                        if (sortBy === 'status-asc') {
                            return statusA === 'paid' ? -1 : statusB === 'paid' ? 1 : statusA.localeCompare(statusB);
                        } else {
                            return statusA === 'unpaid' ? -1 : statusB === 'unpaid' ? 1 : statusB.localeCompare(statusA);
                        }
                    } else if (sortBy === 'priority-asc' || sortBy === 'priority-desc') {
                        const priorityOrder = { 'low': 1, 'medium': 2, 'high': 3 };
                        const priorityA = priorityOrder[a.priority || 'medium'] || 2;
                        const priorityB = priorityOrder[b.priority || 'medium'] || 2;
                        return sortBy === 'priority-asc' ? priorityA - priorityB : priorityB - priorityA;
                    }
                    return 0;
                });
            }

            const tbody = document.getElementById('list-tbody');
            const headers = document.querySelectorAll('#list-thead th').length;
            renderTableRows(currentListType, filteredData, tbody, headers);

            // Update item count
            const countEl = document.getElementById('list-count');
            if (countEl) {
                const totalCount = state.data[currentListType]?.length || 0;
                const filteredCount = filteredData.length;
                if (filteredCount === totalCount) {
                    countEl.textContent = `${totalCount} ${totalCount !== 1 ? t('items') : t('item')}`;
                } else {
                    countEl.textContent = `${t('showing')} ${filteredCount} ${t('of')} ${totalCount} ${totalCount !== 1 ? t('items') : t('item')}`;
                }
            }
            
            // Re-translate after rendering
            setTimeout(() => translatePage(), 100);
        }

        function clearFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('category-filter').value = '';
            document.getElementById('date-from-filter').value = '';
            document.getElementById('date-to-filter').value = '';
            document.getElementById('recurring-filter').value = '';
            document.getElementById('sort-by').value = '';
            applyFilters();
        }

        function renderPlansList() {
            const container = document.getElementById('plans-container');
            container.innerHTML = '';
            const data = state.data.plans || [];

            if (data.length === 0) {
                container.innerHTML = `<div class="text-center" style="padding: 2rem; color: var(--text-light);">${t('no_future_plans')}</div>`;
                return;
            }

            const totalSavings = calculateTotalSavings();

            data.forEach((plan, index) => {
                const target = Number(plan.targetAmount || 1);
                const percent = Math.min(100, Math.round((totalSavings / target) * 100));
                const status = plan.status || 'in progress';
                const statusBadge = status === 'completed'
                    ? '<span style="background: #48bb78; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">Completed</span>'
                    : status === 'cancelled'
                        ? '<span style="background: #a0aec0; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">Cancelled</span>'
                        : '<span style="background: #4299e1; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">In Progress</span>';
                const priority = plan.priority || 'medium';
                const priorityBadge = priority === 'high'
                    ? '<span style="background: #e53e3e; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">High</span>'
                    : priority === 'low'
                        ? '<span style="background: #48bb78; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">Low</span>'
                        : '<span style="background: #d69e2e; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">Medium</span>';

                const div = document.createElement('div');
                div.className = 'plan-item';
                div.innerHTML = `
                    <div class="plan-header">
                        <div>
                            <h3 style="font-size: 1.1rem; margin-bottom: 0.5rem;">${plan.title || 'Untitled'}</h3>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; margin-bottom: 0.5rem;">
                                ${statusBadge}
                                ${priorityBadge}
                                ${plan.startDate ? `<span style="font-size: 0.75rem; color: var(--text-light);">Start: ${plan.startDate}</span>` : ''}
                                ${plan.deadline ? `<span style="font-size: 0.75rem; color: var(--text-light);">Deadline: ${plan.deadline}</span>` : ''}
                            </div>
                            ${plan.notes ? `<div style="font-size: 0.875rem; color: var(--text-light); margin-top: 0.25rem; font-style: italic;">${plan.notes}</div>` : ''}
                        </div>
                        <div class="action-buttons" style="position: relative;">
                            <button class="btn-edit" onclick="editItem('plans', ${index})">
                                <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                                <span class="desktop-only">Edit</span>
                            </button>
                            <button class="btn-delete" onclick="deleteItem('plans', ${index})">
                                <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                                <span class="desktop-only">Delete</span>
                            </button>
                            </div>
                            <div class="mobile-actions-menu">
                                <button class="mobile-menu-button" onclick="toggleMobileMenu(event)" title="Actions">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="1"></circle>
                                        <circle cx="12" cy="5" r="1"></circle>
                                        <circle cx="12" cy="19" r="1"></circle>
                                    </svg>
                                </button>
                                <div class="mobile-menu-dropdown" id="menu-plan-${index}">
                                    <button class="mobile-menu-item" onclick="editItem('plans', ${index}); closeMobileMenu(event);">
                                        <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                        </svg>
                                        Edit
                                    </button>
                                    <button class="mobile-menu-item delete" onclick="deleteItem('plans', ${index}); closeMobileMenu(event);">
                                        <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <polyline points="3 6 5 6 21 6"></polyline>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                        </svg>
                                        Delete
                                    </button>
                                </div>
                        </div>
                    </div>
                    <div style="font-size: 0.875rem; color: var(--text-light); margin-bottom: 0.5rem;">
                        Target: ${formatCurrency(target)} by ${plan.deadline || 'No Date'}
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill" style="width: ${percent}%"></div>
                    </div>
                    <div class="plan-meta">
                        <span>Total Savings: ${formatCurrency(totalSavings)}</span>
                        <span style="font-weight: bold; color: var(--purple);">${percent}%</span>
                    </div>
                    <div style="font-size: 0.75rem; color: var(--text-light); margin-top: 0.5rem;">
                        Remaining: ${formatCurrency(Math.max(0, target - totalSavings))}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Budget rendering
        function renderBudgetsList() {
            const container = document.getElementById('budgets-container');
            if (!container) return;

            container.innerHTML = '';
            const budgets = state.data.budgets || [];

            if (budgets.length === 0) {
                container.innerHTML = `<div class="text-center" style="padding: 2rem; color: var(--text-light);">${t('no_budgets_set')}</div>`;
                return;
            }

            budgets.forEach((budget, index) => {
                const category = budget.category || 'Uncategorized';
                const budgetAmount = Number(budget.amount || 0);
                const period = budget.period || 'monthly';

                // Helper function to filter expenses by period
                const filterExpensesByPeriod = (expenses, periodType) => {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    return expenses.filter(exp => {
                        if (!exp.date) return false;
                        const expDate = new Date(exp.date);
                        expDate.setHours(0, 0, 0, 0);

                        switch (periodType) {
                            case 'daily':
                                return expDate.getTime() === today.getTime();
                            case 'monthly':
                                return expDate.getMonth() === today.getMonth() &&
                                    expDate.getFullYear() === today.getFullYear();
                            case 'per 3 month':
                                const threeMonthsAgo = new Date(today);
                                threeMonthsAgo.setMonth(today.getMonth() - 3);
                                return expDate >= threeMonthsAgo && expDate <= today;
                            case 'per 6 month':
                                const sixMonthsAgo = new Date(today);
                                sixMonthsAgo.setMonth(today.getMonth() - 6);
                                return expDate >= sixMonthsAgo && expDate <= today;
                            case 'yearly':
                                return expDate.getFullYear() === today.getFullYear();
                            default:
                                return true; // fallback to all expenses
                        }
                    });
                };

                // Get all expenses for this category
                const categoryExpenses = state.data.expenses.filter(exp => exp.category === category);

                // Calculate overall expenses (all time)
                const overallExpenses = categoryExpenses.reduce((sum, exp) => sum + Number(exp.amount || 0), 0);

                // Calculate actual spending for this category within the budget period
                const periodExpenses = filterExpensesByPeriod(categoryExpenses, period);
                const actualSpending = periodExpenses.reduce((sum, exp) => sum + Number(exp.amount || 0), 0);

                // Calculate period-wise expenses
                const dailyExpenses = filterExpensesByPeriod(categoryExpenses, 'daily');
                const dailySpending = dailyExpenses.reduce((sum, exp) => sum + Number(exp.amount || 0), 0);

                const monthlyExpenses = filterExpensesByPeriod(categoryExpenses, 'monthly');
                const monthlySpending = monthlyExpenses.reduce((sum, exp) => sum + Number(exp.amount || 0), 0);

                const yearlyExpenses = filterExpensesByPeriod(categoryExpenses, 'yearly');
                const yearlySpending = yearlyExpenses.reduce((sum, exp) => sum + Number(exp.amount || 0), 0);

                const percent = budgetAmount > 0 ? Math.min(100, Math.round((actualSpending / budgetAmount) * 100)) : 0;
                const remaining = Math.max(0, budgetAmount - actualSpending);
                const isOverBudget = actualSpending > budgetAmount;

                const div = document.createElement('div');
                div.className = 'budget-item';
                div.style.borderLeftColor = isOverBudget ? 'var(--danger)' : 'var(--primary)';
                const periodLabel = period.charAt(0).toUpperCase() + period.slice(1);
                div.innerHTML = `
                    <div class="budget-header">
                        <div>
                            <div class="budget-category">${category}</div>
                            <div style="font-size: 0.75rem; color: var(--text-light); margin-top: 0.25rem;">Period: ${periodLabel}</div>
                        </div>
                        <div class="action-buttons" style="position: relative;">
                            <button class="btn-edit" onclick="editItem('budgets', ${index})">
                                <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                                <span class="desktop-only">Edit</span>
                            </button>
                            <button class="btn-delete" onclick="deleteItem('budgets', ${index})">
                                <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                                <span class="desktop-only">Delete</span>
                            </button>
                        </div>
                        <div class="mobile-actions-menu">
                                <button class="mobile-menu-button" onclick="toggleMobileMenu(event)" title="Actions">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="1"></circle>
                                        <circle cx="12" cy="5" r="1"></circle>
                                        <circle cx="12" cy="19" r="1"></circle>
                                    </svg>
                                </button>
                                <div class="mobile-menu-dropdown" id="menu-budget-${index}">
                                    <button class="mobile-menu-item" onclick="editItem('budgets', ${index}); closeMobileMenu(event);">
                                        <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                        </svg>
                                        Edit
                                    </button>
                                    <button class="mobile-menu-item delete" onclick="deleteItem('budgets', ${index}); closeMobileMenu(event);">
                                        <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <polyline points="3 6 5 6 21 6"></polyline>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                        </svg>
                                        Delete
                                    </button>
                                </div>
                            </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-light);">Budget</div>
                            <div class="budget-amount">${formatCurrency(budgetAmount)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-light);">Spent (${periodLabel})</div>
                            <div class="budget-amount budget-spent">${formatCurrency(actualSpending)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-light);">Remaining</div>
                            <div class="budget-amount budget-remaining">${formatCurrency(remaining)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-light);">Overall Expenses</div>
                            <div class="budget-amount" style="color: var(--text-main);">${formatCurrency(overallExpenses)}</div>
                        </div>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill" style="width: ${percent}%; background: ${isOverBudget ? 'var(--danger)' : 'var(--primary)'}"></div>
                    </div>
                    <div style="font-size: 0.75rem; color: ${isOverBudget ? 'var(--danger)' : 'var(--text-light)'}; margin-top: 0.5rem; margin-bottom: 1rem;">
                        ${isOverBudget ? `âš ï¸ Over budget by ${formatCurrency(actualSpending - budgetAmount)}` : `${percent}% used`}
                    </div>
                    <div style="background: #f7fafc; border-radius: 8px; padding: 1rem; margin-top: 1rem;">
                        <div style="font-size: 0.875rem; font-weight: 600; color: var(--text-main); margin-bottom: 0.75rem;">Period-wise Expenses Breakdown</div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem;">
                            <div>
                                <div style="font-size: 0.7rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px;">Daily (Today)</div>
                                <div style="font-size: 1rem; font-weight: 600; color: var(--text-main); margin-top: 0.25rem;">${formatCurrency(dailySpending)}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.7rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px;">Monthly (This Month)</div>
                                <div style="font-size: 1rem; font-weight: 600; color: var(--text-main); margin-top: 0.25rem;">${formatCurrency(monthlySpending)}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.7rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px;">Yearly (This Year)</div>
                                <div style="font-size: 1rem; font-weight: 600; color: var(--text-main); margin-top: 0.25rem;">${formatCurrency(yearlySpending)}</div>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Reports rendering
        function renderReports() {
            const container = document.getElementById('reports-container');
            if (!container) return;

            const period = document.getElementById('report-period')?.value || 'month';
            const dateFromContainer = document.getElementById('custom-date-from-container');
            const dateToContainer = document.getElementById('custom-date-to-container');
            const reportType = document.getElementById('report-type')?.value || 'all';
            const categoryFilter = document.getElementById('report-category')?.value || '';
            const accountFilter = document.getElementById('report-account')?.value || '';
            const statusFilter = document.getElementById('report-status')?.value || '';
            const priorityFilter = document.getElementById('report-priority')?.value || '';
            const recurringFilter = document.getElementById('report-recurring')?.value || '';
            const dateFromFilter = document.getElementById('report-date-from')?.value || '';
            const dateToFilter = document.getElementById('report-date-to')?.value || '';

            // Show/hide custom date inputs based on period selection
            if (period === 'custom') {
                if (dateFromContainer) dateFromContainer.style.display = 'block';
                if (dateToContainer) dateToContainer.style.display = 'block';
            } else {
                if (dateFromContainer) dateFromContainer.style.display = 'none';
                if (dateToContainer) dateToContainer.style.display = 'none';
            }

            // Populate category dropdown
            const categorySelect = document.getElementById('report-category');
            if (categorySelect) {
                const allCategories = [
                    ...new Set([
                        ...state.data.income.map(i => i.category).filter(Boolean),
                        ...state.data.expenses.map(e => e.category).filter(Boolean)
                    ])
                ].sort();
                const currentValue = categorySelect.value;
                categorySelect.innerHTML = '<option value="">All Categories</option>' +
                    allCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
                if (currentValue) categorySelect.value = currentValue;
            }

            const now = new Date();
            let startDate = '', endDate = '';

            // If date filters are set, use them (they override period selection)
            if (dateFromFilter || dateToFilter) {
                startDate = dateFromFilter;
                endDate = dateToFilter || now.toISOString().split('T')[0];
            } else {
                // Otherwise use period selection
                if (period === 'month') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
                    endDate = now.toISOString().split('T')[0];
                } else if (period === 'lastmonth') {
                    startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1).toISOString().split('T')[0];
                    endDate = new Date(now.getFullYear(), now.getMonth(), 0).toISOString().split('T')[0];
                } else if (period === 'quarter') {
                    const quarter = Math.floor(now.getMonth() / 3);
                    startDate = new Date(now.getFullYear(), quarter * 3, 1).toISOString().split('T')[0];
                    endDate = now.toISOString().split('T')[0];
                } else if (period === 'year') {
                    startDate = new Date(now.getFullYear(), 0, 1).toISOString().split('T')[0];
                    endDate = now.toISOString().split('T')[0];
                } else if (period === 'lastyear') {
                    startDate = new Date(now.getFullYear() - 1, 0, 1).toISOString().split('T')[0];
                    endDate = new Date(now.getFullYear() - 1, 11, 31).toISOString().split('T')[0];
                } else if (period === 'custom') {
                    startDate = dateFromFilter || '';
                    endDate = dateToFilter || '';
                }
            }

            const filterByDate = (items, dateField) => {
                // If no date filters and period is 'all', return all items
                if (!startDate && !endDate && (period === 'all' || (!dateFromFilter && !dateToFilter))) {
                    return items;
                }

                // If only one date is set, use it appropriately
                if (startDate && !endDate) {
                    return items.filter(item => {
                        const itemDate = item[dateField] || '';
                        return itemDate >= startDate;
                    });
                }
                if (!startDate && endDate) {
                    return items.filter(item => {
                        const itemDate = item[dateField] || '';
                        return itemDate <= endDate;
                    });
                }

                // Both dates set
                if (startDate && endDate) {
                    return items.filter(item => {
                        const itemDate = item[dateField] || '';
                        return itemDate >= startDate && itemDate <= endDate;
                    });
                }

                return items;
            };

            // Apply all filters
            const applyFilters = (items, dateField, itemType) => {
                let filtered = filterByDate(items, dateField);

                // Category filter (for income/expenses)
                if (categoryFilter && (itemType === 'income' || itemType === 'expense')) {
                    filtered = filtered.filter(item => item.category === categoryFilter);
                }

                // Payment method filter (for income/expenses)
                if (accountFilter && (itemType === 'income' || itemType === 'expense')) {
                    filtered = filtered.filter(item => item.account === accountFilter);
                }

                // Status filter (for receivables/payables)
                if (statusFilter && (itemType === 'receivable' || itemType === 'payable')) {
                    filtered = filtered.filter(item => (item.status || 'unpaid') === statusFilter);
                }

                // Priority filter (for receivables/payables)
                if (priorityFilter && (itemType === 'receivable' || itemType === 'payable')) {
                    filtered = filtered.filter(item => (item.priority || 'medium') === priorityFilter);
                }

                // Recurring filter (for income/expenses)
                if (recurringFilter && (itemType === 'income' || itemType === 'expense')) {
                    const isRecurring = recurringFilter === 'recurring';
                    filtered = filtered.filter(item => {
                        const itemRecurring = item.recurring === true || item.recurring === 'true';
                        return isRecurring ? itemRecurring : !itemRecurring;
                    });
                }

                return filtered;
            };

            let periodIncome = applyFilters(state.data.income, 'date', 'income');
            let periodExpenses = applyFilters(state.data.expenses, 'date', 'expense');
            let periodReceivables = applyFilters(state.data.receivables, 'dueDate', 'receivable');
            let periodPayables = applyFilters(state.data.payables, 'dueDate', 'payable');

            // Apply transaction type filter
            if (reportType === 'income') {
                periodExpenses = [];
                periodReceivables = [];
                periodPayables = [];
            } else if (reportType === 'expense') {
                periodIncome = [];
                periodReceivables = [];
                periodPayables = [];
            } else if (reportType === 'receivable') {
                periodIncome = [];
                periodExpenses = [];
                periodPayables = [];
            } else if (reportType === 'payable') {
                periodIncome = [];
                periodExpenses = [];
                periodReceivables = [];
            }

            const totalIncome = periodIncome.reduce((sum, i) => sum + Number(i.amount || 0), 0);
            const totalExpenses = periodExpenses.reduce((sum, i) => sum + Number(i.amount || 0), 0);
            const netBalance = totalIncome - totalExpenses;
            const totalReceivables = periodReceivables.reduce((sum, i) => sum + Number(i.amount || 0), 0);
            const totalPayables = periodPayables.reduce((sum, i) => sum + Number(i.amount || 0), 0);

            let reportHTML = `
                <div class="report-section">
                    <div class="report-title">Summary</div>
                    <div class="report-grid">
            `;

            if (reportType === 'all' || reportType === 'income') {
                reportHTML += `
                        <div class="stat-card" style="border-color: var(--success);">
                            <div class="stat-label" data-translate="total_income">Total Income</div>
                            <div class="stat-value">${formatCurrency(totalIncome)}</div>
                        </div>
                `;
            }

            if (reportType === 'all' || reportType === 'expense') {
                reportHTML += `
                        <div class="stat-card" style="border-color: var(--danger);">
                            <div class="stat-label" data-translate="total_expenses">Total Expenses</div>
                            <div class="stat-value">${formatCurrency(totalExpenses)}</div>
                        </div>
                `;
            }

            if (reportType === 'all' && (periodIncome.length > 0 || periodExpenses.length > 0)) {
                reportHTML += `
                        <div class="stat-card" style="border-color: var(--primary);">
                            <div class="stat-label" data-translate="net_balance">Net Balance</div>
                            <div class="stat-value">${formatCurrency(netBalance)}</div>
                        </div>
                `;
            }

            if (reportType === 'all' || reportType === 'receivable') {
                reportHTML += `
                        <div class="stat-card" style="border-color: var(--warning);">
                            <div class="stat-label" data-translate="due_receivables">Due Receivables</div>
                            <div class="stat-value">${formatCurrency(totalReceivables)}</div>
                        </div>
                `;
            }

            if (reportType === 'all' || reportType === 'payable') {
                reportHTML += `
                        <div class="stat-card" style="border-color: #c53030;">
                            <div class="stat-label" data-translate="due_payables">Due Payables</div>
                            <div class="stat-value">${formatCurrency(totalPayables)}</div>
                        </div>
                `;
            }

            reportHTML += `
                    </div>
                </div>
            `;

            if ((reportType === 'all' || reportType === 'expense') && periodExpenses.length > 0) {
                reportHTML += `
                <div class="report-section">
                    <div class="report-title">Top Expense Categories</div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Amount</th>
                                    <th>Transactions</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${getCategoryBreakdown(periodExpenses).map(cat => `
                                    <tr>
                                        <td><span class="tag tag-danger">${cat.name}</span></td>
                                        <td>${formatCurrency(cat.amount)}</td>
                                        <td>${cat.count}</td>
                                        <td>${cat.percentage}%</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td class="table-total-label"><strong>Total:</strong></td>
                                    <td class="table-total-value">${formatCurrency(totalExpenses)}</td>
                                    <td><strong>${periodExpenses.length}</strong></td>
                                    <td><strong>100%</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                `;
            }

            if ((reportType === 'all' || reportType === 'income') && periodIncome.length > 0) {
                reportHTML += `
                <div class="report-section">
                    <div class="report-title">Top Income Categories</div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Amount</th>
                                    <th>Transactions</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${getCategoryBreakdown(periodIncome).map(cat => `
                                    <tr>
                                        <td><span class="tag tag-success">${cat.name}</span></td>
                                        <td>${formatCurrency(cat.amount)}</td>
                                        <td>${cat.count}</td>
                                        <td>${cat.percentage}%</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td class="table-total-label"><strong>Total:</strong></td>
                                    <td class="table-total-value">${formatCurrency(totalIncome)}</td>
                                    <td><strong>${periodIncome.length}</strong></td>
                                    <td><strong>100%</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                `;
            }

            if (reportHTML.trim() === '<div class="report-section">') {
                reportHTML = '<div class="text-center" style="padding: 2rem; color: var(--text-light);">No data found for the selected filters.</div>';
            }

            container.innerHTML = reportHTML;
        }

        function resetReportFilters() {
            document.getElementById('report-period').value = 'month';
            document.getElementById('report-type').value = 'all';
            document.getElementById('report-category').value = '';
            document.getElementById('report-payment-method').value = '';
            document.getElementById('report-status').value = '';
            document.getElementById('report-priority').value = '';
            document.getElementById('report-recurring').value = '';
            document.getElementById('report-date-from').value = '';
            document.getElementById('report-date-to').value = '';
            document.getElementById('custom-from').value = '';
            document.getElementById('custom-to').value = '';
            document.getElementById('custom-date-range').style.display = 'none';
            renderReports();
        }

        function getCategoryBreakdown(items) {
            const categoryMap = {};
            items.forEach(item => {
                const cat = item.category || 'Other';
                if (!categoryMap[cat]) {
                    categoryMap[cat] = { amount: 0, count: 0 };
                }
                categoryMap[cat].amount += Number(item.amount || 0);
                categoryMap[cat].count++;
            });

            const total = items.reduce((sum, item) => sum + Number(item.amount || 0), 0);
            return Object.entries(categoryMap)
                .map(([name, data]) => ({
                    name,
                    amount: data.amount,
                    count: data.count,
                    percentage: total > 0 ? ((data.amount / total) * 100).toFixed(1) : 0
                }))
                .sort((a, b) => b.amount - a.amount)
                .slice(0, 10);
        }

        function printReport() {
            window.print();
        }

        function exportReportToPDF() {
            // Simple PDF export using window.print with PDF option
            // For better PDF generation, you could use libraries like jsPDF
            alert('To export as PDF, use the Print button and select "Save as PDF" from your printer options.');
            window.print();
        }

        // Analytics rendering
        // Category Management
        function getCategoriesByType(type) {
            // Get all unique categories from data if categories sheet is empty
            if (!state.data.categories || state.data.categories.length === 0) {
                const dataArray = type === 'income' ? state.data.income : state.data.expenses;
                const uniqueCategories = [...new Set(dataArray.map(item => item.category).filter(Boolean))];
                return uniqueCategories.map(cat => ({ name: cat, type: type }));
            }
            return state.data.categories.filter(cat => cat.type === type);
        }

        function renderCategoriesList() {
            const incomeContainer = document.getElementById('income-categories-list');
            const expenseContainer = document.getElementById('expense-categories-list');

            if (!incomeContainer || !expenseContainer) return;

            const incomeCategories = getCategoriesByType('income');
            const expenseCategories = getCategoriesByType('expense');

            // Render Income Categories
            if (incomeCategories.length === 0) {
                incomeContainer.innerHTML = '<div style="color: var(--text-light); font-style: italic; padding: 1rem;">No income categories. Add one to get started.</div>';
            } else {
                incomeContainer.innerHTML = incomeCategories.map((cat, index) => {
                    const catIndex = state.data.categories.findIndex(c => c.name === cat.name && c.type === 'income');
                    const usageCount = state.data.income.filter(i => i.category === cat.name).length;
                    return `
                        <div class="category-item">
                            <div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    ${cat.color ? `<span style="width: 16px; height: 16px; border-radius: 50%; background: ${cat.color}; display: inline-block;"></span>` : ''}
                                    <span class="category-name">${cat.name || 'Unnamed'}</span>
                                </div>
                                <span class="category-badge badge-income">Income</span>
                                <small style="color: var(--text-light); margin-left: 0.5rem;">(${usageCount} transactions)</small>
                            </div>
                            <div class="category-actions">
                                <button class="btn-edit" onclick="editItem('categories', ${catIndex >= 0 ? catIndex : index})">
                                    <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                    Edit
                                </button>
                                <button class="btn-delete" onclick="deleteCategory('income', '${cat.name}', ${usageCount})">
                                    <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                    Delete
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Render Expense Categories
            if (expenseCategories.length === 0) {
                expenseContainer.innerHTML = '<div style="color: var(--text-light); font-style: italic; padding: 1rem;">No expense categories. Add one to get started.</div>';
            } else {
                expenseContainer.innerHTML = expenseCategories.map((cat, index) => {
                    const catIndex = state.data.categories.findIndex(c => c.name === cat.name && c.type === 'expense');
                    const usageCount = state.data.expenses.filter(e => e.category === cat.name).length;
                    return `
                        <div class="category-item">
                            <div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    ${cat.color ? `<span style="width: 16px; height: 16px; border-radius: 50%; background: ${cat.color}; display: inline-block;"></span>` : ''}
                                    <span class="category-name">${cat.name || 'Unnamed'}</span>
                                </div>
                                <span class="category-badge badge-expense">Expense</span>
                                <small style="color: var(--text-light); margin-left: 0.5rem;">(${usageCount} transactions)</small>
                            </div>
                            <div class="category-actions">
                                <button class="btn-edit" onclick="editItem('categories', ${catIndex >= 0 ? catIndex : index})">
                                    <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                    Edit
                                </button>
                                <button class="btn-delete" onclick="deleteCategory('expense', '${cat.name}', ${usageCount})">
                                    <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                    Delete
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function deleteCategory(type, name, usageCount) {
            if (usageCount > 0) {
                if (!confirm(`${t('category_used_in_transactions')} ${usageCount} ${t('transaction')}${usageCount !== 1 ? 's' : ''}. ${t('deleting_will_set_to_other')}`)) {
                    return;
                }
                // Update transactions to use "Other" category
                if (type === 'income') {
                    state.data.income.forEach(item => {
                        if (item.category === name) item.category = 'Other';
                    });
                } else {
                    state.data.expenses.forEach(item => {
                        if (item.category === name) item.category = 'Other';
                    });
                }
            }

            const index = state.data.categories.findIndex(c => c.name === name && c.type === type);
            if (index >= 0) {
                state.data.categories.splice(index, 1);
            }

            writeExcelFile().then(() => {
                renderAll();
            });
        }

        function renderAnalytics() {
            const container = document.getElementById('analytics-container');
            if (!container) return;

            const monthlyData = getMonthlyData();
            const expenseCategories = getCategoryData('expenses');
            const incomeCategories = getCategoryData('income');

            // Calculate trends
            const recentMonths = 3;
            const recentExpenses = monthlyData.expenses.slice(-recentMonths);
            const recentIncome = monthlyData.income.slice(-recentMonths);
            const avgRecentExpense = recentExpenses.length > 0
                ? recentExpenses.reduce((a, b) => a + b, 0) / recentExpenses.length
                : 0;
            const avgRecentIncome = recentIncome.length > 0
                ? recentIncome.reduce((a, b) => a + b, 0) / recentIncome.length
                : 0;

            container.innerHTML = `
                <div class="analytics-grid">
                    <div class="insight-card">
                        <div class="insight-title">Average Monthly Spending</div>
                        <div class="insight-value">${formatCurrency(avgRecentExpense)}</div>
                        <div class="insight-trend">Last ${recentMonths} months average</div>
                    </div>
                    <div class="insight-card">
                        <div class="insight-title" data-translate="average_monthly_income">Average Monthly Income</div>
                        <div class="insight-value">${formatCurrency(avgRecentIncome)}</div>
                        <div class="insight-trend">Last ${recentMonths} months average</div>
                    </div>
                    <div class="insight-card">
                        <div class="insight-title">Savings Rate</div>
                        <div class="insight-value">${avgRecentIncome > 0 ? ((avgRecentIncome - avgRecentExpense) / avgRecentIncome * 100).toFixed(1) : 0}%</div>
                        <div class="insight-trend">Income vs Expenses</div>
                    </div>
                    <div class="insight-card">
                        <div class="insight-title">Total Transactions</div>
                        <div class="insight-value">${state.data.expenses.length + state.data.income.length}</div>
                        <div class="insight-trend">${state.data.expenses.length} expenses, ${state.data.income.length} income</div>
                    </div>
                </div>
                <div class="card" style="margin-bottom: 1.5rem;">
                    <h3>Top Spending Categories</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Total Amount</th>
                                    <th>Percentage</th>
                                    <th>Transactions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${expenseCategories.labels.slice(0, 10).map((label, idx) => {
                const amount = expenseCategories.values[idx];
                const total = expenseCategories.values.reduce((a, b) => a + b, 0);
                const percentage = total > 0 ? ((amount / total) * 100).toFixed(1) : 0;
                const count = state.data.expenses.filter(e => e.category === label).length;
                return `
                                        <tr>
                                            <td><span class="tag tag-danger">${label}</span></td>
                                            <td>${formatCurrency(amount)}</td>
                                            <td>${percentage}%</td>
                                            <td>${count}</td>
                                        </tr>
                                    `;
            }).join('')}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td class="table-total-label"><strong>Total:</strong></td>
                                    <td class="table-total-value">${formatCurrency(expenseCategories.values.reduce((a, b) => a + b, 0))}</td>
                                    <td><strong>100%</strong></td>
                                    <td><strong>${state.data.expenses.length}</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                <div class="card">
                    <h3>Top Income Categories</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Total Amount</th>
                                    <th>Percentage</th>
                                    <th>Transactions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${incomeCategories.labels.slice(0, 10).map((label, idx) => {
                const amount = incomeCategories.values[idx];
                const total = incomeCategories.values.reduce((a, b) => a + b, 0);
                const percentage = total > 0 ? ((amount / total) * 100).toFixed(1) : 0;
                const count = state.data.income.filter(i => i.category === label).length;
                return `
                                        <tr>
                                            <td><span class="tag tag-success">${label}</span></td>
                                            <td>${formatCurrency(amount)}</td>
                                            <td>${percentage}%</td>
                                            <td>${count}</td>
                                        </tr>
                                    `;
            }).join('')}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td class="table-total-label"><strong>Total:</strong></td>
                                    <td class="table-total-value">${formatCurrency(incomeCategories.values.reduce((a, b) => a + b, 0))}</td>
                                    <td><strong>100%</strong></td>
                                    <td><strong>${state.data.income.length}</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            `;
        }

        // --- 4. MODAL & FORM LOGIC ---

        // Edit state
        let editingIndex = null;
        let editingType = null;

        function openModal(mode, type = null, editIndex = null, categoryType = null) {
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');

            editingIndex = editIndex;
            editingType = type;
            if (categoryType) window.lastCategoryType = categoryType;

            overlay.classList.add('active');

            if (mode === 'selector') {
                content.innerHTML = `
                    <div class="modal-header">${t('add')} ${t('new')} ${t('item')}</div>
                    <div class="type-grid">
                        <div class="type-card" onclick="openModal('form', 'income')">
                            <span class="type-icon">ðŸ’°</span>
                            <div class="type-label">${t('income')}</div>
                        </div>
                        <div class="type-card" onclick="openModal('form', 'expense')">
                            <span class="type-icon">ðŸ’¸</span>
                            <div class="type-label">${t('expenses')}</div>
                        </div>
                        <div class="type-card" onclick="openModal('form', 'receivable')">
                            <span class="type-icon">ðŸ“¥</span>
                            <div class="type-label">${t('receivables')}</div>
                        </div>
                        <div class="type-card" onclick="openModal('form', 'payable')">
                            <span class="type-icon">ðŸ“¤</span>
                            <div class="type-label">${t('payables')}</div>
                        </div>
                        <div class="type-card"  onclick="openModal('form', 'plan')">
                            <span class="type-icon">ðŸŽ¯</span>
                            <div class="type-label">${t('plans')}</div>
                        </div>
                        <div class="type-card"  onclick="openModal('form', 'budget')">
                            <span class="type-icon">ðŸ’°</span>
                            <div class="type-label">${t('budgets')}</div>
                        </div>
                        <div class="type-card"  onclick="openCategorySelector()">
                            <span class="type-icon">ðŸ“</span>
                            <div class="type-label">${t('categories')}</div>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
                `;
                setTimeout(() => translatePage(), 50);
            } else if (mode === 'form') {
                const isEditing = editIndex !== null;
                // Map form type back to data type for retrieving item
                const dataTypeMap = {
                    'income': 'income',
                    'expense': 'expenses',
                    'receivable': 'receivables',
                    'payable': 'payables',
                    'plan': 'plans',
                    'budget': 'budgets',
                    'category': 'categories'
                };
                const dataType = dataTypeMap[type] || type;
                const item = isEditing && editIndex !== null ? (state.data[dataType] && state.data[dataType][editIndex]) : null;
                const today = new Date().toISOString().split('T')[0]; // Default date

                let formHTML = `<div class="modal-header">${isEditing ? 'Edit' : 'Add'} ${type.charAt(0).toUpperCase() + type.slice(1)}</div>`;

                if (type === 'income') {
                    const incomeCategories = getCategoriesByType('income').map(c => c.name);
                    const uniqueCategories = [...new Set([...incomeCategories, ...state.data.income.map(i => i.category).filter(Boolean)])].sort();
                    const categoryOptions = uniqueCategories.map(cat => `<option${item?.category === cat ? ' selected' : ''}>${cat || 'Other'}</option>`).join('');
                    formHTML += `
                        <div class="form-group">
                            <label class="form-label">Source</label>
                            <input type="text" class="form-input" id="inp-source" placeholder="${t('placeholder_salary_freelance')}" value="${item?.source || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <select class="form-select" id="inp-category" style="flex: 1;">
                                    <option value="">Select Category</option>
                                    ${categoryOptions}
                                </select>
                                <button type="button" class="btn-icon" onclick="closeModal(); setTimeout(() => openModal('form', 'category', null, 'income'), 100);" title="Manage Categories">âš™ï¸</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('amount')}</label>
                            <input type="number" class="form-input" id="inp-amount" placeholder="0" step="0.01" value="${item?.amount || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('date')}</label>
                            <input type="date" class="form-input" id="inp-date" value="${item?.date || today}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('account')} *</label>
                            ${(state.data.accounts || []).length === 0 ? `
                                <div style="padding: 1rem; background: #fef3c7; border-radius: 8px; margin-bottom: 0.5rem;">
                                    <div style="font-size: 0.875rem; color: #92400e;">âš ï¸ No accounts found. Please <a href="#" onclick="closeModal(); setTimeout(() => switchTab('accounts'), 100);" style="color: var(--primary); text-decoration: underline;">add an account</a> first.</div>
                                </div>
                            ` : ''}
                            <div style="display: flex; gap: 0.5rem;">
                                <select class="form-select" id="inp-account" style="flex: 1;" required ${(state.data.accounts || []).length === 0 ? 'disabled' : ''}>
                                    <option value="">${t('select_account')}</option>
                                    ${(state.data.accounts || []).map(acc => `<option value="${acc.name}" ${(item?.account === acc.name || (!item?.account && item?.paymentMethod && item.paymentMethod === acc.type)) ? 'selected' : ''}>${acc.name} (${acc.type})</option>`).join('')}
                                </select>
                                <button type="button" class="btn-icon" onclick="closeModal(); setTimeout(() => switchTab('accounts'), 100);" title="Manage Accounts">âš™ï¸</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('notes_optional')}</label>
                            <textarea class="form-input" id="inp-notes" placeholder="${t('additional_notes')}" rows="2">${item?.notes || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="inp-recurring" ${item?.recurring ? 'checked' : ''} onchange="toggleRecurringOptions('income')">
                                <span>${t('recurring_transaction')}</span>
                            </label>
                        </div>
                        <div id="recurring-options-income" style="display: ${item?.recurring ? 'block' : 'none'}; margin-top: 0.5rem; padding: 1rem; background: #f7fafc; border-radius: 8px;">
                            <div class="form-group">
                                <label class="form-label">${t('frequency')}</label>
                                <select class="form-select" id="inp-recurring-frequency-income">
                                    <option value="daily" ${item?.recurringFrequency === 'daily' ? 'selected' : ''}>${t('daily')}</option>
                                    <option value="weekly" ${item?.recurringFrequency === 'weekly' ? 'selected' : ''}>${t('weekly')}</option>
                                    <option value="monthly" ${item?.recurringFrequency === 'monthly' || !item?.recurringFrequency ? 'selected' : ''}>${t('monthly')}</option>
                                    <option value="yearly" ${item?.recurringFrequency === 'yearly' ? 'selected' : ''}>${t('yearly')}</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">${t('next_occurrence_date')}</label>
                                <input type="date" class="form-input" id="inp-recurring-next-income" value="${item?.recurringNextDate || ''}">
                            </div>
                        </div>
                    `;
                } else if (type === 'expense') {
                    const expenseCategories = getCategoriesByType('expense').map(c => c.name);
                    const uniqueCategories = [...new Set([...expenseCategories, ...state.data.expenses.map(e => e.category).filter(Boolean)])].sort();
                    const categoryOptions = uniqueCategories.map(cat => `<option${item?.category === cat ? ' selected' : ''}>${cat || 'Other'}</option>`).join('');
                    formHTML += `
                        <div class="form-group">
                            <label class="form-label">${t('description')}</label>
                            <input type="text" class="form-input" id="inp-desc" placeholder="${t('placeholder_groceries')}" value="${item?.description || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('category')}</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <select class="form-select" id="inp-category" style="flex: 1;">
                                    <option value="">${t('select_category')}</option>
                                    ${categoryOptions}
                                </select>
                                <button type="button" class="btn-icon" onclick="closeModal(); setTimeout(() => openModal('form', 'category', null, 'expense'), 100);" title="Manage Categories">âš™ï¸</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('amount')}</label>
                            <input type="number" class="form-input" id="inp-amount" placeholder="0" step="0.01" value="${item?.amount || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('date')}</label>
                            <input type="date" class="form-input" id="inp-date" value="${item?.date || today}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('account')} *</label>
                            ${(state.data.accounts || []).length === 0 ? `
                                <div style="padding: 1rem; background: #fef3c7; border-radius: 8px; margin-bottom: 0.5rem;">
                                    <div style="font-size: 0.875rem; color: #92400e;">âš ï¸ No accounts found. Please <a href="#" onclick="closeModal(); setTimeout(() => switchTab('accounts'), 100);" style="color: var(--primary); text-decoration: underline;">add an account</a> first.</div>
                                </div>
                            ` : ''}
                            <div style="display: flex; gap: 0.5rem;">
                                <select class="form-select" id="inp-account" style="flex: 1;" required ${(state.data.accounts || []).length === 0 ? 'disabled' : ''}>
                                    <option value="">${t('select_account')}</option>
                                    ${(state.data.accounts || []).map(acc => `<option value="${acc.name}" ${(item?.account === acc.name || (!item?.account && item?.paymentMethod && item.paymentMethod === acc.type)) ? 'selected' : ''}>${acc.name} (${acc.type})</option>`).join('')}
                                </select>
                                <button type="button" class="btn-icon" onclick="closeModal(); setTimeout(() => switchTab('accounts'), 100);" title="Manage Accounts">âš™ï¸</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('notes_optional')}</label>
                            <textarea class="form-input" id="inp-notes" placeholder="${t('additional_notes')}" rows="2">${item?.notes || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="inp-recurring" ${item?.recurring ? 'checked' : ''} onchange="toggleRecurringOptions('expense')">
                                <span>${t('recurring_transaction')}</span>
                            </label>
                        </div>
                        <div id="recurring-options-expense" style="display: ${item?.recurring ? 'block' : 'none'}; margin-top: 0.5rem; padding: 1rem; background: #f7fafc; border-radius: 8px;">
                            <div class="form-group">
                                <label class="form-label">${t('frequency')}</label>
                                <select class="form-select" id="inp-recurring-frequency-expense">
                                    <option value="daily" ${item?.recurringFrequency === 'daily' ? 'selected' : ''}>${t('daily')}</option>
                                    <option value="weekly" ${item?.recurringFrequency === 'weekly' ? 'selected' : ''}>${t('weekly')}</option>
                                    <option value="monthly" ${item?.recurringFrequency === 'monthly' || !item?.recurringFrequency ? 'selected' : ''}>${t('monthly')}</option>
                                    <option value="yearly" ${item?.recurringFrequency === 'yearly' ? 'selected' : ''}>${t('yearly')}</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Next Occurrence Date</label>
                                <input type="date" class="form-input" id="inp-recurring-next-expense" value="${item?.recurringNextDate || ''}">
                            </div>
                        </div>
                    `;
                } else if (type === 'receivable') {
                    formHTML += `
                        <div class="form-group">
                            <label class="form-label">${t('from_client')}</label>
                            <input type="text" class="form-input" id="inp-from" placeholder="${t('name_placeholder')}" value="${item?.from || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('description')}</label>
                            <input type="text" class="form-input" id="inp-desc" placeholder="${t('reason')}" value="${item?.description || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('amount')}</label>
                            <input type="number" class="form-input" id="inp-amount" placeholder="0" value="${item?.amount || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('due_date')}</label>
                            <input type="date" class="form-input" id="inp-duedate" value="${item?.dueDate || today}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('status')}</label>
                            <select class="form-select" id="inp-status">
                                <option value="unpaid" ${(item?.status || 'unpaid') === 'unpaid' ? 'selected' : ''}>${t('unpaid')}</option>
                                <option value="paid" ${item?.status === 'paid' ? 'selected' : ''}>${t('paid')}</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('priority')}</label>
                            <select class="form-select" id="inp-priority">
                                <option value="low" ${(item?.priority || 'medium') === 'low' ? 'selected' : ''}>${t('low')}</option>
                                <option value="medium" ${(item?.priority || 'medium') === 'medium' ? 'selected' : ''}>${t('medium')}</option>
                                <option value="high" ${item?.priority === 'high' ? 'selected' : ''}>${t('high')}</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('notes_optional')}</label>
                            <textarea class="form-input" id="inp-notes" placeholder="${t('additional_notes')}" rows="2">${item?.notes || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('reminder_days_before')}</label>
                            <input type="number" class="form-input" id="inp-reminder-days" placeholder="${t('placeholder_example_3')}" min="0" value="${item?.reminderDays || ''}">
                            <small style="color: var(--text-light); font-size: 0.75rem;">${t('reminder_help_text')}</small>
                        </div>
                    `;
                } else if (type === 'payable') {
                    formHTML += `
                        <div class="form-group">
                            <label class="form-label">${t('to_vendor')}</label>
                            <input type="text" class="form-input" id="inp-to" placeholder="${t('name_placeholder')}" value="${item?.to || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('description')}</label>
                            <input type="text" class="form-input" id="inp-desc" placeholder="${t('reason')}" value="${item?.description || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('amount')}</label>
                            <input type="number" class="form-input" id="inp-amount" placeholder="0" value="${item?.amount || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('due_date')}</label>
                            <input type="date" class="form-input" id="inp-duedate" value="${item?.dueDate || today}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('status')}</label>
                            <select class="form-select" id="inp-status">
                                <option value="unpaid" ${(item?.status || 'unpaid') === 'unpaid' ? 'selected' : ''}>${t('unpaid')}</option>
                                <option value="paid" ${item?.status === 'paid' ? 'selected' : ''}>${t('paid')}</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('priority')}</label>
                            <select class="form-select" id="inp-priority">
                                <option value="low" ${(item?.priority || 'medium') === 'low' ? 'selected' : ''}>${t('low')}</option>
                                <option value="medium" ${(item?.priority || 'medium') === 'medium' ? 'selected' : ''}>${t('medium')}</option>
                                <option value="high" ${item?.priority === 'high' ? 'selected' : ''}>${t('high')}</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('notes_optional')}</label>
                            <textarea class="form-input" id="inp-notes" placeholder="${t('additional_notes')}" rows="2">${item?.notes || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('reminder_days_before')}</label>
                            <input type="number" class="form-input" id="inp-reminder-days" placeholder="${t('placeholder_example_3')}" min="0" value="${item?.reminderDays || ''}">
                            <small style="color: var(--text-light); font-size: 0.75rem;">${t('reminder_help_text')}</small>
                        </div>
                    `;
                } else if (type === 'plan') {
                    formHTML += `
                        <div class="form-group">
                            <label class="form-label">${t('plan_title')}</label>
                            <input type="text" class="form-input" id="inp-title" placeholder="${t('placeholder_new_laptop')}" value="${item?.title || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('target_amount')}</label>
                            <input type="number" class="form-input" id="inp-target" placeholder="0" value="${item?.targetAmount || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('start_date')}</label>
                            <input type="date" class="form-input" id="inp-start-date" value="${item?.startDate || today}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('target_deadline')}</label>
                            <input type="date" class="form-input" id="inp-deadline" value="${item?.deadline || today}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('status')}</label>
                            <select class="form-select" id="inp-status">
                                <option value="in progress" ${(item?.status || 'in progress') === 'in progress' ? 'selected' : ''}>${t('in_progress')}</option>
                                <option value="completed" ${item?.status === 'completed' ? 'selected' : ''}>${t('completed')}</option>
                                <option value="cancelled" ${item?.status === 'cancelled' ? 'selected' : ''}>${t('cancelled')}</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('priority')}</label>
                            <select class="form-select" id="inp-priority">
                                <option value="low" ${(item?.priority || 'medium') === 'low' ? 'selected' : ''}>${t('low')}</option>
                                <option value="medium" ${(item?.priority || 'medium') === 'medium' ? 'selected' : ''}>${t('medium')}</option>
                                <option value="high" ${item?.priority === 'high' ? 'selected' : ''}>${t('high')}</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('notes_optional')}</label>
                            <textarea class="form-input" id="inp-notes" placeholder="${t('additional_notes')}" rows="2">${item?.notes || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('reminder_days_before_deadline')}</label>
                            <input type="number" class="form-input" id="inp-reminder-days" placeholder="${t('placeholder_example_7')}" min="0" value="${item?.reminderDays || ''}">
                            <small style="color: var(--text-light); font-size: 0.75rem;">${t('reminder_deadline_help')}</small>
                        </div>
                        <div style="padding: 1rem; background: #f7fafc; border-radius: 8px; font-size: 0.875rem; color: var(--text-light);">
                            ${t('progress_note')}
                        </div>
                    `;
                } else if (type === 'category') {
                    const categoryType = editIndex === null && typeof editIndex !== 'number' ? (window.lastCategoryType || 'expense') : (item?.type || 'expense');
                    const colors = ['#4299e1', '#48bb78', '#ed8936', '#e53e3e', '#9f7aea', '#38b2ac', '#f56565', '#805ad5', '#d69e2e', '#319795'];
                    const currentColor = item?.color || colors[0];
                    formHTML += `
                        <div class="form-group">
                            <label class="form-label">${t('category')} ${t('name')}</label>
                            <input type="text" class="form-input" id="inp-name" placeholder="${t('placeholder_groceries_salary')}" value="${item?.name || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('type')}</label>
                            <select class="form-select" id="inp-type" ${item ? 'disabled' : ''}>
                                <option value="income" ${categoryType === 'income' ? 'selected' : ''}>${t('income')}</option>
                                <option value="expense" ${categoryType === 'expense' ? 'selected' : ''}>${t('expenses')}</option>
                            </select>
                            ${item ? `<small style="color: var(--text-light);">${t('type_cannot_change')}</small>` : ''}
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('color')}</label>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem;">
                                ${colors.map(color => `
                                    <label style="cursor: pointer; display: flex; align-items: center; gap: 0.25rem;">
                                        <input type="radio" name="category-color" value="${color}" ${currentColor === color ? 'checked' : ''} style="display: none;">
                                        <span style="width: 32px; height: 32px; border-radius: 50%; background: ${color}; border: ${currentColor === color ? '3px solid #000' : '2px solid #e2e8f0'}; display: block;"></span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else if (type === 'budget') {
                    const categories = [...new Set(state.data.expenses.map(e => e.category).filter(Boolean))].sort();
                    const categoryOptions = categories.map(cat => `<option${item?.category === cat ? ' selected' : ''}>${cat}</option>`).join('');
                    const periodValue = item?.period || 'monthly';
                    formHTML += `
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <select class="form-select" id="inp-category" ${isEditing ? 'disabled' : ''}>
                                <option value="">Select Category</option>
                                ${categoryOptions}
                            </select>
                            ${isEditing ? '<small style="color: var(--text-light);">Category cannot be changed after creation</small>' : ''}
                        </div>
                        <div class="form-group">
                            <label class="form-label">Budget Amount</label>
                            <input type="number" class="form-input" id="inp-amount" placeholder="0" value="${item?.amount || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('period')}</label>
                            <select class="form-select" id="inp-period">
                                <option value="daily" ${periodValue === 'daily' ? 'selected' : ''}>${t('daily')}</option>
                                <option value="monthly" ${periodValue === 'monthly' ? 'selected' : ''}>${t('monthly')}</option>
                                <option value="per 3 month" ${periodValue === 'per 3 month' ? 'selected' : ''}>${t('per_3_month')}</option>
                                <option value="per 6 month" ${periodValue === 'per 6 month' ? 'selected' : ''}>${t('per_6_month')}</option>
                                <option value="yearly" ${periodValue === 'yearly' ? 'selected' : ''}>${t('yearly')}</option>
                            </select>
                        </div>
                        <div style="padding: 1rem; background: #f7fafc; border-radius: 8px; font-size: 0.875rem; color: var(--text-light);">
                            ${t('budget_tracks_info')}
                        </div>
                    `;
                }

                formHTML += `
                    <button class="btn btn-primary" onclick="submitForm('${type}')">${isEditing ? t('update_item') : t('save_item')}</button>
                    <button class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
                `;

                content.innerHTML = formHTML;
            setTimeout(() => translatePage(), 50);
            }
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('active');
            editingIndex = null;
            editingType = null;
        }

        function editItem(type, index) {
            // Map data type to form type
            if (type === 'income') openModal('form', 'income', index);
            else if (type === 'expenses') openModal('form', 'expense', index);
            else if (type === 'receivables') openModal('form', 'receivable', index);
            else if (type === 'payables') openModal('form', 'payable', index);
            else if (type === 'plans') openModal('form', 'plan', index);
            else if (type === 'budgets') openModal('form', 'budget', index);
            else if (type === 'categories') openModal('form', 'category', index);
            else if (type === 'templates') editTemplate(index);
            else if (type === 'accounts') editAccount(index);
            else if (type === 'debts') editDebt(index);
            else if (type === 'transfers') editTransfer(index);
        }

        function duplicateTransaction(type, index) {
            const data = state.data[type];
            if (data && data[index]) {
                const original = data[index];
                const duplicate = { ...original };
                duplicate.date = new Date().toISOString().split('T')[0]; // Set to today
                delete duplicate.id; // Remove any ID if present
                data.push(duplicate);
                writeExcelFile().then(() => {
                    showToast('Transaction duplicated successfully!', 'success');
                    renderAll();
                });
            }
        }

        function openCategorySelector() {
            closeModal();
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');

            overlay.classList.add('active');
            content.innerHTML = `
                <div class="modal-header">Add Category</div>
                <div class="form-group">
                    <label class="form-label">Category Type</label>
                    <select class="form-select" id="cat-type-selector" onchange="updateCategoryForm()">
                        <option value="income">Income</option>
                        <option value="expense">Expense</option>
                    </select>
                </div>
                <div id="category-form-content"></div>
                <button class="btn btn-primary" onclick="submitCategoryFromSelector()">${t('add')} ${t('categories')}</button>
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            `;
            updateCategoryForm();
        }

        function updateCategoryForm() {
            const type = document.getElementById('cat-type-selector')?.value || 'expense';
            const formContent = document.getElementById('category-form-content');
            if (formContent) {
                formContent.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Category Name</label>
                        <input type="text" class="form-input" id="cat-name-input" placeholder="${t('placeholder_groceries_salary')}" required>
                    </div>
                    <div style="padding: 1rem; background: #f7fafc; border-radius: 8px; font-size: 0.875rem; color: var(--text-light);">
                        This category will be available for ${type} transactions.
                    </div>
                `;
            }
        }

        function submitCategoryFromSelector() {
            const type = document.getElementById('cat-type-selector')?.value || 'expense';
            const name = document.getElementById('cat-name-input')?.value.trim();

            if (!name) {
                showToast(t('category_name_required'), 'error');
                return;
            }

            const newCategory = { name, type };

            // Check if category already exists
            if (!state.data.categories) state.data.categories = [];
            const exists = state.data.categories.find(c =>
                c.name.toLowerCase() === name.toLowerCase() && c.type === type
            );

            if (exists) {
                showToast('This category already exists!', 'error');
                return;
            }

            state.data.categories.push(newCategory);
            writeExcelFile().then(() => {
                showToast('Category added successfully!', 'success');
                closeModal();
                if (window.location.hash === '#categories' || document.querySelector('.nav-tab.active')?.textContent.includes('Categor')) {
                    switchTab('categories');
                } else {
                    renderAll();
                }
            });
        }

        function submitForm(type) {
            let newItem = {};

            // Map form type to data array name
            const dataTypeMap = {
                'income': 'income',
                'expense': 'expenses',
                'receivable': 'receivables',
                'payable': 'payables',
                'plan': 'plans',
                'budget': 'budgets',
                'category': 'categories'
            };
            const dataType = dataTypeMap[type] || type;

            // Helper to get value
            const val = (id) => document.getElementById(id)?.value || '';
            const num = (id) => Number(document.getElementById(id)?.value) || 0;

            const isEditing = editingIndex !== null;

            // Ensure the data array exists
            if (!state.data[dataType]) state.data[dataType] = [];

            // Save to transaction history before making changes
            if (!state.data.transactionHistory) state.data.transactionHistory = [];
            const historyEntry = {
                timestamp: new Date().toISOString(),
                action: isEditing ? 'edit' : 'add',
                type: type,
                data: isEditing && editingIndex !== null && state.data[dataType][editingIndex] ? JSON.parse(JSON.stringify(state.data[dataType][editingIndex])) : null
            };
            state.data.transactionHistory.push(historyEntry);
            // Keep only last 50 history entries
            if (state.data.transactionHistory.length > 50) {
                state.data.transactionHistory.shift();
            }

            // Validation helper
            const validateRequired = (value, fieldName) => {
                if (!value || value.trim() === '') {
                    showToast(`${fieldName} ${t('is_required')}`, 'error');
                    return false;
                }
                return true;
            };

            const validateAmount = (amount, fieldName = t('amount')) => {
                if (!amount || amount <= 0) {
                    showToast(`${fieldName} ${t('must_be_greater_than_zero')}`, 'error');
                    return false;
                }
                return true;
            };

            if (type === 'income') {
                if (!validateRequired(val('inp-source'), 'Source')) return;
                if (!validateAmount(num('inp-amount'), 'Amount')) return;
                if (!validateRequired(val('inp-date'), 'Date')) return;
                if (!validateRequired(val('inp-account'), 'Account')) return;
                newItem = {
                    source: val('inp-source'),
                    category: val('inp-category') || 'Other',
                    amount: num('inp-amount'),
                    date: val('inp-date'),
                    account: val('inp-account'),
                    notes: val('inp-notes'),
                    recurring: document.getElementById('inp-recurring')?.checked || false,
                    recurringFrequency: document.getElementById('inp-recurring')?.checked ? (val('inp-recurring-frequency-income') || 'monthly') : '',
                    recurringNextDate: document.getElementById('inp-recurring')?.checked ? val('inp-recurring-next-income') : ''
                };
                if (isEditing && editingIndex !== null) {
                    state.data[dataType][editingIndex] = newItem;
                } else {
                    state.data[dataType].push(newItem);
                }
            } else if (type === 'expense') {
                if (!validateRequired(val('inp-desc'), 'Description')) return;
                if (!validateAmount(num('inp-amount'), 'Amount')) return;
                if (!validateRequired(val('inp-date'), 'Date')) return;
                if (!validateRequired(val('inp-account'), 'Account')) return;
                newItem = {
                    description: val('inp-desc'),
                    category: val('inp-category') || 'Other',
                    amount: num('inp-amount'),
                    date: val('inp-date'),
                    account: val('inp-account'),
                    notes: val('inp-notes'),
                    recurring: document.getElementById('inp-recurring')?.checked || false,
                    recurringFrequency: document.getElementById('inp-recurring')?.checked ? (val('inp-recurring-frequency-expense') || 'monthly') : '',
                    recurringNextDate: document.getElementById('inp-recurring')?.checked ? val('inp-recurring-next-expense') : ''
                };
                if (isEditing && editingIndex !== null) {
                    state.data[dataType][editingIndex] = newItem;
                } else {
                    state.data[dataType].push(newItem);
                }
            } else if (type === 'receivable') {
                if (!validateRequired(val('inp-from'), 'From')) return;
                if (!validateAmount(num('inp-amount'), 'Amount')) return;
                if (!validateRequired(val('inp-duedate'), 'Due Date')) return;
                newItem = {
                    from: val('inp-from'),
                    description: val('inp-desc'),
                    amount: num('inp-amount'),
                    dueDate: val('inp-duedate'),
                    status: val('inp-status') || 'unpaid',
                    priority: val('inp-priority') || 'medium',
                    notes: val('inp-notes'),
                    reminderDays: num('inp-reminder-days') || 0
                };
                if (isEditing && editingIndex !== null) {
                    state.data[dataType][editingIndex] = newItem;
                } else {
                    state.data[dataType].push(newItem);
                }
            } else if (type === 'payable') {
                if (!validateRequired(val('inp-to'), 'To')) return;
                if (!validateAmount(num('inp-amount'), 'Amount')) return;
                if (!validateRequired(val('inp-duedate'), 'Due Date')) return;
                newItem = {
                    to: val('inp-to'),
                    description: val('inp-desc'),
                    amount: num('inp-amount'),
                    dueDate: val('inp-duedate'),
                    status: val('inp-status') || 'unpaid',
                    priority: val('inp-priority') || 'medium',
                    notes: val('inp-notes'),
                    reminderDays: num('inp-reminder-days') || 0
                };
                if (isEditing && editingIndex !== null) {
                    state.data[dataType][editingIndex] = newItem;
                } else {
                    state.data[dataType].push(newItem);
                }
            } else if (type === 'plan') {
                if (!validateRequired(val('inp-title'), 'Plan Title')) return;
                if (!validateAmount(num('inp-target'), 'Target Amount')) return;
                if (!validateRequired(val('inp-deadline'), 'Deadline')) return;
                newItem = {
                    title: val('inp-title'),
                    targetAmount: num('inp-target'),
                    startDate: val('inp-start-date') || val('inp-deadline'),
                    deadline: val('inp-deadline'),
                    status: val('inp-status') || 'in progress',
                    priority: val('inp-priority') || 'medium',
                    notes: val('inp-notes'),
                    reminderDays: num('inp-reminder-days') || 0
                };
                if (isEditing && editingIndex !== null) {
                    state.data[dataType][editingIndex] = newItem;
                } else {
                    state.data[dataType].push(newItem);
                }
            } else if (type === 'budget') {
                if (!validateRequired(val('inp-category'), 'Category')) return;
                if (!validateAmount(num('inp-amount'), 'Budget Amount')) return;
                newItem = {
                    category: val('inp-category'),
                    amount: num('inp-amount'),
                    period: val('inp-period') || 'monthly'
                };
                if (isEditing && editingIndex !== null) {
                    state.data[dataType][editingIndex] = newItem;
                } else {
                    state.data[dataType].push(newItem);
                }
            } else if (type === 'category') {
                if (!validateRequired(val('inp-name'), 'Category Name')) return;
                const colorInput = document.querySelector('input[name="category-color"]:checked');
                newItem = {
                    name: val('inp-name'),
                    type: val('inp-type'),
                    color: colorInput?.value || '#4299e1'
                };
                if (isEditing && editingIndex !== null) {
                    state.data[dataType][editingIndex] = newItem;
                } else {
                    // Check if category already exists
                    const exists = state.data[dataType].find(c => c.name === newItem.name && c.type === newItem.type);
                    if (!exists) {
                        state.data[dataType].push(newItem);
                    } else {
                        showToast(t('category_already_exists'), 'error');
                        return;
                    }
                }
            }

            // Save to Excel and UI
            writeExcelFile().then(() => {
                showToast(`${isEditing ? 'Updated' : 'Added'} ${type} successfully!`, 'success');
                renderAll();
                closeModal();
            }).catch(err => {
                showToast('Error saving data. Please try again.', 'error');
                console.error(err);
            });
        }

        // Professional Confirmation Modal
        function showConfirmModal(options) {
            return new Promise((resolve) => {
                const { title, message, type = 'warning', confirmText = 'Confirm', cancelText = 'Cancel', icon = 'âš ï¸' } = options;
                const iconClass = type === 'danger' ? 'danger' : type === 'info' ? 'info' : 'warning';
                const iconEmoji = type === 'danger' ? 'ðŸ—‘ï¸' : type === 'info' ? 'â„¹ï¸' : 'âš ï¸';

                const modalHTML = `
                    <div class="confirm-modal">
                        <div class="confirm-header">
                            <div class="confirm-icon ${iconClass}">${iconEmoji}</div>
                            <h3 class="confirm-title">${title}</h3>
                        </div>
                        <div class="confirm-body">
                            ${message}
                        </div>
                        <div class="confirm-actions">
                            <button class="btn btn-secondary" onclick="closeConfirmModal(false)">${cancelText}</button>
                            <button class="btn ${type === 'danger' ? 'btn-danger' : 'btn-primary'}" onclick="closeConfirmModal(true)">${confirmText}</button>
                        </div>
                    </div>
                `;

                const overlay = document.getElementById('modal-overlay');
                const content = document.getElementById('modal-content');
                content.innerHTML = modalHTML;
                overlay.classList.add('active');

                window.closeConfirmModal = (result) => {
                    overlay.classList.remove('active');
                    delete window.closeConfirmModal;
                    resolve(result);
                };

                // Close on overlay click
                overlay.onclick = (e) => {
                    if (e.target === overlay) {
                        window.closeConfirmModal(false);
                    }
                };
            });
        }

        function deleteItem(type, index) {
            const itemName = type === 'income' ? 'income entry' :
                type === 'expenses' ? 'expense entry' :
                    type === 'receivables' ? 'receivable' :
                        type === 'payables' ? 'payable' :
                            type === 'plans' ? 'plan' :
                                type === 'budgets' ? 'budget' : 'item';

            showConfirmModal({
                title: 'Delete Item',
                message: `Are you sure you want to delete this ${itemName}? This action cannot be undone.`,
                type: 'danger',
                confirmText: 'Delete',
                cancelText: 'Cancel'
            }).then(confirmed => {
                if (confirmed) {
                    state.data[type].splice(index, 1);
                    writeExcelFile().then(() => {
                        showToast(`${itemName.charAt(0).toUpperCase() + itemName.slice(1)} deleted successfully`, 'success');
                        renderAll();
                    });
                }
            });
        }

        // --- 6. EXPORT FUNCTIONALITY ---
        function exportData() {
            if (!state.isConnected || !state.fileHandle) {
                showToast('Please connect to Excel file first.', 'warning');
                return;
            }
            if (!state.isConnected) {
                alert('Please connect to Excel file first.');
                return;
            }

            const wb = XLSX.utils.book_new();
            const incomeSheet = XLSX.utils.json_to_sheet(state.data.income);
            const expensesSheet = XLSX.utils.json_to_sheet(state.data.expenses);
            const receivablesSheet = XLSX.utils.json_to_sheet(state.data.receivables);
            const payablesSheet = XLSX.utils.json_to_sheet(state.data.payables);
            const plansSheet = XLSX.utils.json_to_sheet(state.data.plans);
            const budgetsSheet = XLSX.utils.json_to_sheet(state.data.budgets || []);
            const categoriesSheet = XLSX.utils.json_to_sheet(state.data.categories || []);

            XLSX.utils.book_append_sheet(wb, incomeSheet, "Income");
            XLSX.utils.book_append_sheet(wb, expensesSheet, "Expenses");
            XLSX.utils.book_append_sheet(wb, receivablesSheet, "Receivables");
            XLSX.utils.book_append_sheet(wb, payablesSheet, "Payables");
            XLSX.utils.book_append_sheet(wb, plansSheet, "Plans");
            XLSX.utils.book_append_sheet(wb, budgetsSheet, "Budgets");
            XLSX.utils.book_append_sheet(wb, categoriesSheet, "Categories");

            const dateStr = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `finance_data_export_${dateStr}.xlsx`);
            showToast('Data exported to Excel successfully', 'success');
        }

        function exportDataCSV() {
            const dateStr = new Date().toISOString().split('T')[0];
            let csvContent = '';

            // Export each data type as separate CSV
            const dataTypes = [
                { name: 'Income', data: state.data.income },
                { name: 'Expenses', data: state.data.expenses },
                { name: 'Receivables', data: state.data.receivables },
                { name: 'Payables', data: state.data.payables },
                { name: 'Plans', data: state.data.plans },
                { name: 'Budgets', data: state.data.budgets || [] },
                { name: 'Categories', data: state.data.categories || [] }
            ];

            dataTypes.forEach(({ name, data }) => {
                if (data.length > 0) {
                    csvContent += `\n=== ${name} ===\n`;
                    const headers = Object.keys(data[0]).join(',');
                    csvContent += headers + '\n';
                    data.forEach(item => {
                        const values = Object.values(item).map(v => {
                            if (v === null || v === undefined) return '';
                            if (typeof v === 'string' && v.includes(',')) return `"${v}"`;
                            return v;
                        }).join(',');
                        csvContent += values + '\n';
                    });
                    csvContent += '\n';
                }
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `finance_data_export_${dateStr}.csv`;
            link.click();
            URL.revokeObjectURL(link.href);
            showToast('Data exported to CSV successfully', 'success');
        }

        function toggleRecurringOptions(type) {
            const checkbox = document.getElementById('inp-recurring');
            const optionsDiv = document.getElementById(`recurring-options-${type}`);
            if (optionsDiv) {
                optionsDiv.style.display = checkbox?.checked ? 'block' : 'none';
            }
        }

        // --- 7. INITIALIZATION ---
        // Initialize on page load
        (async function () {
            // Initialize language selector
            const langSelector = document.getElementById('language-selector');
            const langSelectorMobile = document.getElementById('language-selector-mobile');
            if (langSelector) {
                langSelector.value = currentLanguage;
            }
            if (langSelectorMobile) {
                langSelectorMobile.value = currentLanguage;
            }
            translatePage();
            
            // Initialize notifications
            updateNotificationBadge();
            
            // Initialize IndexedDB
            try {
                await initDB();
            } catch (err) {
                console.error('Failed to initialize database:', err);
            }

            // First, try to restore file handle from IndexedDB (might work in same session)
            try {
                const savedHandle = await loadFileHandle();
                if (savedHandle) {
                    const isValid = await verifyFileHandle(savedHandle);
                    if (isValid) {
                        state.fileHandle = savedHandle;
                        state.isConnected = true;
                        updateStatus(true);
                        await readExcelFile();
                        renderAll();
                        showToast('Restored connection to Excel file.', 'success');
                        return;
                    } else {
                        // Handle is invalid (stale from previous session), clear it
                        console.log('Stored file handle is invalid, clearing from storage');
                        await removeFileHandle();
                    }
                }
            } catch (err) {
                console.log('Could not restore from IndexedDB:', err);
                // Clear invalid handle on error
                try {
                    await removeFileHandle();
                } catch (clearErr) {
                    console.error('Error clearing invalid handle:', clearErr);
                }
            }

            // Check if we have stored file metadata
            const metadata = getStoredFileMetadata();

            if (metadata && metadata.name === CONFIG.fileName) {
                // We have a stored file, show message that reconnection is available
                const statusEl = document.getElementById('status-bar');
                if (statusEl) {
                    statusEl.className = 'status-bar status-disconnected';
                    statusEl.textContent = `Previously connected to ${CONFIG.fileName}. Click "Connect Excel" to reconnect.`;
                }
                updateStatus(false);
            } else {
                // No stored file, show disconnected state
                updateStatus(false);
            }
        })();
        // --- SETTINGS MANAGEMENT ---
        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('financeManagerSettings') || '{}');
            if (document.getElementById('setting-currency')) {
                document.getElementById('setting-currency').value = settings.currency || 'à§³';
            }
            if (document.getElementById('setting-date-format')) {
                document.getElementById('setting-date-format').value = settings.dateFormat || 'YYYY-MM-DD';
            }
            if (document.getElementById('setting-auto-save')) {
                document.getElementById('setting-auto-save').checked = settings.autoSave !== false;
            }
        }

        function saveSettings() {
            const settings = {
                currency: document.getElementById('setting-currency')?.value || 'à§³',
                dateFormat: document.getElementById('setting-date-format')?.value || 'YYYY-MM-DD',
                autoSave: document.getElementById('setting-auto-save')?.checked !== false
            };
            localStorage.setItem('financeManagerSettings', JSON.stringify(settings));
            showToast('Settings saved successfully', 'success');
        }

        // --- IMPORT FUNCTIONALITY ---
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });

                        showConfirmModal({
                            title: 'Import Data',
                            message: 'This will merge imported data with your existing data. Duplicate entries may be created. Continue?',
                            type: 'warning',
                            confirmText: 'Import',
                            cancelText: 'Cancel'
                        }).then(confirmed => {
                            if (!confirmed) return;

                            const sheetNames = ['Income', 'Expenses', 'Receivables', 'Payables', 'Plans', 'Budgets', 'Categories'];
                            let importedCount = 0;

                            sheetNames.forEach(sheetName => {
                                const sheet = workbook.Sheets[sheetName];
                                if (sheet) {
                                    const jsonData = XLSX.utils.sheet_to_json(sheet);
                                    const dataKey = sheetName.toLowerCase();
                                    if (state.data[dataKey]) {
                                        state.data[dataKey].push(...jsonData);
                                        importedCount += jsonData.length;
                                    }
                                }
                            });

                            writeExcelFile().then(() => {
                                showToast(`Successfully imported ${importedCount} items`, 'success');
                                renderAll();
                            });
                        });
                    } catch (error) {
                        showToast('Error importing file: ' + error.message, 'error');
                    }
                };
                reader.readAsArrayBuffer(file);
            };
            input.click();
        }

        // --- BACKUP & RESTORE ---
        function backupData() {
            const backup = {
                timestamp: new Date().toISOString(),
                version: '1.0',
                data: state.data
            };
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `finance_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Backup created successfully', 'success');
        }

        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const backup = JSON.parse(event.target.result);

                        showConfirmModal({
                            title: 'Restore Backup',
                            message: `This will replace all your current data with the backup from ${new Date(backup.timestamp).toLocaleString()}. This action cannot be undone. Continue?`,
                            type: 'danger',
                            confirmText: 'Restore',
                            cancelText: 'Cancel'
                        }).then(confirmed => {
                            if (!confirmed) return;

                            state.data = backup.data;
                            writeExcelFile().then(() => {
                                showToast('Data restored successfully', 'success');
                                renderAll();
                            });
                        });
                    } catch (error) {
                        showToast('Error restoring backup: ' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // --- TEMPLATES MANAGEMENT ---
        function renderTemplatesList() {
            const container = document.getElementById('templates-container');
            if (!container) return;
            container.innerHTML = '';

            const templates = state.data.templates || [];
            if (templates.length === 0) {
                container.innerHTML = '<div class="text-center" style="padding: 2rem; color: var(--text-light);">No templates created. Create one to quickly add common transactions.</div>';
                return;
            }

            templates.forEach((template, index) => {
                const div = document.createElement('div');
                div.className = 'card';
                div.style.marginBottom = '1rem';
                div.style.padding = '1rem';
                const typeLabel = template.type === 'income' ? 'Income' : template.type === 'expense' ? 'Expense' : template.type === 'receivable' ? 'Receivable' : 'Payable';
                const typeColor = template.type === 'income' ? 'var(--success)' : template.type === 'expense' ? 'var(--danger)' : template.type === 'receivable' ? 'var(--warning)' : 'var(--purple)';

                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 1rem;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <h3 style="margin: 0; font-size: 1.1rem;">${template.name || 'Untitled Template'}</h3>
                                <span style="background: ${typeColor}; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">${typeLabel}</span>
                            </div>
                            <div style="color: var(--text-light); font-size: 0.875rem; margin-bottom: 0.5rem;">
                                <div><strong>Amount:</strong> ${formatCurrency(template.amount || 0)}</div>
                                ${template.category ? `<div><strong>Category:</strong> ${template.category}</div>` : ''}
                                ${template.description ? `<div><strong>Description:</strong> ${template.description}</div>` : ''}
                                ${template.paymentMethod ? `<div><strong>Payment Method:</strong> ${template.paymentMethod}</div>` : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary" onclick="useTemplate(${index})" style="font-size: 0.875rem;">
                                Use Template
                            </button>
                            <button class="btn-edit" onclick="editTemplate(${index})">
                                <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                            <button class="btn-delete" onclick="deleteTemplate(${index})">
                                <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function openTemplateModal(templateIndex = null) {
            const template = templateIndex !== null ? state.data.templates[templateIndex] : null;
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');

            if (!overlay || !content) return;

            overlay.classList.add('active');
            content.innerHTML = `
                <div class="modal-header">
                    <h2>${template ? t('edit_template') : t('create_template')}</h2>
                    <button class="modal-close" onclick="closeModal()">Ã—</button>
                </div>
                <form id="template-form" onsubmit="saveTemplate(event, ${templateIndex !== null ? templateIndex : 'null'}); return false;">
                    <div class="form-group">
                        <label class="form-label">Template Name *</label>
                        <input type="text" class="form-input" id="template-name" required value="${template?.name || ''}" placeholder="e.g. Monthly Salary">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Transaction Type *</label>
                        <select class="form-input" id="template-type" required>
                            <option value="income" ${template?.type === 'income' ? 'selected' : ''}>Income</option>
                            <option value="expense" ${template?.type === 'expense' ? 'selected' : ''}>Expense</option>
                            <option value="receivable" ${template?.type === 'receivable' ? 'selected' : ''}>Receivable</option>
                            <option value="payable" ${template?.type === 'payable' ? 'selected' : ''}>Payable</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount *</label>
                        <input type="number" class="form-input" id="template-amount" required step="0.01" value="${template?.amount || ''}" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <input type="text" class="form-input" id="template-category" value="${template?.category || ''}" placeholder="e.g. Salary, Groceries">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-input" id="template-description" rows="3" placeholder="Optional description">${template?.description || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Payment Method</label>
                        <select class="form-input" id="template-payment-method">
                            <option value="">Select Method</option>
                            <option value="Cash" ${template?.paymentMethod === 'Cash' ? 'selected' : ''}>Cash</option>
                            <option value="Bank Transfer" ${template?.paymentMethod === 'Bank Transfer' ? 'selected' : ''}>Bank Transfer</option>
                            <option value="Card" ${template?.paymentMethod === 'Card' ? 'selected' : ''}>Card</option>
                            <option value="Mobile Payment" ${template?.paymentMethod === 'Mobile Payment' ? 'selected' : ''}>Mobile Payment</option>
                            <option value="Other" ${template?.paymentMethod === 'Other' ? 'selected' : ''}>Other</option>
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">${template ? 'Update' : 'Create'} Template</button>
                    </div>
                </form>
            `;
        }

        function saveTemplate(event, templateIndex) {
            if (event) event.preventDefault();
            if (!state.data.templates) state.data.templates = [];

            const template = {
                name: document.getElementById('template-name').value,
                type: document.getElementById('template-type').value,
                amount: document.getElementById('template-amount').value,
                category: document.getElementById('template-category').value,
                description: document.getElementById('template-description').value,
                paymentMethod: document.getElementById('template-payment-method').value
            };

            const index = templateIndex === 'null' || templateIndex === null ? null : parseInt(templateIndex);
            if (index !== null && index >= 0) {
                state.data.templates[index] = template;
            } else {
                state.data.templates.push(template);
            }

            writeExcelFile().then(() => {
                renderTemplatesList();
                closeModal();
                showToast(`Template ${index !== null ? 'updated' : 'created'} successfully`, 'success');
            });
        }

        function useTemplate(templateIndex) {
            const template = state.data.templates[templateIndex];
            if (!template) return;

            openModal('form', template.type);
            // Wait for modal to render, then fill in values
            setTimeout(() => {
                const amountInput = document.getElementById('inp-amount');
                const categoryInput = document.getElementById('inp-category') || document.getElementById('inp-source');
                const descriptionInput = document.getElementById('inp-description') || document.getElementById('inp-notes');
                const paymentMethodInput = document.getElementById('inp-payment-method');

                if (amountInput) amountInput.value = template.amount;
                if (categoryInput) categoryInput.value = template.category;
                if (descriptionInput) descriptionInput.value = template.description;
                if (paymentMethodInput) paymentMethodInput.value = template.paymentMethod;
            }, 100);
        }

        function editTemplate(templateIndex) {
            openTemplateModal(templateIndex);
        }

        function deleteTemplate(templateIndex) {
            showConfirmModal({
                title: 'Delete Template',
                message: t('are_you_sure_delete_template'),
                type: 'danger'
            }).then(confirmed => {
                if (!confirmed) return;
                state.data.templates.splice(templateIndex, 1);
                writeExcelFile().then(() => {
                    renderTemplatesList();
                    showToast('Template deleted successfully', 'success');
                });
            });
        }

        // --- ACCOUNTS MANAGEMENT ---
        function renderAccountsList() {
            const container = document.getElementById('accounts-container');
            if (!container) return;
            container.innerHTML = '';

            const accounts = state.data.accounts || [];
            if (accounts.length === 0) {
                container.innerHTML = '<div class="text-center" style="padding: 2rem; color: var(--text-light);">No accounts added. Add an account to track balances across different sources.</div>';
                return;
            }

            // Calculate balances for each account
            accounts.forEach((account, index) => {
                const div = document.createElement('div');
                div.className = 'card';
                div.style.marginBottom = '1rem';
                div.style.padding = '1.5rem';

                // Calculate account balance from transactions
                let balance = Number(account.initialBalance || 0);
                state.data.income.forEach(item => {
                    if (item.account === account.name) balance += Number(item.amount || 0);
                });
                state.data.expenses.forEach(item => {
                    if (item.account === account.name) balance -= Number(item.amount || 0);
                });
                // Handle transfers
                (state.data.transfers || []).forEach(transfer => {
                    if (transfer.fromAccount === account.name) balance -= Number(transfer.amount || 0);
                    if (transfer.toAccount === account.name) balance += Number(transfer.amount || 0);
                });

                const typeColors = {
                    'Cash': 'var(--success)',
                    'Bank': 'var(--primary)',
                    'Credit Card': 'var(--danger)',
                    'Savings': 'var(--purple)',
                    'Investment': 'var(--warning)'
                };
                const typeColor = typeColors[account.type] || 'var(--text-light)';

                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 1rem;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <h3 style="margin: 0; font-size: 1.2rem;">${account.name || 'Unnamed Account'}</h3>
                                <span style="background: ${typeColor}; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">${account.type || 'Other'}</span>
                            </div>
                            <div style="color: var(--text-light); font-size: 0.875rem; margin-bottom: 0.75rem;">
                                ${account.description || 'No description'}
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                                <div>
                                    <div style="font-size: 0.75rem; color: var(--text-light);">Current Balance</div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: ${balance >= 0 ? 'var(--success)' : 'var(--danger)'};">
                                        ${formatCurrency(balance)}
                                    </div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75rem; color: var(--text-light);">Initial Balance</div>
                                    <div style="font-size: 1.1rem; font-weight: 600;">
                                        ${formatCurrency(account.initialBalance || 0)}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn-edit" onclick="editAccount(${index})">
                                <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                            <button class="btn-delete" onclick="deleteAccount(${index})">
                                <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function openAccountModal(accountIndex = null) {
            const account = accountIndex !== null ? state.data.accounts[accountIndex] : null;
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');

            if (!overlay || !content) return;

            overlay.classList.add('active');
            content.innerHTML = `
                <div class="modal-header">
                    <h2>${account ? t('edit') + ' ' + t('accounts') : t('add_account')}</h2>
                    <button class="modal-close" onclick="closeModal()">Ã—</button>
                </div>
                <form id="account-form" onsubmit="saveAccount(event, ${accountIndex !== null ? accountIndex : 'null'}); return false;">
                    <div class="form-group">
                        <label class="form-label">${t('account_name')} *</label>
                        <input type="text" class="form-input" id="account-name" required value="${account?.name || ''}" placeholder="${t('placeholder_main_bank')}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">${t('account_type')} *</label>
                        <select class="form-input" id="account-type" required>
                            <option value="Cash" ${account?.type === 'Cash' ? 'selected' : ''}>${t('cash')}</option>
                            <option value="Bank" ${account?.type === 'Bank' ? 'selected' : ''}>${t('bank_transfer')}</option>
                            <option value="Credit Card" ${account?.type === 'Credit Card' ? 'selected' : ''}>${t('card')}</option>
                            <option value="Savings" ${account?.type === 'Savings' ? 'selected' : ''}>${t('savings')}</option>
                            <option value="Investment" ${account?.type === 'Investment' ? 'selected' : ''}>${t('investments')}</option>
                            <option value="Other" ${account?.type === 'Other' ? 'selected' : ''}>${t('other')}</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">${t('initial_balance')}</label>
                        <input type="number" class="form-input" id="account-balance" step="0.01" value="${account?.initialBalance || 0}" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">${t('description')}</label>
                        <textarea class="form-input" id="account-description" rows="3" placeholder="${t('optional_description')}">${account?.description || ''}</textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
                        <button type="submit" class="btn btn-primary">${account ? t('update_account') : t('add_account')}</button>
                    </div>
                </form>
            `;
        }

        function saveAccount(event, accountIndex) {
            if (event) event.preventDefault();
            if (!state.data.accounts) state.data.accounts = [];

            const account = {
                name: document.getElementById('account-name').value,
                type: document.getElementById('account-type').value,
                initialBalance: Number(document.getElementById('account-balance').value) || 0,
                description: document.getElementById('account-description').value
            };

            const index = accountIndex === 'null' || accountIndex === null ? null : parseInt(accountIndex);
            if (index !== null && index >= 0) {
                state.data.accounts[index] = account;
            } else {
                state.data.accounts.push(account);
            }

            writeExcelFile().then(() => {
                renderAccountsList();
                closeModal();
                showToast(`Account ${index !== null ? 'updated' : 'added'} successfully`, 'success');
            });
        }

        function editAccount(accountIndex) {
            openAccountModal(accountIndex);
        }

        function deleteAccount(accountIndex) {
            showConfirmModal({
                title: 'Delete Account',
                message: t('are_you_sure_delete_account'),
                type: 'danger'
            }).then(confirmed => {
                if (!confirmed) return;
                state.data.accounts.splice(accountIndex, 1);
                writeExcelFile().then(() => {
                    renderAccountsList();
                    showToast('Account deleted successfully', 'success');
                });
            });
        }

        // Undo Last Action
        function undoLastAction() {
            if (!state.data.transactionHistory || state.data.transactionHistory.length === 0) {
                showToast('No actions to undo', 'warning');
                return;
            }

            const lastAction = state.data.transactionHistory.pop();

            if (lastAction.action === 'delete') {
                // Restore deleted item
                if (lastAction.data && lastAction.index !== undefined) {
                    state.data[lastAction.type].splice(lastAction.index, 0, lastAction.data);
                    writeExcelFile().then(() => {
                        showToast('Last deletion undone', 'success');
                        renderAll();
                    });
                }
            } else if (lastAction.action === 'edit') {
                // Restore previous version
                if (lastAction.data && lastAction.index !== undefined) {
                    state.data[lastAction.type][lastAction.index] = lastAction.data;
                    writeExcelFile().then(() => {
                        showToast('Last edit undone', 'success');
                        renderAll();
                    });
                }
            } else if (lastAction.action === 'add') {
                // Remove last added item
                if (state.data[lastAction.type].length > 0) {
                    state.data[lastAction.type].pop();
                    writeExcelFile().then(() => {
                        showToast('Last addition undone', 'success');
                        renderAll();
                    });
                }
            }
        }

        // --- ACCOUNT TRANSFERS ---
        function renderTransfersList() {
            const container = document.getElementById('transfers-container');
            if (!container) return;
            container.innerHTML = '';

            const transfers = state.data.transfers || [];
            if (transfers.length === 0) {
                container.innerHTML = '<div class="text-center" style="padding: 2rem; color: var(--text-light);">No transfers recorded. Add a transfer to track money movement between accounts.</div>';
                return;
            }

            transfers.forEach((transfer, index) => {
                const div = document.createElement('div');
                div.className = 'card';
                div.style.marginBottom = '1rem';
                div.style.padding = '1.5rem';

                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 1rem;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <h3 style="margin: 0; font-size: 1.2rem;">${transfer.fromAccount || 'Unknown'} â†’ ${transfer.toAccount || 'Unknown'}</h3>
                            </div>
                            <div style="color: var(--text-light); font-size: 0.875rem; margin-bottom: 0.75rem;">
                                ${transfer.description || 'No description'} ${transfer.date ? `â€¢ Date: ${transfer.date}` : ''}
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                                <div>
                                    <div style="font-size: 0.75rem; color: var(--text-light);">Amount</div>
                                    <div style="font-size: 1.2rem; font-weight: bold;">${formatCurrency(transfer.amount || 0)}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75rem; color: var(--text-light);">Date</div>
                                    <div style="font-size: 1rem; font-weight: 600;">${transfer.date || '-'}</div>
                                </div>
                                ${transfer.notes ? `
                                <div style="grid-column: 1 / -1;">
                                    <div style="font-size: 0.75rem; color: var(--text-light);">Notes</div>
                                    <div style="font-size: 0.875rem;">${transfer.notes}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn-edit" onclick="editTransfer(${index})">
                                <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                            <button class="btn-delete" onclick="deleteTransfer(${index})">
                                <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function openTransferModal(transferIndex = null) {
            const transfer = transferIndex !== null ? state.data.transfers[transferIndex] : null;
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            const today = new Date().toISOString().split('T')[0];

            if (!overlay || !content) return;

            const accounts = state.data.accounts || [];
            const accountOptions = accounts.map(acc => `<option value="${acc.name}">${acc.name} (${acc.type})</option>`).join('');

            overlay.classList.add('active');
            content.innerHTML = `
                <div class="modal-header">
                    <h2>${transfer ? t('edit') + ' ' + t('transfer') : t('add_transfer')}</h2>
                    <button class="modal-close" onclick="closeModal()">Ã—</button>
                </div>
                <form onsubmit="saveTransfer(event, ${transferIndex !== null ? transferIndex : 'null'}); return false;">
                    <div class="form-group">
                        <label class="form-label">${t('from_account')} *</label>
                        <select class="form-select" id="transfer-from-account" required>
                            <option value="">${t('select_account')}</option>
                            ${accountOptions}
                            ${transfer?.fromAccount ? `<option value="${transfer.fromAccount}" selected>${transfer.fromAccount}</option>` : ''}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">${t('to_account')} *</label>
                        <select class="form-select" id="transfer-to-account" required>
                            <option value="">${t('select_account')}</option>
                            ${accountOptions}
                            ${transfer?.toAccount ? `<option value="${transfer.toAccount}" selected>${transfer.toAccount}</option>` : ''}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">${t('amount')} *</label>
                        <input type="number" class="form-input" id="transfer-amount" required step="0.01" value="${transfer?.amount || ''}" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">${t('date')} *</label>
                        <input type="date" class="form-input" id="transfer-date" required value="${transfer?.date || today}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">${t('description')}</label>
                        <input type="text" class="form-input" id="transfer-description" value="${transfer?.description || ''}" placeholder="${t('transfer_description_placeholder')}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">${t('notes_optional')}</label>
                        <textarea class="form-input" id="transfer-notes" placeholder="${t('additional_notes')}" rows="2">${transfer?.notes || ''}</textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
                        <button type="submit" class="btn btn-primary">${transfer ? t('update') : t('save')}</button>
                    </div>
                </form>
            `;
        }

        function saveTransfer(event, transferIndex) {
            if (event) event.preventDefault();
            if (!state.data.transfers) state.data.transfers = [];

            const fromAccount = document.getElementById('transfer-from-account').value;
            const toAccount = document.getElementById('transfer-to-account').value;

            if (fromAccount === toAccount) {
                showToast('From and To accounts cannot be the same', 'error');
                return;
            }

            const transfer = {
                fromAccount: fromAccount,
                toAccount: toAccount,
                amount: Number(document.getElementById('transfer-amount').value) || 0,
                date: document.getElementById('transfer-date').value,
                description: document.getElementById('transfer-description').value || '',
                notes: document.getElementById('transfer-notes').value || ''
            };

            const index = transferIndex === 'null' || transferIndex === null ? null : parseInt(transferIndex);
            if (index !== null && index >= 0) {
                state.data.transfers[index] = transfer;
            } else {
                state.data.transfers.push(transfer);
            }

            writeExcelFile().then(() => {
                renderTransfersList();
                renderAccountsList(); // Refresh account balances
                closeModal();
                showToast(`Transfer ${index !== null ? 'updated' : 'added'} successfully`, 'success');
            });
        }

        function editTransfer(transferIndex) {
            openTransferModal(transferIndex);
        }

        function deleteTransfer(transferIndex) {
            showConfirmModal({
                title: 'Delete Transfer',
                message: 'Are you sure you want to delete this transfer?',
                type: 'danger'
            }).then(confirmed => {
                if (!confirmed) return;
                state.data.transfers.splice(transferIndex, 1);
                writeExcelFile().then(() => {
                    renderTransfersList();
                    renderAccountsList(); // Refresh account balances
                    showToast('Transfer deleted successfully', 'success');
                });
            });
        }

        // --- DEBT TRACKER ---
        function renderDebtsList() {
            const container = document.getElementById('debts-container');
            if (!container) return;
            container.innerHTML = '';

            const debts = state.data.debts || [];
            if (debts.length === 0) {
                container.innerHTML = '<div class="text-center" style="padding: 2rem; color: var(--text-light);">No debts tracked. Add a debt to start tracking.</div>';
                return;
            }

            let totalDebt = 0;
            debts.forEach((debt, index) => {
                const div = document.createElement('div');
                div.className = 'card';
                div.style.marginBottom = '1rem';
                div.style.padding = '1.5rem';

                const principal = Number(debt.principal || 0);
                const paid = Number(debt.paid || 0);
                const remaining = principal - paid;
                totalDebt += remaining;
                const percentPaid = principal > 0 ? (paid / principal) * 100 : 0;

                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 1rem;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <h3 style="margin: 0; font-size: 1.2rem;">${debt.name || 'Unnamed Debt'}</h3>
                                <span style="background: ${debt.type === 'Loan' ? 'var(--primary)' : 'var(--danger)'}; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">${debt.type || 'Debt'}</span>
                            </div>
                            <div style="color: var(--text-light); font-size: 0.875rem; margin-bottom: 0.75rem;">
                                ${debt.description || 'No description'} ${debt.creditor ? `â€¢ Creditor: ${debt.creditor}` : ''}
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                                <div>
                                    <div style="font-size: 0.75rem; color: var(--text-light);">Principal</div>
                                    <div style="font-size: 1.2rem; font-weight: bold;">${formatCurrency(principal)}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75rem; color: var(--text-light);">Paid</div>
                                    <div style="font-size: 1.2rem; font-weight: bold; color: var(--success);">${formatCurrency(paid)}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75rem; color: var(--text-light);">Remaining</div>
                                    <div style="font-size: 1.2rem; font-weight: bold; color: var(--danger);">${formatCurrency(remaining)}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75rem; color: var(--text-light);">Progress</div>
                                    <div style="font-size: 1.2rem; font-weight: bold;">${Math.round(percentPaid)}%</div>
                                </div>
                            </div>
                            <div class="progress-track" style="margin-bottom: 0.5rem;">
                                <div class="progress-fill" style="width: ${Math.min(100, percentPaid)}%; background: var(--success);"></div>
                            </div>
                            ${debt.dueDate ? `<div style="font-size: 0.75rem; color: var(--text-light);">Due Date: ${debt.dueDate}</div>` : ''}
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary" onclick="makePayment(${index})" style="font-size: 0.875rem;">
                                Record Payment
                            </button>
                            <button class="btn-edit" onclick="editDebt(${index})">
                                <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                            <button class="btn-delete" onclick="deleteDebt(${index})">
                                <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });

            // Add summary
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'card';
            summaryDiv.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;';
            summaryDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Total Debt Remaining</div>
                        <div style="font-size: 2rem; font-weight: bold;">${formatCurrency(totalDebt)}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Total Debts</div>
                        <div style="font-size: 1.5rem; font-weight: bold;">${debts.length}</div>
                    </div>
                </div>
            `;
            container.insertBefore(summaryDiv, container.firstChild);
        }

        function openDebtModal(debtIndex = null) {
            const debt = debtIndex !== null ? state.data.debts[debtIndex] : null;
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');

            if (!overlay || !content) return;

            overlay.classList.add('active');
            content.innerHTML = `
                <div class="modal-header">
                    <h2>${debt ? t('edit') + ' ' + t('debts') : t('add_debt')}</h2>
                    <button class="modal-close" onclick="closeModal()">Ã—</button>
                </div>
                <form onsubmit="saveDebt(event, ${debtIndex !== null ? debtIndex : 'null'}); return false;">
                    <div class="form-group">
                        <label class="form-label">${t('debt_name')} *</label>
                        <input type="text" class="form-input" id="debt-name" required value="${debt?.name || ''}" placeholder="e.g. Home Loan">
                    </div>
                    <div class="form-group">
                        <label class="form-label">${t('debt_type')} *</label>
                        <select class="form-input" id="debt-type" required>
                            <option value="Loan" ${debt?.type === 'Loan' ? 'selected' : ''}>${t('loan')}</option>
                            <option value="Credit Card" ${debt?.type === 'Credit Card' ? 'selected' : ''}>${t('card')}</option>
                            <option value="Mortgage" ${debt?.type === 'Mortgage' ? 'selected' : ''}>${t('mortgage')}</option>
                            <option value="Personal Loan" ${debt?.type === 'Personal Loan' ? 'selected' : ''}>${t('personal_loan')}</option>
                            <option value="Other" ${debt?.type === 'Other' ? 'selected' : ''}>${t('other')}</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">${t('principal_amount')} *</label>
                        <input type="number" class="form-input" id="debt-principal" required step="0.01" value="${debt?.principal || ''}" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">${t('amount_paid')}</label>
                        <input type="number" class="form-input" id="debt-paid" step="0.01" value="${debt?.paid || 0}" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">${t('creditor_lender')}</label>
                        <input type="text" class="form-input" id="debt-creditor" value="${debt?.creditor || ''}" placeholder="e.g. Bank Name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">${t('due_date')}</label>
                        <input type="date" class="form-input" id="debt-due-date" value="${debt?.dueDate || ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">${t('description')}</label>
                        <textarea class="form-input" id="debt-description" rows="3" placeholder="${t('optional_description')}">${debt?.description || ''}</textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
                        <button type="submit" class="btn btn-primary">${debt ? t('update_debt') : t('add_debt')}</button>
                    </div>
                </form>
            `;
        }

        function saveDebt(event, debtIndex) {
            if (event) event.preventDefault();
            if (!state.data.debts) state.data.debts = [];

            const debt = {
                name: document.getElementById('debt-name').value,
                type: document.getElementById('debt-type').value,
                principal: Number(document.getElementById('debt-principal').value) || 0,
                paid: Number(document.getElementById('debt-paid').value) || 0,
                creditor: document.getElementById('debt-creditor').value,
                dueDate: document.getElementById('debt-due-date').value,
                description: document.getElementById('debt-description').value
            };

            const index = debtIndex === 'null' || debtIndex === null ? null : parseInt(debtIndex);
            if (index !== null && index >= 0) {
                state.data.debts[index] = debt;
            } else {
                state.data.debts.push(debt);
            }

            writeExcelFile().then(() => {
                renderDebtsList();
                closeModal();
                showToast(`Debt ${index !== null ? 'updated' : 'added'} successfully`, 'success');
            });
        }

        function makePayment(debtIndex) {
            const debt = state.data.debts[debtIndex];
            const modal = document.getElementById('modal');
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Record Payment</h2>
                        <button class="modal-close" onclick="closeModal()">Ã—</button>
                    </div>
                    <form onsubmit="savePayment(event, ${debtIndex})">
                        <div class="form-group">
                            <label class="form-label">Payment Amount *</label>
                            <input type="number" class="form-input" id="payment-amount" required step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Payment Date</label>
                            <input type="date" class="form-input" id="payment-date" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Notes</label>
                            <textarea class="form-input" id="payment-notes" rows="3" placeholder="${t('optional_notes')}"></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Record Payment</button>
                        </div>
                    </form>
                </div>
            `;
            modal.classList.add('show');
        }

        function savePayment(event, debtIndex) {
            event.preventDefault();
            const paymentAmount = Number(document.getElementById('payment-amount').value) || 0;
            const debt = state.data.debts[debtIndex];

            debt.paid = (Number(debt.paid || 0) + paymentAmount);
            if (debt.paid > debt.principal) debt.paid = debt.principal;

            writeExcelFile().then(() => {
                renderDebtsList();
                closeModal();
                showToast('Payment recorded successfully', 'success');
            });
        }

        function editDebt(debtIndex) {
            openDebtModal(debtIndex);
        }

        function deleteDebt(debtIndex) {
            showConfirmModal({
                title: 'Delete Debt',
                message: t('are_you_sure_delete_debt'),
                type: 'danger'
            }).then(confirmed => {
                if (!confirmed) return;
                state.data.debts.splice(debtIndex, 1);
                writeExcelFile().then(() => {
                    renderDebtsList();
                    showToast('Debt deleted successfully', 'success');
                });
            });
        }

        // --- RECURRING TRANSACTIONS MANAGER ---
        function renderRecurringList() {
            const container = document.getElementById('recurring-container');
            if (!container) return;
            container.innerHTML = '';

            const allRecurring = [
                ...state.data.income.filter(item => item.recurring).map(item => ({ ...item, type: 'income', typeLabel: 'Income' })),
                ...state.data.expenses.filter(item => item.recurring).map(item => ({ ...item, type: 'expense', typeLabel: 'Expense' })),
                ...state.data.receivables.filter(item => item.recurring).map(item => ({ ...item, type: 'receivable', typeLabel: 'Receivable' })),
                ...state.data.payables.filter(item => item.recurring).map(item => ({ ...item, type: 'payable', typeLabel: 'Payable' }))
            ];

            if (allRecurring.length === 0) {
                container.innerHTML = '<div class="text-center" style="padding: 2rem; color: var(--text-light);">No recurring transactions found. Mark transactions as recurring to see them here.</div>';
                return;
            }

            allRecurring.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'card';
                div.style.marginBottom = '1rem';
                div.style.padding = '1rem';

                const typeColor = item.type === 'income' ? 'var(--success)' : item.type === 'expense' ? 'var(--danger)' : item.type === 'receivable' ? 'var(--warning)' : 'var(--purple)';
                const nextDate = item.recurringNextDate || item.date || item.dueDate || 'Not set';
                const frequency = item.recurringFrequency || 'monthly';

                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 1rem;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="background: ${typeColor}; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">${item.typeLabel}</span>
                                <strong>${item.source || item.description || item.from || item.to || 'Unnamed'}</strong>
                            </div>
                            <div style="color: var(--text-light); font-size: 0.875rem; margin-bottom: 0.5rem;">
                                Amount: <strong style="color: ${typeColor};">${formatCurrency(item.amount)}</strong> â€¢ Frequency: ${frequency} â€¢ Next: ${nextDate}
                            </div>
                            ${item.category ? `<div style="font-size: 0.75rem; color: var(--text-light);">Category: ${item.category}</div>` : ''}
                        </div>
                        <button class="btn btn-secondary" onclick="editRecurringItem('${item.type}', ${state.data[item.type === 'income' ? 'income' : item.type === 'expense' ? 'expenses' : item.type === 'receivable' ? 'receivables' : 'payables'].indexOf(item)})" style="font-size: 0.875rem;">
                            Edit
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function generateRecurringTransactions() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            let generatedCount = 0;

            const generateForType = (items, type) => {
                items.forEach(item => {
                    if (!item.recurring || !item.recurringNextDate) return;

                    const nextDate = new Date(item.recurringNextDate);
                    nextDate.setHours(0, 0, 0, 0);

                    if (nextDate <= today) {
                        // Create new transaction
                        const newItem = { ...item };
                        delete newItem.recurringNextDate;

                        // Set date based on type
                        if (type === 'income' || type === 'expense') {
                            newItem.date = item.recurringNextDate;
                        } else {
                            newItem.dueDate = item.recurringNextDate;
                        }

                        // Calculate next date
                        const frequency = item.recurringFrequency || 'monthly';
                        const next = new Date(nextDate);
                        switch (frequency) {
                            case 'daily':
                                next.setDate(next.getDate() + 1);
                                break;
                            case 'weekly':
                                next.setDate(next.getDate() + 7);
                                break;
                            case 'monthly':
                                next.setMonth(next.getMonth() + 1);
                                break;
                            case 'yearly':
                                next.setFullYear(next.getFullYear() + 1);
                                break;
                        }

                        // Update next date
                        item.recurringNextDate = next.toISOString().split('T')[0];

                        // Add to appropriate array
                        if (type === 'income') {
                            state.data.income.push(newItem);
                        } else if (type === 'expense') {
                            state.data.expenses.push(newItem);
                        } else if (type === 'receivable') {
                            state.data.receivables.push(newItem);
                        } else if (type === 'payable') {
                            state.data.payables.push(newItem);
                        }

                        generatedCount++;
                    }
                });
            };

            generateForType(state.data.income, 'income');
            generateForType(state.data.expenses, 'expense');
            generateForType(state.data.receivables, 'receivable');
            generateForType(state.data.payables, 'payable');

            if (generatedCount > 0) {
                writeExcelFile().then(() => {
                    showToast(`Generated ${generatedCount} recurring transaction(s)`, 'success');
                    renderAll();
                });
            } else {
                showToast('No recurring transactions due at this time', 'info');
            }
        }

        function editRecurringItem(type, index) {
            openModal('form', type);
            setTimeout(() => {
                const item = state.data[type === 'income' ? 'income' : type === 'expenses' ? 'expenses' : type === 'receivable' ? 'receivables' : 'payables'][index];
                editingIndex = index;
                // Form will be populated by openModal function
            }, 100);
        }

        // --- FINANCIAL CALENDAR ---
        let currentCalendarDate = new Date();

        function renderFinancialCalendar() {
            const container = document.getElementById('calendar-container');
            if (!container) return;

            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();

            // Get all transactions for the month
            const monthStart = `${year}-${String(month + 1).padStart(2, '0')}-01`;
            const monthEnd = `${year}-${String(month + 1).padStart(2, '0')}-${String(daysInMonth).padStart(2, '0')}`;

            const transactionsByDate = {};

            [...state.data.income, ...state.data.expenses, ...state.data.receivables, ...state.data.payables].forEach(item => {
                const date = item.date || item.dueDate;
                if (date && date >= monthStart && date <= monthEnd) {
                    if (!transactionsByDate[date]) transactionsByDate[date] = [];
                    transactionsByDate[date].push(item);
                }
            });

            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

            let html = `
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <h3 style="font-size: 1.5rem; margin-bottom: 0.5rem;">${monthNames[month]} ${year}</h3>
                </div>
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem; margin-bottom: 1rem;">
            `;

            // Day headers
            dayNames.forEach(day => {
                html += `<div style="text-align: center; font-weight: 600; padding: 0.5rem; background: var(--card-bg); border-radius: 4px;">${day}</div>`;
            });

            // Empty cells for days before month starts
            for (let i = 0; i < startingDayOfWeek; i++) {
                html += `<div style="min-height: 80px; border: 1px solid var(--border); border-radius: 4px;"></div>`;
            }

            // Days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayTransactions = transactionsByDate[dateStr] || [];
                const isToday = dateStr === new Date().toISOString().split('T')[0];

                let incomeTotal = 0;
                let expenseTotal = 0;
                dayTransactions.forEach(t => {
                    if (t.amount) {
                        if (state.data.income.includes(t) || (t.type === 'receivable' && (t.status || 'unpaid') === 'unpaid')) {
                            incomeTotal += Number(t.amount);
                        } else {
                            expenseTotal += Number(t.amount);
                        }
                    }
                });

                html += `
                    <div style="min-height: 80px; border: 1px solid var(--border); border-radius: 4px; padding: 0.5rem; ${isToday ? 'background: #e6f3ff; border: 2px solid var(--primary);' : ''}">
                        <div style="font-weight: 600; margin-bottom: 0.25rem; ${isToday ? 'color: var(--primary);' : ''}">${day}</div>
                        ${incomeTotal > 0 ? `<div style="font-size: 0.75rem; color: var(--success);">+${formatCurrency(incomeTotal)}</div>` : ''}
                        ${expenseTotal > 0 ? `<div style="font-size: 0.75rem; color: var(--danger);">-${formatCurrency(expenseTotal)}</div>` : ''}
                        ${dayTransactions.length > 0 ? `<div style="font-size: 0.7rem; color: var(--text-light); margin-top: 0.25rem;">${dayTransactions.length} transaction(s)</div>` : ''}
                    </div>
                `;
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function changeCalendarMonth(direction) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            renderFinancialCalendar();
        }

        // --- CASH FLOW ANALYSIS ---
        function renderCashFlow() {
            const container = document.getElementById('cashflow-container');
            if (!container) return;

            const period = document.getElementById('cashflow-period')?.value || 'monthly';
            const today = new Date();
            const periods = [];

            // Get data for last 12 periods
            for (let i = 11; i >= 0; i--) {
                let periodStart, periodEnd, periodLabel;
                const periodDate = new Date(today);

                if (period === 'monthly') {
                    periodDate.setMonth(today.getMonth() - i);
                    periodStart = `${periodDate.getFullYear()}-${String(periodDate.getMonth() + 1).padStart(2, '0')}-01`;
                    const lastDay = new Date(periodDate.getFullYear(), periodDate.getMonth() + 1, 0).getDate();
                    periodEnd = `${periodDate.getFullYear()}-${String(periodDate.getMonth() + 1).padStart(2, '0')}-${String(lastDay).padStart(2, '0')}`;
                    periodLabel = periodDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                } else if (period === 'quarterly') {
                    const quarter = Math.floor((today.getMonth() - i * 3) / 3);
                    const year = periodDate.getFullYear() - Math.floor((today.getMonth() - i * 3) / 12);
                    periodDate.setFullYear(year);
                    periodDate.setMonth(quarter * 3);
                    periodStart = `${periodDate.getFullYear()}-${String(periodDate.getMonth() + 1).padStart(2, '0')}-01`;
                    const lastDay = new Date(periodDate.getFullYear(), periodDate.getMonth() + 3, 0).getDate();
                    periodEnd = `${periodDate.getFullYear()}-${String(periodDate.getMonth() + 3).padStart(2, '0')}-${String(lastDay).padStart(2, '0')}`;
                    periodLabel = `Q${quarter + 1} ${year}`;
                } else {
                    periodDate.setFullYear(today.getFullYear() - i);
                    periodStart = `${periodDate.getFullYear()}-01-01`;
                    periodEnd = `${periodDate.getFullYear()}-12-31`;
                    periodLabel = periodDate.getFullYear().toString();
                }

                const income = state.data.income
                    .filter(item => item.date && item.date >= periodStart && item.date <= periodEnd)
                    .reduce((sum, item) => sum + Number(item.amount || 0), 0);

                const expenses = state.data.expenses
                    .filter(item => item.date && item.date >= periodStart && item.date <= periodEnd)
                    .reduce((sum, item) => sum + Number(item.amount || 0), 0);

                const cashFlow = income - expenses;
                periods.push({ label: periodLabel, income, expenses, cashFlow });
            }

            let html = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; min-width: 600px;">
                        <thead>
                            <tr style="background: var(--card-bg);">
                                <th style="padding: 1rem; text-align: left;">Period</th>
                                <th style="padding: 1rem; text-align: right;">Income</th>
                                <th style="padding: 1rem; text-align: right;">Expenses</th>
                                <th style="padding: 1rem; text-align: right;">Cash Flow</th>
                                <th style="padding: 1rem; text-align: center;">Trend</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            periods.forEach((p, index) => {
                const trend = index > 0 ? (p.cashFlow - periods[index - 1].cashFlow) : 0;
                html += `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 1rem; font-weight: 600;">${p.label}</td>
                        <td style="padding: 1rem; text-align: right; color: var(--success);">${formatCurrency(p.income)}</td>
                        <td style="padding: 1rem; text-align: right; color: var(--danger);">${formatCurrency(p.expenses)}</td>
                        <td style="padding: 1rem; text-align: right; font-weight: bold; color: ${p.cashFlow >= 0 ? 'var(--success)' : 'var(--danger)'};">
                            ${formatCurrency(p.cashFlow)}
                        </td>
                        <td style="padding: 1rem; text-align: center;">
                            ${trend > 0 ? 'ðŸ“ˆ' : trend < 0 ? 'ðŸ“‰' : 'âž¡ï¸'}
                            ${trend !== 0 ? `<span style="font-size: 0.75rem; color: ${trend > 0 ? 'var(--success)' : 'var(--danger)'};">${trend > 0 ? '+' : ''}${formatCurrency(trend)}</span>` : ''}
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        }

        // --- INVESTMENT PORTFOLIO TRACKER ---
        function renderInvestmentsList() {
            const container = document.getElementById('investments-container');
            if (!container) return;
            container.innerHTML = '';

            const investments = state.data.investments || [];
            if (investments.length === 0) {
                container.innerHTML = '<div class="text-center" style="padding: 2rem; color: var(--text-light);">No investments tracked. Add an investment to start tracking your portfolio.</div>';
                return;
            }

            let totalValue = 0;
            let totalCost = 0;

            investments.forEach((investment, index) => {
                const div = document.createElement('div');
                div.className = 'card';
                div.style.marginBottom = '1rem';
                div.style.padding = '1.5rem';

                const cost = Number(investment.cost || 0);
                const currentValue = Number(investment.currentValue || cost);
                const gain = currentValue - cost;
                const gainPercent = cost > 0 ? ((gain / cost) * 100) : 0;
                totalValue += currentValue;
                totalCost += cost;

                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 1rem;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <h3 style="margin: 0; font-size: 1.2rem;">${investment.name || 'Unnamed Investment'}</h3>
                                <span style="background: ${investment.type === 'Stock' ? 'var(--primary)' : investment.type === 'Bond' ? 'var(--success)' : investment.type === 'Mutual Fund' ? 'var(--purple)' : 'var(--warning)'}; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">${investment.type || 'Investment'}</span>
                            </div>
                            <div style="color: var(--text-light); font-size: 0.875rem; margin-bottom: 0.75rem;">
                                ${investment.description || 'No description'} ${investment.symbol ? `â€¢ Symbol: ${investment.symbol}` : ''}
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                                <div>
                                    <div style="font-size: 0.75rem; color: var(--text-light);">Cost Basis</div>
                                    <div style="font-size: 1.2rem; font-weight: bold;">${formatCurrency(cost)}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75rem; color: var(--text-light);">Current Value</div>
                                    <div style="font-size: 1.2rem; font-weight: bold; color: ${currentValue >= cost ? 'var(--success)' : 'var(--danger)'};">
                                        ${formatCurrency(currentValue)}
                                    </div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75rem; color: var(--text-light);">Gain/Loss</div>
                                    <div style="font-size: 1.2rem; font-weight: bold; color: ${gain >= 0 ? 'var(--success)' : 'var(--danger)'};">
                                        ${gain >= 0 ? '+' : ''}${formatCurrency(gain)}
                                    </div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75rem; color: var(--text-light);">Return %</div>
                                    <div style="font-size: 1.2rem; font-weight: bold; color: ${gainPercent >= 0 ? 'var(--success)' : 'var(--danger)'};">
                                        ${gainPercent >= 0 ? '+' : ''}${gainPercent.toFixed(2)}%
                                    </div>
                                </div>
                            </div>
                            ${investment.purchaseDate ? `<div style="font-size: 0.75rem; color: var(--text-light); margin-top: 0.5rem;">Purchase Date: ${investment.purchaseDate}</div>` : ''}
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary" onclick="updateInvestmentValue(${index})" style="font-size: 0.875rem;">
                                Update Value
                            </button>
                            <button class="btn-edit" onclick="editInvestment(${index})">
                                <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                            <button class="btn-delete" onclick="deleteInvestment(${index})">
                                <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });

            // Add portfolio summary
            const totalGain = totalValue - totalCost;
            const totalGainPercent = totalCost > 0 ? ((totalGain / totalCost) * 100) : 0;
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'card';
            summaryDiv.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;';
            summaryDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
                    <div>
                        <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Total Portfolio Value</div>
                        <div style="font-size: 2rem; font-weight: bold;">${formatCurrency(totalValue)}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">${t('total_cost_basis')}</div>
                        <div style="font-size: 1.5rem; font-weight: bold;">${formatCurrency(totalCost)}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">${t('total_gain_loss')}</div>
                        <div style="font-size: 1.5rem; font-weight: bold;">${totalGain >= 0 ? '+' : ''}${formatCurrency(totalGain)}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">${t('total_return')}</div>
                        <div style="font-size: 1.5rem; font-weight: bold;">${totalGainPercent >= 0 ? '+' : ''}${totalGainPercent.toFixed(2)}%</div>
                    </div>
                </div>
            `;
            container.insertBefore(summaryDiv, container.firstChild);
        }

        function openInvestmentModal(investmentIndex = null) {
            const investment = investmentIndex !== null ? state.data.investments[investmentIndex] : null;
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');

            if (!overlay || !content) return;

            overlay.classList.add('active');
            content.innerHTML = `
                <div class="modal-header">
                    <h2>${investment ? t('edit_investment') : t('add_investment')}</h2>
                    <button class="modal-close" onclick="closeModal()">Ã—</button>
                </div>
                <form onsubmit="saveInvestment(event, ${investmentIndex !== null ? investmentIndex : 'null'}); return false;">
                        <div class="form-group">
                            <label class="form-label">${t('investment_name')} *</label>
                            <input type="text" class="form-input" id="investment-name" required value="${investment?.name || ''}" placeholder="${t('placeholder_apple_inc')}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('type')} *</label>
                            <select class="form-input" id="investment-type" required>
                                <option value="Stock" ${investment?.type === 'Stock' ? 'selected' : ''}>${t('stock')}</option>
                                <option value="Bond" ${investment?.type === 'Bond' ? 'selected' : ''}>${t('bond')}</option>
                                <option value="Mutual Fund" ${investment?.type === 'Mutual Fund' ? 'selected' : ''}>${t('mutual_fund')}</option>
                                <option value="ETF" ${investment?.type === 'ETF' ? 'selected' : ''}>${t('etf')}</option>
                                <option value="Crypto" ${investment?.type === 'Crypto' ? 'selected' : ''}>${t('cryptocurrency')}</option>
                                <option value="Other" ${investment?.type === 'Other' ? 'selected' : ''}>${t('other')}</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('symbol_ticker')}</label>
                            <input type="text" class="form-input" id="investment-symbol" value="${investment?.symbol || ''}" placeholder="${t('placeholder_aapl')}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('cost_basis')} *</label>
                            <input type="number" class="form-input" id="investment-cost" required step="0.01" value="${investment?.cost || ''}" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('current_value')}</label>
                            <input type="number" class="form-input" id="investment-value" step="0.01" value="${investment?.currentValue || investment?.cost || ''}" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('purchase_date')}</label>
                            <input type="date" class="form-input" id="investment-date" value="${investment?.purchaseDate || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">${t('description')}</label>
                            <textarea class="form-input" id="investment-description" rows="3" placeholder="${t('optional_description')}">${investment?.description || ''}</textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
                            <button type="submit" class="btn btn-primary">${investment ? t('update_investment') : t('add_investment')}</button>
                        </div>
                    </form>
            `;
        }

        function saveInvestment(event, investmentIndex) {
            if (event) event.preventDefault();
            if (!state.data.investments) state.data.investments = [];

            const investment = {
                name: document.getElementById('investment-name').value,
                type: document.getElementById('investment-type').value,
                symbol: document.getElementById('investment-symbol').value,
                cost: Number(document.getElementById('investment-cost').value) || 0,
                currentValue: Number(document.getElementById('investment-value').value) || Number(document.getElementById('investment-cost').value) || 0,
                purchaseDate: document.getElementById('investment-date').value,
                description: document.getElementById('investment-description').value
            };

            const index = investmentIndex === 'null' || investmentIndex === null ? null : parseInt(investmentIndex);
            if (index !== null && index >= 0) {
                state.data.investments[index] = investment;
            } else {
                state.data.investments.push(investment);
            }

            writeExcelFile().then(() => {
                renderInvestmentsList();
                closeModal();
                showToast(`Investment ${index !== null ? 'updated' : 'added'} successfully`, 'success');
            });
        }

        function updateInvestmentValue(investmentIndex) {
            const investment = state.data.investments[investmentIndex];
            const modal = document.getElementById('modal');
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Update Investment Value</h2>
                        <button class="modal-close" onclick="closeModal()">Ã—</button>
                    </div>
                    <form onsubmit="saveInvestmentValue(event, ${investmentIndex})">
                        <div class="form-group">
                            <label class="form-label">Current Value *</label>
                            <input type="number" class="form-input" id="investment-update-value" required step="0.01" value="${investment?.currentValue || investment?.cost || 0}" placeholder="0.00">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Update Value</button>
                        </div>
                    </form>
                </div>
            `;
            modal.classList.add('show');
        }

        function saveInvestmentValue(event, investmentIndex) {
            event.preventDefault();
            const currentValue = Number(document.getElementById('investment-update-value').value) || 0;
            const investment = state.data.investments[investmentIndex];

            investment.currentValue = currentValue;

            writeExcelFile().then(() => {
                renderInvestmentsList();
                closeModal();
                showToast('Investment value updated successfully', 'success');
            });
        }

        function editInvestment(investmentIndex) {
            openInvestmentModal(investmentIndex);
        }

        function deleteInvestment(investmentIndex) {
            showConfirmModal({
                title: 'Delete Investment',
                message: t('are_you_sure_delete_investment'),
                type: 'danger'
            }).then(confirmed => {
                if (!confirmed) return;
                state.data.investments.splice(investmentIndex, 1);
                writeExcelFile().then(() => {
                    renderInvestmentsList();
                    showToast('Investment deleted successfully', 'success');
                });
            });
        }

        // --- KEYBOARD SHORTCUTS ---
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd combinations
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case '1':
                        e.preventDefault();
                        switchTab('dashboard');
                        break;
                    case '2':
                        e.preventDefault();
                        switchTab('income');
                        break;
                    case '3':
                        e.preventDefault();
                        switchTab('expenses');
                        break;
                    case 'n':
                        e.preventDefault();
                        const activeTab = document.querySelector('.nav-tab.active')?.getAttribute('onclick');
                        if (activeTab) {
                            const match = activeTab.match(/'([^']+)'/);
                            if (match) {
                                const tab = match[1];
                                if (tab === 'income') openModal('form', 'income');
                                else if (tab === 'expenses') openModal('form', 'expense');
                                else if (tab === 'receivables') openModal('form', 'receivable');
                                else if (tab === 'payables') openModal('form', 'payable');
                                else if (tab === 'plans') openModal('form', 'plan');
                                else if (tab === 'budgets') openModal('form', 'budget');
                            }
                        }
                        break;
                    case 's':
                        e.preventDefault();
                        if (state.isConnected) {
                            writeExcelFile().then(() => {
                                showToast('Saved successfully', 'success');
                            });
                        }
                        break;
                    case 'f':
                        e.preventDefault();
                        const searchInput = document.getElementById('search-input');
                        if (searchInput) searchInput.focus();
                        break;
                }
            }

            // Escape key
            if (e.key === 'Escape') {
                const overlay = document.getElementById('modal-overlay');
                if (overlay && overlay.classList.contains('active')) {
                    closeModal();
                }
            }

            // Delete key for bulk delete
            if (e.key === 'Delete' && selectedItems.size > 0) {
                bulkDelete();
            }
        });

        // Initialize settings on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                loadSettings();
                loadSettingsFromStorage();
            });
        } else {
            loadSettings();
            loadSettingsFromStorage();
        }
    </script>
</body>

</html>